# Plan 10-03: Navigation Visibility & Super Admin Safeguards

**Phase:** 10 - Route Protection & Session Security
**Requirements:** SEC-04, SEC-05, SEC-06
**Dependencies:** Plans 10-01 and 10-02 complete

---

## Goal

1. Hide navigation links from unauthenticated users (show only Login/Register)
2. Increase minimum Super Admin requirement from 1 to 2 (prevent single point of failure)
3. Improve overall UX and security posture

---

## Success Criteria

1. ✅ Unauthenticated users see only Login/Register links in navigation
2. ✅ Authenticated users see permitted tabs based on role
3. ✅ System requires minimum 2 active Super Admins (not 1)
4. ✅ Cannot deactivate Super Admin if only 2 remain
5. ✅ Cannot change role of Super Admin if only 2 remain
6. ✅ Clear error messages explain why operation is blocked

---

## Part 1: Navigation Visibility for Unauthenticated Users

### Current State

**File:** `app/auth.js:367-393`
**Function:** `updateNavForAuth(user)`

**Current behavior:**
```javascript
function updateNavForAuth(user) {
    if (user) {
        // Show only permitted tabs
        navLinks.forEach(link => {
            const hasAccess = permissions?.tabs?.[route]?.access ?? true;
            link.style.display = hasAccess ? '' : 'none';
        });
    } else {
        // Show all nav links for unauthenticated users
        // (route protection comes in Phase 10) ← THIS COMMENT
        navLinks.forEach(link => {
            link.style.display = '';
        });
    }
}
```

**Problem:**
- Unauthenticated users see ALL navigation links
- Confusing UX (links don't work)
- Looks unprofessional

---

### Implementation: Hide Protected Links

**File:** `app/auth.js`
**Location:** `updateNavForAuth()` function

**Modified:**
```javascript
function updateNavForAuth(user) {
    const logoutBtn = document.getElementById('logoutBtn');
    const navLinks = document.querySelectorAll('.nav-link[data-route]');

    if (user) {
        // Show logout button for authenticated users
        if (logoutBtn) logoutBtn.style.display = 'block';

        // Filter navigation based on permissions (PERM-13, PERM-14)
        const permissions = window.getCurrentPermissions?.();

        navLinks.forEach(link => {
            const route = link.getAttribute('data-route');
            const hasAccess = permissions?.tabs?.[route]?.access ?? true;

            link.style.display = hasAccess ? '' : 'none';
        });
    } else {
        // Hide logout button for unauthenticated users
        if (logoutBtn) logoutBtn.style.display = 'none';

        // SEC-04: Hide all navigation links for unauthenticated users
        // Only auth pages (login/register) should be accessible
        navLinks.forEach(link => {
            link.style.display = 'none';
        });

        console.log('[Auth] Navigation hidden for unauthenticated user');
    }
}
```

**Result:**
- Unauthenticated users see empty navigation (clean look)
- No confusing non-functional links
- Professional appearance

---

### Optional: Add Login/Register Links for Unauthenticated Users

**File:** `index.html`
**Location:** Navbar

**Add conditional auth links:**
```html
<nav class="navbar" id="navbar">
    <div class="navbar-brand">
        <img src="/assets/logo.svg" alt="CLMC" class="navbar-logo" />
        <span class="navbar-title">CLMC Operations</span>
    </div>

    <div class="navbar-menu">
        <!-- Main navigation (shown only when authenticated) -->
        <a href="#/" class="nav-link" data-route="dashboard">Home</a>
        <a href="#/clients" class="nav-link" data-route="clients">Clients</a>
        <!-- ... other nav links ... -->

        <!-- Auth links (shown only when NOT authenticated) -->
        <a href="#/login" class="nav-link auth-link" id="navLoginLink" style="display: none;">
            Login
        </a>
        <a href="#/register" class="nav-link auth-link" id="navRegisterLink" style="display: none;">
            Register
        </a>

        <button id="logoutBtn" class="btn btn-secondary" onclick="handleLogout()" style="display: none;">
            Logout
        </button>
    </div>
</nav>
```

**File:** `app/auth.js`
**Update `updateNavForAuth()`:**

```javascript
function updateNavForAuth(user) {
    const logoutBtn = document.getElementById('logoutBtn');
    const navLinks = document.querySelectorAll('.nav-link[data-route]');
    const navLoginLink = document.getElementById('navLoginLink');
    const navRegisterLink = document.getElementById('navRegisterLink');

    if (user) {
        // Show logout button
        if (logoutBtn) logoutBtn.style.display = 'block';

        // Hide auth links
        if (navLoginLink) navLoginLink.style.display = 'none';
        if (navRegisterLink) navRegisterLink.style.display = 'none';

        // Show permitted navigation links
        const permissions = window.getCurrentPermissions?.();
        navLinks.forEach(link => {
            const route = link.getAttribute('data-route');
            const hasAccess = permissions?.tabs?.[route]?.access ?? true;
            link.style.display = hasAccess ? '' : 'none';
        });
    } else {
        // Hide logout button
        if (logoutBtn) logoutBtn.style.display = 'none';

        // Show auth links (SEC-04)
        if (navLoginLink) navLoginLink.style.display = '';
        if (navRegisterLink) navRegisterLink.style.display = '';

        // Hide all main navigation links
        navLinks.forEach(link => {
            link.style.display = 'none';
        });
    }
}
```

**Result:**
- Clean navigation for unauthenticated users
- Clear call-to-action (Login/Register)
- Better UX

---

## Part 2: Minimum 2 Super Admins Requirement

### Current State

**File:** `app/views/user-management.js:882-911`
**Function:** `handleDeactivateUser(userId)`

**Current check:**
```javascript
if (user.role === 'super_admin') {
    const activeSuperAdminCount = countActiveSuperAdmins();

    if (activeSuperAdminCount <= 1) {
        showErrorModal(
            'Cannot Deactivate Last Super Admin',
            'Cannot deactivate the last Super Admin account...'
        );
        return;
    }
}
```

**Problem:**
- Allows system to have only 1 active Super Admin
- Single point of failure
- No redundancy if that account is compromised/unavailable

---

### Implementation: Require Minimum 2 Super Admins

#### Step 1: Update Deactivation Check

**File:** `app/views/user-management.js`
**Location:** `handleDeactivateUser()` function

**Modified:**
```javascript
async function handleDeactivateUser(userId) {
    try {
        const user = allUsers.find(u => u.id === userId);
        if (!user) {
            showToast('User not found', 'error');
            return;
        }

        // SEC-05: Check if user is super_admin
        if (user.role === 'super_admin') {
            const activeSuperAdminCount = countActiveSuperAdmins();

            // SEC-05: Require minimum 2 active Super Admins (changed from 1)
            if (activeSuperAdminCount <= 2) {
                showErrorModal(
                    'Cannot Deactivate Super Admin',
                    'System requires at least 2 active Super Admin accounts. Please promote another user to Super Admin before deactivating this account.'
                );
                return;
            }
        }

        // Show deactivation confirmation modal
        await showDeactivationModal(user);
    } catch (error) {
        console.error('[UserManagement] Error in deactivation flow:', error);
        showToast('Error initiating deactivation', 'error');
    }
}
```

**Key change:** `<= 1` becomes `<= 2`

---

#### Step 2: Update Role Change Check

**File:** `app/views/user-management.js:1350-1394`
**Location:** `handleEditRole()` function

**Current:**
```javascript
// If changing away from super_admin, check if last Super Admin
if (user.role === 'super_admin' && newRole !== 'super_admin') {
    const activeSuperAdminCount = countActiveSuperAdmins();
    if (activeSuperAdminCount <= 1) {
        showErrorModal(
            'Cannot Change Role',
            'Cannot change role. This is the last Super Admin account.'
        );
        return;
    }
}
```

**Modified:**
```javascript
// SEC-05: If changing away from super_admin, check minimum requirement
if (user.role === 'super_admin' && newRole !== 'super_admin') {
    const activeSuperAdminCount = countActiveSuperAdmins();

    // SEC-05: Require minimum 2 active Super Admins (changed from 1)
    if (activeSuperAdminCount <= 2) {
        showErrorModal(
            'Cannot Change Role',
            'System requires at least 2 active Super Admin accounts. Please promote another user to Super Admin before changing this account\'s role.'
        );
        return;
    }
}
```

**Key change:** `<= 1` becomes `<= 2`

---

#### Step 3: Add Warning on User Approval

**Purpose:** Warn Super Admin when approving first Super Admin

**File:** `app/views/user-management.js`
**Location:** `confirmApproval()` function

**Add before approval:**
```javascript
async function confirmApproval() {
    try {
        if (!selectedUserForApproval) {
            showToast('No user selected', 'error');
            return;
        }

        const roleSelect = document.getElementById('approvalRoleSelect');
        const selectedRole = roleSelect?.value;

        if (!selectedRole) {
            showToast('Please select a role', 'error');
            return;
        }

        // SEC-05: Warn when approving first Super Admin
        if (selectedRole === 'super_admin') {
            const activeSuperAdminCount = countActiveSuperAdmins();

            if (activeSuperAdminCount === 1) {
                // Only 1 SA exists, approving this user will make 2 (good!)
                console.log('[UserManagement] Approving second Super Admin (recommended)');
            } else if (activeSuperAdminCount === 0) {
                // No SAs exist - this will be the first (risky but necessary)
                const confirmed = await showSimpleConfirmation(
                    'First Super Admin',
                    'You are about to create the first Super Admin account. <strong>Important:</strong> Create at least one more Super Admin to ensure redundancy.'
                );

                if (!confirmed) {
                    return;
                }
            }
        }

        // ... rest of approval logic ...
    } catch (error) {
        console.error('[UserManagement] Error approving user:', error);
        showToast('Failed to approve user', 'error');
    }
}
```

**Benefits:**
- Reminds admins to create redundant SA accounts
- Prevents forgetting about minimum requirement
- Educational moment

---

#### Step 4: Add Super Admin Count Badge

**Purpose:** Show current SA count in User Management UI

**File:** `app/views/user-management.js`
**Location:** `renderUsersTable()` function

**Add SA count display:**
```javascript
function renderUsersTable() {
    const container = document.getElementById('usersTableContainer');
    const badge = document.getElementById('allUsersBadge');

    if (!container) return;

    // Calculate Super Admin count (SEC-05)
    const activeSuperAdminCount = allUsers.filter(
        u => u.role === 'super_admin' && u.status === 'active'
    ).length;

    // Update badge
    if (badge) {
        badge.textContent = `${allUsers.length} users`;
        badge.style.background = '#e0f2fe';
        badge.style.color = '#0369a1';
        badge.style.border = '1px solid #0ea5e9';
    }

    // Add SA count info box (SEC-05)
    const saInfoBox = `
        <div class="info-box" style="margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 6px; ${
            activeSuperAdminCount >= 2
                ? 'background: #d1fae5; border: 1px solid #059669; color: #065f46;'
                : 'background: #fef3c7; border: 1px solid #f59e0b; color: #92400e;'
        }">
            ${activeSuperAdminCount >= 2 ? '✅' : '⚠️'}
            <strong>${activeSuperAdminCount} active Super Admin${activeSuperAdminCount === 1 ? '' : 's'}</strong>
            ${activeSuperAdminCount < 2 ? ' — Promote at least one more user to Super Admin for redundancy.' : ' — System has redundant Super Admin coverage.'}
        </div>
    `;

    // ... existing table rendering with saInfoBox prepended ...
}
```

**Result:**
- Visual indicator of SA count
- Green when >= 2 (good)
- Yellow when < 2 (warning)
- Reminds admins to maintain redundancy

---

## Testing Plan

### Test 1: Navigation Visibility - Unauthenticated
```
1. Open browser in incognito mode
2. Navigate to http://localhost:8000
3. Expected: Only Login/Register links visible in nav
4. Expected: No dashboard/projects/etc links visible
```

### Test 2: Navigation Visibility - Authenticated
```
1. Log in as Operations User
2. Expected: See only permitted tabs (Dashboard, Projects, MRF Form)
3. Expected: Login/Register links hidden
4. Expected: Logout button visible
```

### Test 3: Cannot Deactivate When Only 2 SAs
```
1. Ensure exactly 2 active Super Admins exist
2. Try to deactivate one of them
3. Expected: Error modal appears
4. Expected: Message mentions "at least 2 active Super Admin accounts"
5. Expected: Deactivation blocked
```

### Test 4: Can Deactivate When 3+ SAs
```
1. Create 3 active Super Admins
2. Try to deactivate one
3. Expected: Deactivation proceeds normally
4. Expected: 2 SAs remain
```

### Test 5: Cannot Change Role When Only 2 SAs
```
1. Ensure exactly 2 active Super Admins
2. Try to change one SA to different role
3. Expected: Error modal appears
4. Expected: Role change blocked
```

### Test 6: SA Count Badge Display
```
1. Go to User Management → All Users tab
2. Check info box above user table
3. Expected: Shows current SA count
4. Expected: Green if >= 2, yellow if < 2
```

---

## Files Changed

1. **app/auth.js**
   - Update `updateNavForAuth()` to hide nav links when unauthenticated
   - Show Login/Register links for unauthenticated users

2. **index.html** (optional)
   - Add auth links (Login/Register) to navbar
   - Add IDs for auth links

3. **app/views/user-management.js**
   - Update `handleDeactivateUser()`: minimum 2 SAs
   - Update `handleEditRole()`: minimum 2 SAs
   - Add warning in `confirmApproval()` for first SA
   - Add SA count badge in `renderUsersTable()`

---

## Edge Cases

### Case 1: System Has 0 Super Admins
**Scenario:** Database reset, no SAs exist
**Behavior:** First user approved as SA gets warning
**Handling:** Confirmation dialog reminds to create second SA
**Implemented:** Step 3

### Case 2: System Has 1 Super Admin
**Scenario:** Initial setup, only 1 SA
**Behavior:** Cannot deactivate or change role
**Handling:** Error message prompts to create second SA
**Implemented:** Steps 1 and 2

### Case 3: Concurrent Deactivation Attempts
**Scenario:** Two admins try to deactivate different SAs simultaneously
**Behavior:** First succeeds (if 3+ SAs), second blocks (if 2 remain)
**Handling:** Real-time `allUsers` array updated via Firestore listener
**No change needed:** Existing architecture handles this

---

## Security Impact

**Before:**
- 1 SA minimum allows single point of failure
- Unauthenticated users see navigation structure

**After:**
- 2 SA minimum ensures redundancy
- Unauthenticated users see minimal UI
- Reduced information disclosure

---

## UX Impact

**Before:**
- Confusing (nav links visible but non-functional)
- Unprofessional appearance

**After:**
- Clean navigation for unauthenticated users
- Clear call-to-action (Login/Register)
- Professional appearance
- Visual SA count indicator

---

## Rollback Plan

If issues arise:
1. Revert `updateNavForAuth()` to show all nav links
2. Change minimum SA back to 1 (`<= 1`)
3. Remove SA count badge
4. System returns to Plan 10-02 behavior

---

## Success Metrics

- [ ] Unauthenticated users see only Login/Register
- [ ] Authenticated users see permitted tabs
- [ ] Cannot deactivate SA when only 2 remain
- [ ] Cannot change SA role when only 2 remain
- [ ] SA count badge displays correctly
- [ ] All 6 test cases pass

---

## Next Steps

After Plan 10-03 complete:
- **Plan 10-04:** End-to-end verification and testing
- Final Phase 10 review and milestone completion
