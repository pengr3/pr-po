# Plan 10-04: End-to-End Verification & Security Audit

**Phase:** 10 - Route Protection & Session Security
**Requirements:** SEC-01 through SEC-06 (all)
**Dependencies:** Plans 10-01, 10-02, and 10-03 complete

---

## Goal

Comprehensively verify that Phase 10 route protection and session security implementation meets all success criteria, handles edge cases gracefully, and maintains backward compatibility with existing features.

---

## Success Criteria (from Roadmap)

**All must pass:**

1. âœ… **SEC-01:** Unauthenticated users are redirected to login page
2. âœ… **SEC-02:** System saves intended route and restores after successful login (deep link support)
3. âœ… **SEC-03:** Pending users cannot access main system (shown approval message)
4. âœ… **SEC-04:** Deactivated users are automatically logged out when status changes
5. âœ… **SEC-05:** System requires minimum 2 active Super Admin accounts
6. âœ… **SEC-06:** System prevents operations that would violate minimum Super Admin requirement

---

## Comprehensive Test Suite

### Category 1: Unauthenticated Access (SEC-01)

#### Test 1.1: Direct Access to Dashboard
```
Prerequisites: Not logged in
Steps:
1. Open browser in incognito mode
2. Navigate to http://localhost:8000/#/
3. Observe behavior

Expected Results:
- Initial loading indicator shown briefly (~100-200ms)
- Immediate redirect to #/login
- NO flash of dashboard content
- NO permission errors in console
- Login page displayed cleanly

Pass/Fail: [ ]
Notes:
```

#### Test 1.2: Direct Access to Protected Route
```
Prerequisites: Not logged in
Steps:
1. Navigate to http://localhost:8000/#/projects
2. Observe behavior

Expected Results:
- Immediate redirect to #/login
- No content flash
- sessionStorage contains 'intendedRoute' = '/projects'
- Clean redirect, no errors

Pass/Fail: [ ]
Notes:
```

#### Test 1.3: Public Routes Remain Accessible
```
Prerequisites: Not logged in
Steps:
1. Navigate to #/login
2. Navigate to #/register
3. Navigate to #/pending (if applicable)

Expected Results:
- All public routes load without redirect
- No authentication required
- Pages function normally

Pass/Fail: [ ]
Notes:
```

#### Test 1.4: Navigation Links Hidden
```
Prerequisites: Not logged in
Steps:
1. Navigate to #/login
2. Inspect navigation bar

Expected Results:
- Main nav links (Dashboard, Projects, etc.) are hidden
- Only Login/Register links visible (if implemented)
- Logout button hidden
- Clean, professional appearance

Pass/Fail: [ ]
Notes:
```

---

### Category 2: Deep Link Support (SEC-02)

#### Test 2.1: Deep Link to Project Detail
```
Prerequisites: Not logged in
Steps:
1. Navigate to http://localhost:8000/#/projects/detail/CLMC_001_2026001
2. Check sessionStorage for 'intendedRoute'
3. Log in with valid active user
4. Observe post-login navigation

Expected Results:
- Redirected to #/login
- sessionStorage has '/projects/detail/CLMC_001_2026001'
- After login, redirected to project detail (NOT home)
- Project detail page loads correctly
- sessionStorage 'intendedRoute' cleared after redirect

Pass/Fail: [ ]
Notes:
```

#### Test 2.2: Deep Link to Tabbed Route
```
Prerequisites: Not logged in
Steps:
1. Navigate to http://localhost:8000/#/procurement/suppliers
2. Log in as user with procurement access
3. Observe post-login state

Expected Results:
- Redirected to #/procurement/suppliers
- Procurement view loads
- 'suppliers' tab is active
- sessionStorage cleared

Pass/Fail: [ ]
Notes:
```

#### Test 2.3: Normal Login Without Intended Route
```
Prerequisites: Not logged in
Steps:
1. Navigate directly to #/login
2. Log in

Expected Results:
- No sessionStorage 'intendedRoute' saved
- After login, redirected to #/ (dashboard)
- Normal login flow preserved

Pass/Fail: [ ]
Notes:
```

#### Test 2.4: Intended Route Cleared on Logout
```
Prerequisites: Logged in
Steps:
1. Manually set sessionStorage.setItem('intendedRoute', '/test')
2. Log out
3. Check sessionStorage

Expected Results:
- 'intendedRoute' cleared from sessionStorage
- Clean logout
- No stale route data

Pass/Fail: [ ]
Notes:
```

---

### Category 3: Pending User Restrictions (SEC-03)

#### Test 3.1: Pending User Cannot Access Protected Routes
```
Prerequisites: Logged in as pending user
Steps:
1. Try to navigate to #/
2. Try to navigate to #/projects
3. Try to navigate to #/procurement

Expected Results:
- All attempts redirect to #/pending
- Cannot access any protected route
- Pending approval page displayed
- Clear message about status

Pass/Fail: [ ]
Notes:
```

#### Test 3.2: Pending User with Intended Route
```
Prerequisites: Not logged in
Steps:
1. Navigate to #/projects
2. Log in as pending user
3. Observe behavior

Expected Results:
- Redirected to #/pending
- sessionStorage preserves '/projects' as intended route
- Info message on pending page (optional)
- When approved, should redirect to '/projects'

Pass/Fail: [ ]
Notes:
```

#### Test 3.3: Pending User Can Access Pending Page
```
Prerequisites: Logged in as pending user
Steps:
1. Navigate to #/pending
2. Page should load normally

Expected Results:
- Pending page displays
- Shows approval status message
- No redirect loop
- Clean UX

Pass/Fail: [ ]
Notes:
```

---

### Category 4: Deactivated User Auto-Logout (SEC-04)

#### Test 4.1: Deactivation at Login
```
Prerequisites: User account is deactivated
Steps:
1. Attempt to log in with deactivated user credentials
2. Observe behavior

Expected Results:
- Login validation detects deactivated status
- Immediate sign out
- Error message on login page: "Your account has been deactivated..."
- User NEVER sees home page
- Stays on login page

Pass/Fail: [ ]
Notes:
```

#### Test 4.2: Real-Time Deactivation While Active
```
Prerequisites:
- User A logged in and viewing dashboard
- Super Admin logged in separate browser/tab

Steps:
1. Super Admin deactivates User A
2. Observe User A's session

Expected Results:
- User A immediately signed out (real-time listener)
- Alert modal appears: "Your account has been deactivated..."
- Redirected to #/login
- Cannot access system again

Pass/Fail: [ ]
Notes:
```

#### Test 4.3: Deactivated User Cannot Log Back In
```
Prerequisites: User account deactivated
Steps:
1. Try to log in
2. Observe behavior

Expected Results:
- Login appears to succeed with Firebase Auth
- Validation check detects deactivation
- Immediate sign out
- Error on login page
- No access granted

Pass/Fail: [ ]
Notes:
```

---

### Category 5: Minimum 2 Super Admins (SEC-05)

#### Test 5.1: Cannot Deactivate When Only 2 SAs
```
Prerequisites: Exactly 2 active Super Admins exist
Steps:
1. As Super Admin, go to User Management
2. Try to deactivate one of the 2 SAs
3. Observe result

Expected Results:
- Error modal appears
- Message: "System requires at least 2 active Super Admin accounts..."
- Deactivation blocked
- SA remains active

Pass/Fail: [ ]
Notes:
```

#### Test 5.2: Can Deactivate When 3+ SAs
```
Prerequisites: 3 or more active Super Admins exist
Steps:
1. Try to deactivate one SA
2. Complete deactivation

Expected Results:
- Deactivation proceeds normally
- Email confirmation required
- SA successfully deactivated
- At least 2 SAs remain

Pass/Fail: [ ]
Notes:
```

#### Test 5.3: Cannot Change Role When Only 2 SAs
```
Prerequisites: Exactly 2 active Super Admins
Steps:
1. Try to change one SA's role to 'operations_admin'
2. Observe result

Expected Results:
- Error modal appears
- Message about minimum 2 SAs
- Role change blocked
- SA role unchanged

Pass/Fail: [ ]
Notes:
```

#### Test 5.4: SA Count Badge Display
```
Prerequisites: Any number of SAs
Steps:
1. Go to User Management â†’ All Users tab
2. Check info box above table

Expected Results:
- Badge shows current active SA count
- Green background if >= 2
- Yellow background if < 2
- Clear messaging about redundancy

Pass/Fail: [ ]
Notes:
```

---

### Category 6: Super Admin Violation Prevention (SEC-06)

#### Test 6.1: First SA Creation Warning
```
Prerequisites: 0 active Super Admins (fresh system)
Steps:
1. Approve first user as Super Admin
2. Observe warnings

Expected Results:
- Confirmation dialog appears
- Warns about creating first SA
- Reminds to create second SA
- Approval proceeds after confirmation

Pass/Fail: [ ]
Notes:
```

#### Test 6.2: Concurrent Deactivation Prevention
```
Prerequisites: Exactly 3 active Super Admins
Steps:
1. Open 2 browser tabs as 2 different SAs
2. Both try to deactivate 2 different SAs simultaneously
3. Observe results

Expected Results:
- First deactivation succeeds (3 â†’ 2 SAs)
- Second deactivation blocks (would leave 1 SA)
- Real-time allUsers array prevents violation
- System maintains 2+ SAs

Pass/Fail: [ ]
Notes:
```

---

### Category 7: Backward Compatibility

#### Test 7.1: Existing Authentication Flow
```
Prerequisites: None
Steps:
1. Navigate to #/login
2. Enter valid credentials
3. Complete login

Expected Results:
- Login works exactly as before
- Auth observer triggers
- Permissions load
- Navigation updates
- No regressions

Pass/Fail: [ ]
Notes:
```

#### Test 7.2: Permission System Integration
```
Prerequisites: Logged in as various roles
Steps:
1. Test each role: Super Admin, Operations Admin, Operations User, Finance, Procurement
2. Verify tab visibility
3. Verify access control

Expected Results:
- Permission system works as Phase 6-9
- No changes to existing behavior
- Tab visibility correct
- Access control enforced

Pass/Fail: [ ]
Notes:
```

#### Test 7.3: Real-Time Role Changes
```
Prerequisites:
- User logged in one tab
- Admin in another tab

Steps:
1. Admin changes user's role
2. Observe user's tab

Expected Results:
- Navigation updates in real-time
- New permissions apply immediately
- No logout required
- Existing Phase 6 behavior preserved

Pass/Fail: [ ]
Notes:
```

#### Test 7.4: Project Assignment Filtering
```
Prerequisites: Operations User with project assignments
Steps:
1. Log in as Operations User
2. Check project list filtering
3. Check MRF form project dropdown

Expected Results:
- Only assigned projects visible
- Filtering works as Phase 7
- No regressions
- Deep link to project works if assigned

Pass/Fail: [ ]
Notes:
```

---

### Category 8: Edge Cases & Error Handling

#### Test 8.1: Invalid Route Handling
```
Prerequisites: Not logged in
Steps:
1. Navigate to #/invalid-route-12345
2. Observe behavior

Expected Results:
- Redirect to #/login (auth guard)
- Save '/invalid-route-12345' as intended
- After login, router handles invalid route
- Redirects to #/ (error handling)
- No crashes

Pass/Fail: [ ]
Notes:
```

#### Test 8.2: Browser Back Button After Login
```
Prerequisites: None
Steps:
1. Not logged in, navigate to #/projects
2. Redirected to #/login
3. Log in successfully
4. Redirected to #/projects
5. Click browser back button

Expected Results:
- Goes back to #/login
- Already authenticated, can click forward
- Or login page detects auth and redirects
- No broken state

Pass/Fail: [ ]
Notes:
```

#### Test 8.3: Multiple Tabs Same User
```
Prerequisites: None
Steps:
1. Open 2 tabs
2. Log in Tab 1
3. Tab 2 should detect auth state
4. Log out Tab 1
5. Tab 2 should detect sign out

Expected Results:
- Auth state syncs across tabs
- Both tabs respond to auth changes
- No conflicts
- sessionStorage is tab-specific (ok)

Pass/Fail: [ ]
Notes:
```

#### Test 8.4: Page Refresh Preserves Auth
```
Prerequisites: Logged in
Steps:
1. Navigate to #/projects
2. Refresh page (F5)
3. Observe behavior

Expected Results:
- Auth state restored from Firebase
- Same route maintained
- No redirect to login
- Existing Phase 5 behavior preserved

Pass/Fail: [ ]
Notes:
```

---

### Category 9: Security Audit

#### Test 9.1: Console Bypass Attempt
```
Prerequisites: Not logged in
Steps:
1. Open DevTools console
2. Try: window.location.hash = '#/'
3. Try: window.navigateTo('/')
4. Observe behavior

Expected Results:
- Router auth guard blocks navigation
- Immediate redirect to #/login
- Cannot bypass auth check
- Defense in depth works

Pass/Fail: [ ]
Notes:
```

#### Test 9.2: sessionStorage Manipulation
```
Prerequisites: Not logged in
Steps:
1. Set sessionStorage.setItem('intendedRoute', '#/role-config')
2. Log in as non-SA user
3. Observe behavior

Expected Results:
- Redirected to #/role-config
- Permission check blocks (access denied page)
- No privilege escalation
- Security rules enforce permissions

Pass/Fail: [ ]
Notes:
```

#### Test 9.3: Direct Firebase Auth Bypass
```
Prerequisites: Developer tools
Steps:
1. Sign in with Firebase Auth directly in console
2. Try to navigate without user document
3. Observe behavior

Expected Results:
- Auth observer detects missing user document
- Immediate sign out
- Redirect to #/login
- Cannot access system

Pass/Fail: [ ]
Notes:
```

---

### Category 10: Performance & UX

#### Test 10.1: Loading Time Measurement
```
Prerequisites: None
Steps:
1. Clear cache
2. Navigate to #/
3. Measure time to redirect

Expected Results:
- Redirect happens < 200ms
- Loading indicator smooth
- No janky UI
- Professional feel

Pass/Fail: [ ]
Notes:
```

#### Test 10.2: No Content Flash
```
Prerequisites: Not logged in
Steps:
1. Navigate to #/
2. Watch carefully for any content flash
3. Use slow 3G network throttling

Expected Results:
- Zero content flash even on slow network
- Clean loading experience
- No FOUC (Flash of Unstyled Content)

Pass/Fail: [ ]
Notes:
```

#### Test 10.3: Navigation Smoothness
```
Prerequisites: Logged in
Steps:
1. Click through various nav links rapidly
2. Use browser back/forward buttons
3. Observe smoothness

Expected Results:
- Navigation remains smooth
- No extra redirects
- Performance unchanged from Phase 9
- Good UX

Pass/Fail: [ ]
Notes:
```

---

## Success Metrics Summary

**Must achieve:**
- [ ] All 6 roadmap success criteria pass (SEC-01 through SEC-06)
- [ ] All 40+ test cases pass
- [ ] Zero regressions in existing features (Phases 5-9)
- [ ] No performance degradation
- [ ] No security vulnerabilities found in audit

**Quality bar:**
- **Critical tests:** 100% pass rate
- **Edge cases:** 95%+ pass rate
- **Performance:** No regression (< 5% difference)
- **Security:** All bypass attempts blocked

---

## Testing Procedure

### Phase 1: Automated Checks
```bash
# Run linter (if configured)
npm run lint

# Check for console errors in browser
# Manual: Open DevTools â†’ Console â†’ Run through test cases
```

### Phase 2: Manual Test Execution
1. Print this test plan
2. Execute each test case in order
3. Mark Pass/Fail and add notes
4. Document any failures with screenshots

### Phase 3: Edge Case Exploration
1. Try creative bypass attempts
2. Test unusual user flows
3. Multi-tab scenarios
4. Network conditions (slow 3G, offline)

### Phase 4: Security Review
1. Run all Category 9 tests
2. Attempt additional bypass methods
3. Review code for vulnerabilities
4. Check Firebase Security Rules alignment

---

## Bug Tracking

**For each failed test:**

1. **Test ID:** [e.g., Test 2.1]
2. **Description:** [What failed]
3. **Expected:** [What should happen]
4. **Actual:** [What actually happened]
5. **Screenshots:** [Attach if applicable]
6. **Console errors:** [Copy any errors]
7. **Severity:** Critical / High / Medium / Low
8. **Fix required:** Yes / No

---

## Sign-Off Checklist

Before marking Phase 10 complete:

- [ ] All critical path tests pass (Categories 1-6)
- [ ] Backward compatibility verified (Category 7)
- [ ] Edge cases handled (Category 8)
- [ ] Security audit pass (Category 9)
- [ ] Performance acceptable (Category 10)
- [ ] No critical or high severity bugs
- [ ] All code committed and pushed
- [ ] Documentation updated (CLAUDE.md if needed)
- [ ] Ready for v2.0 milestone completion

---

## Rollback Criteria

**Rollback to Phase 9 if:**
- 3+ critical bugs found
- Performance degrades >10%
- Security vulnerability discovered
- Backward compatibility broken

**Rollback process:**
1. Revert commits from Phase 10
2. Test Phase 9 still works
3. Investigate issues
4. Re-plan and re-implement

---

## Post-Verification Tasks

**After all tests pass:**

1. Update ROADMAP.md (mark Phase 10 complete)
2. Create Phase 10 verification summary document
3. Prepare for v2.0 milestone completion
4. Plan celebration! ðŸŽ‰

---

## Final Notes

**Important reminders:**
- Test thoroughly - security depends on this
- Don't rush - quality over speed
- Document everything - helps future debugging
- Ask for help if stuck

**Phase 10 is the final phase of v2.0!**
After this, the authentication and permissions system is complete and production-ready.
