# Plan 10-02: Deep Link Support & Intended Route Restoration

**Phase:** 10 - Route Protection & Session Security
**Requirements:** SEC-02
**Dependencies:** Plan 10-01 complete

---

## Goal

Save the user's intended route when redirected to login, then restore that route after successful authentication, enabling seamless deep linking and bookmarking.

---

## Success Criteria

1. ‚úÖ User accesses protected deep link while not logged in ‚Üí route is saved
2. ‚úÖ After successful login, user is redirected to saved route (not `/`)
3. ‚úÖ Deep links work: `#/projects/detail/CLMC_001_2026001`
4. ‚úÖ Tabbed routes preserved: `#/procurement/mrfs`
5. ‚úÖ Normal login flow (user goes to `/login` directly) ‚Üí redirects to `/`
6. ‚úÖ Saved route cleared after successful redirect

---

## User Story

**Scenario 1: Deep Link from Email**
```
1. User receives link via email: http://app.com/#/projects/detail/CLMC_001_2026001
2. User clicks link (not logged in)
3. System:
   - Saves intended route: '/projects/detail/CLMC_001_2026001'
   - Redirects to #/login
4. User enters credentials
5. Login succeeds
6. System:
   - Checks for saved route
   - Redirects to #/projects/detail/CLMC_001_2026001 (NOT #/)
   - Clears saved route
7. User sees project detail immediately
```

**Scenario 2: Bookmark**
```
1. User bookmarks #/finance/approvals
2. Later, opens bookmark (not logged in)
3. System saves '/finance/approvals' and redirects to login
4. After login, redirects to #/finance/approvals with 'approvals' tab active
```

**Scenario 3: Normal Login**
```
1. User navigates directly to #/login
2. No intended route to save
3. After login, redirects to #/ (default)
```

---

## Current Behavior

**File:** `app/router.js` (after Plan 10-01)
```javascript
// Auth guard redirects to login
if (!user) {
    console.warn('[Router] Unauthenticated access attempt:', path);
    window.location.hash = '#/login';
    return;
}
```

**Problem:**
- Intended route is lost during redirect
- After login, always goes to `#/`
- No way to restore user's context

---

## Implementation Plan

### Step 1: Save Intended Route Before Redirect

**File:** `app/router.js`
**Location:** Auth guard in `navigate()` function

**Add before redirect:**
```javascript
export async function navigate(path, tab = null, param = null) {
    // ... route validation ...

    // Authentication check for protected routes (SEC-01)
    if (!publicRoutes.includes(path)) {
        const user = window.getCurrentUser?.();

        if (!user) {
            // Save intended route for deep linking (SEC-02)
            const intendedRoute = buildRouteString(path, tab, param);
            console.log('[Router] Saving intended route:', intendedRoute);
            sessionStorage.setItem('intendedRoute', intendedRoute);

            // Redirect to login
            console.warn('[Router] Unauthenticated access attempt:', path);
            window.location.hash = '#/login';
            return;
        }

        // ... rest of auth checks ...
    }

    // ... rest of navigate function ...
}
```

**Helper function to build route string:**
```javascript
/**
 * Build route string from path, tab, and param
 * @param {string} path - Route path
 * @param {string} tab - Optional tab
 * @param {string} param - Optional parameter
 * @returns {string} Full route string (e.g., '/projects/detail/CLMC_001')
 */
function buildRouteString(path, tab, param) {
    let route = path;

    if (tab) {
        route += '/' + tab;
    }

    if (param) {
        route += '/' + param;
    }

    return route;
}
```

**Key points:**
- Uses `sessionStorage` (cleared when tab closes)
- Saves full route including tabs and params
- Only saves when redirecting unauthenticated user

---

### Step 2: Restore Intended Route After Login

**File:** `app/views/login.js`
**Location:** After successful authentication and validation

**Current (after Plan 10-01):**
```javascript
// Valid user - navigate to home
console.log('[Login] User validation passed, navigating...');
window.location.hash = '#/';
```

**Modified:**
```javascript
// Valid user - check for intended route (SEC-02)
const intendedRoute = sessionStorage.getItem('intendedRoute');

if (intendedRoute) {
    console.log('[Login] Restoring intended route:', intendedRoute);
    sessionStorage.removeItem('intendedRoute');
    window.location.hash = '#' + intendedRoute;
} else {
    console.log('[Login] No intended route, navigating to home');
    window.location.hash = '#/';
}
```

**Flow:**
1. Login succeeds
2. User document validated
3. Check sessionStorage for saved route
4. If found: redirect to saved route and clear storage
5. If not found: redirect to `/` (normal behavior)

---

### Step 3: Clear Intended Route on Successful Navigation

**Purpose:** Prevent stale routes from being restored multiple times

**File:** `app/router.js`
**Location:** End of `navigate()` function

**Add after successful navigation:**
```javascript
export async function navigate(path, tab = null, param = null) {
    // ... all existing navigation logic ...

    try {
        // ... load and render view ...

        // Store current view
        currentView = module;
        currentRoute = path;
        currentParam = param;

        // Update navigation
        updateNavigation(path);

        // Scroll to top
        window.scrollTo(0, 0);

        // Clear intended route if navigation succeeded (SEC-02)
        // This prevents re-restoring the route on subsequent logins
        const intendedRoute = sessionStorage.getItem('intendedRoute');
        if (intendedRoute && intendedRoute === buildRouteString(path, tab, param)) {
            console.log('[Router] Clearing fulfilled intended route');
            sessionStorage.removeItem('intendedRoute');
        }

        console.log('[Router] ‚úÖ Navigation complete:', { path, tab, isSameView });
    } catch (error) {
        // ... existing error handling ...
    }
}
```

**Rationale:**
- Route successfully loaded ‚Üí user got to intended destination
- Clear the saved route to prevent confusion
- Only clears if current route matches saved route

---

### Step 4: Handle Pending Users with Saved Routes

**Problem:** Pending users get redirected to `/pending`, but what if they had an intended route?

**Solution:** Save the intended route, but don't redirect yet

**File:** `app/auth.js`
**Location:** Status-based routing in `initAuthObserver()`

**Current:**
```javascript
if (userData.status === 'pending') {
    if (!currentHash.includes('/pending')) {
        console.log('[Auth] Pending user - redirecting to pending page');
        window.location.hash = '#/pending';
    }
}
```

**Modified:**
```javascript
if (userData.status === 'pending') {
    if (!currentHash.includes('/pending')) {
        console.log('[Auth] Pending user - redirecting to pending page');

        // Preserve intended route for after approval (SEC-02)
        // If they become active, they'll be redirected to intended route
        const currentPath = window.location.hash.slice(1);
        if (currentPath && currentPath !== '/' && currentPath !== '/pending') {
            console.log('[Auth] Preserving intended route for pending user:', currentPath);
            sessionStorage.setItem('intendedRoute', currentPath);
        }

        window.location.hash = '#/pending';
    }
}
```

**Flow:**
1. Pending user tries to access `/projects`
2. Auth observer detects pending status
3. Saves `/projects` as intended route
4. Redirects to `/pending`
5. When user is approved (status ‚Üí active), they'll be redirected to `/projects`

---

### Step 5: Add Intended Route Info to Pending Page

**File:** `app/views/pending.js`
**Enhancement:** Show user where they'll be redirected after approval

**Add to pending page display:**
```javascript
export function render() {
    const user = window.getCurrentUser?.();
    const isRejected = user?.status === 'rejected';
    const intendedRoute = sessionStorage.getItem('intendedRoute');

    return `
        <div class="auth-container">
            <div class="auth-card">
                <!-- ... existing pending/rejected message ... -->

                ${intendedRoute && !isRejected ? `
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #e0f2fe; border: 1px solid #0ea5e9; border-radius: 6px;">
                        <p style="margin: 0; color: #0369a1; font-size: 0.875rem;">
                            üìç After approval, you'll be redirected to your intended page.
                        </p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}
```

**UX benefit:** User knows their intended route is saved

---

### Step 6: Handle Logout with Saved Route

**Problem:** User logs out, intended route might still be in sessionStorage

**Solution:** Clear intended route on logout

**File:** `app/auth.js`
**Location:** `handleLogout()` function

**Add before sign out:**
```javascript
export async function handleLogout() {
    console.log('[Auth] Logout requested');

    const confirmed = await showLogoutConfirmation();

    if (!confirmed) {
        console.log('[Auth] Logout cancelled');
        return;
    }

    try {
        // Clear any saved intended route (SEC-02)
        sessionStorage.removeItem('intendedRoute');

        await signOut(auth);
        console.log('[Auth] User signed out successfully');
        window.location.hash = '#/login';
    } catch (error) {
        console.error('[Auth] Error signing out:', error);
        alert('Error logging out. Please try again.');
    }
}
```

**Rationale:**
- User explicitly logged out
- Intended route no longer relevant
- Clean slate for next login

---

## Testing Plan

### Test 1: Deep Link to Project Detail
```
1. Not logged in
2. Navigate to: http://localhost:8000/#/projects/detail/CLMC_001_2026001
3. Expected: Redirect to #/login
4. Expected: sessionStorage has 'intendedRoute' = '/projects/detail/CLMC_001_2026001'
5. Log in with valid credentials
6. Expected: Redirect to #/projects/detail/CLMC_001_2026001
7. Expected: Project detail page loads correctly
8. Expected: sessionStorage 'intendedRoute' is cleared
```

### Test 2: Tabbed Route Restoration
```
1. Not logged in
2. Navigate to: http://localhost:8000/#/procurement/suppliers
3. Expected: Redirect to #/login, save '/procurement/suppliers'
4. Log in
5. Expected: Redirect to #/procurement/suppliers
6. Expected: Procurement view loads with 'suppliers' tab active
```

### Test 3: Normal Login (No Intended Route)
```
1. Navigate to #/login directly
2. Log in
3. Expected: Redirect to #/ (dashboard)
4. Expected: No intended route saved or restored
```

### Test 4: Pending User with Intended Route
```
1. Not logged in
2. Navigate to #/projects
3. Log in as pending user
4. Expected: Redirect to #/pending
5. Expected: sessionStorage has '/projects' saved
6. Admin approves user
7. Expected: After approval, redirect to #/projects
```

### Test 5: Logout Clears Intended Route
```
1. Set intended route in sessionStorage manually
2. Log in
3. Log out
4. Check sessionStorage
5. Expected: 'intendedRoute' is cleared
```

### Test 6: Invalid Intended Route
```
1. Not logged in
2. Navigate to #/invalid-route
3. Expected: Redirect to #/login
4. Expected: Save '/invalid-route'
5. Log in
6. Expected: Attempt to restore /invalid-route
7. Expected: Router handles invalid route ‚Üí redirect to #/
```

---

## Files Changed

1. **app/router.js**
   - Add `buildRouteString()` helper function
   - Save intended route before redirect in `navigate()`
   - Clear fulfilled intended route after successful navigation

2. **app/views/login.js**
   - Check for intended route after successful login
   - Restore route instead of defaulting to `/`
   - Clear intended route from sessionStorage

3. **app/auth.js**
   - Preserve intended route for pending users
   - Clear intended route on logout

4. **app/views/pending.js** (optional enhancement)
   - Show message about saved intended route

---

## Edge Cases

### Case 1: User Has Multiple Tabs Open
**Scenario:** Tab 1 saves route, Tab 2 logs in
**Behavior:** sessionStorage is tab-specific, no conflict
**Handling:** Works correctly by design

### Case 2: Session Expires While Viewing Page
**Scenario:** User on `/projects`, session expires
**Behavior:** Auth observer signs out, redirects to login
**Handling:** Save current route as intended route
**Implementation:** Add to auth observer deactivation handler

### Case 3: Route Requires Permissions User Doesn't Have
**Scenario:** User saved `/role-config`, but not Super Admin
**Behavior:** After login, redirected to `/role-config`, then access denied
**Handling:** Permission check in router shows access denied page
**No change needed:** Existing permission system handles this

### Case 4: Browser Back Button After Login
**Scenario:** Login ‚Üí redirect to intended route ‚Üí click back
**Behavior:** Goes back to login page
**Handling:** User is already authenticated, can click forward
**No change needed:** Standard browser behavior

---

## Security Considerations

### sessionStorage vs localStorage
**Choice:** sessionStorage
**Rationale:**
- Cleared when tab closes (no stale routes)
- Tab-specific (no cross-tab conflicts)
- Automatic cleanup

### Validation of Intended Route
**Current:** Router validates all routes
**Security:** Invalid routes handled by existing error handling
**No additional validation needed**

### XSS Prevention
**Concern:** Could intended route contain malicious script?
**Mitigation:** Hash routing doesn't execute scripts
**Additional:** Router validates route exists before loading
**Safe:** No XSS risk

---

## Performance Impact

- **sessionStorage read/write:** <1ms (synchronous)
- **No network calls added:** Uses existing sessionStorage API
- **Memory:** Negligible (single string value)
- **Net impact:** Zero performance change

---

## Rollback Plan

If issues arise:
1. Remove sessionStorage save from `router.js`
2. Remove sessionStorage restore from `login.js`
3. Remove sessionStorage clear from `auth.js` logout
4. System returns to Plan 10-01 behavior (always redirect to `/`)

---

## Success Metrics

- [ ] Deep links work end-to-end
- [ ] Tabbed routes preserved correctly
- [ ] Normal login still redirects to `/`
- [ ] Pending users' routes saved
- [ ] Logout clears saved routes
- [ ] All 6 test cases pass

---

## Next Steps

After Plan 10-02 complete:
- **Plan 10-03:** Navigation visibility + Super Admin minimum = 2
- **Plan 10-04:** End-to-end verification
