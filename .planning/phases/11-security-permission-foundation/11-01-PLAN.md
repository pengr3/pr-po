---
phase: 11-security-permission-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - firestore.rules
  - test/firestore.test.js
autonomous: true

must_haves:
  truths:
    - "Super Admin can view Clients tab without permission denied errors"
    - "Super Admin can create new client records"
    - "Operations Admin can view and create client records"
    - "Finance users can view but not create client records"
    - "Clients collection Security Rules tests pass in emulator"
  artifacts:
    - path: "firestore.rules"
      provides: "clients collection match block with role-based access"
      contains: "match /clients/{clientId}"
      min_lines: 12
    - path: "test/firestore.test.js"
      provides: "Test suite for clients collection access patterns"
      exports: ["describe('clients collection - super admin access')"]
      min_lines: 80
  key_links:
    - from: "app/views/clients.js"
      to: "firestore.rules clients collection block"
      via: "Firestore queries validated by Security Rules"
      pattern: "collection\\(db, 'clients'\\)"
    - from: "firestore.rules clients block"
      to: "helper functions (hasRole, isActiveUser)"
      via: "Role-based permission checks"
      pattern: "hasRole\\(\\['super_admin'|isActiveUser\\(\\)"
---

<objective>
Add Security Rules for the clients collection to enable Super Admin and Operations Admin access without permission denied errors.

Purpose: Fix critical bug where Clients tab is completely inaccessible due to missing Security Rules, blocking core workflow for SEC-01 and SEC-02 requirements.

Output:
- firestore.rules with clients collection match block
- Test suite verifying admin access patterns
- Deployed rules to production Firestore
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\REQUIREMENTS.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\11-security-permission-foundation\11-RESEARCH.md

# Prior phase context
@C:\Users\franc\dev\projects\pr-po\.planning\phases\08-security-rules-enforcement\08-01-SUMMARY.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\01-clients-foundation\01-01-SUMMARY.md

# Relevant source files
@C:\Users\franc\dev\projects\pr-po\firestore.rules
@C:\Users\franc\dev\projects\pr-po\test\firestore.test.js
@C:\Users\franc\dev\projects\pr-po\app\views\clients.js
</context>

<tasks>

<task type="auto">
  <name>Add clients collection Security Rules</name>
  <files>firestore.rules</files>
  <action>
Add clients collection match block to firestore.rules after the projects collection block (after line 126).

Follow the exact pattern from projects collection (lines 114-126):
- Read access: All active users via isActiveUser()
- Create access: hasRole(['super_admin', 'operations_admin'])
- Update access: hasRole(['super_admin', 'operations_admin'])
- Delete access: hasRole(['super_admin', 'operations_admin'])

Add section header comment "// clients collection" and use identical structure to projects block.

WHY this approach: The clients collection was created in Phase 1 but Security Rules added in Phase 8 did not include it. Without explicit rules, Firestore defaults to deny-all, causing permission-denied errors even for Super Admin. The projects collection pattern is the correct template because clients and projects have the same access requirements (all users read, admin roles write).
  </action>
  <verify>
1. Confirm clients collection block exists: `grep -A 12 "match /clients" firestore.rules`
2. Verify includes super_admin in all write operations: `grep -A 12 "match /clients" firestore.rules | grep super_admin`
3. Firebase CLI validates syntax: `firebase deploy --only firestore:rules --dry-run`
  </verify>
  <done>
- clients collection match block exists in firestore.rules
- All allow statements include appropriate roles (super_admin, operations_admin)
- Firebase CLI validation passes without syntax errors
  </done>
</task>

<task type="auto">
  <name>Add test suite for clients collection access</name>
  <files>test/firestore.test.js</files>
  <action>
Add comprehensive test suite for clients collection Security Rules to test/firestore.test.js.

Follow the test pattern from 11-RESEARCH.md "Test Suite Additions for Phase 11" section (lines 419-506).

Test cases to implement:
1. super_admin can read clients (getDoc)
2. super_admin can list clients (getDocs)
3. super_admin can create client
4. super_admin can update client
5. super_admin can delete client
6. operations_admin can read clients
7. operations_admin can create client
8. finance CANNOT create client (should fail)

Use existing seedUsers() pattern from test file. Seed test client data with:
- client_code: "TEST"
- company_name: "Test Company"
- contact_person: "John Doe"
- contact_details: "john@test.com"
- created_at: ISO timestamp

WHY this approach: Test suite prevents regression and validates that the fix actually works. The 8 test cases cover all CRUD operations for both admin roles (super_admin, operations_admin) and verify non-admin roles are blocked. Uses existing test infrastructure from Phase 8 (emulator, assertSucceeds/assertFails).
  </action>
  <verify>
1. Start Firestore emulator: `firebase emulators:start --only firestore` (background)
2. Run clients collection tests: `npx mocha test/firestore.test.js --grep "clients collection" --exit`
3. All tests pass (8 passing)
  </verify>
  <done>
- Test suite added to test/firestore.test.js with 8 test cases
- All tests pass when run against emulator
- Both super_admin and operations_admin access verified
- Finance role correctly blocked from write operations
  </done>
</task>

<task type="auto">
  <name>Deploy Security Rules to production</name>
  <files>firestore.rules</files>
  <action>
Deploy updated Security Rules to production Firestore and verify deployment.

Steps:
1. Deploy rules: `firebase deploy --only firestore:rules`
2. Verify deployment timestamp in Firebase console output
3. Confirm no deployment errors

WHY this approach: Security Rules changes only take effect after deployment. The --only firestore:rules flag ensures we don't accidentally deploy other Firebase services. Verification step confirms the new rules are active in production.

IMPORTANT: This writes to production Firestore. The changes are additive (adding missing rules) and tested via emulator, so low risk.
  </action>
  <verify>
1. Check Firebase CLI output for successful deployment message
2. Verify rules version updated: `firebase firestore:rules get`
3. Test in browser: Navigate to Clients tab as Super Admin user, confirm no permission denied errors
  </verify>
  <done>
- Firebase Security Rules deployed successfully
- Clients tab accessible without permission denied errors
- Super Admin can view and create clients in production
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
1. `grep -A 12 "match /clients" firestore.rules` shows complete clients collection block
2. `npx mocha test/firestore.test.js --grep "clients collection" --exit` passes all tests
3. `firebase firestore:rules get` shows recent deployment timestamp

**Manual verification:**
1. Log in as Super Admin user
2. Navigate to Clients tab (#/clients)
3. Verify no permission denied errors in browser console
4. Create a new test client record
5. Confirm client appears in list without errors
</verification>

<success_criteria>
**Observable outcomes (from ROADMAP.md success criteria):**
- [ ] SEC-01: Super Admin can access Clients tab without permission denied errors
- [ ] SEC-02 (partial): Super Admin can access Projects tab (already works, verified by existing rules)
- [ ] SEC-03: Super Admin has proper permission structure via Security Rules

**Artifacts produced:**
- firestore.rules contains clients collection match block
- test/firestore.test.js contains 8 passing test cases for clients collection
- Firebase production rules updated (verified by deployment timestamp)

**System state changes:**
- Clients tab becomes functional for Super Admin and Operations Admin
- Permission denied errors eliminated from Clients view
- Security Rules coverage complete for all collections used in v1.0-v2.0
</success_criteria>

<output>
After completion, create `.planning/phases/11-security-permission-foundation/11-01-SUMMARY.md` following the summary template.

Document:
- Rules added (clients collection block structure)
- Test coverage (8 test cases for admin access patterns)
- Deployment verification steps
- Any issues encountered during deployment
</output>
