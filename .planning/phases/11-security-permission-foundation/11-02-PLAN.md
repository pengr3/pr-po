---
phase: 11-security-permission-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/project-assignments.js
  - test/firestore.test.js
autonomous: true

must_haves:
  truths:
    - "Operations Admin role appears in project assignments user dropdown"
    - "Operations Admin assigned to project sees it in filtered project lists"
    - "Super Admin can assign Operations Admin users to projects"
    - "Operations Admin assignments persist and load on page refresh"
    - "Security Rules tests pass for Operations Admin assignment scenarios"
  artifacts:
    - path: "app/views/project-assignments.js"
      provides: "User query including both operations_user and operations_admin"
      contains: "where('role', 'in', ['operations_user', 'operations_admin'])"
      min_lines: 5
    - path: "test/firestore.test.js"
      provides: "Test suite for Operations Admin assignment scenarios"
      exports: ["describe('operations_admin project assignments')"]
      min_lines: 60
  key_links:
    - from: "app/views/project-assignments.js"
      to: "users collection query"
      via: "Firestore where clause with role filter"
      pattern: "where\\('role'.*operations"
    - from: "test/firestore.test.js"
      to: "firestore.rules users collection"
      via: "Assignment update permissions"
      pattern: "updateDoc.*assigned_project_codes"
---

<objective>
Enable Operations Admin role to receive project assignments in the assignment admin UI.

Purpose: Fix artificial restriction where Operations Admin cannot be assigned to projects despite the data model supporting any role having assignments. This resolves SEC-04 requirement.

Output:
- project-assignments.js querying both operations_user and operations_admin roles
- Test suite verifying Operations Admin can receive and use assignments
- Operations Admin users visible in assignment admin dropdown
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\REQUIREMENTS.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\11-security-permission-foundation\11-RESEARCH.md

# Prior phase context
@C:\Users\franc\dev\projects\pr-po\.planning\phases\07-project-assignment-system\07-01-SUMMARY.md

# Relevant source files
@C:\Users\franc\dev\projects\pr-po\app\views\project-assignments.js
@C:\Users\franc\dev\projects\pr-po\test\firestore.test.js
@C:\Users\franc\dev\projects\pr-po\firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Update project-assignments query to include operations_admin</name>
  <files>app/views/project-assignments.js</files>
  <action>
Modify the user query in project-assignments.js to include operations_admin role in addition to operations_user.

Current code (line 75):
```javascript
const usersQuery = query(collection(db, 'users'), where('role', '==', 'operations_user'));
```

Replace with:
```javascript
const usersQuery = query(
  collection(db, 'users'),
  where('role', 'in', ['operations_user', 'operations_admin'])
);
```

WHY this change: The data model (assigned_project_codes array on user documents) supports any role having project assignments. Phase 7 initially designed this for operations_user only, but v2.1 requirements (SEC-04) extend it to operations_admin for distributed management. The UI artificially restricts the dropdown to operations_user; removing this restriction allows the existing assignment system to work for operations_admin without any other code changes.

WHY 'in' operator: Firestore where clause with 'in' supports filtering by multiple values in a single query. This is more efficient than client-side filtering and follows Firestore query best practices.
  </action>
  <verify>
1. Confirm query uses 'in' operator: `grep "where('role', 'in'" app/views/project-assignments.js`
2. Verify includes both roles: `grep "operations_user.*operations_admin" app/views/project-assignments.js`
3. Start dev server and navigate to User Management → Project Assignments as Super Admin
4. Verify dropdown shows both operations_user AND operations_admin users
  </verify>
  <done>
- project-assignments.js query updated to include operations_admin
- User dropdown in assignment UI displays both operations_user and operations_admin roles
- No JavaScript errors in browser console during assignment operations
  </done>
</task>

<task type="auto">
  <name>Add test suite for Operations Admin assignments</name>
  <files>test/firestore.test.js</files>
  <action>
Add comprehensive test suite for Operations Admin project assignment scenarios to test/firestore.test.js.

Follow the test pattern from 11-RESEARCH.md "Test Suite: Operations Admin Assignments" section (lines 511-577).

Test cases to implement:
1. Seed ops-admin-assigned user with assigned_project_codes: ["CLMC_TEST_2026001"]
2. Seed ops-admin-all user with all_projects: true
3. Seed assigned-project and other-project test data
4. Test: operations_admin with assigned_project_codes can read assigned project
5. Test: operations_admin with all_projects=true can read any project
6. Test: super_admin can update user assignments (add operations_admin to assigned_project_codes)

Use testEnv.withSecurityRulesDisabled() for seeding (bypasses rules for test setup).
Use assertSucceeds/assertFails for permission validation.

WHY this approach: These tests verify the complete assignment workflow for operations_admin: receiving assignments (Super Admin updates user doc), reading assigned projects (Security Rules enforce scoping), and all_projects flag behavior. The tests use the same infrastructure as Phase 8, ensuring consistency and preventing regressions.
  </action>
  <verify>
1. Start Firestore emulator: `firebase emulators:start --only firestore` (background)
2. Run operations_admin assignment tests: `npx mocha test/firestore.test.js --grep "operations_admin project assignments" --exit`
3. All tests pass (3 passing)
  </verify>
  <done>
- Test suite added to test/firestore.test.js with 3 test cases
- All tests pass when run against emulator
- Operations Admin assignment scenarios verified (assigned projects, all_projects flag)
- Super Admin assignment update permissions confirmed
  </done>
</task>

</tasks>

<verification>
**Automated checks:**
1. `grep "where('role', 'in'" app/views/project-assignments.js` shows updated query
2. `npx mocha test/firestore.test.js --grep "operations_admin project assignments" --exit` passes all tests

**Manual verification:**
1. Log in as Super Admin
2. Navigate to User Management → Project Assignments tab
3. Click "Assign to User" button
4. Verify dropdown includes operations_admin users (not just operations_user)
5. Assign an operations_admin user to a test project
6. Verify assignment saves successfully
7. Log in as that operations_admin user
8. Navigate to Projects tab
9. Confirm assigned project appears in filtered list (if all_projects=false)
</verification>

<success_criteria>
**Observable outcomes (from ROADMAP.md success criteria):**
- [ ] SEC-04: Operations Admin role can receive project assignments (assignable by Super Admin or Operations Admin)

**Artifacts produced:**
- project-assignments.js contains updated query with 'in' operator for both roles
- test/firestore.test.js contains 3 passing test cases for operations_admin assignments
- Assignment UI dropdown displays operations_admin users

**System state changes:**
- Operations Admin users become assignable in project assignment workflow
- Operations Admin with assignments see filtered project lists (like operations_user)
- all_projects flag works for operations_admin (sees all projects when true)
</success_criteria>

<output>
After completion, create `.planning/phases/11-security-permission-foundation/11-02-SUMMARY.md` following the summary template.

Document:
- Query change (where 'in' operator usage)
- Test coverage (3 test cases for assignment scenarios)
- UI behavior verification (dropdown includes operations_admin)
- Any edge cases discovered during testing
</output>
