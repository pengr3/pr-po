---
phase: 20-multi-personnel-pill-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - styles/components.css
  - app/utils.js
autonomous: true

must_haves:
  truths:
    - "Pill/chip CSS classes render correctly when applied to HTML elements"
    - "normalizePersonnel() returns arrays from all three legacy data formats"
    - "normalizePersonnel() returns empty arrays for missing/null personnel data"
  artifacts:
    - path: "styles/components.css"
      provides: "Pill input container, pill chip, pill remove button, pill search input, pill dropdown styling"
      contains: ".pill-input-container"
    - path: "app/utils.js"
      provides: "normalizePersonnel read-time migration function"
      exports: ["normalizePersonnel"]
  key_links:
    - from: "styles/components.css"
      to: "app/views/projects.js"
      via: "CSS classes used in rendered HTML"
      pattern: "pill-input-container|personnel-pill|pill-remove|pill-search-input|pill-dropdown"
    - from: "app/utils.js"
      to: "app/views/projects.js"
      via: "import { normalizePersonnel }"
      pattern: "normalizePersonnel"
---

<objective>
Add pill/chip CSS styling and the shared normalizePersonnel() utility function that both views will use.

Purpose: Establish the visual foundation and data normalization layer before either view is modified. The CSS provides the pill container, chip, remove button, borderless search input, and dropdown styles. The utility function handles backward-compatible reading of three legacy personnel data formats (Phase 2 freetext, Phase 15 single-user, Phase 20 arrays).

Output: Updated styles/components.css with pill component CSS section; updated app/utils.js with exported normalizePersonnel function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-multi-personnel-pill-selection/20-RESEARCH.md
@styles/components.css
@styles/main.css
@app/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pill/chip CSS to components.css</name>
  <files>styles/components.css</files>
  <action>
  Append a new section at the end of styles/components.css (before the closing `}` of the `@media (max-width: 768px)` block if that is the last thing, or after it). Add the following CSS classes:

  **Section header:** `/* PILL/CHIP MULTI-SELECT */`

  **`.pill-input-container`** - The outer container styled to look like a form input:
  - `display: flex; flex-wrap: wrap; align-items: center; gap: 0.375rem`
  - `padding: 0.375rem 0.5rem`
  - `border: 1px solid var(--gray-300); border-radius: 4px`
  - `background: white; min-height: 38px` (matches existing input height)
  - `cursor: text; transition: all 0.2s`
  - `position: relative` (needed for absolutely-positioned dropdown)

  **`.pill-input-container:focus-within`** - Blue border + shadow on focus:
  - `border-color: var(--primary)`
  - `box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1)`

  **`.pill-input-container.disabled`** - Disabled/view-only state:
  - `background: var(--gray-100); cursor: default`

  **`.personnel-pill`** - Individual pill/chip element:
  - `display: inline-flex; align-items: center; gap: 0.25rem`
  - `padding: 0.125rem 0.5rem`
  - `background: #e8f0fe; color: var(--primary)`
  - `border-radius: 12px; font-size: 0.8125rem; font-weight: 500`
  - `white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis`

  **`.personnel-pill.legacy`** - Gray style for legacy freetext personnel (no user ID):
  - `background: var(--gray-100); color: var(--gray-700)`

  **`.pill-remove`** - The X button on each pill:
  - `display: inline-flex; align-items: center; justify-content: center`
  - `width: 16px; height: 16px; border: none; background: transparent`
  - `color: var(--primary); font-size: 0.875rem; cursor: pointer`
  - `padding: 0; line-height: 1; border-radius: 50%; flex-shrink: 0`

  **`.pill-remove:hover`** - Hover state:
  - `background: rgba(26, 115, 232, 0.2)`

  **`.personnel-pill.legacy .pill-remove`** - Legacy pill remove hover matches gray:
  - Override color to `var(--gray-700)`

  **`.personnel-pill.legacy .pill-remove:hover`**:
  - `background: rgba(0, 0, 0, 0.1)`

  **`.pill-search-input`** - The borderless text input inside the container:
  - `border: none !important; outline: none !important; box-shadow: none !important`
  - `padding: 0.25rem 0 !important; font-size: 0.875rem`
  - `flex: 1; min-width: 120px; background: transparent`

  **`.pill-dropdown`** - The filtered dropdown below the container:
  - `position: absolute; left: 0; right: 0; top: 100%`
  - `background: white; border: 1px solid var(--gray-300); border-top: none`
  - `border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto`
  - `z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1)`

  **`.pill-dropdown-item`** - Each item in the dropdown:
  - `padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem`

  **`.pill-dropdown-item:hover`** - Hover state:
  - `background: var(--gray-50)`

  Do NOT modify any existing CSS. Only append.
  </action>
  <verify>
  Open styles/components.css and verify:
  1. All pill classes are present at the end of the file
  2. No existing CSS was modified (diff shows only additions)
  3. The file still ends cleanly (no syntax errors, no unclosed braces)
  </verify>
  <done>All 11 pill CSS rules (.pill-input-container, :focus-within, .disabled, .personnel-pill, .personnel-pill.legacy, .pill-remove, .pill-remove:hover, .personnel-pill.legacy .pill-remove, .personnel-pill.legacy .pill-remove:hover, .pill-search-input, .pill-dropdown, .pill-dropdown-item, .pill-dropdown-item:hover) exist in components.css</done>
</task>

<task type="auto">
  <name>Task 2: Add normalizePersonnel utility function to utils.js</name>
  <files>app/utils.js</files>
  <action>
  Add an exported `normalizePersonnel` function to app/utils.js. Place it at the end of the file, before the final line (or at the very bottom).

  The function signature: `export function normalizePersonnel(project)`

  It accepts a project object (from Firestore) and returns `{ userIds: string[], names: string[] }`.

  Logic (in priority order):
  1. **Phase 20 array format**: If `project.personnel_user_ids` is a non-empty Array, return `{ userIds: project.personnel_user_ids, names: project.personnel_names || [] }`.
  2. **Phase 15 single-user format**: If `project.personnel_user_id` is truthy (string), return `{ userIds: [project.personnel_user_id], names: [project.personnel_name || ''] }`.
  3. **Phase 2 freetext format**: If `project.personnel` is truthy (string), return `{ userIds: [], names: [project.personnel] }`. Note: userIds is empty because freetext has no associated user ID.
  4. **Empty/missing**: Return `{ userIds: [], names: [] }`.

  Add a JSDoc comment block explaining the function, the four input formats, and the return type.

  Do NOT modify any existing functions. Only add this new export at the end.
  </action>
  <verify>
  1. Read app/utils.js and confirm normalizePersonnel is exported
  2. Verify the function handles all 4 cases described above by tracing logic manually
  3. Confirm no existing functions were modified (diff shows only additions)
  </verify>
  <done>normalizePersonnel() is exported from app/utils.js and correctly normalizes all three legacy formats plus empty state into { userIds: [], names: [] } structure</done>
</task>

</tasks>

<verification>
1. styles/components.css contains all `.pill-*` and `.personnel-pill` CSS classes
2. app/utils.js exports `normalizePersonnel` function
3. No existing code in either file was modified (only additions)
4. Both files parse without syntax errors
</verification>

<success_criteria>
- Pill CSS classes are ready for use by views in Plans 20-02 and 20-03
- normalizePersonnel() handles Phase 2 freetext, Phase 15 single-user, Phase 20 arrays, and empty states
- Both files remain backward compatible (no existing behavior changed)
</success_criteria>

<output>
After completion, create `.planning/phases/20-multi-personnel-pill-selection/20-01-SUMMARY.md`
</output>
