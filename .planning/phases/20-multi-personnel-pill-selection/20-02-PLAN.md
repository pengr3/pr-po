---
phase: 20-multi-personnel-pill-selection
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - app/views/projects.js
autonomous: true

must_haves:
  truths:
    - "Personnel field in project creation form shows a pill input container instead of a datalist input"
    - "Typing in the personnel field filters active users by name or email"
    - "Clicking a dropdown item adds a pill to the container"
    - "Clicking X on a pill removes it from the selection"
    - "Already-selected users are excluded from the dropdown"
    - "Creating a new project saves personnel_user_ids array and personnel_names array to Firestore"
    - "Editing an existing project populates pills from current personnel data (all legacy formats)"
    - "Saving an edited project writes array format and nulls legacy fields"
    - "Clicking outside the dropdown closes it"
  artifacts:
    - path: "app/views/projects.js"
      provides: "Multi-select pill personnel in create/edit form"
      contains: "pill-input-container"
  key_links:
    - from: "app/views/projects.js"
      to: "app/utils.js"
      via: "import { normalizePersonnel }"
      pattern: "normalizePersonnel"
    - from: "app/views/projects.js"
      to: "Firestore projects collection"
      via: "addDoc/updateDoc with personnel_user_ids and personnel_names arrays"
      pattern: "personnel_user_ids.*personnel_names"
---

<objective>
Replace the single-select HTML5 datalist personnel field in projects.js with a multi-select pill/chip input that supports adding multiple users, removing them with X buttons, and filtering by name or email.

Purpose: This is the primary UI transformation -- the create/edit form in the Projects view is where most personnel assignments happen. The form is shared between create and edit mode (same DOM element), so both paths must be updated.

Output: Updated app/views/projects.js with pill input component, dropdown filtering, add/remove handlers, and array-based Firestore save logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-multi-personnel-pill-selection/20-RESEARCH.md
@.planning/phases/20-multi-personnel-pill-selection/20-01-SUMMARY.md
@app/views/projects.js
@app/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace datalist with pill input in render() and add pill state management</name>
  <files>app/views/projects.js</files>
  <action>
  This task modifies app/views/projects.js to replace the single-select datalist personnel field with a multi-select pill input. All changes are in this single file.

  **1. Add import for normalizePersonnel:**
  Update the import from `../utils.js` (line 7) to include `normalizePersonnel`:
  ```javascript
  import { showLoading, showToast, generateProjectCode, normalizePersonnel } from '../utils.js';
  ```

  **2. Add module-level state for selected personnel:**
  Near the top (after `let editingProject = null;` around line 13), add:
  ```javascript
  let selectedPersonnel = []; // Array of { id: string, name: string } for pill state
  ```

  **3. Replace the personnel form group in render():**
  Find the form group around lines 150-155 containing:
  ```html
  <div class="form-group">
      <label>Personnel *</label>
      <input type="text" id="personnel" list="personnelUsersList" ...>
      <datalist id="personnelUsersList"></datalist>
      <small class="form-hint">Select an active user from the list. Required for new projects.</small>
  </div>
  ```
  Replace with:
  ```html
  <div class="form-group" style="position: relative;">
      <label>Personnel *</label>
      <div class="pill-input-container" id="personnelPillContainer"
           onclick="document.getElementById('personnelSearchInput')?.focus()">
          <input type="text"
                 class="pill-search-input"
                 id="personnelSearchInput"
                 placeholder="Type name or email..."
                 oninput="window.filterPersonnelDropdown(this.value)"
                 onfocus="window.showPersonnelDropdown()"
                 autocomplete="off">
      </div>
      <div class="pill-dropdown" id="personnelDropdown" style="display: none;"></div>
      <small class="form-hint">Select one or more active users. Required for new projects.</small>
  </div>
  ```
  Note: The pills are rendered dynamically by a `renderPills()` function, not in the static HTML template.

  **4. Add pill rendering function:**
  Add a new function `renderPills()` that updates the pill container DOM:
  ```javascript
  function renderPills() {
      const container = document.getElementById('personnelPillContainer');
      if (!container) return;

      const searchInput = document.getElementById('personnelSearchInput');
      const searchValue = searchInput?.value || '';

      // Build pills HTML from selectedPersonnel
      const pillsHtml = selectedPersonnel.map(user => `
          <span class="personnel-pill ${user.id ? '' : 'legacy'}" data-user-id="${user.id || ''}">
              ${user.name}
              <button type="button" class="pill-remove"
                  onmousedown="event.preventDefault(); window.removePersonnel('${user.id || ''}', '${user.name.replace(/'/g, "\\'")}')">&times;</button>
          </span>
      `).join('');

      // Replace container contents: pills + search input
      container.innerHTML = `
          ${pillsHtml}
          <input type="text"
                 class="pill-search-input"
                 id="personnelSearchInput"
                 placeholder="${selectedPersonnel.length === 0 ? 'Type name or email...' : ''}"
                 value="${searchValue}"
                 oninput="window.filterPersonnelDropdown(this.value)"
                 onfocus="window.showPersonnelDropdown()"
                 autocomplete="off">
      `;

      // Re-focus the search input if it was focused before
      const newSearchInput = document.getElementById('personnelSearchInput');
      if (document.activeElement === container || searchValue) {
          newSearchInput?.focus();
      }
  }
  ```

  **5. Add dropdown filter function:**
  Add `filterPersonnelDropdown(searchText)`:
  ```javascript
  function filterPersonnelDropdown(searchText) {
      const dropdown = document.getElementById('personnelDropdown');
      if (!dropdown) return;

      const term = searchText.toLowerCase().trim();
      const selectedIds = selectedPersonnel.map(u => u.id).filter(Boolean);

      // Filter: exclude already-selected, match name or email, require at least 1 char
      const matches = term ? usersData.filter(user =>
          !selectedIds.includes(user.id) &&
          (user.full_name.toLowerCase().includes(term) ||
           user.email.toLowerCase().includes(term))
      ) : [];

      if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
      }

      dropdown.innerHTML = matches.slice(0, 10).map(user => `
          <div class="pill-dropdown-item"
               onmousedown="event.preventDefault(); window.selectPersonnel('${user.id}', '${user.full_name.replace(/'/g, "\\'")}')">
              <strong>${user.full_name}</strong>
              <span style="color: #64748b; margin-left: 0.5rem;">${user.email}</span>
          </div>
      `).join('');

      dropdown.style.display = 'block';
  }
  ```
  CRITICAL: Use `onmousedown` with `event.preventDefault()` on dropdown items, not `onclick`. The input's blur fires before onclick, which would close the dropdown before the click registers. `onmousedown` fires before blur.

  **6. Add showPersonnelDropdown function:**
  ```javascript
  function showPersonnelDropdown() {
      const searchInput = document.getElementById('personnelSearchInput');
      if (searchInput?.value?.trim()) {
          filterPersonnelDropdown(searchInput.value);
      }
  }
  ```

  **7. Add selectPersonnel function:**
  ```javascript
  function selectPersonnel(userId, userName) {
      // Guard against duplicates
      if (selectedPersonnel.some(u => u.id === userId)) return;

      selectedPersonnel.push({ id: userId, name: userName });
      renderPills();

      // Clear search and close dropdown
      const searchInput = document.getElementById('personnelSearchInput');
      if (searchInput) {
          searchInput.value = '';
          searchInput.focus();
      }
      const dropdown = document.getElementById('personnelDropdown');
      if (dropdown) dropdown.style.display = 'none';
  }
  ```

  **8. Add removePersonnel function:**
  ```javascript
  function removePersonnel(userId, userName) {
      if (userId) {
          selectedPersonnel = selectedPersonnel.filter(u => u.id !== userId);
      } else {
          // Legacy freetext pill (no ID) - remove by name
          selectedPersonnel = selectedPersonnel.filter(u => u.name !== userName);
      }
      renderPills();
  }
  ```

  **9. Add click-outside handler:**
  Add a document click listener to close the dropdown when clicking outside. Set this up in `init()` and clean up in `destroy()`.

  In init(), after `attachWindowFunctions()`:
  ```javascript
  // Click-outside handler to close personnel dropdown
  const clickOutsideHandler = (e) => {
      const container = document.getElementById('personnelPillContainer');
      const dropdown = document.getElementById('personnelDropdown');
      if (dropdown && container && !container.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
      }
  };
  document.addEventListener('mousedown', clickOutsideHandler);
  window._personnelClickOutside = clickOutsideHandler;
  ```

  In destroy(), add cleanup:
  ```javascript
  if (window._personnelClickOutside) {
      document.removeEventListener('mousedown', window._personnelClickOutside);
      delete window._personnelClickOutside;
  }
  selectedPersonnel = [];
  ```

  **10. Register window functions in attachWindowFunctions():**
  Add these to the existing `attachWindowFunctions()` function:
  ```javascript
  window.selectPersonnel = selectPersonnel;
  window.removePersonnel = removePersonnel;
  window.filterPersonnelDropdown = filterPersonnelDropdown;
  window.showPersonnelDropdown = showPersonnelDropdown;
  ```

  And in destroy(), add cleanup for these:
  ```javascript
  delete window.selectPersonnel;
  delete window.removePersonnel;
  delete window.filterPersonnelDropdown;
  delete window.showPersonnelDropdown;
  ```

  **11. Update toggleAddProjectForm() for create mode:**
  In the form-clearing section (around line 456-463), replace:
  ```javascript
  document.getElementById('personnel').value = '';
  // Populate datalist
  populatePersonnelDatalist();
  ```
  With:
  ```javascript
  selectedPersonnel = [];
  renderPills();
  ```

  **12. Update editProject() to populate pills from existing data:**
  Replace line ~800 (`document.getElementById('personnel').value = project.personnel_name || project.personnel || '';`) with:
  ```javascript
  // Populate pills from existing personnel data (handles all legacy formats)
  const normalized = normalizePersonnel(project);
  selectedPersonnel = [];
  for (let i = 0; i < normalized.names.length; i++) {
      selectedPersonnel.push({
          id: normalized.userIds[i] || '',
          name: normalized.names[i]
      });
  }
  renderPills();
  ```

  **13. Update addProject() validation and save:**
  Replace the validation call (line ~507):
  ```javascript
  const selectedPersonnel2 = validatePersonnelSelection();
  if (!selectedPersonnel2) return;
  ```
  With a direct check on the module-level `selectedPersonnel` array:
  ```javascript
  if (selectedPersonnel.length === 0) {
      showToast('Personnel field is required - select at least one user', 'error');
      return;
  }
  ```

  In the `addDoc` call (around line 541-554), replace:
  ```javascript
  personnel_user_id: selectedPersonnel.id,
  personnel_name: selectedPersonnel.full_name,
  ```
  With:
  ```javascript
  personnel_user_ids: selectedPersonnel.map(u => u.id).filter(Boolean),
  personnel_names: selectedPersonnel.map(u => u.name),
  personnel_user_id: null,
  personnel_name: null,
  personnel: null,
  ```

  **14. Update saveEdit() personnel handling:**
  Replace the entire personnel handling block (lines ~826-854) which reads from `document.getElementById('personnel')` and does freetext/user matching. Replace with:
  ```javascript
  const personnelUpdate = {
      personnel_user_ids: selectedPersonnel.map(u => u.id).filter(Boolean),
      personnel_names: selectedPersonnel.map(u => u.name),
      personnel_user_id: null,
      personnel_name: null,
      personnel: null
  };
  ```
  The `selectedPersonnel` module state is already populated from the pill UI. No need to read from a text input or match against usersData.

  **15. Remove obsolete functions:**
  - Delete `populatePersonnelDatalist()` function (around lines 363-371) - no longer needed
  - Delete `validatePersonnelSelection()` function (around lines 373-395) - replaced by array length check
  - In `loadActiveUsers()`, remove the call to `populatePersonnelDatalist()` (around line 353). The onSnapshot callback should still load usersData but no longer needs to populate a datalist.

  **Key implementation notes:**
  - The create and edit forms share the SAME DOM element (`#addProjectForm`). The `selectedPersonnel` module-level array is the single source of truth for both modes.
  - Limit dropdown results to 10 items max (`.slice(0, 10)`) for performance with many users.
  - Use `onmousedown` with `event.preventDefault()` for dropdown items to prevent blur from closing the dropdown before the click registers.
  - Use `event.preventDefault()` on pill remove buttons too, for the same blur-interaction reason.
  </action>
  <verify>
  1. Start the dev server: `python -m http.server 8000` (or `npx http-server`)
  2. Navigate to #/projects
  3. Click "Add Project" -- verify pill input container appears instead of datalist
  4. Type a name -- verify dropdown filters users
  5. Click a dropdown item -- verify pill appears in container
  6. Add a second user -- verify first user is excluded from dropdown
  7. Click X on a pill -- verify it is removed
  8. Click outside dropdown -- verify it closes
  9. Fill all required fields and submit -- verify project is created
  10. Check Firestore: project has `personnel_user_ids` (array) and `personnel_names` (array), and legacy fields are null
  11. Click Edit on a project -- verify pills populate from existing data
  12. Save edit -- verify Firestore has array format and legacy fields are null
  </verify>
  <done>
  - Personnel field in project creation/edit form uses pill multi-select instead of datalist
  - Typing filters active users by name or email in custom dropdown
  - Clicking dropdown item adds a pill; clicking X removes it
  - Already-selected users excluded from dropdown
  - New projects save personnel_user_ids[] and personnel_names[] to Firestore
  - Edited projects populate pills from any legacy format via normalizePersonnel()
  - Legacy fields (personnel, personnel_user_id, personnel_name) are nulled on save
  - Click outside closes dropdown
  </done>
</task>

</tasks>

<verification>
1. Project creation with multiple personnel saves arrays to Firestore
2. Project editing loads personnel from all legacy formats and displays as pills
3. Saving edit writes array format and nulls legacy fields
4. Dropdown filtering works by name and email
5. Duplicate selection is prevented
6. Click outside closes dropdown
7. No JavaScript console errors during create/edit/save flows
</verification>

<success_criteria>
- The full create and edit flow works end-to-end with pill multi-select
- Firestore documents use personnel_user_ids[] and personnel_names[] arrays
- Legacy data formats are read correctly and migrated on edit
- No regressions in other Projects view functionality (table, filters, sort, pagination, delete, activate/deactivate)
</success_criteria>

<output>
After completion, create `.planning/phases/20-multi-personnel-pill-selection/20-02-SUMMARY.md`
</output>
