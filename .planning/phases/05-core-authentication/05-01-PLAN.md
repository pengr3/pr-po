---
phase: 05-core-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/firebase.js
  - app/auth.js
autonomous: true

must_haves:
  truths:
    - "Firebase Auth module is initialized and exports auth functions"
    - "Firestore user document structure is defined"
    - "Invitation code validation function exists"
  artifacts:
    - path: "app/firebase.js"
      provides: "Firebase Auth initialization and exports"
      contains: "getAuth"
    - path: "app/auth.js"
      provides: "Auth utilities and invitation code validation"
      exports: ["auth", "validateInvitationCode", "createUserDocument"]
  key_links:
    - from: "app/auth.js"
      to: "app/firebase.js"
      via: "import auth instance"
      pattern: "import.*from.*firebase"
---

<objective>
Set up Firebase Authentication foundation and create auth utility module with invitation code validation.

Purpose: Establish the authentication infrastructure that all subsequent auth features depend on.
Output: Firebase Auth initialized, auth.js module with core utilities, Firestore schema for users and invitation_codes documented.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-authentication/05-CONTEXT.md
@app/firebase.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firebase Auth to firebase.js</name>
  <files>app/firebase.js</files>
  <action>
    Extend the existing firebase.js to include Firebase Authentication:

    1. Add imports from Firebase Auth CDN (same version 10.7.1):
       - getAuth
       - createUserWithEmailAndPassword
       - signInWithEmailAndPassword
       - signOut
       - onAuthStateChanged
       - setPersistence
       - browserLocalPersistence

    2. Initialize auth with the existing app instance:
       ```javascript
       const auth = getAuth(app);
       ```

    3. Set persistence to browserLocalPersistence for 1-day sessions

    4. Export auth instance and auth methods

    5. Add to window object for backward compatibility (like existing Firestore exports)

    Keep all existing Firestore exports intact. Add Auth exports alongside them.
  </action>
  <verify>
    Open browser console and verify:
    - `window.auth` is defined
    - No console errors about Firebase initialization
    - Existing Firestore functionality still works
  </verify>
  <done>
    Firebase Auth is initialized alongside Firestore, exports available globally
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth.js utility module</name>
  <files>app/auth.js</files>
  <action>
    Create new auth utility module at app/auth.js:

    1. Import from firebase.js:
       - db, auth
       - Firestore methods (collection, doc, getDoc, setDoc, updateDoc, serverTimestamp)

    2. Create validateInvitationCode(code) function:
       - Query invitation_codes collection where code matches and status === 'active'
       - Return { valid: true, docId } if found and unused
       - Return { valid: false, error: 'Invalid or already used invitation code' } otherwise

    3. Create markInvitationCodeUsed(docId) function:
       - Update invitation_codes document: status = 'used', used_at = serverTimestamp(), used_by = userId

    4. Create createUserDocument(userId, data) function:
       - Create document in users collection with:
         - email (from data)
         - full_name (from data)
         - status: 'pending' (AUTH-04)
         - role: null (assigned during approval)
         - invitation_code: data.invitationCode
         - created_at: serverTimestamp()
         - updated_at: serverTimestamp()

    5. Create getUserDocument(userId) function:
       - Fetch user document from users collection
       - Return null if not found

    6. Export all functions

    7. Document Firestore schema in code comments:
       ```
       // users collection:
       // - email: string
       // - full_name: string
       // - status: 'pending' | 'active' | 'rejected' | 'deactivated'
       // - role: null | 'super_admin' | 'operations_admin' | 'operations_user' | 'finance' | 'procurement'
       // - invitation_code: string
       // - created_at: Timestamp
       // - updated_at: Timestamp

       // invitation_codes collection:
       // - code: string (unique)
       // - status: 'active' | 'used'
       // - created_at: Timestamp
       // - created_by: string (admin userId)
       // - used_at: Timestamp | null
       // - used_by: string | null (userId who used it)
       ```
  </action>
  <verify>
    - File exists at app/auth.js
    - Imports resolve correctly (no console errors when loaded)
    - Functions are exported and callable
  </verify>
  <done>
    Auth utility module with invitation code validation and user document management ready for registration flow
  </done>
</task>

</tasks>

<verification>
1. Open http://localhost:8000 in browser
2. Check console for any errors
3. Verify existing functionality (navigate to Home, Projects, etc.) still works
4. In console, verify `window.auth` is defined
5. Import auth.js in console and verify functions exist
</verification>

<success_criteria>
- Firebase Auth initialized without breaking existing Firestore functionality
- auth.js module created with validateInvitationCode, createUserDocument, getUserDocument
- Firestore schema documented in comments
- No console errors on page load
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-authentication/05-01-SUMMARY.md`
</output>
