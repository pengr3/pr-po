---
phase: 05-core-authentication
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - app/views/pending.js
  - app/router.js
  - index.html
  - app/auth.js
  - styles/views.css
autonomous: false

must_haves:
  truths:
    - "Pending users see awaiting approval page instead of main system"
    - "Pending page shows timeline estimate and logout button"
    - "User can manually check approval status"
    - "Logout button appears in header for authenticated users"
    - "Logout shows confirmation modal before signing out"
  artifacts:
    - path: "app/views/pending.js"
      provides: "Pending user approval page"
      exports: ["render", "init", "destroy"]
      min_lines: 80
    - path: "index.html"
      provides: "Logout button in navigation"
      contains: "logout"
  key_links:
    - from: "app/views/pending.js"
      to: "app/auth.js"
      via: "check user status and logout"
      pattern: "getCurrentUser|signOut"
    - from: "index.html"
      to: "app/auth.js"
      via: "logout handler"
      pattern: "handleLogout"
---

<objective>
Create pending user experience and integrate logout functionality into the application.

Purpose: Complete the authentication flow by handling pending users and enabling logout from anywhere.
Output: Pending approval page for new users, logout button in header with confirmation.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-authentication/05-CONTEXT.md
@.planning/phases/05-core-authentication/05-02-SUMMARY.md
@.planning/phases/05-core-authentication/05-03-SUMMARY.md
@app/router.js
@app/auth.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pending user view</name>
  <files>app/views/pending.js, styles/views.css</files>
  <action>
    Create app/views/pending.js for users awaiting approval:

    1. render() function returns approval waiting page:
       - Centered layout (use .auth-container)
       - CLMC logo at top
       - Title: "Account Pending Approval"
       - Message: "Your account is being reviewed by an administrator."
       - Timeline: "Approvals typically take 24-48 hours."
       - Status display area (shows current status)
       - "Check Status" button (secondary style)
       - "Log Out" button (outline/danger style)
       - NO navigation links to main system

    2. init() function:
       - Get current user data and display name/email
       - Set up checkStatus() handler
       - Set up logout handler

    3. checkStatus() function:
       - Show loading indicator
       - Re-fetch user document from Firestore
       - If status === 'active':
         - Show "Your account has been approved!" message
         - Redirect to #/ after 2 seconds
       - If status === 'rejected':
         - Show "Your registration was not approved. Please contact admin."
         - Show logout button only
       - If status === 'pending':
         - Show "Still pending approval" message
       - If status === 'deactivated':
         - Show "Your account has been deactivated. Please contact admin."
         - Log user out

    4. handleLogoutFromPending() function:
       - Call signOut from Firebase Auth
       - Redirect to #/login

    5. destroy() function:
       - Clean up handlers

    Add any needed CSS for status messages (success green, error red).
  </action>
  <verify>
    - Navigate to #/pending
    - Page displays with message, timeline, and buttons
    - Check Status button works (shows current status)
    - Logout button works (redirects to login)
  </verify>
  <done>
    Pending users have dedicated page with status checking and logout
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logout to navigation header</name>
  <files>index.html, app/auth.js</files>
  <action>
    Part A - Update index.html navigation:

    1. Add logout button to nav-links div (after Finance link):
       ```html
       <button id="logoutBtn" class="nav-logout-btn" onclick="handleLogout()" style="display: none;">
           Log Out
       </button>
       ```

    2. The button should be hidden by default (shown when authenticated)

    Part B - Add logout handler to app/auth.js:

    1. Add handleLogout() function:
       - Show confirmation modal: "Are you sure you want to log out?"
       - If confirmed:
         a. Call signOut(auth)
         b. Redirect to #/login
       - If cancelled: do nothing

    2. Add showLogoutConfirmation() helper:
       - Create modal dynamically (or reuse existing modal pattern if one exists)
       - Two buttons: "Cancel" and "Log Out"
       - Style consistent with existing CLMC modals

    3. Add updateNavForAuth(user) function:
       - If user: show logout button, optionally show user email/name
       - If no user: hide logout button

    4. Modify initAuthObserver() to call updateNavForAuth on state change

    5. Expose handleLogout to window for onclick handler:
       ```javascript
       window.handleLogout = handleLogout;
       ```

    Add CSS for .nav-logout-btn in styles/views.css:
    - Style as subtle button that fits nav aesthetic
    - Maybe right-aligned with some margin
  </action>
  <verify>
    - Login as any user
    - Logout button appears in header
    - Click logout -> confirmation modal appears
    - Confirm -> logged out, redirected to login
    - Logout button disappears when not authenticated
  </verify>
  <done>
    Logout button in header with confirmation modal
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pending route and update auth observer routing</name>
  <files>app/router.js, app/auth.js</files>
  <action>
    Part A - Add pending route to router.js:

    1. Add to routes object:
       ```javascript
       '/pending': {
           name: 'Pending Approval',
           load: () => import('./views/pending.js'),
           title: 'Pending Approval | CLMC Procurement'
       }
       ```

    Part B - Update auth observer for status-based routing:

    In app/auth.js, modify the auth state observer:

    1. When user signs in and user document is fetched:
       - If status === 'pending': redirect to #/pending
       - If status === 'rejected': redirect to #/pending (shows rejection message)
       - If status === 'deactivated': sign out and redirect to #/login
       - If status === 'active': allow normal navigation (don't force redirect)

    2. Add a helper isUserAllowed(status) that returns true only for 'active' users

    Note: Full route protection (preventing access to main app) is deferred to Phase 10.
    This phase just ensures pending users are directed to the pending page on login.
  </action>
  <verify>
    - Login as pending user -> automatically redirected to #/pending
    - Login as active user -> stays on home page
    - Manually navigate to #/pending as active user -> page loads (no block yet)
  </verify>
  <done>
    Pending users redirected to approval page on login
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 5 authentication flow:
    1. Registration with invitation code validation
    2. Login with session persistence
    3. Pending user experience with status checking
    4. Logout from navigation header with confirmation
  </what-built>
  <how-to-verify>
    Full flow test:

    1. Create invitation code in Firestore console:
       - Collection: invitation_codes
       - Add document: { code: 'VERIFYTEST', status: 'active', created_at: now }

    2. Test Registration:
       - Navigate to #/register?code=VERIFYTEST
       - Verify code is pre-filled and disabled
       - Fill: name, email, valid password
       - Submit -> should redirect to login
       - Check Firestore: users collection has pending user

    3. Test Pending State:
       - Login with the new account
       - Should redirect to #/pending
       - See "Account Pending Approval" message
       - Click "Check Status" -> shows "Still pending"
       - Click "Log Out" -> redirected to login

    4. Test Active User (manual):
       - In Firestore, change user status to 'active'
       - Login again
       - Should stay on home page (not redirected to pending)
       - Logout button visible in header
       - Click logout -> confirmation modal
       - Confirm -> logged out

    5. Test Session Persistence:
       - Login as active user
       - Refresh browser
       - Still logged in

    6. Test Rejection (manual):
       - Change user status to 'rejected'
       - Login -> goes to pending page
       - Click "Check Status" -> shows rejection message

    7. Test Deactivation (AUTH-09):
       - Login as active user
       - While logged in, change user status to 'deactivated' in Firestore
       - Verify: user is immediately logged out and redirected to login
       - Alert shows "Your account has been deactivated"
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All Phase 5 requirements verified:
- AUTH-01: User can self-register with email, password, invitation code, full name
- AUTH-02: Invalid/used invitation codes rejected
- AUTH-03: Invitation code marked as used after registration
- AUTH-04: New user starts with 'pending' status
- AUTH-05: User can login with email/password
- AUTH-06: Session persists across browser refresh
- AUTH-07: User can logout (from header or pending page)
- AUTH-08: Pending users see awaiting approval message
- AUTH-09: Deactivated users are automatically logged out when status changes (implemented in Plan 03)
</verification>

<success_criteria>
- Pending page shows approval message, timeline, status check, and logout
- Logout button in navigation header for authenticated users
- Logout shows confirmation modal
- Pending users automatically directed to pending page
- All AUTH-01 through AUTH-08 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-authentication/05-04-SUMMARY.md`
</output>
