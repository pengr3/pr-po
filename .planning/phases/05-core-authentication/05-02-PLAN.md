---
phase: 05-core-authentication
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/views/register.js
  - app/router.js
  - styles/views.css
autonomous: true

must_haves:
  truths:
    - "User can access registration page via #/register URL"
    - "Registration form validates all fields before submission"
    - "Invalid invitation code shows inline error"
    - "Successful registration creates pending user and redirects to login"
  artifacts:
    - path: "app/views/register.js"
      provides: "Registration view with form and validation"
      exports: ["render", "init", "destroy"]
      min_lines: 150
    - path: "app/router.js"
      provides: "Route to registration page"
      contains: "/register"
  key_links:
    - from: "app/views/register.js"
      to: "app/auth.js"
      via: "import validation and user creation"
      pattern: "import.*from.*auth"
    - from: "app/views/register.js"
      to: "firebase/auth"
      via: "createUserWithEmailAndPassword"
      pattern: "createUserWithEmailAndPassword"
---

<objective>
Create the registration flow where users can self-register with email, password, invitation code, and full name.

Purpose: Enable new users to create accounts that await Super Admin approval.
Output: Working registration page at #/register with full validation and Firebase Auth integration.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-core-authentication/05-CONTEXT.md
@.planning/phases/05-core-authentication/05-01-SUMMARY.md
@app/router.js
@app/auth.js
@styles/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create registration view</name>
  <files>app/views/register.js, styles/views.css</files>
  <action>
    Create app/views/register.js following existing view patterns:

    1. render() function returns registration form HTML:
       - Centered card layout (consistent with existing CLMC design)
       - CLMC logo at top
       - Title: "Create Account"
       - Form fields (all required):
         - Full Name (text input)
         - Email (email input)
         - Password (password input with requirements note: "8+ characters, mixed case, at least one number")
         - Invitation Code (text input, pre-filled from URL param if present, disabled if pre-filled)
       - Register button (primary style)
       - Link: "Already have an account? Log in" -> #/login
       - Error message area (hidden by default)

    2. Parse URL for invitation code on render:
       - Check window.location.hash for ?code= parameter
       - Format: #/register?code=ABC123
       - If code present, pre-fill and disable the invitation code field

    3. Add CSS to styles/views.css for auth pages:
       - .auth-container: centered, max-width 400px, vertical padding
       - .auth-card: white background, rounded corners, shadow, padding
       - .auth-logo: centered logo display
       - .auth-title: centered heading
       - .auth-form: form layout with spacing
       - .auth-field: form field wrapper
       - .auth-error: red error text, initially hidden
       - .auth-link: styled link text

    Match existing CLMC design language (colors from main.css variables).
  </action>
  <verify>
    - Navigate to #/register in browser
    - Form displays with all fields
    - UI matches existing CLMC styling
    - No console errors
  </verify>
  <done>
    Registration form renders with proper styling and layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement registration submission</name>
  <files>app/views/register.js</files>
  <action>
    Add init() function with form submission logic:

    1. init() function:
       - Get form element and add submit handler
       - Attach window functions for any onclick handlers

    2. handleRegister() function (called on form submit):
       - Prevent default form submission
       - Get values: fullName, email, password, invitationCode
       - Clear previous errors

       Client-side validation (AUTH-01 requirements from CONTEXT.md):
       - Full name: required, non-empty
       - Email: required, valid email format
       - Password: 8+ chars, at least one uppercase, one lowercase, one number
       - Invitation code: required, non-empty

       If validation fails:
       - Show inline errors below fields
       - Return early

       If validation passes:
       - Show loading state on button
       - Call validateInvitationCode(code) from auth.js (AUTH-02)
       - If invalid: show "Invalid or already used invitation code" error, stop
       - If valid:
         a. Create Firebase Auth user with createUserWithEmailAndPassword
         b. Create user document with createUserDocument (status: 'pending') (AUTH-04)
         c. Mark invitation code as used with markInvitationCodeUsed (AUTH-03)
         d. Sign out the user (they must manually log in per CONTEXT.md)
         e. Show success message: "Account created! Please log in."
         f. Redirect to #/login after 2 seconds

       Error handling:
       - Firebase auth errors: show raw Firebase error message (per CONTEXT.md)
       - Network errors: show "Network error. Please try again."

    3. destroy() function:
       - Clean up any event listeners
       - Remove window functions
  </action>
  <verify>
    Test registration flow:
    1. Submit empty form -> validation errors appear
    2. Submit with invalid password -> password validation error
    3. Submit with non-existent invitation code -> "Invalid or already used" error
    4. (Manual) Create test invitation_code in Firestore: { code: 'TEST123', status: 'active', created_at: Timestamp.now() }
    5. Submit with valid data -> account created, redirects to login
    6. Check Firestore: users collection has new pending user, invitation_codes status = 'used'
  </verify>
  <done>
    Registration creates pending user in Firestore, validates invitation codes, handles all error cases
  </done>
</task>

<task type="auto">
  <name>Task 3: Add registration route</name>
  <files>app/router.js</files>
  <action>
    Add registration route to router.js:

    1. Add to routes object:
       ```javascript
       '/register': {
           name: 'Register',
           load: () => import('./views/register.js'),
           title: 'Create Account | CLMC Procurement'
       }
       ```

    2. This route should be publicly accessible (no auth guard needed - that comes in Phase 10)
  </action>
  <verify>
    - Navigate to #/register
    - View loads without errors
    - Title updates to "Create Account | CLMC Procurement"
  </verify>
  <done>
    Registration route accessible via #/register
  </done>
</task>

</tasks>

<verification>
Complete registration flow test:
1. Create invitation code in Firestore console: invitation_codes collection, document with { code: 'TESTCODE', status: 'active', created_at: now }
2. Navigate to #/register?code=TESTCODE
3. Verify code is pre-filled and disabled
4. Fill in name, email, password (valid)
5. Submit
6. Verify: redirected to login, users collection has pending user, invitation_codes status is 'used'
7. Try registering with same code again -> "Invalid or already used" error
</verification>

<success_criteria>
- Registration page accessible at #/register
- Form validates all fields with inline errors
- Invitation code validated against Firestore
- Successful registration creates pending user
- Invitation code marked as used
- User redirected to login after registration
</success_criteria>

<output>
After completion, create `.planning/phases/05-core-authentication/05-02-SUMMARY.md`
</output>
