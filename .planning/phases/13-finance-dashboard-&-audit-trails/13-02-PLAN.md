# Phase 13, Plan 02: Supplier Purchase History Modal

---
phase: 13-finance-dashboard-&-audit-trails
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "Procurement user sees clickable supplier names in PR-PO Records tab"
    - "Clicking supplier name opens modal showing all purchases from that supplier"
    - "Modal displays total purchases amount and PO count"
    - "Modal shows purchase history table with PO details"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Supplier purchase history modal and aggregation logic"
      contains: "showSupplierPurchaseHistory"
      min_lines: 4750
  key_links:
    - from: "app/views/procurement.js"
      to: "firebase aggregation API"
      via: "import { getAggregateFromServer, sum, count } from '../firebase.js'"
      pattern: "getAggregateFromServer.*sum.*total_amount"
    - from: "app/views/procurement.js"
      to: "supplier click handler"
      via: "onclick in supplier name cells"
      pattern: "showSupplierPurchaseHistory\\("
    - from: "app/views/procurement.js"
      to: "pos collection query by supplier"
      via: "where('supplier_name', '==', supplierName)"
      pattern: "where\\('supplier_name'"
---

<objective>
Add supplier purchase history modal to PR-PO Records tab showing aggregated totals and detailed purchase list when clicking supplier names.

Purpose: Enables Procurement users to review all purchases from a supplier for vendor performance analysis and spending oversight.

Output: Clickable supplier names in PR-PO Records with modal displaying total purchases, PO count, and detailed purchase history.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\REQUIREMENTS.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\13-finance-dashboard-&-audit-trails\13-RESEARCH.md
@C:\Users\franc\dev\projects\pr-po\app\views\procurement.js
@C:\Users\franc\dev\projects\pr-po\CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aggregation import to procurement.js</name>
  <files>app/views/procurement.js</files>
  <action>
Add Firestore aggregation imports to procurement.js line 6 (after existing firebase imports):

Update the import from '../firebase.js' to include:
- getAggregateFromServer
- sum
- count

Follow existing import style (destructured import on line 6).
  </action>
  <verify>
```bash
grep "getAggregateFromServer" "C:\Users\franc\dev\projects\pr-po\app\views\procurement.js"
```
Should show import statement with getAggregateFromServer, sum, count.
  </verify>
  <done>procurement.js imports aggregation API for supplier totals calculation.</done>
</task>

<task type="auto">
  <name>Task 2: Add supplier purchase history modal and logic</name>
  <files>app/views/procurement.js</files>
  <action>
Add supplier purchase history modal to PR-PO Records tab following established procurement.js patterns:

**1. Find PR-PO Records tab rendering section (search for "<!-- PR-PO Records Section -->"):**

Locate the table rendering in renderPRPORecords() function that displays PR/PO data.

**2. Make supplier names clickable in renderPRPORecords():**

Find where supplier_name is displayed in the table cells. Modify to:
```javascript
<td>
    <a href="javascript:void(0)"
       onclick="window.showSupplierPurchaseHistory('${record.supplier_name}')"
       style="color: #1a73e8; text-decoration: none; cursor: pointer;">
        ${record.supplier_name}
    </a>
</td>
```

Apply to both PR rows and PO rows in the combined records table.

**3. Add supplier history modal HTML in render() function:**

Add after PR-PO Records section, before closing container div:

```html
<!-- Supplier Purchase History Modal -->
<div id="supplierHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="supplierHistoryModalTitle">Supplier Purchase History</h2>
            <button class="modal-close" onclick="window.closeSupplierHistoryModal()">&times;</button>
        </div>
        <div class="modal-body" id="supplierHistoryModalBody">
            <!-- Dynamically populated -->
        </div>
    </div>
</div>
```

**4. Add window functions in attachWindowFunctions() (after line 79):**
```javascript
window.showSupplierPurchaseHistory = showSupplierPurchaseHistory;
window.closeSupplierHistoryModal = closeSupplierHistoryModal;
```

**5. Implement showSupplierPurchaseHistory(supplierName) function (before destroy()):**

```javascript
async function showSupplierPurchaseHistory(supplierName) {
    showLoading(true);

    try {
        const q = query(
            collection(db, 'pos'),
            where('supplier_name', '==', supplierName),
            orderBy('date_issued', 'desc')
        );

        // Get aggregated totals
        const aggSnapshot = await getAggregateFromServer(q, {
            totalPurchases: sum('total_amount'),
            orderCount: count()
        });

        const totalPurchases = aggSnapshot.data().totalPurchases || 0;
        const orderCount = aggSnapshot.data().orderCount || 0;

        // Load PO details for table
        const posSnapshot = await getDocs(q);
        const pos = [];
        posSnapshot.forEach(doc => pos.push({ id: doc.id, ...doc.data() }));

        // Render modal content
        const modalContent = `
            <div class="modal-details-grid">
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Supplier:</div>
                    <div class="modal-detail-value"><strong>${supplierName}</strong></div>
                </div>
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Total Purchase Orders:</div>
                    <div class="modal-detail-value">${orderCount}</div>
                </div>
                <div class="modal-detail-item full-width">
                    <div class="modal-detail-label">Total Purchases:</div>
                    <div class="modal-detail-value">
                        <strong style="color: #059669; font-size: 1.5rem;">₱${formatCurrency(totalPurchases)}</strong>
                    </div>
                </div>
            </div>

            <h4 style="margin: 1.5rem 0 1rem; font-size: 1rem; font-weight: 600;">Purchase History</h4>
            <table class="modal-items-table">
                <thead>
                    <tr>
                        <th>PO ID</th>
                        <th>Project</th>
                        <th>Date Issued</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${pos.map(po => `
                        <tr>
                            <td><strong>${po.po_id}</strong></td>
                            <td>${po.project_code ? po.project_code + ' - ' : ''}${po.project_name || 'N/A'}</td>
                            <td>${formatDate(po.date_issued)}</td>
                            <td><strong>₱${formatCurrency(po.total_amount)}</strong></td>
                            <td><span style="background: #fef3c7; color: #f59e0b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${po.procurement_status}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        document.getElementById('supplierHistoryModalTitle').textContent = `Supplier Purchase History - ${supplierName}`;
        document.getElementById('supplierHistoryModalBody').innerHTML = modalContent;
        document.getElementById('supplierHistoryModal').classList.add('active');

    } catch (error) {
        console.error('[Procurement] Error loading supplier history:', error);
        showToast('Failed to load supplier purchase history', 'error');
    } finally {
        showLoading(false);
    }
}
```

**6. Implement closeSupplierHistoryModal() function:**
```javascript
function closeSupplierHistoryModal() {
    document.getElementById('supplierHistoryModal').classList.remove('active');
}
```

Follow established patterns:
- Use getAggregateFromServer for totals (not client-side reduce)
- Use modal-details-grid and modal-items-table classes (existing styles)
- Add console.log with [Procurement] prefix for debugging
- Handle null results: aggSnapshot.data().totalPurchases || 0
- Use formatCurrency() and formatDate() from utils.js
- Use showLoading() and showToast() for UX

DO NOT add ESC key handling (procurement.js doesn't have AbortController pattern yet - out of scope).
DO NOT modify existing modal structures (PO details, PR details, etc).
  </action>
  <verify>
Manual testing:
1. Navigate to Procurement > PR-PO Records tab
2. Load records with loadPRPORecords()
3. Click supplier name in table
4. Verify supplier history modal opens
5. Verify total purchases amount is correct
6. Verify purchase history table shows all POs for that supplier
7. Click close button (×), verify modal closes

Check console for [Procurement] logs and no errors.
  </verify>
  <done>
Procurement user can:
- See clickable supplier names (blue, underlined on hover)
- Click supplier name to open purchase history modal
- View aggregated total purchases and PO count
- See detailed purchase history table with all POs from that supplier
- Close modal with × button
  </done>
</task>

</tasks>

<verification>
**Functional verification:**
1. Procurement user clicks supplier name in PR-PO Records
2. Modal opens showing supplier name and totals
3. Total purchases matches sum of all POs from that supplier
4. Purchase history table shows all POs ordered by date (newest first)
5. Table displays: PO ID, Project, Date Issued, Amount, Status
6. Close button works

**Technical verification:**
- getAggregateFromServer used for totals (not loading all POs then reducing)
- Supplier names clickable via onclick with window.showSupplierPurchaseHistory
- Window functions attached in attachWindowFunctions()
- Modal follows existing procurement.js patterns (modal class, modal-content)
- Query uses where + orderBy correctly

**Edge cases:**
- Supplier with no POs shows ₱0.00 and 0 count
- Supplier with 100+ POs loads without performance issues (aggregation efficient)
- Projects without project_code show "N/A - Project Name"
</verification>

<success_criteria>
**Requirement PROC-01 satisfied when:**
- Procurement user sees clickable supplier names in PR-PO Records
- Clicking supplier opens modal with purchase history
- Modal shows total purchases (server-side aggregated)
- Modal shows all POs from that supplier in table
- Close button dismisses modal
</success_criteria>

<output>
After completion, create `.planning/phases/13-finance-dashboard-&-audit-trails/13-02-SUMMARY.md`
</output>
