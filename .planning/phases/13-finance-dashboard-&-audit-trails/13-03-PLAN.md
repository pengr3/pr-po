# Phase 13, Plan 03: Procurement Timeline Modal

---
phase: 13-finance-dashboard-&-audit-trails
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "Procurement user sees Timeline button in PR-PO Records tab for each MRF"
    - "Clicking Timeline button opens modal showing procurement audit trail"
    - "Timeline displays MRF ‚Üí PRs ‚Üí TRs ‚Üí POs ‚Üí Status flow"
    - "Timeline shows dates and statuses for each step"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Timeline modal using createTimeline component"
      contains: "showProcurementTimeline"
      min_lines: 4850
  key_links:
    - from: "app/views/procurement.js"
      to: "components.js createTimeline"
      via: "import { createTimeline } from '../components.js'"
      pattern: "createTimeline\\(timelineItems\\)"
    - from: "app/views/procurement.js"
      to: "Timeline button click handler"
      via: "onclick in PR-PO Records table"
      pattern: "showProcurementTimeline\\("
    - from: "app/views/procurement.js"
      to: "Multi-collection queries (mrfs, prs, transport_requests, pos)"
      via: "where('mrf_id', '==', mrfId)"
      pattern: "where\\('mrf_id'"
---

<objective>
Add Timeline button to PR-PO Records showing complete procurement audit trail (MRF ‚Üí PRs ‚Üí TRs ‚Üí POs ‚Üí Delivered) using existing createTimeline component.

Purpose: Provides Procurement users with visibility into the complete procurement workflow lifecycle for audit and progress tracking.

Output: Timeline button in PR-PO Records table that opens modal displaying chronological procurement events with status indicators.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\REQUIREMENTS.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\13-finance-dashboard-&-audit-trails\13-RESEARCH.md
@C:\Users\franc\dev\projects\pr-po\app\views\procurement.js
@C:\Users\franc\dev\projects\pr-po\app\components.js
@C:\Users\franc\dev\projects\pr-po\CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createTimeline import to procurement.js</name>
  <files>app/views/procurement.js</files>
  <action>
Add createTimeline to existing components.js import on line 8:

Update the import from '../components.js' to include:
- createTimeline

Current line 8:
```javascript
import { createStatusBadge, createModal, openModal, closeModal } from '../components.js';
```

Update to:
```javascript
import { createStatusBadge, createModal, openModal, closeModal, createTimeline } from '../components.js';
```
  </action>
  <verify>
```bash
grep "createTimeline" "C:\Users\franc\dev\projects\pr-po\app\views\procurement.js"
```
Should show import statement including createTimeline.
  </verify>
  <done>procurement.js imports createTimeline component for timeline rendering.</done>
</task>

<task type="auto">
  <name>Task 2: Add Timeline button and modal to PR-PO Records</name>
  <files>app/views/procurement.js</files>
  <action>
Add Timeline functionality to PR-PO Records tab following established procurement.js patterns:

**1. Add Timeline button to PR-PO Records table:**

Find renderPRPORecords() function that renders the combined PR/PO table.

In the table rendering, add a Timeline button column. Modify table headers to include:
```html
<th>Actions</th>
```

In the data rows, add Timeline button cell:
```html
<td>
    <button class="btn btn-sm btn-secondary"
            onclick="window.showProcurementTimeline('${record.mrf_id}')">
        üìÖ Timeline
    </button>
</td>
```

Add to both PR rows and PO rows (use record.mrf_id which exists in both).

**2. Add timeline modal HTML in render() function:**

Add after supplier history modal (or at end of PR-PO Records section):

```html
<!-- Procurement Timeline Modal -->
<div id="timelineModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="timelineModalTitle">Procurement Timeline</h2>
            <button class="modal-close" onclick="window.closeTimelineModal()">&times;</button>
        </div>
        <div class="modal-body" id="timelineModalBody">
            <!-- Dynamically populated with createTimeline() -->
        </div>
    </div>
</div>
```

**3. Add window functions in attachWindowFunctions() (after showSupplierPurchaseHistory):**
```javascript
window.showProcurementTimeline = showProcurementTimeline;
window.closeTimelineModal = closeTimelineModal;
```

**4. Implement showProcurementTimeline(mrfId) function (before destroy()):**

```javascript
async function showProcurementTimeline(mrfId) {
    showLoading(true);

    try {
        // Fetch MRF
        const mrfQuery = query(
            collection(db, 'mrfs'),
            where('mrf_id', '==', mrfId)
        );
        const mrfSnapshot = await getDocs(mrfQuery);

        if (mrfSnapshot.empty) {
            showToast('MRF not found', 'error');
            showLoading(false);
            return;
        }

        const mrf = { id: mrfSnapshot.docs[0].id, ...mrfSnapshot.docs[0].data() };

        // Fetch PRs
        const prsQuery = query(
            collection(db, 'prs'),
            where('mrf_id', '==', mrfId)
        );
        const prsSnapshot = await getDocs(prsQuery);
        const prs = [];
        prsSnapshot.forEach(doc => prs.push(doc.data()));

        // Fetch TRs
        const trsQuery = query(
            collection(db, 'transport_requests'),
            where('mrf_id', '==', mrfId)
        );
        const trsSnapshot = await getDocs(trsQuery);
        const trs = [];
        trsSnapshot.forEach(doc => trs.push(doc.data()));

        // Fetch POs
        const posQuery = query(
            collection(db, 'pos'),
            where('mrf_id', '==', mrfId),
            orderBy('date_issued', 'asc')
        );
        const posSnapshot = await getDocs(posQuery);
        const pos = [];
        posSnapshot.forEach(doc => pos.push(doc.data()));

        // Build timeline items array
        const timelineItems = [
            {
                title: `üìù MRF Created: ${mrf.mrf_id}`,
                date: formatDate(mrf.created_at),
                description: `Requestor: ${mrf.requestor_name} | Project: ${mrf.project_name || 'N/A'}`,
                status: 'completed'
            }
        ];

        // Add PRs
        prs.forEach(pr => {
            timelineItems.push({
                title: `üõí Purchase Request: ${pr.pr_id}`,
                date: formatDate(pr.date_generated),
                description: `Supplier: ${pr.supplier_name} | Amount: ‚Ç±${formatCurrency(pr.total_amount)}`,
                status: pr.finance_status === 'Approved' ? 'completed' :
                        pr.finance_status === 'Rejected' ? 'rejected' : 'pending'
            });
        });

        // Add TRs
        trs.forEach(tr => {
            timelineItems.push({
                title: `üöö Transport Request: ${tr.tr_id}`,
                date: formatDate(tr.date_submitted),
                description: `Amount: ‚Ç±${formatCurrency(tr.total_amount)}`,
                status: tr.finance_status === 'Approved' ? 'completed' :
                        tr.finance_status === 'Rejected' ? 'rejected' : 'pending'
            });
        });

        // Add POs
        pos.forEach(po => {
            timelineItems.push({
                title: `üìÑ Purchase Order: ${po.po_id}`,
                date: formatDate(po.date_issued),
                description: `Supplier: ${po.supplier_name} | Status: ${po.procurement_status}`,
                status: po.procurement_status === 'Delivered' ? 'completed' : 'active'
            });
        });

        // Render timeline using createTimeline component
        const timelineHtml = createTimeline(timelineItems);

        document.getElementById('timelineModalTitle').textContent = `Procurement Timeline - ${mrfId}`;
        document.getElementById('timelineModalBody').innerHTML = timelineHtml;
        document.getElementById('timelineModal').classList.add('active');

    } catch (error) {
        console.error('[Procurement] Error loading timeline:', error);
        showToast('Failed to load procurement timeline', 'error');
    } finally {
        showLoading(false);
    }
}
```

**5. Implement closeTimelineModal() function:**
```javascript
function closeTimelineModal() {
    document.getElementById('timelineModal').classList.remove('active');
}
```

Follow established patterns:
- Use createTimeline() from components.js (already imported)
- Query all related collections by mrf_id
- Map status values to timeline status classes (completed, pending, rejected, active)
- Use emoji icons for visual identification (üìù üìÑ üõí üöö)
- Add console.log with [Procurement] prefix for debugging
- Use formatDate() and formatCurrency() from utils.js
- Use showLoading() and showToast() for UX
- Handle empty collections gracefully (prs, trs, pos may be empty arrays)

Timeline status mapping:
- MRF: always 'completed' (created in past)
- PR/TR: 'completed' if Approved, 'rejected' if Rejected, 'pending' otherwise
- PO: 'completed' if Delivered, 'active' otherwise

DO NOT add ESC key handling (out of scope).
DO NOT modify createTimeline component (use as-is from components.js).
  </action>
  <verify>
Manual testing:
1. Navigate to Procurement > PR-PO Records tab
2. Load records with loadPRPORecords()
3. Click Timeline button (üìÖ Timeline) for any record
4. Verify timeline modal opens
5. Verify timeline shows MRF creation event
6. Verify timeline shows PRs (if any)
7. Verify timeline shows TRs (if any)
8. Verify timeline shows POs (if any)
9. Verify status indicators (completed = green, pending = yellow, active = blue)
10. Click close button (√ó), verify modal closes

Check console for [Procurement] logs and no errors.
  </verify>
  <done>
Procurement user can:
- See Timeline button (üìÖ Timeline) in PR-PO Records for each record
- Click Timeline button to open modal
- View chronological procurement audit trail (MRF ‚Üí PRs ‚Üí TRs ‚Üí POs)
- See dates, amounts, suppliers, and statuses for each step
- Identify workflow bottlenecks (pending approvals, rejected items)
- Close modal with √ó button
  </done>
</task>

</tasks>

<verification>
**Functional verification:**
1. Procurement user clicks Timeline button in PR-PO Records
2. Modal opens showing timeline for that MRF
3. Timeline displays events in chronological order
4. MRF creation shows requestor and project
5. PRs show supplier, amount, and approval status
6. TRs show amount and approval status
7. POs show supplier and procurement status
8. Status colors indicate workflow state (green = done, yellow = pending, blue = in progress)
9. Close button works

**Technical verification:**
- createTimeline() component used (not custom HTML)
- Timeline items array follows createTimeline API (title, date, description, status)
- Status mapping correct: Approved‚Üícompleted, Rejected‚Üírejected, Pending‚Üípending, Delivered‚Üícompleted
- Multiple collections queried efficiently (4 queries per timeline load)
- Window functions attached in attachWindowFunctions()
- Modal follows existing procurement.js patterns

**Edge cases:**
- MRF with no PRs/TRs/POs shows only MRF creation event
- Mixed supplier MRF shows multiple PRs in timeline
- Transport-only MRF shows TRs in timeline
- Old MRFs without project_name show "N/A"
- Timeline works for MRFs from any status (Pending, Approved, Rejected)
</verification>

<success_criteria>
**Requirement PROC-02 satisfied when:**
- Procurement user sees Timeline button in PR-PO Records
- Clicking Timeline opens modal with full audit trail
- Timeline shows MRF ‚Üí PRs ‚Üí TRs ‚Üí POs workflow
- Each event displays date, description, and status
- Status indicators show workflow progress visually
- Timeline uses existing createTimeline component (DRY principle)
</success_criteria>

<output>
After completion, create `.planning/phases/13-finance-dashboard-&-audit-trails/13-03-SUMMARY.md`
</output>
