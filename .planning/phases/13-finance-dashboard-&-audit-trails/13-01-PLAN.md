# Phase 13, Plan 01: Finance Project List Tab

---
phase: 13-finance-dashboard-&-audit-trails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/firebase.js
  - app/views/finance.js
autonomous: true

must_haves:
  truths:
    - "Finance user sees Project List tab in Finance navigation"
    - "Project List displays all projects with total expenses"
    - "Clicking project name opens modal with expense breakdown by category"
    - "Dashboard totals update when manual refresh button is clicked"
  artifacts:
    - path: "app/firebase.js"
      provides: "Firestore aggregation API imports (getAggregateFromServer, sum, count)"
      exports: ["getAggregateFromServer", "sum", "count"]
    - path: "app/views/finance.js"
      provides: "Project List tab rendering and aggregation logic"
      contains: "activeTab === 'projects'"
      min_lines: 1300
  key_links:
    - from: "app/views/finance.js"
      to: "firebase aggregation API"
      via: "import { getAggregateFromServer, sum, count } from '../firebase.js'"
      pattern: "getAggregateFromServer.*sum.*total_amount"
    - from: "app/views/finance.js"
      to: "projects collection query"
      via: "getDocs(collection(db, 'projects'))"
      pattern: "collection\\(db, 'projects'\\)"
    - from: "app/views/finance.js"
      to: "pos collection aggregation"
      via: "getAggregateFromServer with where project_name"
      pattern: "where\\('project_name', '=='"
---

<objective>
Add Project List tab to Finance view showing all projects with aggregated expense totals and drill-down modals for category breakdown.

Purpose: Enables Finance users to monitor project spending and identify budget concerns without loading all PO documents client-side.

Output: Working Project List tab with server-side aggregation, expense breakdown modals, and manual refresh capability.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\REQUIREMENTS.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\13-finance-dashboard-&-audit-trails\13-RESEARCH.md
@C:\Users\franc\dev\projects\pr-po\app\firebase.js
@C:\Users\franc\dev\projects\pr-po\app\views\finance.js
@C:\Users\franc\dev\projects\pr-po\CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firestore aggregation API to firebase.js</name>
  <files>app/firebase.js</files>
  <action>
Add Firestore aggregation imports to firebase.js following the established pattern:

1. Add to line 26 imports (after writeBatch):
   - getAggregateFromServer
   - sum
   - count
   - average

2. Add to line 75 exports (after writeBatch):
   - getAggregateFromServer
   - sum
   - count
   - average

3. Add to window.firestore object (after writeBatch in line 105):
   - getAggregateFromServer
   - sum
   - count
   - average

Follow existing code style: CDN import from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'

DO NOT add any other dependencies or modify firebaseConfig.
  </action>
  <verify>
```bash
grep "getAggregateFromServer" "C:\Users\franc\dev\projects\pr-po\app\firebase.js"
grep "sum," "C:\Users\franc\dev\projects\pr-po\app\firebase.js"
```
Should show imports in 3 places (import statement, export block, window.firestore object).
  </verify>
  <done>firebase.js exports getAggregateFromServer, sum, count, and average for use in views.</done>
</task>

<task type="auto">
  <name>Task 2: Add Project List tab to finance.js</name>
  <files>app/views/finance.js</files>
  <action>
Add Project List tab to Finance view following established patterns from Phase 12 (attachWindowFunctions, modal lifecycle):

**1. Add aggregation import (line 5):**
Import getAggregateFromServer, sum, count from '../firebase.js'

**2. Add module state (after line 14):**
```javascript
let projectExpenses = [];
```

**3. Add tab navigation link in render() function (after line 98, before closing div):**
```html
<a href="#/finance/projects" class="tab-btn ${activeTab === 'projects' ? 'active' : ''}">
    ðŸ’° Project List
</a>
```

**4. Add Project List section HTML in render() after Purchase Orders section (search for "<!-- Purchase Orders Section -->" and add after its closing section tag):**
- Section with id="projects-section", class="section ${activeTab === 'projects' ? 'active' : ''}"
- Card with header "Project Expenses" and Refresh button calling refreshProjectExpenses()
- Instructions: "Click project name to view expense breakdown by category"
- Table with columns: Project Code, Project Name, Total Expenses, PO Count, Actions
- tbody id="projectExpensesBody" with loading placeholder

**5. Add expense breakdown modal HTML in render() (after rejection modal):**
Modal structure matching existing PR modal pattern:
- id="projectExpenseModal"
- Modal header with id="projectExpenseModalTitle"
- Modal body with id="projectExpenseModalBody"
- Close button calling closeProjectExpenseModal()

**6. Add window functions in attachWindowFunctions() (after line 38):**
```javascript
window.refreshProjectExpenses = refreshProjectExpenses;
window.showProjectExpenseModal = showProjectExpenseModal;
window.closeProjectExpenseModal = closeProjectExpenseModal;
```

**7. Add ESC key handling in setupModalListeners() (after line 69, inside keydown handler):**
```javascript
else if (document.getElementById('projectExpenseModal')?.classList.contains('active')) {
    closeProjectExpenseModal();
}
```

**8. Implement refreshProjectExpenses() function (before destroy()):**
- Get all projects from collection(db, 'projects')
- For each project, use getAggregateFromServer with query where('project_name', '==', projectName) on 'pos' collection
- Aggregate: totalAmount: sum('total_amount'), poCount: count()
- Handle null results (no POs yet): return 0 for both
- Store in projectExpenses array
- Call renderProjectExpenses()

**9. Implement renderProjectExpenses() function:**
- Get tbody element by id 'projectExpensesBody'
- If no projects, show "No projects found" message
- For each project in projectExpenses:
  - Row with project_code, project_name, formatted total (â‚±), PO count
  - Click project name to call showProjectExpenseModal(projectCode, projectName)
  - Use formatCurrency() from utils.js

**10. Implement showProjectExpenseModal(projectCode, projectName) function:**
- showLoading(true)
- Get aggregated total for project (same query as refresh)
- Get all POs for project (getDocs with where project_name)
- Parse items_json from each PO (use JSON.parse(po.items_json || '[]'))
- Group by category client-side (reduce into categoryTotals object)
- Calculate percentage of total for each category
- Render modal with:
  - Project code and name in header
  - Total expenses in large green text
  - Table with Category, Amount, % of Total columns
  - Use modal-details-grid and modal-items-table classes (existing styles)
- classList.add('active') to show modal
- showLoading(false)
- Wrap in try/catch with showToast on error

**11. Implement closeProjectExpenseModal() function:**
- classList.remove('active') from projectExpenseModal

**12. Wire into init() lifecycle:**
Add after setupModalListeners():
```javascript
if (activeTab === 'projects') {
    await refreshProjectExpenses();
}
```

Follow Phase 12 patterns:
- Use attachWindowFunctions() for onclick handlers
- Use AbortController pattern for ESC key (already in setupModalListeners)
- Add console.log with [Finance] prefix for debugging
- Safe JSON parsing with fallback: JSON.parse(po.items_json || '[]')
- Handle null aggregation results: snapshot.data().totalAmount || 0

DO NOT add real-time listeners for aggregation (not supported by Firebase).
DO NOT load all POs for dashboard totals (use aggregation instead).
  </action>
  <verify>
Manual testing:
1. Navigate to Finance view, click "Project List" tab
2. Verify project list appears with expense totals
3. Click project name
4. Verify expense breakdown modal opens with categories
5. Press ESC key, verify modal closes
6. Click Refresh button, verify totals update

Check console for [Finance] logs and no errors.
  </verify>
  <done>
Finance user can:
- See Project List tab in Finance navigation
- View all projects with total expenses calculated server-side
- Click project name to open expense breakdown modal showing categories
- Press ESC to close modal
- Click Refresh to update totals
  </done>
</task>

</tasks>

<verification>
**Functional verification:**
1. Finance user navigates to Finance > Project List tab
2. All projects appear with accurate total expenses (sum of all POs)
3. Clicking project name opens modal with category breakdown
4. Categories show correct amounts and percentages
5. ESC key closes modal
6. Refresh button updates totals after new POs created

**Technical verification:**
- getAggregateFromServer used for dashboard totals (not getDocs)
- Client-side grouping only for modal detail view (filtered subset)
- Modal follows existing finance.js patterns (modal-details-grid classes)
- Window functions attached in attachWindowFunctions()
- ESC key handling uses existing AbortController

**Edge cases:**
- Projects with no POs show â‚±0.00 (not â‚±NaN)
- Items with null category grouped as "Uncategorized"
- Invalid JSON in items_json handled gracefully (try/catch with fallback)
</verification>

<success_criteria>
**Requirement FIN-03 satisfied when:**
- Finance user sees Project List tab
- Project List displays all projects with total expenses
- Clicking project name opens expense breakdown modal
- Modal shows categories with amounts and percentages
- Dashboard uses server-side aggregation (1 read per 1000 entries, not 1 per PO)
- Manual refresh updates totals
</success_criteria>

<output>
After completion, create `.planning/phases/13-finance-dashboard-&-audit-trails/13-01-SUMMARY.md`
</output>
