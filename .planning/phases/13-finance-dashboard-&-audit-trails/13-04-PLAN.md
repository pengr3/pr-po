---
phase: 13-finance-dashboard-&-audit-trails
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [firestore.indexes.json]
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Finance Project List tab loads without Firebase index errors"
    - "Project List table displays all projects with expense totals"
    - "Refresh button updates dashboard without errors"
    - "Timeline button loads procurement timeline modal without errors"
  artifacts:
    - path: "firestore.indexes.json"
      provides: "Composite indexes for pos collection aggregation and timeline queries"
      min_lines: 40
  key_links:
    - from: "app/views/finance.js"
      to: "Firebase pos collection"
      via: "getAggregateFromServer with where filter"
      pattern: "getAggregateFromServer.*where.*project_name"
    - from: "app/views/procurement.js"
      to: "Firebase pos collection"
      via: "query with where and orderBy"
      pattern: "where.*mrf_id.*orderBy.*date_issued"
---

<objective>
Add Firebase composite indexes to fix aggregation query and timeline query errors.

Purpose: Enable Finance Project List aggregation queries and Procurement Timeline queries to execute without "query requires an index" errors by deploying required composite indexes to Firebase.
Output: Updated firestore.indexes.json with pos collection indexes, successfully deployed to Firebase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-finance-dashboard-&-audit-trails/13-01-SUMMARY.md
@.planning/phases/13-finance-dashboard-&-audit-trails/13-03-SUMMARY.md
@.planning/phases/13-finance-dashboard-&-audit-trails/13-UAT.md
@firestore.indexes.json
@app/views/finance.js
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pos collection composite indexes to firestore.indexes.json</name>
  <files>firestore.indexes.json</files>
  <action>
Add two composite indexes for the pos collection to firestore.indexes.json:

**Index 1: Project expense aggregation**
- Collection: "pos"
- Fields:
  - project_name (ASCENDING)

This index supports the aggregation query in finance.js (lines 362-370):
```javascript
const q = query(
  collection(db, 'pos'),
  where('project_name', '==', projectName)
);
const snapshot = await getAggregateFromServer(q, {
  totalExpenses: sum('total_amount'),
  poCount: count()
});
```

**Index 2: Timeline query with ordering**
- Collection: "pos"
- Fields:
  - mrf_id (ASCENDING)
  - date_issued (ASCENDING)

This index supports the timeline query in procurement.js (lines 4203-4207):
```javascript
const posQuery = query(
  collection(db, 'pos'),
  where('mrf_id', '==', mrfId),
  orderBy('date_issued', 'asc')
);
```

**Important:**
- Follow existing firestore.indexes.json structure (users collection index is the reference)
- Use "ASCENDING" order for all fields
- Set queryScope: "COLLECTION" for both indexes
- Maintain valid JSON formatting
- Keep existing users collection index unchanged

**Why these specific indexes:**
- Firebase requires composite indexes when combining where() filters with aggregation
- Firebase requires composite indexes when filtering on one field and ordering by another
- Single-field indexes are auto-created by Firebase; multi-field indexes must be declared
  </action>
  <verify>
Run `cat firestore.indexes.json` and confirm:
1. File contains 3 indexes total (1 existing users, 2 new pos)
2. First pos index has project_name field
3. Second pos index has mrf_id and date_issued fields
4. JSON is valid (no syntax errors)
  </verify>
  <done>
firestore.indexes.json contains two new composite indexes for pos collection with correct field configurations
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Deploy Firebase indexes to production</action>
  <why>
Firebase index deployment requires firebase-tools CLI and authenticated Firebase account. This cannot be automated via git commit - requires manual deployment step.
  </why>
  <instructions>
**Deploy indexes using Firebase CLI:**

```bash
# Install firebase-tools globally (if not already installed)
npm install -g firebase-tools

# Login to Firebase (if not already authenticated)
firebase login

# Ensure you're in project root directory
cd C:\Users\franc\dev\projects\pr-po

# Deploy indexes only (does not affect other Firebase services)
firebase deploy --only firestore:indexes
```

**Expected output:**
```
=== Deploying to 'clmc-procurement'...
i  firestore: reading indexes from firestore.indexes.json...
âœ”  firestore: deployed indexes in firestore.indexes.json successfully
âœ”  Deploy complete!
```

**Verification:**
1. After deployment, visit Firebase Console: https://console.firebase.google.com/project/clmc-procurement/firestore/indexes
2. Confirm you see 3 indexes:
   - users: status + created_at
   - pos: project_name (new)
   - pos: mrf_id + date_issued (new)
3. Index build status shows "Enabled" (may take 1-2 minutes for new indexes)

**Important notes:**
- Index creation is one-time operation - subsequent deploys only update changed indexes
- Build time is typically < 2 minutes for collections with < 10k documents
- Application continues working during index build (queries queue until ready)
- If deployment fails, check firebase-tools version: `firebase --version` (requires >= 11.0.0)

**Troubleshooting:**
- "Permission denied": Run `firebase login --reauth`
- "Project not found": Check firebase.json has correct project ID
- "Invalid index": Verify firestore.indexes.json JSON syntax
  </instructions>
  <resume-signal>Type "indexes deployed" when Firebase Console shows all 3 indexes as Enabled</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Firebase composite indexes deployed for pos collection supporting:
1. Project expense aggregation queries (Finance Project List tab)
2. Timeline queries with mrf_id filter and date_issued ordering (Procurement Timeline modal)
  </what-built>
  <how-to-verify>
**Test 1: Finance Project List tab**
1. Navigate to Finance view
2. Click "Project List" tab
3. Confirm: Table loads and displays projects with expense totals (no console errors)
4. Click "Refresh" button
5. Confirm: Dashboard updates successfully (no Firebase index errors in console)

**Test 2: Project Expense Breakdown modal**
1. In Project List table, click on any project name
2. Confirm: Modal opens showing POs grouped by category
3. Press ESC to close modal

**Test 3: Procurement Timeline modal**
1. Navigate to Procurement view â†’ PR-PO Records tab
2. Click Timeline button (ðŸ“…) in Actions column for any MRF
3. Confirm: Modal opens showing complete timeline (MRF â†’ PRs â†’ TRs â†’ POs)
4. Confirm: No Firebase index errors in browser console
5. Click Close button to dismiss modal

**Expected results:**
- All queries execute without "query requires an index" errors
- Finance Project List loads project expense data
- Procurement Timeline loads complete audit trail
- Browser console shows no Firebase errors

**If errors persist:**
1. Check Firebase Console: https://console.firebase.google.com/project/clmc-procurement/firestore/indexes
2. Verify all 3 indexes show "Enabled" status (not "Building")
3. Hard refresh browser (Ctrl+Shift+R) to clear cached Firebase connection
4. Check browser console for specific error messages
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
**Overall phase checks:**

1. **Index file validation:**
   - firestore.indexes.json contains 3 indexes (users + 2 pos)
   - JSON syntax is valid
   - Index field names match query patterns in code

2. **Firebase deployment validation:**
   - Firebase Console shows all 3 indexes as Enabled
   - No pending builds or errors in index status

3. **Query execution validation:**
   - Finance Project List tab loads without errors
   - Refresh button works without errors
   - Project expense breakdown modal opens successfully
   - Procurement Timeline modal loads without errors
   - Browser console shows no Firebase index requirement errors

4. **Code references unchanged:**
   - app/views/finance.js aggregation queries unchanged (lines 362-370)
   - app/views/procurement.js timeline queries unchanged (lines 4203-4207)
   - Queries now supported by deployed composite indexes
</verification>

<success_criteria>
1. firestore.indexes.json contains pos collection indexes for project_name and mrf_id+date_issued
2. Firebase indexes deployed successfully to clmc-procurement project
3. Finance Project List tab loads and displays project expense data without errors
4. Refresh button updates dashboard without Firebase index errors
5. Procurement Timeline modal opens and displays audit trail without errors
6. All UAT tests 1, 2, 3, 9, 10, 11 now pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-finance-dashboard-&-audit-trails/13-04-SUMMARY.md`
</output>
