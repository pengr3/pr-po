---
phase: 09-super-admin-user-management
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - app/views/user-management.js
autonomous: true

must_haves:
  truths:
    - "Super Admin can see list of pending user registrations"
    - "Pending users show email, registration date, and invitation code used"
    - "Super Admin can approve a pending user"
    - "Approval opens modal to select role before confirming"
    - "Super Admin can reject a pending user"
    - "Rejected users are immediately deleted from Firestore"
    - "Approved users become active with assigned role"
  artifacts:
    - path: "app/views/user-management.js"
      provides: "Pending user approval functionality"
      contains: "renderPendingUsersTable"
      min_lines: 400
  key_links:
    - from: "app/views/user-management.js"
      to: "Firestore users collection"
      via: "query where status == pending"
      pattern: "where.*status.*pending"
    - from: "app/views/user-management.js"
      to: "Firestore users collection"
      via: "updateDoc for approval"
      pattern: "updateDoc.*status.*active"
    - from: "app/views/user-management.js"
      to: "Firestore users collection"
      via: "deleteDoc for rejection"
      pattern: "deleteDoc"
---

<objective>
Implement pending user approval workflow with role assignment modal.

Purpose: Enable Super Admin to review pending registrations, assign roles during approval, or reject (delete) invalid registrations.
Output: Working pending user approval flow with role selection modal and rejection capability.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-super-admin-user-management/09-CONTEXT.md
@.planning/phases/09-super-admin-user-management/09-01-SUMMARY.md (if exists)
@app/views/user-management.js
@app/auth.js (reference for modal pattern from showLogoutConfirmation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pending users listener and table display</name>
  <files>app/views/user-management.js</files>
  <action>
Extend user-management.js to display pending user registrations:

1. Add module-level state:
   - pendingUsers array
   - pendingUsersListener variable

2. Update init() function:
   - Add onSnapshot listener for users collection where status == 'pending'
   - Store results in pendingUsers array sorted by created_at descending
   - Add listener to listeners array
   - Call renderPendingUsersTable() when data updates

3. Create renderPendingUsersTable() function:
   - Target container: document.getElementById('pendingUsersContainer')
   - If no pending users: show empty state "No pending registrations"
   - Table columns: Email, Full Name, Registered, Invitation Code, Actions
   - Registered: format created_at as relative time or date
   - Invitation Code: truncated display (first 8 chars)
   - Actions: "Approve" button (green), "Reject" button (red/outline)
   - Use onclick handlers: openApprovalModal(userId), handleRejectUser(userId)

4. Update render() function:
   - Pending Approvals tab content:
     - Header: "Pending User Approvals"
     - Badge showing count of pending users
     - Container div with id="pendingUsersContainer"
     - Loading state initially

5. Register window functions in init():
   - window.openApprovalModal = openApprovalModal
   - window.handleRejectUser = handleRejectUser
   - window.confirmApproval = confirmApproval
   - window.closeApprovalModal = closeApprovalModal
  </action>
  <verify>
Navigate to Pending Approvals tab - shows list of pending users or empty state. Console shows listener initialization.
  </verify>
  <done>
Pending users table displays with email, name, registration date, and action buttons for each pending user.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement approval modal with role selection</name>
  <files>app/views/user-management.js</files>
  <action>
Add approval modal and role assignment functionality:

1. Add module-level state:
   - selectedUserForApproval (stores userId being approved)

2. Create openApprovalModal(userId) function:
   - Store userId in selectedUserForApproval
   - Find user data from pendingUsers array
   - Create modal overlay dynamically (like auth.js showLogoutConfirmation)
   - Modal content:
     - Title: "Approve User"
     - User info: email, full name, registered date
     - Role dropdown with 5 options:
       - super_admin: "Super Admin"
       - operations_admin: "Operations Admin"
       - operations_user: "Operations User"
       - finance: "Finance"
       - procurement: "Procurement"
     - Default selection: operations_user (most common)
     - Warning text: "Approved users will have immediate access to the system"
     - Buttons: Cancel, Approve (primary)
   - Add modal to document.body
   - Close on backdrop click

3. Create closeApprovalModal() function:
   - Remove modal from DOM
   - Clear selectedUserForApproval

4. Create confirmApproval() function:
   - Get selected role from modal dropdown
   - Validate role is selected
   - Update user document:
     ```javascript
     await updateDoc(doc(db, 'users', selectedUserForApproval), {
         status: 'active',
         role: selectedRole,
         approved_at: serverTimestamp(),
         approved_by: window.getCurrentUser().uid
     });
     ```
   - Close modal
   - Show success toast: "User approved successfully"
   - Table auto-updates via onSnapshot listener

5. Style the modal (inline styles or add to views.css):
   - Centered modal with white background
   - Proper padding and border-radius
   - Role dropdown full-width
   - Buttons aligned right
  </action>
  <verify>
Click Approve on pending user - modal opens with role selection. Select role and confirm - user becomes active with that role in Firestore.
  </verify>
  <done>
Approval modal with role selection works. Approved users become active with assigned role immediately.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement rejection with immediate deletion</name>
  <files>app/views/user-management.js</files>
  <action>
Add rejection functionality that deletes pending users from Firestore:

1. Create handleRejectUser(userId) function:
   - Find user data from pendingUsers array
   - Show confirmation dialog:
     - Title: "Reject User"
     - Content: "Are you sure you want to reject [email]? This will permanently delete their registration."
     - Warning: "This action cannot be undone."
     - Buttons: Cancel, Reject (danger red)
   - On confirm: delete user document from Firestore
     ```javascript
     await deleteDoc(doc(db, 'users', userId));
     ```
   - Show toast: "User rejected and deleted"

2. Import deleteDoc from firebase.js if not already imported

3. Create confirmation modal (similar to approval modal structure):
   - Can reuse showConfirmationModal helper or create inline
   - Return Promise that resolves true/false based on user action

**KNOWN LIMITATION - Firebase Auth Account Persistence:**
When a user registers, they create their own Firebase Auth account. Rejecting a user only deletes their Firestore user document, NOT their Firebase Auth account. This means:
- The rejected user's Firebase Auth account still exists
- If they try to log in, they will authenticate successfully with Firebase Auth
- However, the auth observer in auth.js will find no Firestore user document
- They will be shown an error or redirected appropriately (no Firestore doc = no access)

This is acceptable because:
1. Deleting Firebase Auth accounts requires Admin SDK (server-side only)
2. The system already handles "authenticated but no user doc" gracefully
3. Firebase Auth accounts without Firestore docs have zero system access
4. This avoids the complexity of deploying Cloud Functions just for user cleanup

If stricter cleanup is needed in the future, a Cloud Function can be added to delete Firebase Auth accounts when Firestore user docs are deleted.
  </action>
  <verify>
Click Reject on pending user - confirmation dialog appears. Confirm rejection - user document deleted from Firestore. User disappears from pending list. Attempting to log in as rejected user shows appropriate error (no user document).
  </verify>
  <done>
Rejection functionality deletes pending user's Firestore document immediately with proper confirmation dialog. Firebase Auth account persists but has no system access without Firestore user doc.
  </done>
</task>

</tasks>

<verification>
1. Pending Approvals tab shows count badge with number of pending users
2. Table displays all pending users with correct information
3. Approve button opens modal with role dropdown
4. Role selection defaults to "Operations User"
5. Approving user sets status='active' and role in Firestore
6. Approved user disappears from pending list (real-time update)
7. Reject button shows confirmation dialog
8. Rejecting user deletes their Firestore document
9. Empty state shown when no pending users exist
</verification>

<success_criteria>
- AUTH-11: Super Admin can view pending user registrations
- AUTH-12: Super Admin can approve pending user (assign role during approval)
- ADMIN-02: Super Admin can view pending approval queue
- ADMIN-05: Super Admin can assign role to user
- Rejected users are deleted immediately from Firestore (no lingering rejected status)
- Role assignment happens atomically with approval
- Known limitation documented: Firebase Auth accounts persist after rejection (acceptable - no system access without Firestore doc)
</success_criteria>

<output>
After completion, create `.planning/phases/09-super-admin-user-management/09-02-SUMMARY.md`
</output>
