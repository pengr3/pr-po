---
phase: 09-super-admin-user-management
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - app/views/user-management.js
autonomous: true

must_haves:
  truths:
    - "Super Admin can see list of all users"
    - "User list shows email, role, status, assigned projects"
    - "Super Admin can search users by email"
    - "Super Admin can deactivate a user account"
    - "Deactivation requires typing the user's email to confirm"
    - "Super Admin cannot deactivate the last Super Admin"
    - "Super Admin can reactivate a deactivated user"
    - "Super Admin can only delete users who are already deactivated"
    - "Super Admin can change a user's role"
  artifacts:
    - path: "app/views/user-management.js"
      provides: "User list and action management"
      contains: "renderUsersTable"
      min_lines: 700
  key_links:
    - from: "app/views/user-management.js"
      to: "Firestore users collection"
      via: "onSnapshot for all users"
      pattern: "onSnapshot.*users"
    - from: "app/views/user-management.js"
      to: "Firestore users collection"
      via: "query for Super Admin count"
      pattern: "where.*super_admin"
---

<objective>
Implement All Users list with search, action menu, and user management operations.

Purpose: Enable Super Admin to view all users, search by email, and perform user management actions (deactivate, reactivate, delete, change role) with appropriate safety measures.
Output: Complete user list display with dropdown action menu and all user management operations.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-super-admin-user-management/09-CONTEXT.md
@.planning/phases/09-super-admin-user-management/09-01-SUMMARY.md (if exists)
@app/views/user-management.js
@app/views/project-assignments.js (reference for user listing pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement All Users list with search</name>
  <files>app/views/user-management.js</files>
  <action>
Add All Users tab functionality:

1. Add module-level state:
   - allUsers array
   - allUsersListener variable
   - userSearchQuery string

2. Update init() function:
   - Add onSnapshot listener for users collection (no filter - get all users)
   - Exclude pending users from display (show only active/deactivated)
   - Store in allUsers array sorted by email
   - Call renderUsersTable() when data updates

3. Update render() function for All Users tab:
   - Header: "All Users" with count badge
   - Search input: placeholder="Search by email...", oninput="handleUserSearch(event)"
   - Container div with id="usersTableContainer"

4. Create renderUsersTable() function:
   - Filter by userSearchQuery if set (case-insensitive email match)
   - Table columns: Email, Full Name, Role, Status, Assigned Projects, Actions
   - Role: Display label (e.g., "Super Admin", "Operations User")
   - Status: Badge - green "Active", gray "Deactivated"
   - Assigned Projects column:
     - If role != 'operations_user': show "-" (not applicable)
     - If all_projects == true: show "All projects"
     - If assigned_project_codes exists: show count (e.g., "3 projects")
     - Otherwise: show "No projects"
   - Actions: Three-dot menu button (kebab menu) that opens dropdown
   - Highlight current user's row (cannot perform actions on self)

5. Create handleUserSearch(event) function:
   - Update userSearchQuery with input value
   - Call renderUsersTable()

6. Create action dropdown HTML:
   - Edit Role
   - Assign Projects (only show if role === 'operations_user', links to #/project-assignments)
   - Deactivate (show if status === 'active')
   - Reactivate (show if status === 'deactivated')
   - Delete (show if status === 'deactivated')
   - Disable actions for current user

7. Register window functions in init():
   - window.handleUserSearch
   - window.toggleUserActionMenu
   - window.handleEditRole
   - window.handleDeactivateUser
   - window.handleReactivateUser
   - window.handleDeleteUser

8. Create toggleUserActionMenu(userId) function:
   - Toggle visibility of dropdown for specific user row
   - Close other open dropdowns
  </action>
  <verify>
Navigate to All Users tab - shows list of all non-pending users. Search filters list by email. Action menu shows appropriate options based on user status.
  </verify>
  <done>
All Users table displays with email, role, status, assigned projects, and action dropdown menu per row. Search filters by email.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement deactivation with email confirmation and Super Admin protection</name>
  <files>app/views/user-management.js</files>
  <action>
Add deactivation with safety measures:

1. Create handleDeactivateUser(userId) function:
   - Find user from allUsers array
   - Check if user is super_admin role:
     - If yes, count active Super Admins in allUsers
     - If count <= 1, show error modal: "Cannot deactivate the last Super Admin account. Promote another user to Super Admin first."
     - Return early without showing deactivation modal
   - Show deactivation confirmation modal

2. Create showDeactivationModal(userId, userEmail) function:
   - Modal content:
     - Title: "Deactivate User Account"
     - Warning icon (red/orange)
     - Text: "You are about to deactivate [email]"
     - Consequence: "This will immediately log them out and prevent future access."
     - Email input: "Type the user's email to confirm:"
     - Input field for email confirmation
     - Buttons: Cancel, Deactivate (danger, disabled until email matches)
   - Enable Deactivate button only when input matches userEmail exactly
   - On confirm:
     ```javascript
     await updateDoc(doc(db, 'users', userId), {
         status: 'deactivated',
         deactivated_at: serverTimestamp(),
         deactivated_by: window.getCurrentUser().uid
     });
     ```
   - Close modal
   - Show toast: "User deactivated"

3. Create handleReactivateUser(userId) function:
   - Simple confirmation: "Reactivate [email]? They will regain access to the system."
   - On confirm:
     ```javascript
     await updateDoc(doc(db, 'users', userId), {
         status: 'active',
         reactivated_at: serverTimestamp(),
         reactivated_by: window.getCurrentUser().uid
     });
     ```
   - Show toast: "User reactivated"

4. Add countActiveSuperAdmins() helper function:
   - Filter allUsers where role === 'super_admin' AND status === 'active'
   - Return count
  </action>
  <verify>
Deactivate active user - must type email to confirm. User becomes deactivated. Cannot deactivate if last Super Admin. Reactivate works with simple confirm.
  </verify>
  <done>
Deactivation requires email confirmation and blocks deactivating last Super Admin. Reactivation restores user access.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement delete and role editing</name>
  <files>app/views/user-management.js</files>
  <action>
Add delete and role editing functionality:

1. Create handleDeleteUser(userId) function:
   - Find user from allUsers
   - Verify user is deactivated (defense in depth - UI should only show option for deactivated users)
   - If not deactivated, show error: "Users must be deactivated before deletion"
   - Show confirmation modal:
     - Title: "Permanently Delete User"
     - Warning: "This will permanently delete [email] and cannot be undone."
     - Text: "User's created data (MRFs, PRs, POs) will be preserved with original creator info."
     - Buttons: Cancel, Delete (danger)
   - On confirm:
     ```javascript
     await deleteDoc(doc(db, 'users', userId));
     ```
   - Show toast: "User deleted"

2. Create handleEditRole(userId) function:
   - Find user from allUsers
   - Show role edit modal:
     - Title: "Change Role"
     - Current role display: "Current: [role label]"
     - Role dropdown with 5 options (same as approval modal)
     - Pre-select current role
     - Buttons: Cancel, Save Changes
   - On confirm:
     - If changing away from super_admin, check if last Super Admin
     - If last Super Admin, show error: "Cannot change role. This is the last Super Admin account."
     - Otherwise:
       ```javascript
       await updateDoc(doc(db, 'users', userId), {
           role: newRole,
           role_changed_at: serverTimestamp(),
           role_changed_by: window.getCurrentUser().uid
       });
       ```
   - Show toast: "Role updated"

3. Ensure dropdown menus close when clicking outside:
   - Add document click listener to close open menus
   - Stop propagation on menu toggle button

4. Style action dropdown menu:
   - Position absolute below kebab button
   - White background with shadow
   - Hover states on items
   - Danger styling for Deactivate/Delete options
  </action>
  <verify>
Delete only works on deactivated users. Role edit shows modal with dropdown. Cannot change role of last Super Admin to non-admin role. All actions update Firestore correctly.
  </verify>
  <done>
Delete removes deactivated users permanently. Role editing works with Super Admin protection. All user management actions complete.
  </done>
</task>

</tasks>

<verification>
1. All Users tab shows all non-pending users
2. Email search filters the list in real-time
3. Action menu opens with appropriate options per user status
4. Active users can be deactivated (requires email confirmation)
5. Deactivated users can be reactivated
6. Deactivated users can be deleted permanently
7. Cannot deactivate or change role of last Super Admin
8. Role can be changed for non-protected users
9. Current user cannot perform actions on themselves
10. All actions show appropriate confirmation dialogs
</verification>

<success_criteria>
- ADMIN-01: Super Admin can view list of all users (email, role, status, assigned projects)
- AUTH-13: Super Admin can deactivate user account (with confirmation)
- AUTH-14: Super Admin can delete user account (with confirmation)
- AUTH-15: System prevents deactivating last Super Admin account
- ADMIN-07: Super Admin can change user status (activate/deactivate)
- Email confirmation required for deactivation (from CONTEXT.md)
- Two-step delete process enforced (deactivate first)
- Reactivation enables account recovery
</success_criteria>

<output>
After completion, create `.planning/phases/09-super-admin-user-management/09-03-SUMMARY.md`
</output>
