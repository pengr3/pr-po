---
phase: 09-super-admin-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/user-management.js
  - app/router.js
  - index.html
  - styles/views.css
autonomous: true

must_haves:
  truths:
    - "Super Admin can navigate to User Management page"
    - "Super Admin can generate a new invitation code"
    - "Generated code is in UUID format (e.g., a3f8b2c1-4d5e-6f7a-8b9c-0d1e2f3a4b5c)"
    - "Super Admin can copy invitation code to clipboard"
    - "Super Admin can see list of all invitation codes with status"
    - "Invitation codes show used/unused status"
  artifacts:
    - path: "app/views/user-management.js"
      provides: "User management view module"
      exports: ["render", "init", "destroy"]
      min_lines: 200
    - path: "app/router.js"
      provides: "Route definition for /user-management"
      contains: "user-management"
  key_links:
    - from: "app/views/user-management.js"
      to: "app/firebase.js"
      via: "Firestore operations for invitation_codes collection"
      pattern: "collection.*invitation_codes"
    - from: "app/router.js"
      to: "app/views/user-management.js"
      via: "lazy load import"
      pattern: "import.*user-management"
    - from: "index.html"
      to: "#/user-management"
      via: "nav link"
      pattern: "user-management"
---

<objective>
Create User Management view foundation with invitation code generation and display.

Purpose: Enable Super Admin to generate invitation codes for new user registration and track their usage.
Output: New user-management.js view module with invitation code tab, route configuration, and navigation link.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-super-admin-user-management/09-CONTEXT.md
@app/views/role-config.js (reference for view module patterns)
@app/views/project-assignments.js (reference for admin panel patterns)
@app/router.js
@app/auth.js (reference for getCurrentUser pattern)
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user-management.js view module with invitation code tab</name>
  <files>app/views/user-management.js</files>
  <action>
Create new view module following established patterns from role-config.js and project-assignments.js:

1. Module structure:
   - Import db and Firestore functions from firebase.js
   - Import showToast from utils.js
   - Module-level state: listeners array, invitation codes data
   - Export render(), init(), destroy() functions
   - Window function cleanup in destroy()

2. Role gate (defense in depth):
   - Check window.getCurrentUser() returns super_admin role
   - Show Access Denied page if not super_admin (only Super Admin manages users)

3. render() function:
   - Return HTML with 3-tab layout: "Pending Approvals", "All Users", "Invitation Codes"
   - Tab navigation using onclick="switchUserMgmtTab('codes')" pattern
   - Initially show Invitation Codes tab (first functionality to implement)
   - Placeholder content for Pending Approvals and All Users tabs

4. Invitation Codes tab content:
   - Header: "Invitation Codes" with "Generate New Code" button
   - Info box: "Codes expire after 3 hours if unused"
   - Table: Code (truncated display), Status (Used/Unused badge), Created, Expires/Used By columns
   - Loading state placeholder

5. init() function:
   - Register window functions for event handlers
   - Set up onSnapshot listener on invitation_codes collection
   - Sort by created_at descending (newest first)
   - Store listener in listeners array

6. generateInvitationCode() function:
   - Generate UUID using crypto.randomUUID() (browser native)
   - Calculate expires_at as 3 hours from now (serverTimestamp is unreliable for future dates, use Date.now() + 3*60*60*1000)
   - Save to invitation_codes collection: { code, status: 'active', created_at: serverTimestamp(), expires_at: Timestamp.fromMillis(...), created_by: currentUser.uid }
   - Copy to clipboard automatically after creation
   - Show success toast with "Code copied to clipboard"

7. copyToClipboard(code) function:
   - Use navigator.clipboard.writeText(code)
   - Show toast on success

8. renderInvitationCodesTable() function:
   - Display codes with truncated code column (first 8 chars + "...")
   - Full code shown in data attribute for copy
   - Status badges: green "Unused" or gray "Used"
   - For unused codes: show "Expires [relative time]" or "Expired" if past
   - For used codes: show "Used by [email]" and used_at date
   - Copy button per row for unused codes
   - Mark expired codes visually (lighter text)

9. switchUserMgmtTab(tabId) function:
   - Toggle tab content visibility
   - Update tab button active states

10. destroy() function:
    - Unsubscribe all listeners
    - Clear module state
    - Delete window functions
  </action>
  <verify>
File exists at app/views/user-management.js with render, init, destroy exports. Module loads without errors in browser console.
  </verify>
  <done>
user-management.js view module created with invitation code generation, copy-to-clipboard, and codes list display functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add route and navigation for User Management</name>
  <files>app/router.js, index.html, styles/views.css</files>
  <action>
1. In app/router.js:
   - Add route definition:
     ```javascript
     '/user-management': {
         name: 'User Management',
         load: () => import('./views/user-management.js'),
         title: 'User Management | CLMC Procurement'
     }
     ```
   - Add to routePermissionMap: '/user-management': 'role_config' (shares admin permission with Settings)

2. In index.html:
   - Add nav link after "Assignments" link:
     ```html
     <a href="#/user-management" class="nav-link" data-route="role_config">Users</a>
     ```
   - Keep data-route="role_config" so it shares visibility with other admin routes

3. In styles/views.css:
   - Add styles for user management tabs (similar to procurement/finance tab styling)
   - Add styles for invitation code display:
     - .code-display: monospace font, truncation
     - .status-badge.unused: green background
     - .status-badge.used: gray background
     - .expired-code: opacity 0.6
   - Add styles for copy button (small, inline)
  </action>
  <verify>
Navigate to http://localhost:8000/#/user-management - page loads without 404. Console shows [UserManagement] initialization log.
  </verify>
  <done>
Route configured, navigation link added, and CSS styles in place for User Management view.
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual testing of invitation code flow</name>
  <files>None (testing only)</files>
  <action>
1. Start local server: python -m http.server 8000
2. Navigate to http://localhost:8000
3. Log in as Super Admin user (or create one in Firestore console if needed)
4. Click "Users" in navigation
5. Verify User Management page loads with tabs
6. Click "Invitation Codes" tab
7. Click "Generate New Code"
8. Verify:
   - Code appears in list
   - Toast shows "Code copied to clipboard"
   - Code is in UUID format
   - Status shows "Unused"
   - Expiration time shown
9. Click copy button on existing code
10. Verify clipboard contains the code
11. Check Firestore console - invitation_codes collection has new document

Note: If no Super Admin user exists, create one manually in Firestore:
- users collection, document with: { email: "admin@test.com", role: "super_admin", status: "active", full_name: "Test Admin" }
- Log in with that email in the app
  </action>
  <verify>
Invitation code generation works end-to-end. Generated codes appear in list with correct status and expiration.
  </verify>
  <done>
Invitation code generation and display verified working. Super Admin can generate UUID codes, copy to clipboard, and view all codes with status.
  </done>
</task>

</tasks>

<verification>
1. User Management view loads at #/user-management
2. Only visible/accessible for Super Admin role
3. Generate Code button creates UUID-format invitation code
4. Code automatically copied to clipboard on generation
5. Codes list displays with used/unused status badges
6. Unused codes show expiration countdown
7. Used codes show who used them
8. Copy button works for individual codes
9. Tab navigation between Pending Approvals, All Users, Invitation Codes works
</verification>

<success_criteria>
- AUTH-10: Super Admin can generate one-time invitation codes
- ADMIN-03: Super Admin can generate invitation codes from dashboard
- ADMIN-04: Super Admin can view invitation code usage (active/used status)
- View module follows established codebase patterns
- No console errors during normal operation
</success_criteria>

<output>
After completion, create `.planning/phases/09-super-admin-user-management/09-01-SUMMARY.md`
</output>
