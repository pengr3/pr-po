---
phase: 06-role-infrastructure-real-time-permissions
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - app/views/role-config.js
  - app/router.js
  - index.html
  - styles/views.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Super Admin can access role configuration page at #/role-config"
    - "Checkbox matrix displays all 5 roles and all 7 tabs with current permissions"
    - "Clicking Save updates role templates in Firestore atomically"
    - "Permission changes propagate to all users with affected roles (no logout)"
    - "Non-Super Admin users cannot see or access role config page"
  artifacts:
    - path: "app/views/role-config.js"
      provides: "Role configuration view with checkbox matrix"
      exports: ["render", "init", "destroy"]
      min_lines: 200
    - path: "app/router.js"
      provides: "Route definition for role-config"
      contains: "role-config"
  key_links:
    - from: "app/views/role-config.js"
      to: "role_templates collection"
      via: "onSnapshot for reading, writeBatch for saving"
      pattern: "(onSnapshot|writeBatch).*role_templates"
---

<objective>
Create Super Admin role configuration interface with checkbox matrix

Purpose: Enable Super Admin users to view and edit role permissions through a visual checkbox matrix interface. Changes are saved atomically to Firestore and propagate immediately to all affected users via real-time listeners.

Output: Working role configuration page accessible only to Super Admin, with save functionality that triggers real-time permission updates
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-RESEARCH.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-01-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-02-SUMMARY.md
@app/views/clients.js
@app/views/projects.js
@app/router.js
@styles/views.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create role-config.js view with checkbox matrix</name>
  <files>app/views/role-config.js</files>
  <action>
Create new view module for role configuration following existing SPA patterns.

**File structure:**
```javascript
import { db } from '../firebase.js';
import {
    collection,
    doc,
    onSnapshot,
    writeBatch,
    serverTimestamp
} from '../firebase.js';
import { showToast } from '../utils.js';
```

**Module-level state:**
```javascript
let roleTemplates = {};  // Stores loaded role templates by role_id
let listeners = [];      // Array of unsubscribe functions
let pendingChanges = {}; // Tracks unsaved changes: { roleId: { tabId: { permission: value } } }
```

**Tab definitions (for display order and labels):**
```javascript
const TABS = [
    { id: 'dashboard', label: 'Dashboard (Home)' },
    { id: 'clients', label: 'Clients' },
    { id: 'projects', label: 'Projects' },
    { id: 'mrf_form', label: 'Material Request' },
    { id: 'procurement', label: 'Procurement' },
    { id: 'finance', label: 'Finance' },
    { id: 'role_config', label: 'Role Configuration' }
];

const ROLE_ORDER = ['super_admin', 'operations_admin', 'operations_user', 'finance', 'procurement'];
```

**render() function:**
Return HTML structure:
- Page header: "Role Configuration" title with description
- Info banner explaining that changes apply immediately to all users
- Permission matrix table (rendered by renderPermissionMatrix())
- Action buttons: "Discard Changes" (secondary) and "Save Changes" (primary)
- Saving indicator (hidden by default)

**renderPermissionMatrix() function:**
Create table with:
- Header row: "Tab", "Permission", then column for each role (Super Admin, Operations Admin, etc.)
- Body rows: For each tab, two rows (Access and Edit) with checkboxes
- Checkboxes use data attributes: `data-role`, `data-tab`, `data-permission`
- Checkboxes reflect current state from roleTemplates + pendingChanges overlay
- Super Admin's role_config permissions are disabled (always has full access, can't lock themselves out)

**HTML structure for matrix:**
```html
<table class="permission-matrix">
    <thead>
        <tr>
            <th>Tab</th>
            <th>Permission</th>
            <th>Super Admin</th>
            <th>Operations Admin</th>
            <th>Operations User</th>
            <th>Finance</th>
            <th>Procurement</th>
        </tr>
    </thead>
    <tbody>
        <!-- For each tab -->
        <tr>
            <td rowspan="2" class="tab-name">Dashboard</td>
            <td>Access</td>
            <td><input type="checkbox" ... /></td>
            <!-- ... more checkboxes -->
        </tr>
        <tr>
            <td>Edit</td>
            <td><input type="checkbox" ... /></td>
            <!-- ... more checkboxes -->
        </tr>
        <!-- Repeat for other tabs -->
    </tbody>
</table>
```

**init() function:**
1. Set up onSnapshot listener on role_templates collection
2. On snapshot, populate roleTemplates object
3. Re-render matrix to show current values
4. Add change event listeners to all checkboxes (track in pendingChanges)
5. Add click handlers for Save and Discard buttons

**handleCheckboxChange(event):**
- Extract role, tab, permission from data attributes
- Store change in pendingChanges
- Update "unsaved changes" indicator
- DO NOT write to Firestore yet (use Save button)

**handleSave():**
1. Show saving indicator
2. Create writeBatch()
3. For each role in pendingChanges:
   - Get roleRef = doc(db, 'role_templates', roleId)
   - Build update object with dot notation: `permissions.tabs.${tabId}.${permission}: value`
   - Add `updated_at: serverTimestamp()`
   - batch.update(roleRef, updateObj)
4. Commit batch
5. Clear pendingChanges
6. Hide saving indicator
7. Show success toast
8. Log: `[RoleConfig] Permissions updated for roles: [list]`

**handleDiscard():**
- Clear pendingChanges
- Re-render matrix to restore original values
- Show toast: "Changes discarded"

**destroy() function:**
- Unsubscribe all listeners
- Clear roleTemplates and pendingChanges
- Remove window functions

**Window functions:**
```javascript
window.handleRoleConfigSave = handleSave;
window.handleRoleConfigDiscard = handleDiscard;
```

**Console logging:** Use `[RoleConfig]` prefix.
  </action>
  <verify>
File exists at app/views/role-config.js. Check syntax by importing in browser console. Exports render, init, destroy functions.
  </verify>
  <done>
role-config.js view created with checkbox matrix UI, real-time loading from Firestore, batch save functionality, and proper SPA lifecycle methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add role-config route and navigation link</name>
  <files>app/router.js, index.html</files>
  <action>
**Part A: Add route to router.js**

Add new route definition in the routes object:
```javascript
'/role-config': {
    name: 'Role Configuration',
    load: () => import('./views/role-config.js'),
    title: 'Role Configuration | CLMC Procurement'
}
```

The route is already in routePermissionMap from 06-02 (maps to 'role_config' permission).

**Part B: Add navigation link to index.html**

Add new nav link after Finance and before logout button:
```html
<a href="#/role-config" class="nav-link" data-route="role_config">Settings</a>
```

Note: Using "Settings" as display label (more intuitive than "Role Configuration" for nav).

The data-route="role_config" ensures this link is hidden for non-Super Admin users (only super_admin role has role_config.access = true).
  </action>
  <verify>
Navigate to #/role-config -> shows role configuration page. Login as Super Admin -> Settings nav link visible. Login as Finance role -> Settings nav link hidden.
  </verify>
  <done>
Route added for role-config, navigation link added with proper permission filtering (only visible to Super Admin).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSS styles for permission matrix</name>
  <files>styles/views.css</files>
  <action>
Add styles for the role configuration view at the end of views.css.

**Add section comment and styles:**
```css
/* ========================================
   ROLE CONFIGURATION VIEW
   ======================================== */

.role-config-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.role-config-header {
    margin-bottom: 1.5rem;
}

.role-config-header h1 {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
}

.role-config-header p {
    color: var(--gray-600);
    margin: 0;
}

.role-config-info {
    background: var(--blue-50, #eff6ff);
    border: 1px solid var(--blue-200, #bfdbfe);
    border-radius: 8px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.role-config-info-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.role-config-info-text {
    color: var(--blue-800, #1e40af);
    font-size: 0.9375rem;
    line-height: 1.5;
}

/* Permission Matrix Table */
.permission-matrix-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.permission-matrix {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
}

.permission-matrix th,
.permission-matrix td {
    padding: 0.75rem 1rem;
    text-align: center;
    border-bottom: 1px solid var(--gray-200);
}

.permission-matrix th {
    background: var(--gray-50);
    font-weight: 600;
    color: var(--gray-700);
    white-space: nowrap;
}

.permission-matrix th:first-child,
.permission-matrix th:nth-child(2) {
    text-align: left;
}

.permission-matrix td:first-child,
.permission-matrix td:nth-child(2) {
    text-align: left;
}

.permission-matrix .tab-name {
    font-weight: 500;
    color: var(--gray-900);
    background: var(--gray-50);
    vertical-align: middle;
}

.permission-matrix .permission-type {
    color: var(--gray-600);
    font-size: 0.875rem;
}

.permission-matrix tr:last-child td {
    border-bottom: none;
}

.permission-matrix input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--primary);
}

.permission-matrix input[type="checkbox"]:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

/* Highlight changed cells */
.permission-matrix td.has-changes {
    background: var(--yellow-50, #fefce8);
}

/* Action buttons */
.role-config-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 0.5rem;
}

.role-config-actions .btn {
    min-width: 140px;
}

/* Saving indicator */
.saving-indicator {
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-600);
    font-size: 0.9375rem;
}

.saving-indicator.visible {
    display: flex;
}

.saving-indicator .spinner {
    width: 16px;
    height: 16px;
    border-width: 2px;
}

/* Unsaved changes indicator */
.unsaved-indicator {
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: var(--warning);
    font-size: 0.875rem;
    margin-right: auto;
}

.unsaved-indicator.visible {
    display: flex;
}
```
  </action>
  <verify>
Navigate to #/role-config as Super Admin -> matrix displays with proper styling. Checkboxes are clickable. Table has correct layout with role columns and tab rows.
  </verify>
  <done>
CSS styles added for role configuration view: matrix table styling, info banner, action buttons, change indicators.
  </done>
</task>

</tasks>

<verification>
1. Navigate to #/role-config as Super Admin -> shows permission matrix
2. Matrix displays all 5 roles as columns, 7 tabs as rows (14 total rows with Access/Edit)
3. Checkboxes reflect current permissions from Firestore
4. Super Admin's role_config checkboxes are disabled (prevent lockout)
5. Check a box -> change tracked (visual indicator)
6. Click "Discard Changes" -> checkbox reverts
7. Check a box -> click "Save Changes" -> Firestore updated
8. Open second browser tab with different Super Admin -> permissions update in real-time
9. Non-Super Admin user cannot see Settings nav link
10. Non-Super Admin manually navigating to #/role-config shows Access Denied
</verification>

<success_criteria>
- role-config.js view created with checkbox matrix UI
- Route and navigation link added (Settings visible only to Super Admin)
- Matrix loads current permissions from Firestore in real-time
- Save button writes changes atomically with writeBatch
- Permission changes propagate to affected users immediately
- Proper styling matching existing UI patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-role-infrastructure-real-time-permissions/06-03-SUMMARY.md`
</output>
