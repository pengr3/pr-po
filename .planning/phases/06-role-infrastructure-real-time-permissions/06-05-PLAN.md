---
phase: 06-role-infrastructure-real-time-permissions
plan: 05
type: execute
wave: 4
depends_on: [06-01, 06-02, 06-03, 06-04]
files_modified:
  - app/views/procurement.js
  - app/views/finance.js
  - styles/views.css
autonomous: false

must_haves:
  truths:
    - "Procurement view users with view-only access see data but cannot create/edit/delete"
    - "Finance view users with view-only access see data but cannot approve/reject"
    - "Edit buttons and forms are hidden when user lacks edit permission"
    - "View-only notice appears when user has access but no edit rights"
    - "Full edit capability remains for users with edit permission"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Permission-aware procurement view"
      contains: "canEditTab"
    - path: "app/views/finance.js"
      provides: "Permission-aware finance view"
      contains: "canEditTab"
    - path: "styles/views.css"
      provides: "View-only CSS styles"
      contains: "view-only-notice"
  key_links:
    - from: "app/views/procurement.js"
      to: "window.canEditTab"
      via: "permission check in render and action handlers"
      pattern: "canEditTab.*=== false"
    - from: "app/views/finance.js"
      to: "window.canEditTab"
      via: "permission check in render and action handlers"
      pattern: "canEditTab.*=== false"
---

<objective>
Enforce edit mode vs view-only mode in procurement and finance views, add view-only CSS styles

Purpose: Complete the permission enforcement layer by adding edit checks to the two largest and most complex views. Also add the CSS styles for view-only UI elements used across all views.

Output: procurement.js and finance.js views respect edit permissions, view-only CSS styles available
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-RESEARCH.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-01-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-02-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-03-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-04-SUMMARY.md
@app/views/procurement.js
@app/views/finance.js
@styles/views.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add view-only CSS styles to views.css</name>
  <files>styles/views.css</files>
  <action>
Add styles for view-only permission elements at the end of views.css.

**Add section comment and styles:**
```css
/* ========================================
   VIEW-ONLY PERMISSION STYLES
   ======================================== */

.view-only-notice {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-700);
    font-size: 0.9375rem;
}

.view-only-notice .notice-icon {
    font-size: 1.125rem;
}

.view-only-badge {
    display: inline-block;
    background: var(--gray-200);
    color: var(--gray-600);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

/* Disabled form elements for view-only */
.view-only input,
.view-only select,
.view-only textarea {
    pointer-events: none;
    background: var(--gray-100);
    color: var(--gray-600);
}

.view-only button.btn-primary,
.view-only button.btn-danger {
    display: none;
}
```
  </action>
  <verify>
CSS file updated. View-only-notice and view-only-badge classes available. Test by temporarily adding classes to elements in browser DevTools.
  </verify>
  <done>
View-only CSS styles added to views.css: notice banner, badge, and disabled form element styles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add edit permission checks to procurement.js</name>
  <files>app/views/procurement.js</files>
  <action>
**For app/views/procurement.js (3,761 lines - make targeted changes):**

1. Get permission at the start of render():
```javascript
const canEdit = window.canEditTab?.('procurement');
const showEditControls = canEdit !== false;
```

2. Key areas to conditionally render/guard (use showEditControls):

   **MRF tab:**
   - "Process MRF" action buttons
   - "Generate PR/TR" buttons
   - Add view-only notice at top of tab content when canEdit === false

   **Supplier tab:**
   - "Add Supplier" button
   - Edit/Delete supplier action buttons (or "View Only" badge)
   - Add view-only notice when canEdit === false

   **PR/TR tab:**
   - Generation buttons
   - Add view-only notice when canEdit === false

   **PO tab:**
   - Status update buttons
   - "Create PO" button
   - Add view-only notice when canEdit === false

3. Guard key action functions (check at top of each):
```javascript
if (window.canEditTab?.('procurement') === false) {
    showToast('You do not have permission to edit procurement data', 'error');
    return;
}
```

Functions to guard:
- processMRF, generatePR, generateTR, generatePRandTR
- showAddSupplierModal, editSupplier, deleteSupplier
- updatePOStatus, createPO

**Pattern for conditional rendering in template strings:**
```javascript
${showEditControls ? `
    <button class="btn btn-primary" onclick="window.generatePR('${mrfId}')">
        Generate PR
    </button>
` : ''}
```
  </action>
  <verify>
Login as Finance role (procurement.edit=false) -> action buttons hidden, view-only notice shown in each tab. Login as Procurement role (procurement.edit=true) -> full edit controls visible.
  </verify>
  <done>
procurement.js updated with permission checks using strict equality (canEdit === false). All tabs show view-only notice and hide edit controls for users without procurement.edit permission.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add edit permission checks to finance.js</name>
  <files>app/views/finance.js</files>
  <action>
**For app/views/finance.js (1,077 lines):**

1. Get permission at the start of render():
```javascript
const canEdit = window.canEditTab?.('finance');
const showEditControls = canEdit !== false;
```

2. Key areas to conditionally render/guard:

   **Pending Approvals tab:**
   - Approve/Reject buttons for PRs/TRs
   - Add view-only notice when canEdit === false

   **PO tab:**
   - Status update actions
   - Add view-only notice when canEdit === false

   **Historical tab:**
   - Mostly read-only already, but add view-only notice for consistency

3. Guard action functions:
```javascript
if (window.canEditTab?.('finance') === false) {
    showToast('You do not have permission to edit finance data', 'error');
    return;
}
```

Functions to guard:
- approvePR, rejectPR, approveTR, rejectTR
- updatePOPaymentStatus (if exists)
- Any other edit functions
  </action>
  <verify>
Login as Procurement role (finance.edit=false) -> approve/reject buttons hidden, view-only notice shown. Login as Finance role (finance.edit=true) -> full edit controls visible.
  </verify>
  <done>
finance.js updated with permission checks using strict equality (canEdit === false). Approve/reject buttons hidden for users without finance.edit permission.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 6 permission system with:
- 5 role templates in Firestore with default permissions (all 7 tabs)
- Real-time permission loading on login
- Navigation filtering based on tab access
- Router blocking unpermitted routes
- Role configuration UI for Super Admin
- Edit mode vs view-only enforcement in all views
  </what-built>
  <how-to-verify>
**Setup:**
1. Ensure role templates are seeded (from 06-01)
2. Create test users with different roles (or modify existing user's role in Firestore)

**Test 1: Navigation Filtering**
1. Login as Super Admin user (role: super_admin)
2. Verify all nav tabs visible including "Settings"
3. Logout, login as Finance role user
4. Verify: Home, Clients, Projects, Finance visible; Procurement, Material Request, Settings hidden

**Test 2: Route Blocking**
1. While logged in as Finance role, manually type #/procurement in URL bar
2. Verify: "Access Denied" page shown with "Go to Dashboard" button

**Test 3: Real-time Permission Updates**
1. Login as Super Admin in Browser A
2. Login as different Super Admin (or use Firestore console) in Browser B
3. In Browser B: Navigate to Settings, uncheck "Finance - Access - Projects"
4. In Browser A (if logged in as Finance): Verify Projects nav link disappears immediately (no logout)

**Test 4: Edit vs View-Only**
1. Login as Finance role (which has finance.edit=true but clients.edit=false by default)
2. Navigate to Clients tab
3. Verify: View-only notice shown, "Add Client" button hidden, table shows "View Only" badge
4. Navigate to Finance tab
5. Verify: Full edit controls visible (Approve/Reject buttons)

**Test 5: Role Config UI** (requires Plan 06-03 completion)
1. Login as Super Admin
2. Navigate to Settings (#/role-config)
3. Verify: Matrix shows all roles and tabs with checkboxes
4. Toggle a checkbox, verify change indicator appears
5. Click "Discard Changes", verify checkbox reverts
6. Toggle a checkbox, click "Save Changes"
7. Verify: Success toast, change persisted (refresh page to confirm)

**Expected Results:**
- All 5 tests pass
- No console errors
- Permissions update in real-time without logout
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. CSS styles for view-only elements render correctly
2. procurement.js has permission checks using canEdit === false pattern
3. finance.js has permission checks using canEdit === false pattern
4. View-only users see data but cannot edit
5. Edit controls hidden when user lacks permission
6. Guard functions prevent unauthorized actions
7. View-only notice appears appropriately
8. Full edit capability preserved for authorized users
</verification>

<success_criteria>
- styles/views.css has view-only CSS styles
- procurement.js respects canEditTab using strict equality (=== false)
- finance.js respects canEditTab using strict equality (=== false)
- Edit buttons/forms conditionally rendered based on permission
- View-only notice displayed for restricted users
- Action handlers guard against unauthorized edits
- Human verification confirms end-to-end permission system works
</success_criteria>

<output>
After completion, create `.planning/phases/06-role-infrastructure-real-time-permissions/06-05-SUMMARY.md`
</output>
