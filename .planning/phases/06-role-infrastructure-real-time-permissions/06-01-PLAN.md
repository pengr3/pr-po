---
phase: 06-role-infrastructure-real-time-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/permissions.js
  - app/seed-roles.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "5 role templates exist in Firestore with correct default permissions"
    - "Permission utilities can check tab access and edit permissions"
    - "Role template listener updates permissions when role config changes"
  artifacts:
    - path: "app/permissions.js"
      provides: "Permission checking utilities and role template listener"
      exports: ["getCurrentPermissions", "hasTabAccess", "canEditTab", "initPermissionsObserver", "destroyPermissionsObserver"]
      min_lines: 80
    - path: "app/seed-roles.js"
      provides: "One-time role template seeding utility"
      min_lines: 50
  key_links:
    - from: "app/permissions.js"
      to: "role_templates collection"
      via: "onSnapshot listener"
      pattern: "onSnapshot.*role_templates"
---

<objective>
Create the permissions module and role templates foundation for the RBAC system

Purpose: Establish the core permission infrastructure that all other Phase 6 plans depend on. This includes the Firestore schema for role templates, a seeding utility to initialize default permissions, and the permissions.js module that provides permission checking utilities and real-time listeners.

Output: Working permissions module with role template listener, 5 role templates in Firestore with default permissions
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-RESEARCH.md
@app/firebase.js
@app/auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permissions.js module with role template listener</name>
  <files>app/permissions.js</files>
  <action>
Create new permissions module following the pattern from 06-RESEARCH.md:

**Module structure:**
```javascript
import { db } from './firebase.js';
import { doc, onSnapshot } from './firebase.js';
```

**Module-level state:**
- `currentPermissions = null` - Stores current user's permissions object
- `roleTemplateUnsubscribe = null` - Cleanup function for role template listener

**Exported functions:**

1. `getCurrentPermissions()` - Returns currentPermissions object or null

2. `hasTabAccess(tabId)` - Returns boolean
   - Check `currentPermissions?.tabs?.[tabId]?.access || false`
   - Tab IDs: 'dashboard' (Home), 'clients', 'projects', 'mrf_form', 'procurement', 'finance', 'role_config'

3. `canEditTab(tabId)` - Returns boolean
   - Check `currentPermissions?.tabs?.[tabId]?.edit || false`

4. `initPermissionsObserver(user)` - Async, sets up role template listener
   - Clean up existing listener first (prevents memory leaks on role change)
   - If no user.role, set currentPermissions to null and return
   - Create onSnapshot listener on `doc(db, 'role_templates', user.role)`
   - On snapshot: extract permissions, store in currentPermissions
   - Dispatch 'permissionsChanged' custom event with { permissions, role }
   - Include error callback that logs permission-denied errors

5. `destroyPermissionsObserver()` - Cleanup function
   - Call roleTemplateUnsubscribe if exists
   - Set currentPermissions to null

**Window exposure:**
```javascript
window.getCurrentPermissions = getCurrentPermissions;
window.hasTabAccess = hasTabAccess;
window.canEditTab = canEditTab;
```

**Console logging:** Use `[Permissions]` prefix for all logs.
  </action>
  <verify>
File exists at app/permissions.js. Check syntax with browser console (no import errors). Exports all 5 functions.
  </verify>
  <done>
permissions.js module created with getCurrentPermissions, hasTabAccess, canEditTab, initPermissionsObserver, destroyPermissionsObserver functions. Window functions exposed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create role template seeding utility</name>
  <files>app/seed-roles.js</files>
  <action>
Create a standalone utility script that can be run once to initialize role templates in Firestore.

**Module structure:**
```javascript
import { db } from './firebase.js';
import { doc, setDoc, serverTimestamp, writeBatch, getDoc } from './firebase.js';
```

**Role templates data (from 06-RESEARCH.md):**

| Role ID | Role Name | dashboard | clients | projects | mrf_form | procurement | finance | role_config |
|---------|-----------|-----------|---------|----------|----------|-------------|---------|-------------|
| super_admin | Super Admin | access+edit | access+edit | access+edit | access+edit | access+edit | access+edit | access+edit |
| operations_admin | Operations Admin | access | access+edit | access+edit | access+edit | access+edit | access | - |
| operations_user | Operations User | access | access | access | access+edit | access | - | - |
| finance | Finance | access | access | access | - | - | access+edit | - |
| procurement | Procurement | access | access | access | - | access+edit | - | - |

**Permission structure per role:**
```javascript
{
  role_id: 'super_admin',
  role_name: 'Super Admin',
  permissions: {
    tabs: {
      dashboard: { access: true, edit: true },
      clients: { access: true, edit: true },
      projects: { access: true, edit: true },
      mrf_form: { access: true, edit: true },
      procurement: { access: true, edit: true },
      finance: { access: true, edit: true },
      role_config: { access: true, edit: true }
    }
  },
  created_at: serverTimestamp(),
  updated_at: serverTimestamp()
}
```

**Main function: `seedRoleTemplates()`**
1. Check if role_templates already exist (getDoc for 'super_admin')
2. If exists, log warning and return (don't overwrite existing config)
3. Create writeBatch()
4. Add all 5 role documents to batch
5. Commit batch
6. Log success message

**Also export a `forceReseedRoleTemplates()` function that overwrites existing templates (for testing/reset purposes).**

**Window exposure:**
```javascript
window.seedRoleTemplates = seedRoleTemplates;
window.forceReseedRoleTemplates = forceReseedRoleTemplates;
```

**Console logging:** Use `[RoleSeeder]` prefix.
  </action>
  <verify>
File exists at app/seed-roles.js. Run in browser console: `import('./app/seed-roles.js').then(m => m.seedRoleTemplates())`. Check Firestore console for 5 role_templates documents.
  </verify>
  <done>
seed-roles.js created. Running seedRoleTemplates() creates 5 role template documents in Firestore with correct default permissions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Seed role templates in Firestore</name>
  <files>N/A - Firestore data operation</files>
  <action>
Run the seeding utility to populate role templates in Firestore.

**Steps:**
1. Start local server: `python -m http.server 8000` (if not running)
2. Open browser to http://localhost:8000
3. Open browser DevTools Console (F12)
4. Run: `import('./app/seed-roles.js').then(m => m.seedRoleTemplates())`
5. Wait for success message
6. Verify in Firestore console (https://console.firebase.google.com/project/clmc-procurement/firestore/data/role_templates)

**Expected Firestore documents:**
- role_templates/super_admin
- role_templates/operations_admin
- role_templates/operations_user
- role_templates/finance
- role_templates/procurement

Each document should have: role_id, role_name, permissions.tabs, created_at, updated_at
  </action>
  <verify>
Firestore console shows 5 documents in role_templates collection. Each has correct permissions structure with tabs object containing dashboard, clients, projects, mrf_form, procurement, finance, role_config keys.
  </verify>
  <done>
5 role templates seeded in Firestore with correct default permissions structure.
  </done>
</task>

</tasks>

<verification>
1. `app/permissions.js` exists and exports 5 functions
2. `app/seed-roles.js` exists and exports seedRoleTemplates, forceReseedRoleTemplates
3. Firestore has 5 role_templates documents with correct structure
4. Browser console shows no errors when importing permissions.js
5. `window.hasTabAccess` and `window.canEditTab` are available (undefined until initPermissionsObserver called)
</verification>

<success_criteria>
- permissions.js module created with all utility functions
- Role template seeding utility created and successfully run
- 5 role templates exist in Firestore with correct default permissions
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-role-infrastructure-real-time-permissions/06-01-SUMMARY.md`
</output>
