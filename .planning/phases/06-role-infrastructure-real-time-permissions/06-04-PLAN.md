---
phase: 06-role-infrastructure-real-time-permissions
plan: 04
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - app/views/procurement.js
  - app/views/finance.js
  - app/views/clients.js
  - app/views/projects.js
  - app/views/mrf-form.js
autonomous: false

must_haves:
  truths:
    - "Users with view-only access see data but cannot create/edit/delete"
    - "Edit buttons and forms are hidden when user lacks edit permission"
    - "View-only notice appears when user has access but no edit rights"
    - "Full edit capability remains for users with edit permission"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Permission-aware procurement view"
      contains: "canEditTab"
    - path: "app/views/finance.js"
      provides: "Permission-aware finance view"
      contains: "canEditTab"
    - path: "app/views/clients.js"
      provides: "Permission-aware clients view"
      contains: "canEditTab"
    - path: "app/views/projects.js"
      provides: "Permission-aware projects view"
      contains: "canEditTab"
  key_links:
    - from: "app/views/*.js"
      to: "window.canEditTab"
      via: "permission check in render and action handlers"
      pattern: "canEditTab.*edit"
---

<objective>
Enforce edit mode vs view-only mode in existing views based on role permissions

Purpose: Implement the final layer of permission enforcement by conditionally showing/hiding edit controls within each view. Users with view-only access can see data but cannot modify it, while users with edit permission retain full capability.

Output: All main views respect edit permissions with appropriate UI feedback
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-RESEARCH.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-01-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-02-SUMMARY.md
@app/views/procurement.js
@app/views/finance.js
@app/views/clients.js
@app/views/projects.js
@app/views/mrf-form.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit permission checks to clients.js view</name>
  <files>app/views/clients.js</files>
  <action>
Add permission-based rendering to the clients view.

**Pattern to implement:**

1. **At the top of render() function, get edit permission:**
```javascript
const canEdit = window.canEditTab?.('clients') ?? true; // Default true for backwards compatibility
```

2. **Conditionally render "Add Client" button:**
```javascript
${canEdit ? `
    <button class="btn btn-primary" onclick="window.showAddClientModal()">
        <span class="btn-icon">+</span>
        Add Client
    </button>
` : ''}
```

3. **Conditionally render action buttons in table rows:**
```javascript
${canEdit ? `
    <td class="actions-cell">
        <button class="btn btn-sm btn-secondary" onclick="window.editClient('${client.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="window.deleteClient('${client.id}')">Delete</button>
    </td>
` : `
    <td class="actions-cell">
        <span class="view-only-badge">View Only</span>
    </td>
`}
```

4. **Add view-only notice at top (when applicable):**
```javascript
${!canEdit ? `
    <div class="view-only-notice">
        <span class="notice-icon">üëÅ</span>
        <span>You have view-only access to this section.</span>
    </div>
` : ''}
```

5. **Guard action functions (double-check in handlers):**
In showAddClientModal, editClient, deleteClient functions:
```javascript
if (!window.canEditTab?.('clients')) {
    showToast('You do not have permission to edit clients', 'error');
    return;
}
```

**CSS for view-only elements (will be added in Task 3):**
- `.view-only-notice` - Banner at top of view
- `.view-only-badge` - Small label replacing action buttons
  </action>
  <verify>
Login as user with clients.edit=false -> "Add Client" button hidden, table shows "View Only" instead of Edit/Delete buttons. Login as user with clients.edit=true -> full edit capability.
  </verify>
  <done>
clients.js updated with permission checks: Add/Edit/Delete buttons hidden for view-only users, notice displayed, action handlers guard against unauthorized edits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add edit permission checks to projects.js and mrf-form.js views</name>
  <files>app/views/projects.js, app/views/mrf-form.js</files>
  <action>
Apply same permission pattern to projects and MRF form views.

**For app/views/projects.js:**

1. Get permission at render: `const canEdit = window.canEditTab?.('projects') ?? true;`

2. Conditionally render "Add Project" button

3. Conditionally render Edit/Delete action buttons in project list (or "View Only" badge)

4. Guard action functions: showAddProjectModal, editProject, deleteProject

5. Add view-only notice when !canEdit

**For app/views/mrf-form.js:**

This view IS the edit/create form. If user doesn't have mrf_form.edit permission:

1. Get permission at render: `const canEdit = window.canEditTab?.('mrf_form') ?? true;`

2. If !canEdit, render a different view:
```javascript
if (!canEdit) {
    return `
        <div class="container" style="padding: 2rem;">
            <div class="view-only-notice">
                <span class="notice-icon">üëÅ</span>
                <span>You have view-only access. You cannot create or edit Material Requests.</span>
            </div>
            <button class="btn btn-secondary" onclick="location.hash='#/'">
                Back to Dashboard
            </button>
        </div>
    `;
}
```

3. This effectively blocks the entire form for view-only users. Alternative: Show form as read-only, but since this is specifically for creating NEW MRFs, blocking makes more sense.

**Note:** MRF viewing happens in procurement.js MRF details panel, not in mrf-form.js. Users with mrf_form.access=true, edit=false can still VIEW MRFs through procurement tab.
  </action>
  <verify>
Projects: Login as user with projects.edit=false -> Add button hidden, view-only notice shown. MRF Form: Login as user with mrf_form.edit=false -> shows blocked message. Both views work normally with edit=true.
  </verify>
  <done>
projects.js and mrf-form.js updated with permission checks. Projects view hides edit controls for view-only users. MRF form shows blocked message for users without edit permission.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add edit permission checks to procurement.js and finance.js, add CSS</name>
  <files>app/views/procurement.js, app/views/finance.js, styles/views.css</files>
  <action>
**For app/views/procurement.js (3,761 lines - careful with targeted changes):**

1. Get permission at render/init: `const canEdit = window.canEditTab?.('procurement') ?? true;`

2. Key areas to conditionally render/guard:
   - MRF tab: "Process MRF" action buttons, "Generate PR/TR" buttons
   - Supplier tab: "Add Supplier" button, Edit/Delete supplier actions
   - PR/TR tab: Generation buttons
   - PO tab: Status update buttons, "Create PO" button

3. Add view-only notice at top of each tab section when !canEdit

4. Guard key action functions:
   - processMRF, generatePR, generateTR, generatePRandTR
   - showAddSupplierModal, editSupplier, deleteSupplier
   - updatePOStatus, createPO

**For app/views/finance.js (1,077 lines):**

1. Get permission: `const canEdit = window.canEditTab?.('finance') ?? true;`

2. Key areas to conditionally render/guard:
   - Pending Approvals tab: Approve/Reject buttons for PRs/TRs
   - PO tab: Status update actions
   - Historical tab: (mostly read-only already)

3. Add view-only notice when !canEdit

4. Guard action functions:
   - approvePR, rejectPR, approveTR, rejectTR
   - updatePOPaymentStatus

**For styles/views.css - Add view-only styles:**
```css
/* ========================================
   VIEW-ONLY PERMISSION STYLES
   ======================================== */

.view-only-notice {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-700);
    font-size: 0.9375rem;
}

.view-only-notice .notice-icon {
    font-size: 1.125rem;
}

.view-only-badge {
    display: inline-block;
    background: var(--gray-200);
    color: var(--gray-600);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

/* Disabled form elements for view-only */
.view-only input,
.view-only select,
.view-only textarea {
    pointer-events: none;
    background: var(--gray-100);
    color: var(--gray-600);
}

.view-only button.btn-primary,
.view-only button.btn-danger {
    display: none;
}
```
  </action>
  <verify>
Procurement: Login as Finance role (procurement.edit=false if configured) -> action buttons hidden, view-only notice shown. Finance: Login as Procurement role (finance.edit=false) -> action buttons hidden. Both views work normally for users with edit=true.
  </verify>
  <done>
procurement.js and finance.js updated with permission checks. View-only CSS styles added. All main views now respect edit permissions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 6 permission system with:
- 5 role templates in Firestore with default permissions
- Real-time permission loading on login
- Navigation filtering based on tab access
- Router blocking unpermitted routes
- Role configuration UI for Super Admin
- Edit mode vs view-only enforcement in all views
  </what-built>
  <how-to-verify>
**Setup:**
1. Ensure role templates are seeded (from 06-01)
2. Create test users with different roles (or modify existing user's role in Firestore)

**Test 1: Navigation Filtering**
1. Login as Super Admin user (role: super_admin)
2. Verify all nav tabs visible including "Settings"
3. Logout, login as Finance role user
4. Verify: Home, Clients, Projects, Finance visible; Procurement, Material Request, Settings hidden

**Test 2: Route Blocking**
1. While logged in as Finance role, manually type #/procurement in URL bar
2. Verify: "Access Denied" page shown with "Go to Dashboard" button

**Test 3: Real-time Permission Updates**
1. Login as Super Admin in Browser A
2. Login as different Super Admin (or use Firestore console) in Browser B
3. In Browser B: Navigate to Settings, uncheck "Finance - Access - Projects"
4. In Browser A (if logged in as Finance): Verify Projects nav link disappears immediately (no logout)

**Test 4: Edit vs View-Only**
1. Login as Finance role (which has finance.edit=true but clients.edit=false by default)
2. Navigate to Clients tab
3. Verify: View-only notice shown, "Add Client" button hidden, table shows "View Only" badge
4. Navigate to Finance tab
5. Verify: Full edit controls visible (Approve/Reject buttons)

**Test 5: Role Config UI**
1. Login as Super Admin
2. Navigate to Settings (#/role-config)
3. Verify: Matrix shows all roles and tabs with checkboxes
4. Toggle a checkbox, verify change indicator appears
5. Click "Discard Changes", verify checkbox reverts
6. Toggle a checkbox, click "Save Changes"
7. Verify: Success toast, change persisted (refresh page to confirm)

**Expected Results:**
- All 5 tests pass
- No console errors
- Permissions update in real-time without logout
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. All existing views have permission checks
2. View-only users see data but cannot edit
3. Edit controls hidden when user lacks permission
4. Guard functions prevent unauthorized actions
5. View-only notice appears appropriately
6. CSS styles render correctly
7. Full edit capability preserved for authorized users
</verification>

<success_criteria>
- procurement.js, finance.js, clients.js, projects.js, mrf-form.js all respect canEditTab
- Edit buttons/forms conditionally rendered based on permission
- View-only notice displayed for restricted users
- Action handlers guard against unauthorized edits
- CSS styles for view-only elements
- Human verification confirms end-to-end permission system works
</success_criteria>

<output>
After completion, create `.planning/phases/06-role-infrastructure-real-time-permissions/06-04-SUMMARY.md`
</output>
