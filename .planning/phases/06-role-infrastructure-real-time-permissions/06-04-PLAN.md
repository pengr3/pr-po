---
phase: 06-role-infrastructure-real-time-permissions
plan: 04
type: execute
wave: 4
depends_on: [06-01, 06-02, 06-03]
files_modified:
  - app/views/clients.js
  - app/views/projects.js
  - app/views/mrf-form.js
autonomous: true

must_haves:
  truths:
    - "Users with view-only access see data but cannot create/edit/delete"
    - "Edit buttons and forms are hidden when user lacks edit permission"
    - "View-only notice appears when user has access but no edit rights"
    - "Full edit capability remains for users with edit permission"
  artifacts:
    - path: "app/views/clients.js"
      provides: "Permission-aware clients view"
      contains: "canEditTab"
    - path: "app/views/projects.js"
      provides: "Permission-aware projects view"
      contains: "canEditTab"
    - path: "app/views/mrf-form.js"
      provides: "Permission-aware mrf-form view"
      contains: "canEditTab"
  key_links:
    - from: "app/views/*.js"
      to: "window.canEditTab"
      via: "permission check in render and action handlers"
      pattern: "canEditTab.*=== false"
---

<objective>
Enforce edit mode vs view-only mode in clients, projects, and mrf-form views based on role permissions

Purpose: Implement the first part of permission enforcement by conditionally showing/hiding edit controls in the simpler views. Users with view-only access can see data but cannot modify it, while users with edit permission retain full capability.

Output: clients.js, projects.js, and mrf-form.js views respect edit permissions with appropriate UI feedback
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-RESEARCH.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-01-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-02-SUMMARY.md
@.planning/phases/06-role-infrastructure-real-time-permissions/06-03-SUMMARY.md
@app/views/clients.js
@app/views/projects.js
@app/views/mrf-form.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit permission checks to clients.js view</name>
  <files>app/views/clients.js</files>
  <action>
Add permission-based rendering to the clients view.

**Pattern to implement:**

1. **At the top of render() function, get edit permission:**
```javascript
const canEdit = window.canEditTab?.('clients');
// IMPORTANT: Use strict equality to distinguish undefined (not loaded) from false (no permission)
// canEdit === false -> no permission, hide edit controls
// canEdit === undefined -> not loaded yet, show controls (backwards compatible)
// canEdit === true -> has permission, show controls
const showEditControls = canEdit !== false;
```

2. **Conditionally render "Add Client" button:**
```javascript
${showEditControls ? `
    <button class="btn btn-primary" onclick="window.showAddClientModal()">
        <span class="btn-icon">+</span>
        Add Client
    </button>
` : ''}
```

3. **Conditionally render action buttons in table rows:**
```javascript
${showEditControls ? `
    <td class="actions-cell">
        <button class="btn btn-sm btn-secondary" onclick="window.editClient('${client.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="window.deleteClient('${client.id}')">Delete</button>
    </td>
` : `
    <td class="actions-cell">
        <span class="view-only-badge">View Only</span>
    </td>
`}
```

4. **Add view-only notice at top (when applicable):**
```javascript
${canEdit === false ? `
    <div class="view-only-notice">
        <span class="notice-icon">üëÅ</span>
        <span>You have view-only access to this section.</span>
    </div>
` : ''}
```

5. **Guard action functions (double-check in handlers):**
In showAddClientModal, editClient, deleteClient functions:
```javascript
if (window.canEditTab?.('clients') === false) {
    showToast('You do not have permission to edit clients', 'error');
    return;
}
```

**CSS for view-only elements (will be added in Plan 06-05):**
- `.view-only-notice` - Banner at top of view
- `.view-only-badge` - Small label replacing action buttons
  </action>
  <verify>
Login as user with clients.edit=false -> "Add Client" button hidden, table shows "View Only" instead of Edit/Delete buttons. Login as user with clients.edit=true -> full edit capability.
  </verify>
  <done>
clients.js updated with permission checks: Add/Edit/Delete buttons hidden for view-only users (canEdit === false), notice displayed, action handlers guard against unauthorized edits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add edit permission checks to projects.js and mrf-form.js views</name>
  <files>app/views/projects.js, app/views/mrf-form.js</files>
  <action>
Apply same permission pattern to projects and MRF form views.

**For app/views/projects.js:**

1. Get permission at render:
```javascript
const canEdit = window.canEditTab?.('projects');
const showEditControls = canEdit !== false;
```

2. Conditionally render "Add Project" button

3. Conditionally render Edit/Delete action buttons in project list (or "View Only" badge)

4. Guard action functions: showAddProjectModal, editProject, deleteProject
```javascript
if (window.canEditTab?.('projects') === false) {
    showToast('You do not have permission to edit projects', 'error');
    return;
}
```

5. Add view-only notice when canEdit === false

**For app/views/mrf-form.js:**

This view IS the edit/create form. If user doesn't have mrf_form.edit permission:

1. Get permission at render:
```javascript
const canEdit = window.canEditTab?.('mrf_form');
```

2. If canEdit === false, render a different view:
```javascript
if (canEdit === false) {
    return `
        <div class="container" style="padding: 2rem;">
            <div class="view-only-notice">
                <span class="notice-icon">üëÅ</span>
                <span>You have view-only access. You cannot create or edit Material Requests.</span>
            </div>
            <button class="btn btn-secondary" onclick="location.hash='#/'">
                Back to Dashboard
            </button>
        </div>
    `;
}
```

3. This effectively blocks the entire form for view-only users. Alternative: Show form as read-only, but since this is specifically for creating NEW MRFs, blocking makes more sense.

**Note:** MRF viewing happens in procurement.js MRF details panel, not in mrf-form.js. Users with mrf_form.access=true, edit=false can still VIEW MRFs through procurement tab.
  </action>
  <verify>
Projects: Login as user with projects.edit=false -> Add button hidden, view-only notice shown. MRF Form: Login as user with mrf_form.edit=false -> shows blocked message. Both views work normally with edit=true.
  </verify>
  <done>
projects.js and mrf-form.js updated with permission checks using strict equality (=== false). Projects view hides edit controls for view-only users. MRF form shows blocked message for users without edit permission.
  </done>
</task>

</tasks>

<verification>
1. clients.js has permission checks using canEdit === false pattern
2. projects.js has permission checks using canEdit === false pattern
3. mrf-form.js has permission checks using canEdit === false pattern
4. View-only users see data but cannot edit
5. Edit controls hidden when user lacks permission
6. Guard functions prevent unauthorized actions
7. View-only notice appears appropriately
8. Full edit capability preserved for authorized users
</verification>

<success_criteria>
- clients.js, projects.js, mrf-form.js all respect canEditTab using strict equality (=== false)
- Edit buttons/forms conditionally rendered based on permission
- View-only notice displayed for restricted users
- Action handlers guard against unauthorized edits
- Permission loading state (undefined) defaults to showing controls for backwards compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/06-role-infrastructure-real-time-permissions/06-04-SUMMARY.md`
</output>
