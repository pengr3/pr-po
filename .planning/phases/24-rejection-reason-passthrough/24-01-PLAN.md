---
phase: 24-rejection-reason-passthrough
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/finance.js
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "Finance PR rejection reason displays in Procurement MRF Processing (not 'No reason provided')"
    - "Finance TR rejection reason displays in Procurement MRF Processing"
    - "TR-rejected MRFs appear in the Procurement MRF list (not invisible)"
    - "TR-rejected MRFs show red border rejection styling and reason card"
    - "Existing rejected MRFs (with only rejection_reason field) still display their reason"
    - "Rejector name is captured from current logged-in user (not hardcoded)"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Writes pr_rejection_reason to MRF on PR and TR rejection, uses currentUser for rejected_by"
      contains: "pr_rejection_reason: reason"
    - path: "app/views/procurement.js"
      provides: "Queries TR Rejected status, displays rejection reason with fallback chain"
      contains: "TR Rejected"
  key_links:
    - from: "app/views/finance.js submitRejection()"
      to: "Firestore mrfs collection"
      via: "updateDoc writes pr_rejection_reason field"
      pattern: "pr_rejection_reason:\\s*reason"
    - from: "app/views/procurement.js loadMRFs()"
      to: "Firestore mrfs collection"
      via: "query includes TR Rejected status"
      pattern: "TR Rejected"
    - from: "app/views/procurement.js card rendering"
      to: "MRF document fields"
      via: "fallback chain for rejection reason display"
      pattern: "mrf\\.pr_rejection_reason \\|\\| mrf\\.rejection_reason"
---

<objective>
Fix the rejection reason passthrough from Finance to Procurement by correcting a field name mismatch introduced during SPA migration, adding TR rejection visibility, and replacing hardcoded rejector attribution with dynamic user identity.

Purpose: Finance users reject PRs/TRs with reasons that Procurement needs to see to fix and resubmit. Currently, reasons are written to a different field name than what Procurement reads, causing "No reason provided" to always display. TR-rejected MRFs are entirely invisible to Procurement because the status is not in the query filter.

Output: Both PR and TR rejection reasons display correctly in Procurement MRF Processing view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-rejection-reason-passthrough/24-RESEARCH.md
@app/views/finance.js
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix finance.js rejection writes and user attribution</name>
  <files>app/views/finance.js</files>
  <action>
  In the `submitRejection()` function (around line 1807-1893), make these changes:

  **1. PR rejection MRF update (around line 1874-1880):**
  Add `pr_rejection_reason: reason` to the MRF updateDoc call alongside existing `rejection_reason: reason`. Also add dynamic user attribution. Keep `rejection_reason` for backward compatibility. The updated MRF write should include:
  ```
  status: 'PR Rejected',
  rejected_pr_id: request.pr_id,
  pr_rejection_reason: reason,
  rejection_reason: reason,
  is_rejected: true,
  rejected_by: currentUser?.full_name || currentUser?.email || 'Finance User',
  rejected_by_user_id: currentUser?.uid,
  updated_at: new Date().toISOString()
  ```

  **2. TR rejection MRF update (around line 1849-1853):**
  Add `pr_rejection_reason: reason`, `is_rejected: true`, `rejected_tr_id`, and dynamic user attribution. The updated MRF write should include:
  ```
  status: 'TR Rejected',
  rejected_tr_id: request.tr_id || request.pr_id,
  pr_rejection_reason: reason,
  rejection_reason: reason,
  is_rejected: true,
  rejected_by: currentUser?.full_name || currentUser?.email || 'Finance User',
  rejected_by_user_id: currentUser?.uid,
  updated_at: new Date().toISOString()
  ```

  **3. PR document rejection write (around line 1860-1865):**
  Replace hardcoded `rejected_by: 'Ma. Thea Angela R. Lacsamana'` with:
  ```
  rejected_by: currentUser?.full_name || currentUser?.email || 'Finance User',
  rejected_by_user_id: currentUser?.uid
  ```

  **4. TR document rejection write (around line 1835-1840):**
  Replace hardcoded `rejected_by: 'Ma. Thea Angela R. Lacsamana'` with:
  ```
  rejected_by: currentUser?.full_name || currentUser?.email || 'Finance User',
  rejected_by_user_id: currentUser?.uid
  ```

  **5. Add currentUser declaration at top of try block (after line 1829):**
  Add `const currentUser = window.getCurrentUser();` before the `isTransport` check. This follows the same pattern used in the approval functions (lines 1488, 1652).

  IMPORTANT: Do NOT change the structure of the function. Only add/modify the specific fields listed above. Keep all other existing code (error handling, toast messages, loading states) exactly as-is.
  </action>
  <verify>
  Search finance.js for `pr_rejection_reason` -- should appear in both the TR and PR MRF update blocks.
  Search finance.js for `Ma. Thea Angela R. Lacsamana` -- should return zero results (all hardcoded names replaced).
  Search finance.js for `rejected_by_user_id` -- should appear 4 times (2 document writes + 2 MRF writes).
  </verify>
  <done>
  - submitRejection() writes `pr_rejection_reason` to MRF for both PR and TR rejection paths
  - `rejection_reason` also written for backward compatibility
  - TR rejection MRF update includes `is_rejected: true` and `rejected_tr_id`
  - All 4 rejection writes use dynamic `currentUser` instead of hardcoded name
  - No hardcoded person names remain in the rejection flow
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix procurement.js rejection query and display</name>
  <files>app/views/procurement.js</files>
  <action>
  Make these changes to the MRF Processing tab in procurement.js:

  **1. Add TR Rejected to loadMRFs query (line 619):**
  Change:
  ```javascript
  const statuses = ['Pending', 'In Progress', 'PR Rejected', 'Finance Rejected'];
  ```
  To:
  ```javascript
  const statuses = ['Pending', 'In Progress', 'PR Rejected', 'TR Rejected', 'Finance Rejected'];
  ```

  **2. Fix material MRF card isRejected check (line 731):**
  Change:
  ```javascript
  const isRejected = mrf.status === 'PR Rejected';
  ```
  To:
  ```javascript
  const isRejected = mrf.status === 'PR Rejected' || mrf.status === 'TR Rejected';
  ```

  **3. Fix material MRF card rejection label (line 759):**
  Change the hardcoded `'PR REJECTED'` text to be dynamic based on status:
  ```javascript
  ${isRejected ? `<span style="color: #dc2626; font-size: 0.75rem; margin-left: 0.5rem;">${mrf.status === 'TR Rejected' ? 'TR REJECTED' : 'PR REJECTED'}</span>` : ''}
  ```

  **4. Fix material MRF card rejection reason display (line 768):**
  Change:
  ```javascript
  ${mrf.pr_rejection_reason || 'No reason provided'}
  ```
  To:
  ```javascript
  ${mrf.pr_rejection_reason || mrf.rejection_reason || 'No reason provided'}
  ```

  **5. Fix transport MRF card isRejected check (line 796):**
  Change:
  ```javascript
  const isRejected = mrf.status === 'PR Rejected';
  ```
  To:
  ```javascript
  const isRejected = mrf.status === 'PR Rejected' || mrf.status === 'TR Rejected';
  ```

  **6. Fix transport MRF card rejection label (line 815):**
  Change the hardcoded `'PR REJECTED'` text to be dynamic:
  ```javascript
  ${isRejected ? `<span style="color: #dc2626; font-size: 0.75rem; margin-left: 0.5rem;">${mrf.status === 'TR Rejected' ? 'TR REJECTED' : 'PR REJECTED'}</span>` : ''}
  ```

  **7. Fix transport MRF card rejection reason display (line 824):**
  Change:
  ```javascript
  ${mrf.pr_rejection_reason || 'No reason provided'}
  ```
  To:
  ```javascript
  ${mrf.pr_rejection_reason || mrf.rejection_reason || 'No reason provided'}
  ```

  IMPORTANT: Do NOT change any other code in procurement.js. Only touch the 7 specific locations listed above. The PR regeneration code (lines 3039-3199, 3336-3514) already correctly references `pr_rejection_reason` and should NOT be changed.
  </action>
  <verify>
  Search procurement.js for `TR Rejected` -- should appear in the statuses array and in the isRejected checks.
  Search procurement.js for `mrf.rejection_reason` -- should appear as fallback in both card rendering sections.
  Search procurement.js for `'No reason provided'` -- should still exist but now be the third fallback in the chain.
  Confirm `'PR Rejected'` still appears in isRejected checks (it's the first condition, not replaced).
  </verify>
  <done>
  - loadMRFs() query includes 'TR Rejected' status so TR-rejected MRFs appear in the list
  - Both material and transport card sections detect TR rejection with isRejected check
  - Rejection label dynamically shows "PR REJECTED" or "TR REJECTED" based on actual status
  - Rejection reason display uses fallback chain: pr_rejection_reason -> rejection_reason -> 'No reason provided'
  - Existing data with only rejection_reason field still displays correctly
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full passthrough chain:

1. **Field name alignment:** `grep -n "pr_rejection_reason" app/views/finance.js` shows the field being written in both PR and TR rejection paths
2. **No hardcoded names:** `grep -n "Ma. Thea Angela" app/views/finance.js` returns no results
3. **TR query inclusion:** `grep -n "TR Rejected" app/views/procurement.js` shows the status in the query array and isRejected checks
4. **Fallback chain:** `grep -n "mrf.rejection_reason" app/views/procurement.js` shows the fallback in both card rendering sections
5. **Dynamic labels:** `grep -n "TR REJECTED" app/views/procurement.js` shows dynamic label rendering
6. **No regressions in PR regeneration:** `grep -n "pr_rejection_reason" app/views/procurement.js` still shows the field being cleared in regeneration code (lines ~3160, ~3495)
</verification>

<success_criteria>
1. finance.js submitRejection() writes pr_rejection_reason to MRF for both PR and TR paths
2. finance.js uses currentUser for rejected_by attribution (no hardcoded names)
3. procurement.js loadMRFs() queries 'TR Rejected' status
4. procurement.js card rendering detects both PR and TR rejection states
5. procurement.js rejection reason uses fallback chain handling old and new data
6. No changes to any other functions or files
</success_criteria>

<output>
After completion, create `.planning/phases/24-rejection-reason-passthrough/24-01-SUMMARY.md`
</output>
