---
phase: 15-user-data-permission-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/mrf-form.js
autonomous: true

must_haves:
  truths:
    - "User sees their name already filled in when they open the MRF form"
    - "User cannot change the requestor name to someone else's name"
    - "After submitting an MRF, the requestor name remains filled for the next submission"
    - "After resetting the form, the requestor name remains filled"
  artifacts:
    - path: "app/views/mrf-form.js"
      provides: "Auto-populated requestor name from getCurrentUser()"
      contains: "getCurrentUser"
  key_links:
    - from: "app/views/mrf-form.js"
      to: "window.getCurrentUser()"
      via: "init() reads full_name and sets input value"
      pattern: "getCurrentUser.*full_name"
    - from: "app/views/mrf-form.js requestorName input"
      to: "handleFormSubmit"
      via: "readonly input submits value with form"
      pattern: "readOnly.*true"
---

<objective>
Auto-populate the MRF form "Your Name" field from the logged-in user's identity so users never need to type their name manually.

Purpose: Eliminates manual name entry errors and ensures MRF requestor_name always matches the authenticated user's identity from Firestore. This is success criterion #1 of Phase 15.

Output: Modified mrf-form.js where the requestor name field is auto-filled from getCurrentUser().full_name and made readonly.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-user-data-permission-improvements/15-RESEARCH.md

@app/views/mrf-form.js
@app/auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make requestor name field readonly and auto-populated in render()</name>
  <files>app/views/mrf-form.js</files>
  <action>
  In the render() function of mrf-form.js, modify the "Your Name" input field (line ~114-115) to be readonly with visual styling indicating it is auto-populated:

  1. Change the input from:
     `<input type="text" id="requestorName" required>`
     to:
     `<input type="text" id="requestorName" readonly required style="background: #f8fafc; cursor: not-allowed; color: #475569;">`

  2. Change the label from "Your Name *" to "Requestor Name" (since it is auto-populated, "Your Name" is redundant -- the system knows who you are).

  3. Add a small hint text below the field: `<small style="color: #64748b; font-size: 0.8rem;">Auto-populated from your account</small>`

  Use readonly (NOT disabled) because disabled fields do not submit their values with the form. Readonly submits the value but prevents editing.
  </action>
  <verify>Open the app in browser, navigate to MRF form. The "Requestor Name" field should appear with a gray background and show the hint text. The field should not be editable (cursor should show not-allowed).</verify>
  <done>Requestor name input has readonly attribute, gray background styling, and hint text in the rendered HTML.</done>
</task>

<task type="auto">
  <name>Task 2: Auto-populate requestor name from getCurrentUser() in init(), resetForm(), and post-submission</name>
  <files>app/views/mrf-form.js</files>
  <action>
  In the init() function of mrf-form.js, add auto-population logic AFTER the existing date setup (after line ~227) but BEFORE loadProjects():

  1. Get the current user:
     ```javascript
     const user = window.getCurrentUser?.();
     if (user && user.full_name) {
         const requestorInput = document.getElementById('requestorName');
         if (requestorInput) {
             requestorInput.value = user.full_name;
         }
     }
     ```

  2. Also modify the resetForm() function (window.resetForm, line ~480) to re-populate the name after reset. After `document.getElementById('mrfForm').reset();` add:
     ```javascript
     // Re-populate requestor name after reset
     const user = window.getCurrentUser?.();
     if (user && user.full_name) {
         const requestorInput = document.getElementById('requestorName');
         if (requestorInput) {
             requestorInput.value = user.full_name;
         }
     }
     ```

  3. Similarly, in the handleFormSubmit success timeout (line ~558, after form reset), add the same re-population:
     ```javascript
     // Re-populate requestor name after submission reset
     const currentUser = window.getCurrentUser?.();
     if (currentUser && currentUser.full_name) {
         const nameInput = document.getElementById('requestorName');
         if (nameInput) nameInput.value = currentUser.full_name;
     }
     ```

  IMPORTANT: Do NOT import getCurrentUser from auth.js. It is already available on `window.getCurrentUser` (set in auth.js line 534). Using the window global is the established pattern in this codebase for cross-module access.
  </action>
  <verify>
  Test all three code paths that populate the requestor name:

  1. **init() path**: Open the app, log in, navigate to MRF form (#/mrf-form). The requestor name field should show your full_name automatically.
  2. **resetForm() path**: Click "Reset Form" and confirm. The field should still show your name after reset.
  3. **post-submission path**: Fill out all required MRF fields and submit a valid MRF. After the 2-second success timeout resets the form, verify the requestor name field is still populated with your name (do NOT navigate away -- watch the form reset in place).
  4. Check browser console for any errors related to getCurrentUser.
  5. Check a submitted MRF document in Firestore -- requestor_name should contain the user's full_name.
  </verify>
  <done>
  - MRF form auto-populates requestor name from getCurrentUser().full_name on init
  - Form reset preserves the auto-populated name
  - Post-submission reset preserves the auto-populated name (verified by watching form reset after successful submit)
  - No console errors
  - Submitted MRFs contain the correct requestor_name
  </done>
</task>

</tasks>

<verification>
1. Navigate to MRF form while logged in -- requestor name is pre-filled and readonly
2. Try to type in the requestor name field -- field does not accept input
3. Submit an MRF -- requestor_name in Firestore matches the logged-in user's full_name
4. After submission, wait for the 2-second reset -- requestor name is still populated
5. Reset form manually -- requestor name is still populated
6. Navigate away and back to MRF form -- requestor name is still populated
</verification>

<success_criteria>
- The "Your Name" field is replaced with a readonly "Requestor Name" field
- Field auto-populates with getCurrentUser().full_name on page load
- Field value persists through form resets and post-submission resets
- Submitted MRF documents contain the authenticated user's full_name as requestor_name
</success_criteria>

<output>
After completion, create `.planning/phases/15-user-data-permission-improvements/15-01-SUMMARY.md`
</output>
