---
phase: 12-finance-review-workflow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/finance.js
autonomous: true

must_haves:
  truths:
    - "Review modals close when user presses ESC key"
    - "Multiple modals can be open and ESC closes the active one"
    - "Event listeners cleaned up when leaving finance view"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Modal ESC key handling with AbortController cleanup"
      min_lines: 1100
      exports: ["render", "init", "destroy"]
  key_links:
    - from: "app/views/finance.js:setupModalListeners()"
      to: "document keydown event"
      via: "addEventListener with AbortController signal"
      pattern: "addEventListener.*keydown.*signal"
    - from: "app/views/finance.js:destroy()"
      to: "modalAbortController"
      via: "abort() call for cleanup"
      pattern: "modalAbortController\\.abort\\(\\)"
    - from: "ESC key press"
      to: "closePRModal() or closeRejectionModal()"
      via: "e.key === 'Escape' handler"
      pattern: "e\\.key === 'Escape'"
---

<objective>
Add ESC key handling for finance review modals with proper lifecycle cleanup

Purpose: Improve accessibility by enabling keyboard-based modal dismissal (WCAG requirement). Use AbortController pattern for clean event listener management, preventing memory leaks during view navigation.

Output: Finance modals close on ESC key press, with event listeners properly cleaned up when leaving view.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md

# Research findings (AbortController pattern)
@C:\Users\franc\dev\projects\pr-po\.planning\phases\12-finance-review-workflow\12-RESEARCH.md

# File to modify
@C:\Users\franc\dev\projects\pr-po\app\views\finance.js
</context>

<tasks>

<task type="auto">
  <name>Add setupModalListeners() function with AbortController</name>
  <files>app/views/finance.js</files>
  <action>
Add modal keyboard event listener management using AbortController pattern for clean lifecycle.

**Insert after attachWindowFunctions() (added in plan 12-01, before render() function):**

```javascript
/**
 * Setup modal keyboard event listeners
 * Uses AbortController for clean one-call cleanup
 */
let modalAbortController = null;

function setupModalListeners() {
    // Abort previous listeners if they exist (idempotent)
    if (modalAbortController) {
        modalAbortController.abort();
    }

    // Create new controller for this view lifecycle
    modalAbortController = new AbortController();
    const { signal } = modalAbortController;

    // ESC key closes active modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const prModal = document.getElementById('prModal');
            const rejectionModal = document.getElementById('rejectionModal');

            // Close whichever modal is currently active
            if (prModal?.classList.contains('active')) {
                closePRModal();
            } else if (rejectionModal?.classList.contains('active')) {
                closeRejectionModal();
            }
        }
    }, { signal }); // AbortController signal handles cleanup automatically
}
```

**Why AbortController:**
- Single abort() call removes all listeners attached with same signal
- Prevents memory leaks from forgotten removeEventListener calls
- Idempotent (can call setupModalListeners multiple times safely)
- 2026 best practice for event listener lifecycle management

**Why e.key === 'Escape' not e.keyCode === 27:**
- keyCode deprecated 2020, removed from spec 2024
- e.key works with assistive technologies (screen readers)
- String comparison is more readable

**Modal detection logic:**
- Uses optional chaining (prModal?) to handle modal not existing in DOM
- Checks classList.contains('active') to find which modal is open
- Only one modal active at a time in current implementation
- Calls existing close functions (closePRModal, closeRejectionModal) - no new logic
  </action>
  <verify>
1. Search for "let modalAbortController" in finance.js - should be declared at module level
2. Grep for "function setupModalListeners" - function should exist
3. Check for "e.key === 'Escape'" - modern key detection
4. Verify AbortController pattern: new AbortController(), { signal } in addEventListener
5. Count modal checks: should handle both prModal and rejectionModal
  </verify>
  <done>
- modalAbortController variable declared at module scope (before setupModalListeners)
- setupModalListeners() function exists with AbortController pattern
- Event listener uses e.key === 'Escape' (not deprecated keyCode)
- Both prModal and rejectionModal handled in conditional logic
- addEventListener includes { signal } option for cleanup
  </done>
</task>

<task type="auto">
  <name>Call setupModalListeners() in init() and cleanup in destroy()</name>
  <files>app/views/finance.js</files>
  <action>
Wire up modal listener lifecycle to view lifecycle.

**Modify init() function (after attachWindowFunctions() call):**

Add this line after `attachWindowFunctions();` and before the console.log typeof check:

```javascript
    // Setup ESC key modal listeners
    setupModalListeners();
```

Full context should look like:
```javascript
export async function init(activeTab = 'approvals') {
    console.log('[Finance] ðŸ”µ Initializing finance view, tab:', activeTab);

    // CRITICAL: Re-attach window functions every init (router skips destroy on tab switch)
    attachWindowFunctions();

    // Setup ESC key modal listeners
    setupModalListeners();

    console.log('[Finance] Testing window.viewPRDetails availability:', typeof window.viewPRDetails);
```

**Modify destroy() function (at start, before unsubscribing listeners):**

Add after the initial console.log:

```javascript
export async function destroy() {
    console.log('[Finance] ðŸ”´ Destroying finance view...');

    // Cleanup modal event listeners
    if (modalAbortController) {
        modalAbortController.abort();
        modalAbortController = null;
    }

    // Unsubscribe from all Firestore listeners
    listeners.forEach(unsubscribe => {
```

**Why this order:**
- setupModalListeners() in init() ensures listeners active during view lifetime
- Cleanup in destroy() runs BEFORE Firestore listener cleanup (top of function)
- abort() removes all listeners attached with that controller's signal
- Setting to null allows garbage collection
- Idempotent: calling setupModalListeners() multiple times (tab navigation) is safe
  </action>
  <verify>
1. Grep for "setupModalListeners()" in init() - should be called after attachWindowFunctions()
2. Grep for "modalAbortController.abort()" in destroy() - should be called before listener cleanup
3. Verify order: abort() â†’ set to null â†’ forEach listeners cleanup
4. Check init() has setupModalListeners before async operations (loadPRs, loadPOs)
  </verify>
  <done>
- init() calls setupModalListeners() after attachWindowFunctions(), before async loading
- destroy() aborts modalAbortController before Firestore listener cleanup
- modalAbortController set to null after abort for garbage collection
- Lifecycle correctly wired: setup on init, cleanup on destroy
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Modal ESC key handling with AbortController cleanup. Adds keyboard accessibility to finance review modals following WCAG guidelines and 2026 best practices for event listener management.
  </what-built>
  <how-to-verify>
**Setup:**
1. Start dev server: `python -m http.server 8000`
2. Navigate to http://localhost:8000
3. Log in as Finance role user
4. Navigate to Finance > Pending Approvals

**Test Scenario 1: ESC key closes PR review modal**
1. Click "Review" button on any Material Purchase Request
2. Verify modal opens with PR details
3. Press ESC key
   - **Expected:** Modal closes smoothly
   - **Fail if:** Nothing happens, error in console, or page navigation occurs
4. Click "Review" button again
5. Press ESC key again
   - **Expected:** Still works (idempotent listener setup)
   - **Fail if:** Second ESC doesn't work

**Test Scenario 2: ESC key closes rejection modal**
1. Click "Review" button on any Material PR
2. Click "âœ— Reject" button in review modal
3. Verify rejection reason modal opens
4. Press ESC key
   - **Expected:** Rejection modal closes (back to PR review modal OR main list)
   - **Fail if:** Nothing happens or wrong modal closes
5. If back at PR review modal, press ESC again
   - **Expected:** PR review modal closes
   - **Fail if:** Multiple ESC presses needed or unexpected behavior

**Test Scenario 3: ESC key closes TR review modal**
1. Click "Review" button on any Transport Request
2. Verify modal opens with TR details
3. Press ESC key
   - **Expected:** Modal closes
   - **Fail if:** Nothing happens or error occurs

**Test Scenario 4: ESC key works after tab navigation**
1. With modal closed, navigate to Finance > Purchase Orders
2. Navigate back to Finance > Pending Approvals
3. Click "Review" button on Material PR
4. Press ESC key
   - **Expected:** Modal closes (listener re-setup on init)
   - **Fail if:** ESC doesn't work after tab switch

**Test Scenario 5: Event listeners cleaned up on view navigation**
1. Open any review modal, press ESC to close
2. Navigate away from Finance view (e.g., to #/home)
3. Open browser DevTools > Console
4. Type `console.log('Testing ESC cleanup')` then press ESC key
   - **Expected:** Only your test log appears (no finance modal logic runs)
   - **Fail if:** Console shows modal-related activity when Finance view not active
5. Check Network tab for Firestore requests
   - **Expected:** No finance-related queries after leaving view
   - **Fail if:** Finance listeners still fetching data

**Test Scenario 6: Verify modern e.key usage (accessibility)**
1. Open browser DevTools > Sources tab
2. Navigate to app/views/finance.js
3. Find the setupModalListeners function
4. Verify code uses `e.key === 'Escape'`
   - **Expected:** Modern e.key string comparison
   - **Fail if:** Uses deprecated e.keyCode === 27

**Console verification:**
During tests, verify no errors appear like:
- "Cannot read property 'abort' of null"
- "addEventListener is not a function"
- "modalAbortController is not defined"
  </how-to-verify>
  <resume-signal>
Type "approved" if all scenarios pass, or describe which specific scenario failed with details.
  </resume-signal>
</task>

</tasks>

<verification>
**Modal listener setup:**
```bash
# Verify setupModalListeners exists
grep -n "function setupModalListeners" app/views/finance.js

# Verify AbortController pattern
grep -n "new AbortController()" app/views/finance.js
grep -n "{ signal }" app/views/finance.js

# Verify modern e.key usage (not deprecated keyCode)
grep "e.key === 'Escape'" app/views/finance.js
```

**Lifecycle integration:**
```bash
# Verify init() calls setupModalListeners
grep -A5 "attachWindowFunctions();" app/views/finance.js | grep "setupModalListeners"

# Verify destroy() aborts controller
grep -A3 "Destroying finance view" app/views/finance.js | grep "modalAbortController.abort"
```

**Modal detection:**
```bash
# Verify both modals handled
grep -A5 "e.key === 'Escape'" app/views/finance.js | grep -E "(prModal|rejectionModal)"
```
</verification>

<success_criteria>
**Requirement FIN-01 enhanced:**
- âœ… Transport Request review modals close on ESC key press

**Requirement FIN-02 enhanced:**
- âœ… Material Purchase Request review modals close on ESC key press

**Observable behaviors:**
1. User opens PR review modal â†’ ESC key closes modal
2. User opens TR review modal â†’ ESC key closes modal
3. User opens rejection modal â†’ ESC key closes rejection modal
4. After tab navigation, ESC key still works (listeners re-setup in init)
5. After leaving Finance view, ESC key no longer triggers finance modal logic (cleanup successful)
6. No console errors related to event listener lifecycle

**Code quality:**
- setupModalListeners() uses AbortController for automatic cleanup
- Uses modern e.key === 'Escape' (not deprecated keyCode)
- Idempotent: calling setupModalListeners() multiple times is safe
- destroy() properly aborts controller before Firestore listener cleanup
- Event listeners don't leak after view navigation

**Accessibility:**
- Keyboard-only users can dismiss modals
- Follows WCAG 2.1 success criterion 2.1.1 (Keyboard accessible)
- Compatible with assistive technologies (e.key works with screen readers)
</success_criteria>

<output>
After completion, create `C:\Users\franc\dev\projects\pr-po\.planning\phases\12-finance-review-workflow\12-02-SUMMARY.md`

Include:
- AbortController pattern benefits: single abort() call, prevents memory leaks
- Why e.key vs keyCode: modern standard, accessibility compliance
- Modal detection logic: classList.contains('active') check
- Lifecycle integration: setupModalListeners in init, abort in destroy
- Verification results from manual testing scenarios
</output>
