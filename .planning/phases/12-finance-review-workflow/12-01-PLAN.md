---
phase: 12-finance-review-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/finance.js
autonomous: true

must_haves:
  truths:
    - "Finance user clicks Review button on Material Purchase Request and modal opens"
    - "Finance user clicks Review button on Transport Request and modal opens"
    - "Finance user can approve PR and status updates in real-time"
    - "Finance user can approve TR and status updates in real-time"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Window function lifecycle management with attachWindowFunctions()"
      min_lines: 1077
      exports: ["render", "init", "destroy"]
  key_links:
    - from: "app/views/finance.js:init()"
      to: "window.viewPRDetails"
      via: "attachWindowFunctions() call"
      pattern: "attachWindowFunctions\\(\\)"
    - from: "HTML onclick handlers"
      to: "window.viewPRDetails, window.viewTRDetails"
      via: "window object reference"
      pattern: "window\\.(viewPRDetails|viewTRDetails)"
    - from: "app/views/finance.js"
      to: "Firestore listeners"
      via: "onSnapshot real-time updates"
      pattern: "onSnapshot.*finance_status.*Pending"
---

<objective>
Fix window function lifecycle management in finance.js to enable PR/TR review workflow

Purpose: Eliminate "window.viewTRDetails is not a function" error by implementing the established attachWindowFunctions() pattern from procurement.js. This ensures onclick handlers work correctly after tab navigation.

Output: Finance review buttons work reliably, with window functions re-attached on every init() call to handle router's tab-switching optimization.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md

# Research findings
@C:\Users\franc\dev\projects\pr-po\.planning\phases\12-finance-review-workflow\12-RESEARCH.md

# Working pattern reference (verified in production)
@C:\Users\franc\dev\projects\pr-po\app\views\procurement.js

# File to fix
@C:\Users\franc\dev\projects\pr-po\app\views\finance.js

# Router behavior explanation
@C:\Users\franc\dev\projects\pr-po\app\router.js
</context>

<tasks>

<task type="auto">
  <name>Add attachWindowFunctions() pattern to finance.js</name>
  <files>app/views/finance.js</files>
  <action>
Add centralized window function attachment pattern following procurement.js lines 40-89.

**Insert after line 15 (after currentPRForRejection declaration):**

```javascript
/**
 * Attach all window functions for use in onclick handlers
 * This needs to be called every time init() runs to ensure
 * functions are available after tab navigation
 */
function attachWindowFunctions() {
    console.log('[Finance] Attaching window functions...');

    // PR/TR Review Functions
    window.refreshPRs = refreshPRs;
    window.viewPRDetails = viewPRDetails;
    window.viewTRDetails = viewTRDetails;
    window.approvePR = approvePR;
    window.approveTR = approveTR;
    window.rejectPR = rejectPR;

    // Modal Management
    window.closePRModal = closePRModal;
    window.closeRejectionModal = closeRejectionModal;
    window.submitRejection = submitRejection;

    // PO Functions
    window.refreshPOs = refreshPOs;

    console.log('[Finance] âœ… All window functions attached successfully');
}
```

**Modify init() function (line 196):**

Replace:
```javascript
export async function init(activeTab = 'approvals') {
    console.log('Initializing finance view, tab:', activeTab);

    try {
        await loadPRs();
```

With:
```javascript
export async function init(activeTab = 'approvals') {
    console.log('[Finance] ðŸ”µ Initializing finance view, tab:', activeTab);

    // CRITICAL: Re-attach window functions every init (router skips destroy on tab switch)
    attachWindowFunctions();

    console.log('[Finance] Testing window.viewPRDetails availability:', typeof window.viewPRDetails);

    try {
        await loadPRs();
```

**Why this fixes the issue:**
- Router skips destroy() when switching tabs within same view (finance/approvals â†’ finance/pos â†’ finance/approvals)
- Window functions were only attached inline (lines 427, 552) on first load, deleted on destroy(), never re-attached
- attachWindowFunctions() in init() ensures functions available after every tab navigation
- Matches working pattern from procurement.js (verified in production, lines 45-89, 331)

**What NOT to do:**
- Do NOT move window function definitions - they stay inline where currently defined
- Do NOT add window.funcName = assignments scattered throughout code
- Do NOT call attachWindowFunctions() in destroy() - that's cleanup time
  </action>
  <verify>
1. Search for "function attachWindowFunctions" in finance.js - should exist
2. Grep for "attachWindowFunctions()" in init() - should be called before loadPRs()
3. Count console.log statements - should see "[Finance] ðŸ”µ Initializing" and "[Finance] âœ… All window functions attached"
4. Verify all 10 window functions listed in attachWindowFunctions() match those deleted in destroy() (lines 232-241)
  </verify>
  <done>
- attachWindowFunctions() function exists with 10 window function assignments
- init() calls attachWindowFunctions() before async operations
- Console logging matches procurement.js pattern ([Finance] prefix, emojis, success confirmation)
- All window functions in attachWindowFunctions() match cleanup list in destroy()
  </done>
</task>

<task type="auto">
  <name>Add debug logging to confirm fix</name>
  <files>app/views/finance.js</files>
  <action>
Add comprehensive logging to diagnose window function lifecycle issues.

**Already added in previous task:**
- Line ~198: `console.log('[Finance] ðŸ”µ Initializing finance view, tab:', activeTab);`
- Line ~203: `console.log('[Finance] Testing window.viewPRDetails availability:', typeof window.viewPRDetails);`

**Add to destroy() function (after line 214):**

Replace:
```javascript
export async function destroy() {
    console.log('Destroying finance view...');
```

With:
```javascript
export async function destroy() {
    console.log('[Finance] ðŸ”´ Destroying finance view...');
```

**Add at end of destroy() (before final console.log on line 243):**

```javascript
    console.log('[Finance] Finance view destroyed');
```

Should already exist - just verify consistent [Finance] prefix.

**Why this helps:**
- [Finance] prefix makes log filtering easy (matches procurement.js pattern)
- Emoji markers (ðŸ”µ init, ðŸ”´ destroy, âœ… success) provide visual scanning
- typeof check confirms function attachment worked before async operations start
- Helps debug if issue resurfaces with different function
  </action>
  <verify>
1. Grep for "\\[Finance\\]" in finance.js - should appear in init(), destroy(), and attachWindowFunctions()
2. Check for emoji markers: ðŸ”µ (init), ðŸ”´ (destroy), âœ… (success)
3. Verify "Testing window.viewPRDetails availability" log exists in init()
  </verify>
  <done>
- All console.log statements use [Finance] prefix
- init() has ðŸ”µ, destroy() has ðŸ”´, attachWindowFunctions() has âœ… markers
- typeof check for window.viewPRDetails exists in init()
- Logging pattern matches procurement.js exactly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Finance review workflow with window function lifecycle fix. Added attachWindowFunctions() pattern to ensure onclick handlers work after tab navigation. Based on verified working pattern from procurement.js.
  </what-built>
  <how-to-verify>
**Setup:**
1. Start dev server: `python -m http.server 8000`
2. Navigate to http://localhost:8000
3. Log in as Finance role user

**Test Scenario 1: Review buttons work on first load**
1. Navigate to Finance tab (#/finance/approvals)
2. Check browser console for "[Finance] ðŸ”µ Initializing finance view, tab: approvals"
3. Check console for "[Finance] âœ… All window functions attached successfully"
4. Check console for "[Finance] Testing window.viewPRDetails availability: function"
5. Click "Review" button on any Material Purchase Request
   - **Expected:** Modal opens showing PR details
   - **Fail if:** "window.viewPRDetails is not a function" error
6. Close modal, click "Review" button on any Transport Request
   - **Expected:** Modal opens showing TR details
   - **Fail if:** "window.viewTRDetails is not a function" error

**Test Scenario 2: Review buttons work after tab navigation (critical test)**
1. From Finance > Pending Approvals, navigate to Finance > Purchase Orders (#/finance/pos)
2. Check console for "[Finance] ðŸ”µ Initializing finance view, tab: pos"
3. Check console for "[Finance] âœ… All window functions attached successfully"
4. Check console does NOT show "[Finance] ðŸ”´ Destroying" (router skips destroy on tab switch)
5. Navigate back to Finance > Pending Approvals (#/finance/approvals)
6. Check console for ANOTHER "[Finance] ðŸ”µ Initializing finance view, tab: approvals"
7. Check console for ANOTHER "[Finance] âœ… All window functions attached successfully"
8. Click "Review" button on Material PR
   - **Expected:** Modal opens (this previously failed)
   - **Fail if:** "window.viewPRDetails is not a function" error
9. Close modal, click "Review" button on Transport Request
   - **Expected:** Modal opens (this is the original blocker from STATE.md)
   - **Fail if:** "window.viewTRDetails is not a function" error

**Test Scenario 3: Approval workflow with real-time updates**
1. From review modal, click "âœ“ Approve" button
2. Confirm approval in browser confirm dialog
   - **Expected:** Modal closes, success toast appears, PR disappears from pending list automatically
   - **Fail if:** PR remains in list, need to refresh, or error occurs
3. Navigate to Finance > Purchase Orders
   - **Expected:** See newly generated PO(s) from approved PR
   - **Fail if:** POs missing or need manual refresh

**Test Scenario 4: Full view navigation cleanup**
1. Navigate away from Finance view to different view (e.g., #/home)
2. Check console for "[Finance] ðŸ”´ Destroying finance view..."
3. Check console for "[Finance] Finance view destroyed"
4. Open browser DevTools > Console, type `window.viewPRDetails` and press Enter
   - **Expected:** undefined (function cleaned up)
   - **Fail if:** function still exists after leaving view
  </how-to-verify>
  <resume-signal>
Type "approved" if all scenarios pass, or describe which specific scenario failed with error message from console.
  </resume-signal>
</task>

</tasks>

<verification>
**Window function lifecycle:**
```bash
# Verify attachWindowFunctions exists
grep -n "function attachWindowFunctions" app/views/finance.js

# Verify init calls it
grep -n "attachWindowFunctions()" app/views/finance.js

# Verify all 10 functions attached match destroy cleanup
grep -A15 "function attachWindowFunctions" app/views/finance.js | grep "window\."
grep -A15 "async function destroy" app/views/finance.js | grep "delete window\."
```

**Console logging:**
```bash
# Check for standardized logging pattern
grep "\[Finance\]" app/views/finance.js
```

**Real-time listeners:**
```bash
# Confirm onSnapshot listeners exist for real-time updates
grep "onSnapshot.*finance_status.*Pending" app/views/finance.js
```
</verification>

<success_criteria>
**Requirement FIN-01 complete:**
- âœ… Transport Request Review button works (no window.viewTRDetails error)

**Requirement FIN-02 complete:**
- âœ… Material Purchase Request Review button works (no window.viewPRDetails error)

**Observable behaviors:**
1. Finance user clicks Review on Material PR â†’ modal opens showing PR details, items, amounts
2. Finance user clicks Review on Transport Request â†’ modal opens showing TR details
3. After navigating between Finance tabs and returning, Review buttons still work (no function errors)
4. Finance user approves PR â†’ modal closes, success toast, PR removed from pending list automatically
5. Finance user approves TR â†’ modal closes, success toast, TR removed from pending list automatically
6. Real-time listeners update UI when approval status changes (no manual refresh needed)

**Code quality:**
- attachWindowFunctions() centralized function matches procurement.js pattern
- init() calls attachWindowFunctions() before async operations
- destroy() cleanup matches attachWindowFunctions() list exactly
- Console logging uses consistent [Finance] prefix with emoji markers
</success_criteria>

<output>
After completion, create `C:\Users\franc\dev\projects\pr-po\.planning\phases\12-finance-review-workflow\12-01-SUMMARY.md`

Include:
- Root cause analysis: Router skips destroy() on tab switch, requiring attachWindowFunctions() in init()
- Pattern applied: procurement.js lines 40-89, 331 (verified working pattern)
- Functions fixed: viewPRDetails, viewTRDetails, approvePR, approveTR (and 6 others)
- Verification results from manual testing scenarios
</output>
