---
phase: 08-security-rules-enforcement
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified: []
autonomous: false
user_setup:
  - service: firebase
    why: "Deploy security rules to production"
    dashboard_config:
      - task: "Ensure firebase CLI is logged in"
        location: "Terminal: firebase login (if not already authenticated)"

must_haves:
  truths:
    - "Security rules are deployed to production Firebase"
    - "Production Firestore enforces the deployed rules"
    - "Client-side bypass attempts fail in production"
  artifacts: []
  key_links:
    - from: "firestore.rules"
      to: "Firebase Console"
      via: "firebase deploy --only firestore:rules"
      pattern: "Deploy complete"
---

<objective>
Deploy Security Rules to production Firebase

Purpose: Make server-side enforcement live. This is the final step that closes the client-side bypass vulnerability.
Output: Rules deployed to production Firebase project (clmc-procurement)
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-security-rules-enforcement/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Firebase CLI authentication</name>
  <files>N/A</files>
  <action>
Check if Firebase CLI is authenticated and has access to the project:

```bash
firebase projects:list
```

Expected output should include `clmc-procurement` project.

If not authenticated or project not listed:
- Run `firebase login` (opens browser for OAuth)
- User must complete authentication
- Then re-run `firebase projects:list`

If authentication fails, this task becomes a checkpoint for human action.
  </action>
  <verify>
```bash
firebase projects:list | grep clmc-procurement
```
Shows the project in the list.
  </verify>
  <done>
- Firebase CLI authenticated
- clmc-procurement project accessible
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy security rules to production</name>
  <files>N/A (deployment only)</files>
  <action>
Deploy the rules:

```bash
firebase deploy --only firestore:rules --project clmc-procurement
```

Expected output:
```
=== Deploying to 'clmc-procurement'...

i  deploying firestore
i  firestore: reading indexes from firestore.indexes.json...
i  firestore: releasing rules...

...

+  Deploy complete!
```

If deployment fails:
1. Check error message
2. Common issues:
   - Parse error in rules = fix syntax in firestore.rules
   - Permission denied = re-authenticate with firebase login
   - Project not found = check project ID

Do not proceed until "Deploy complete!" message appears.
  </action>
  <verify>
Deploy command output shows:
- "Deploy complete!"
- No errors or warnings about rules

Additionally, verify in Firebase Console:
- Go to Firebase Console > Firestore Database > Rules tab
- Rules should show the deployed content (may take up to 10 minutes to propagate)
  </verify>
  <done>
- firebase deploy command completed successfully
- Rules deployed to production
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Security Rules deployed to production Firebase protecting all 9 collections</what-built>
  <how-to-verify>
1. Open the application in browser (production URL)
2. Open browser DevTools > Console
3. Log in as a user with limited permissions (e.g., operations_user)
4. Attempt a console bypass - try to write to a collection the user shouldn't have access to:

```javascript
// In browser console while logged in as operations_user:
const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
const { db } = await import('./app/firebase.js');

// Try to create a supplier (operations_user should NOT have this permission)
await setDoc(doc(db, 'suppliers', 'test-bypass'), {
  supplier_name: 'Bypass Test',
  contact_person: 'Test'
});
```

**Expected result:** FirebaseError with "permission-denied" code

If the write succeeds, the rules are not enforcing correctly.

5. Verify normal operations still work:
   - Log in as super_admin
   - Create/edit an MRF
   - Operations should succeed without permission-denied errors
  </how-to-verify>
  <resume-signal>Type "approved" if console bypass was blocked and normal operations work, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
Deployment verified by:
1. Firebase CLI shows "Deploy complete!"
2. Console bypass attempt returns permission-denied
3. Normal operations continue to work for authorized users
</verification>

<success_criteria>
- [ ] Firebase CLI authenticated with clmc-procurement access
- [ ] firebase deploy --only firestore:rules completes successfully
- [ ] Console bypass attempt returns permission-denied error
- [ ] Normal operations work for authorized users
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-rules-enforcement/08-04-SUMMARY.md`
</output>
