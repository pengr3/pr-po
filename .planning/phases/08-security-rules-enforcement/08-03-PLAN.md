---
phase: 08-security-rules-enforcement
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - test/firestore.test.js
autonomous: true

must_haves:
  truths:
    - "Emulator tests pass for all critical security paths"
    - "Unauthenticated access is blocked on all collections"
    - "Pending user access is appropriately restricted"
    - "Each role's primary operations succeed"
    - "Console bypass attempts are blocked"
  artifacts:
    - path: "test/firestore.test.js"
      provides: "Security rules test suite"
      min_lines: 200
      contains: "assertFails"
  key_links:
    - from: "test/firestore.test.js"
      to: "firestore.rules"
      via: "initializeTestEnvironment reads rules file"
      pattern: 'readFileSync.*firestore.rules'
---

<objective>
Write and run Security Rules test suite against Firebase Emulator

Purpose: Verify all security rules work correctly before deploying to production. Tests are the gate - no manual browser verification required.
Output: test/firestore.test.js with ~15-20 test cases covering critical paths
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-security-rules-enforcement/08-CONTEXT.md
@.planning/phases/08-security-rules-enforcement/08-RESEARCH.md
@.planning/phases/08-security-rules-enforcement/08-01-SUMMARY.md
@.planning/phases/08-security-rules-enforcement/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies</name>
  <files>test/package.json, test/node_modules/</files>
  <action>
Navigate to test/ directory and run npm install:
```bash
cd test && npm install
```

This installs:
- @firebase/rules-unit-testing (for emulator testing)
- firebase (Firestore SDK)
- mocha (test runner)

Verify node_modules exists after install.
  </action>
  <verify>
```bash
ls test/node_modules/@firebase/rules-unit-testing
ls test/node_modules/firebase
ls test/node_modules/mocha
```
All directories should exist.
  </verify>
  <done>
- test/node_modules/ exists with all dependencies installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive security rules test suite</name>
  <files>test/firestore.test.js</files>
  <action>
Create test/firestore.test.js with test cases covering critical paths (~15-20 tests):

**Test structure:**
- Import from @firebase/rules-unit-testing: initializeTestEnvironment, assertFails, assertSucceeds
- Import fs for reading rules file
- Import mocha: describe, it, before, beforeEach, after

**Setup:**
- `before`: initializeTestEnvironment with rules from ../firestore.rules
- `beforeEach`: clearFirestore
- `after`: cleanup

**Seed helper function:**
Create test users with different roles/statuses:
- active-super-admin (status: active, role: super_admin)
- active-ops-admin (status: active, role: operations_admin)
- active-ops-user (status: active, role: operations_user, assigned_project_codes: ["CLMC_TEST_2026001"], all_projects: false)
- active-finance (status: active, role: finance)
- active-procurement (status: active, role: procurement)
- pending-user (status: pending, role: null)

**Test categories (per CONTEXT.md):**

1. **Unauthenticated access (2 tests)**
   - Denies read on users collection
   - Denies read on mrfs collection

2. **Pending user restrictions (2 tests)**
   - Allows pending user to read invitation_codes (registration validation)
   - Denies pending user from reading mrfs

3. **users collection (4 tests)**
   - super_admin can read any user
   - operations_admin can read operations_user documents only
   - operations_admin CANNOT read super_admin/finance/procurement docs
   - User self-create must have status: pending

4. **role_templates collection (2 tests)**
   - Active user can read role templates
   - Only super_admin can write role templates

5. **mrfs collection - role access (3 tests)**
   - super_admin can create MRF
   - operations_user can create MRF
   - finance CANNOT create MRF

6. **mrfs collection - project scoping (2 tests)**
   - operations_user can read MRF with assigned project_code
   - Legacy MRF (no project_code) is readable by operations_user

7. **Console bypass prevention (2 tests)**
   - operations_user cannot update MRF (even though UI hides the button)
   - finance cannot delete MRF

**Test file template (from RESEARCH.md with modifications):**
```javascript
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import {
  assertFails,
  assertSucceeds,
  initializeTestEnvironment,
} from "@firebase/rules-unit-testing";
import { doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "firebase/firestore";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

let testEnv;

// ... rest of test implementation
```

**Critical: Use getDoc/setDoc/deleteDoc from firebase/firestore, not shorthand methods.**
  </action>
  <verify>
File exists and has correct structure:
```bash
wc -l test/firestore.test.js  # Expect 200+ lines
grep -c "describe(" test/firestore.test.js  # Multiple describe blocks
grep -c "it(" test/firestore.test.js  # 15-20 test cases
grep "assertFails" test/firestore.test.js
grep "assertSucceeds" test/firestore.test.js
```
  </verify>
  <done>
- test/firestore.test.js exists with 200+ lines
- Contains 15-20 test cases in multiple describe blocks
- Covers: unauthenticated, pending, users, role_templates, mrfs role access, mrfs project scoping, console bypass
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests against emulator and verify all pass</name>
  <files>N/A (execution only)</files>
  <action>
Start Firebase emulator and run tests:

**Terminal 1 (or background):**
```bash
firebase emulators:start --only firestore
```
Wait for emulator to start (shows "All emulators ready!")

**Terminal 2:**
```bash
cd test && npm test
```

If tests fail:
1. Read the failure message carefully
2. Check if the failure is in the test setup (seed data) or the rule itself
3. Fix the issue in firestore.rules or test/firestore.test.js
4. Re-run tests

Continue until all tests pass.

**Common issues:**
- "ECONNREFUSED" = emulator not running
- "permission-denied" on seed = withSecurityRulesDisabled not used
- Unexpected pass = test setup didn't create the user properly

Stop emulator after tests pass (Ctrl+C in Terminal 1).
  </action>
  <verify>
Test output shows all tests passing:
```
  Unauthenticated access
    ✓ denies read on users collection
    ✓ denies read on mrfs collection

  ... (all other tests)

  XX passing (Xs)
```

No failures or errors in output.
  </verify>
  <done>
- All ~15-20 tests pass
- Emulator started and stopped cleanly
- No permission-denied errors on expected-to-succeed operations
- No unexpected-success on expected-to-fail operations
  </done>
</task>

</tasks>

<verification>
Final verification:
1. `ls test/node_modules/.package-lock.json` - dependencies installed
2. `wc -l test/firestore.test.js` - 200+ lines
3. Test output shows "XX passing" with 0 failures
</verification>

<success_criteria>
- [ ] test/node_modules/ exists with all dependencies
- [ ] test/firestore.test.js exists with 15-20 test cases
- [ ] Tests cover: unauthenticated blocked, pending restricted, role access, project scoping, console bypass
- [ ] All tests pass when run against emulator
- [ ] No test failures or unexpected passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-rules-enforcement/08-03-SUMMARY.md`
</output>
