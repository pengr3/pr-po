---
phase: 04-mrf-project-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [app/views/procurement.js, app/views/finance.js]
autonomous: true

must_haves:
  truths:
    - "MRF list in procurement view shows project code and name"
    - "MRF details in procurement view show complete project information"
    - "PR/TR list in finance view shows project information"
    - "Display handles both legacy (project_name only) and new (project_code + project_name) MRFs"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Updated MRF display with project code + name"
      contains: "project_code"
    - path: "app/views/finance.js"
      provides: "Updated PR/TR display with project information"
      contains: "project_code"
  key_links:
    - from: "app/views/procurement.js"
      to: "mrfs collection"
      via: "reads project_code and project_name fields"
      pattern: "mrf\\.project_code"
    - from: "app/views/finance.js"
      to: "prs/transport_requests collections"
      via: "reads project_name (already inherited from MRF)"
      pattern: "project_name"
---

<objective>
Update MRF and PR/TR display across procurement and finance views to show project information.

Purpose: After Plan 01 changes MRF storage to include project_code, this plan updates all display locations to show the code alongside the name. Also handles backward compatibility for legacy MRFs that only have project_name.

Output: Modified procurement.js and finance.js with updated project display format.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mrf-project-integration/04-RESEARCH.md

# Source files to modify
@app/views/procurement.js
@app/views/finance.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MRF display in procurement view</name>
  <files>app/views/procurement.js</files>
  <action>
Update all locations where MRF project information is displayed to show "CODE - Name" format with fallback for legacy data. Find these lines using grep results from research:

1. **MRF Card Display** (line ~546, ~602):
   ```javascript
   // CHANGE FROM:
   <div style="font-size: 0.875rem; color: #5f6368;">${mrf.project_name}</div>

   // CHANGE TO:
   <div style="font-size: 0.875rem; color: #5f6368;">
       ${mrf.project_code ? mrf.project_code + ' - ' : ''}${mrf.project_name || 'No project'}
   </div>
   ```

2. **MRF Details Panel** (line ~748):
   ```javascript
   // Update the project display in details panel with same pattern
   ```

3. **MRF Table Row** (line ~2280):
   ```javascript
   // CHANGE FROM:
   <td>${mrf.project_name}</td>

   // CHANGE TO:
   <td>${mrf.project_code ? mrf.project_code + ' - ' : ''}${mrf.project_name || 'No project'}</td>
   ```

4. **Project Dropdown in MRF Edit** (line ~723):
   Update the project dropdown when editing MRF to match new format:
   ```javascript
   // CHANGE FROM:
   `<option value="${p.project_name}" ${p.project_name === mrf.project_name ? 'selected' : ''}>${p.project_name}</option>`

   // CHANGE TO:
   `<option value="${p.project_code}" data-project-name="${p.project_name}"
       ${p.project_code === mrf.project_code ? 'selected' :
         (!mrf.project_code && p.project_name === mrf.project_name ? 'selected' : '')}
   >${p.project_code} - ${p.project_name}</option>`
   ```
   Note: The selection logic handles both new MRFs (match by code) and legacy MRFs (match by name)

5. **PR/PO Records generation** (lines ~2507, ~2754, ~3024, ~3083):
   When creating PR/PO documents from MRF, copy both fields:
   ```javascript
   // CHANGE FROM:
   project_name: mrfData.project_name,

   // CHANGE TO:
   project_code: mrfData.project_code || '',
   project_name: mrfData.project_name,
   ```

6. **PO Table Display** (line ~3289):
   ```javascript
   // CHANGE FROM:
   <td>${po.project_name}</td>

   // CHANGE TO:
   <td>${po.project_code ? po.project_code + ' - ' : ''}${po.project_name || 'No project'}</td>
   ```

7. **PR Details Modal** (line ~3510):
   ```javascript
   // CHANGE FROM:
   <div>${pr.project_name}</div>

   // CHANGE TO:
   <div>${pr.project_code ? pr.project_code + ' - ' : ''}${pr.project_name || 'No project'}</div>
   ```

8. **PO Details Modal** (line ~3667):
   ```javascript
   // Same pattern as PR details
   ```

9. **Document Generation** (lines ~4320, ~4371):
   Include project_code in generated documents:
   ```javascript
   // CHANGE FROM:
   PROJECT: pr.project_name,

   // CHANGE TO:
   PROJECT: pr.project_code ? `${pr.project_code} - ${pr.project_name}` : pr.project_name,
   ```

**Backward Compatibility Pattern:**
All displays use this pattern to handle legacy data:
```javascript
${item.project_code ? item.project_code + ' - ' : ''}${item.project_name || 'No project'}
```
- If project_code exists (new MRFs): shows "CODE - Name"
- If only project_name exists (legacy MRFs): shows just "Name"
- If neither exists: shows "No project"
  </action>
  <verify>
1. Navigate to http://localhost:8000/#/procurement/mrfs
2. Check MRF list shows project in format "CODE - Name" for new MRFs
3. Verify legacy MRFs (without project_code) still display correctly
4. Click an MRF to view details - project info displays correctly
5. Check PR/PO records tab - project column shows correct format
6. Open PR details modal - project info displays correctly
7. Open PO details modal - project info displays correctly
  </verify>
  <done>Procurement view displays project code + name throughout, handles legacy MRFs gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Update PR/TR display in finance view</name>
  <files>app/views/finance.js</files>
  <action>
Update all locations where project information is displayed in finance view. Find these lines using grep results from research:

1. **Material PRs Table** (line ~326):
   ```javascript
   // CHANGE FROM:
   <td>${pr.project_name}</td>

   // CHANGE TO:
   <td>${pr.project_code ? pr.project_code + ' - ' : ''}${pr.project_name || 'No project'}</td>
   ```

2. **Transport Requests Table** (line ~375):
   ```javascript
   // Same pattern
   <td>${tr.project_code ? tr.project_code + ' - ' : ''}${tr.project_name || 'No project'}</td>
   ```

3. **PR Details Modal** (line ~458):
   ```javascript
   // CHANGE FROM:
   <div class="modal-detail-value">${pr.project_name}</div>

   // CHANGE TO:
   <div class="modal-detail-value">${pr.project_code ? pr.project_code + ' - ' : ''}${pr.project_name || 'No project'}</div>
   ```

4. **TR Details Display** (line ~580):
   ```javascript
   // CHANGE FROM:
   <div>${tr.project_name}</div>

   // CHANGE TO:
   <div>${tr.project_code ? tr.project_code + ' - ' : ''}${tr.project_name || 'No project'}</div>
   ```

5. **PO Generation from PR** (line ~952):
   When creating PO from approved PR, copy both fields:
   ```javascript
   // CHANGE FROM:
   project_name: pr.project_name,

   // CHANGE TO:
   project_code: pr.project_code || '',
   project_name: pr.project_name,
   ```

6. **Purchase Orders Table** (line ~1045):
   ```javascript
   // CHANGE FROM:
   <td>${po.project_name}</td>

   // CHANGE TO:
   <td>${po.project_code ? po.project_code + ' - ' : ''}${po.project_name || 'No project'}</td>
   ```

**Pattern:**
Same backward-compatible display pattern as Task 1.
  </action>
  <verify>
1. Navigate to http://localhost:8000/#/finance/approvals
2. Check Material PRs table shows project in correct format
3. Check Transport Requests table shows project correctly
4. Click view on a PR - modal shows project info correctly
5. Navigate to http://localhost:8000/#/finance/pos
6. Check Purchase Orders table shows project correctly
7. Verify legacy records (without project_code) display correctly
  </verify>
  <done>Finance view displays project code + name throughout, handles legacy records gracefully</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **MRF List Display (MRF-06):**
   - Navigate to http://localhost:8000/#/procurement/mrfs
   - MRF cards show project as "CODE - Name" for new MRFs
   - Legacy MRFs show just project name

2. **MRF Details Display (MRF-07):**
   - Click any MRF to view details
   - Project information shows complete code + name

3. **Completed Projects (MRF-08):**
   - In Firebase Console, set a project's project_status to "Completed" (keep status='active')
   - Create new MRF for that project
   - Should work - completed projects with active status allow MRFs

4. **Inactive Projects (MRF-09):**
   - In Firebase Console, set a project's status to "inactive"
   - Refresh MRF form
   - Inactive project should NOT appear in dropdown

5. **PR/PO Chain:**
   - Approve an MRF, generate PR
   - Check PR document has project_code field
   - Approve PR, generate PO
   - Check PO document has project_code field
   - All displays show consistent "CODE - Name" format
</verification>

<success_criteria>
- [ ] Procurement MRF list shows project code + name
- [ ] Procurement MRF details show project code + name
- [ ] Procurement PR/PO records show project code + name
- [ ] Finance PR table shows project code + name
- [ ] Finance TR table shows project code + name
- [ ] Finance PO table shows project code + name
- [ ] Legacy records (without project_code) display gracefully
- [ ] Generated PR/PO documents include project_code field
- [ ] No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-mrf-project-integration/04-02-SUMMARY.md`
</output>
