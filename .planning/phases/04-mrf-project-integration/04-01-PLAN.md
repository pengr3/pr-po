---
phase: 04-mrf-project-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/views/mrf-form.js]
autonomous: true

must_haves:
  truths:
    - "MRF form displays project dropdown with format 'CODE - Name'"
    - "Project dropdown shows only active projects"
    - "Project dropdown is sorted by most recent first"
    - "Submitted MRF stores project_code field"
    - "Submitted MRF stores project_name field (denormalized for display)"
  artifacts:
    - path: "app/views/mrf-form.js"
      provides: "Updated project dropdown and MRF submission"
      contains: "project_code"
  key_links:
    - from: "app/views/mrf-form.js"
      to: "projects collection"
      via: "onSnapshot with where('status', '==', 'active')"
      pattern: "where\\('status', '==', 'active'\\)"
    - from: "app/views/mrf-form.js"
      to: "mrfs collection"
      via: "addDoc with project_code field"
      pattern: "project_code:"
---

<objective>
Update MRF submission form to integrate with the new Projects system.

Purpose: MRF form currently displays project names alphabetically and stores only project_name. This plan updates the dropdown to show "CODE - Name" format, sort by most recent first, and store both project_code (stable reference) and project_name (for display).

Output: Modified mrf-form.js with project dropdown showing proper format and MRF documents storing project_code field.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mrf-project-integration/04-RESEARCH.md

# Source file to modify
@app/views/mrf-form.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update project dropdown format and sorting</name>
  <files>app/views/mrf-form.js</files>
  <action>
Modify the loadProjects() function (lines 226-266) to:

1. Keep the existing query with where('status', '==', 'active') - already correct for MRF-03

2. Change sort from alphabetical to created_at descending (MRF-04):
   ```javascript
   // CHANGE FROM:
   projects.sort((a, b) => a.project_name.localeCompare(b.project_name));

   // CHANGE TO:
   projects.sort((a, b) => {
       const aTime = a.created_at ? new Date(a.created_at).getTime() : 0;
       const bTime = b.created_at ? new Date(b.created_at).getTime() : 0;
       return bTime - aTime; // Most recent first
   });
   ```

3. Update option creation to show formatted display and store code (MRF-01, MRF-02):
   ```javascript
   // CHANGE FROM:
   option.value = project.project_name;
   option.textContent = project.project_name;

   // CHANGE TO:
   option.value = project.project_code; // Store the code
   option.textContent = `${project.project_code} - ${project.project_name}`; // Display format
   // Store project_name in data attribute for submission
   option.dataset.projectName = project.project_name;
   ```

4. Also add doc.id to the project object for consistency:
   ```javascript
   projects.push({ id: doc.id, ...doc.data() });
   ```
  </action>
  <verify>
1. Run `python -m http.server 8000` and navigate to http://localhost:8000/#/mrf
2. Check dropdown shows options in format "CLMC_XXX_2026001 - Project Name"
3. Verify most recently created project appears first
4. Verify inactive projects are NOT shown
5. Browser console should show no errors
  </verify>
  <done>Project dropdown shows "CODE - Name" format, sorted by most recent first, excludes inactive projects</done>
</task>

<task type="auto">
  <name>Task 2: Update MRF submission to store project_code</name>
  <files>app/views/mrf-form.js</files>
  <action>
Modify the handleFormSubmit() function (around line 447) to store both project_code and project_name:

1. Update variable extraction to get code from value and name from data attribute:
   ```javascript
   // CHANGE FROM:
   const projectName = document.getElementById('projectName').value.trim();

   // CHANGE TO:
   const projectSelect = document.getElementById('projectName');
   const projectCode = projectSelect.value.trim(); // Now stores the code
   const selectedOption = projectSelect.options[projectSelect.selectedIndex];
   const projectName = selectedOption?.dataset?.projectName || ''; // Get name from data attribute
   ```

2. Update mrfDoc object to include both fields (MRF-05):
   ```javascript
   const mrfDoc = {
       mrf_id: mrfId,
       request_type: requestType,
       urgency_level: urgencyLevel,
       project_code: projectCode,    // NEW: stable reference
       project_name: projectName,    // KEEP: for display (denormalized)
       requestor_name: requestorName,
       date_needed: dateNeeded,
       // ... rest unchanged
   };
   ```

This approach:
- Stores project_code as the stable reference (survives project renames)
- Denormalizes project_name for efficient display (no join needed)
- Historical MRFs show the project name at time of creation
  </action>
  <verify>
1. Submit a test MRF from http://localhost:8000/#/mrf
2. Check Firebase Console for the new MRF document
3. Verify document contains both:
   - project_code: "CLMC_XXX_YYYY###" format
   - project_name: actual project name string
4. Verify all other fields still saved correctly
  </verify>
  <done>MRF documents now store both project_code (reference) and project_name (display) fields</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Dropdown Format (MRF-01, MRF-02):**
   - Navigate to http://localhost:8000/#/mrf
   - Open project dropdown
   - Each option shows "CLMC_XXX_YYYY### - Project Name" format

2. **Active Only (MRF-03):**
   - Create or identify an inactive project in Firebase Console
   - Refresh MRF form
   - Verify inactive project does NOT appear in dropdown

3. **Sorting (MRF-04):**
   - Check dropdown order matches most-recent-first
   - Compare with Firebase Console projects collection ordered by created_at

4. **Data Storage (MRF-05):**
   - Submit new MRF
   - Check Firebase Console > mrfs collection
   - New document has project_code field with code format
   - New document retains project_name field for backward compatibility
</verification>

<success_criteria>
- [ ] Project dropdown shows "CODE - Name" format
- [ ] Dropdown excludes inactive projects
- [ ] Dropdown sorted by created_at desc (most recent first)
- [ ] New MRF documents contain project_code field
- [ ] New MRF documents contain project_name field (denormalized)
- [ ] No console errors
- [ ] Form submission still works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-mrf-project-integration/04-01-SUMMARY.md`
</output>
