---
phase: 16-project-detail-page-restructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/project-detail.js
  - styles/views.css
autonomous: true

must_haves:
  truths:
    - "Active toggle appears above all cards, not inside right column"
    - "Card 1 displays Project Code, Project Name, Client, Assigned Personnel"
    - "Card 2 displays Budget, Contract Cost, Expense, Remaining Budget"
    - "Card 3 displays Internal Status, Project Status"
    - "Clicking Expense amount opens detailed breakdown modal"
    - "Deactivating project shows confirmation modal, activating does not"
    - "Delete button appears below all cards, not in card header"
  artifacts:
    - path: "app/views/project-detail.js"
      provides: "Restructured 3-card layout with expense calculation"
      min_lines: 600
      exports: ["render", "init", "destroy"]
    - path: "app/views/project-detail.js"
      provides: "Expense modal with category breakdown"
      contains: "showExpenseModal"
    - path: "styles/views.css"
      provides: "Expense summary styling"
      contains: ".expense-summary-card"
  key_links:
    - from: "app/views/project-detail.js"
      to: "pos collection"
      via: "getAggregateFromServer for expense sum"
      pattern: "getAggregateFromServer.*pos"
    - from: "app/views/project-detail.js"
      to: "transport_requests collection"
      via: "getAggregateFromServer for TR totals"
      pattern: "getAggregateFromServer.*transport_requests"
    - from: "Card 2 Expense field"
      to: "window.showExpenseModal"
      via: "onclick handler"
      pattern: "onclick.*showExpenseModal"
    - from: "Active toggle badge"
      to: "window.toggleActive"
      via: "onclick with confirmation for deactivation"
      pattern: "onclick.*toggleActive"
---

<objective>
Restructure project detail page from single two-column card into three vertically-stacked cards with clear information hierarchy: (1) Project Info, (2) Financial Summary with expense calculation and breakdown modal, (3) Status fields. Move Active toggle to prominent top position and Delete button to bottom.

**Purpose**: Improve information hierarchy and visual clarity by grouping related fields into logical cards. Add expense tracking and breakdown capability to project detail view.

**Output**: Reorganized project detail page with 3-card layout, expense calculation with modal breakdown, badge-style active toggle with confirmation, and repositioned delete button.
</objective>

<execution_context>
@C:\Users\franc\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-project-detail-page-restructure/16-CONTEXT.md
@.planning/phases/16-project-detail-page-restructure/16-RESEARCH.md

<!-- Current implementation -->
@app/views/project-detail.js
@styles/components.css
@styles/views.css

<!-- Existing patterns to follow -->
@app/views/finance.js
@app/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure layout into 3-card vertical stack</name>
  <files>
    app/views/project-detail.js
  </files>
  <action>
**Update `renderProjectDetail()` function (line 229-328):**

1. **Move Active toggle above cards** (separate row before all cards):
   - Change from checkbox (line 303-306) to badge-style toggle
   - Badge classes: `.status-badge` with `.approved` (active) or `.rejected` (inactive)
   - Add helper text: "Click to deactivate (requires confirmation)" or "Click to activate"
   - Style: `cursor: pointer`, prominent placement with gap between badge and cards
   - Keep `onclick="window.toggleActive()"` but pass opposite state

2. **Card 1 - Project Information**:
   - Move Created/Updated metadata (line 253) inside Card 1 at top with bottom border separator
   - Fields: Project Code (plain text, NOT disabled input), Project Name (editable), Client (plain text, NOT disabled input), Assigned Personnel (editable datalist)
   - Remove disabled inputs for locked fields - use plain text display with labels instead
   - Two-column grid for fields: `grid-template-columns: repeat(2, 1fr)`, single column on mobile

3. **Card 2 - Financial Summary**:
   - Fields: Budget (editable), Contract Cost (editable), Expense (calculated with click handler and refresh button), Remaining Budget (calculated)
   - Expense field: Display with `onclick="window.showExpenseModal()"`, add small text "Click to view breakdown"
   - Add refresh button next to Expense label: `<button class="btn btn-sm btn-secondary" onclick="window.refreshExpense()">ðŸ”„ Refresh</button>`
   - Remaining Budget: Color-coded (green if positive, red if negative), formula: Budget - Expense
   - Display "â€”" for expense/remaining if budget not set

4. **Card 3 - Status & Assignment**:
   - Fields: Internal Status (dropdown), Project Status (dropdown)
   - Remove Personnel from this card (moved to Card 1)

5. **Move Delete button to bottom**:
   - Relocate delete button (line 256) to appear AFTER all 3 cards
   - Keep same styling and permission guard

6. **Preserve existing functionality**:
   - Keep focus preservation logic (line 321-324)
   - Keep all permission guards and view-only notices
   - Keep all existing `data-field` attributes and `onblur` handlers for inline editing
   - Maintain usersData population for personnel datalist

**DO NOT:**
- Change saveField() logic - keep existing validation and save behavior
- Remove permission checks or view-only mode
- Break focus preservation during real-time updates
- Change client_code or project_code to editable fields
  </action>
  <verify>
1. `grep -c "expense-summary-card" app/views/project-detail.js` (verify contains reference)
2. `grep -c "showExpenseModal" app/views/project-detail.js` (verify function exists)
3. `grep -c "window.showExpenseModal" app/views/project-detail.js` (verify window assignment)
4. Start dev server and navigate to any project detail page
5. Verify Active toggle appears ABOVE all cards as clickable badge
6. Verify 3 distinct cards are visible with correct field groupings
7. Verify Project Code and Client display as plain text (NOT disabled inputs)
8. Verify Delete button appears BELOW all cards
  </verify>
  <done>
- Active toggle badge appears at top with helper text
- 3 cards display: Project Info, Financial Summary, Status
- Project Code and Client show as plain text labels
- Expense field shows placeholder "â€”" or amount with "Refresh" button
- Remaining Budget displays with color coding
- Delete button appears below all cards
- All existing inline editing functionality preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement expense calculation and breakdown modal</name>
  <files>
    app/views/project-detail.js
    styles/views.css
  </files>
  <action>
**In `app/views/project-detail.js`:**

1. **Add global expense state** (after line 13):
```javascript
let currentExpense = { total: 0, poCount: 0, trCount: 0, categories: {} };
```

2. **Add expense calculation function** (after `toggleActive()` function):
```javascript
async function refreshExpense() {
    if (!currentProject) return;

    showLoading(true);
    try {
        // Import aggregation functions at top if not already imported
        // sum, count from firebase/firestore

        // Aggregate POs for this project
        const posQuery = query(
            collection(db, 'pos'),
            where('project_name', '==', currentProject.project_name)
        );

        const posAggregate = await getAggregateFromServer(posQuery, {
            totalAmount: sum('total_amount'),
            poCount: count()
        });

        // Aggregate TRs for this project
        const trsQuery = query(
            collection(db, 'transport_requests'),
            where('project_name', '==', currentProject.project_name)
        );

        const trsAggregate = await getAggregateFromServer(trsQuery, {
            totalAmount: sum('total_amount'),
            trCount: count()
        });

        const poTotal = posAggregate.data().totalAmount || 0;
        const trTotal = trsAggregate.data().totalAmount || 0;

        currentExpense = {
            total: poTotal + trTotal,
            poCount: posAggregate.data().poCount || 0,
            trCount: trsAggregate.data().trCount || 0
        };

        // Re-render to show updated expense
        renderProjectDetail();

        showToast('Expense refreshed', 'success');
    } catch (error) {
        console.error('[ProjectDetail] Expense calculation failed:', error);
        showToast('Failed to calculate expense', 'error');
    } finally {
        showLoading(false);
    }
}
```

3. **Add expense modal function** (after `refreshExpense()`):
```javascript
async function showExpenseModal() {
    if (!currentProject) return;

    showLoading(true);
    try {
        // Fetch all POs for this project
        const posQuery = query(
            collection(db, 'pos'),
            where('project_name', '==', currentProject.project_name)
        );

        const posSnapshot = await getDocs(posQuery);
        const categoryTotals = {};
        let materialTotal = 0;
        let transportTotal = 0;

        posSnapshot.forEach(poDoc => {
            const po = poDoc.data();
            const items = JSON.parse(po.items_json || '[]');
            const isSubcon = po.is_subcon || false;

            items.forEach(item => {
                const category = item.category || 'Uncategorized';
                const subtotal = parseFloat(item.subtotal || 0);

                if (!categoryTotals[category]) {
                    categoryTotals[category] = { amount: 0, items: [] };
                }
                categoryTotals[category].amount += subtotal;
                categoryTotals[category].items.push({
                    po_id: po.po_id,
                    item_name: item.item_name,
                    quantity: item.quantity,
                    unit: item.unit,
                    unit_cost: item.unit_cost,
                    subtotal
                });

                materialTotal += subtotal;
            });
        });

        // Fetch TRs for transport fees
        const trsQuery = query(
            collection(db, 'transport_requests'),
            where('project_name', '==', currentProject.project_name)
        );

        const trsSnapshot = await getDocs(trsQuery);
        trsSnapshot.forEach(trDoc => {
            const tr = trDoc.data();
            transportTotal += parseFloat(tr.total_amount || 0);
        });

        // Create and show modal
        const modalHTML = `
            <div id="expenseModal" class="modal active">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Project Expense Breakdown</h3>
                        <button class="modal-close" onclick="window.closeExpenseModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- Scorecards -->
                        <div class="expense-summary-grid">
                            <div class="expense-summary-card">
                                <div class="expense-summary-label">Material Purchases</div>
                                <div class="expense-summary-value">${formatCurrency(materialTotal)}</div>
                            </div>
                            <div class="expense-summary-card">
                                <div class="expense-summary-label">Transport Fees</div>
                                <div class="expense-summary-value">${formatCurrency(transportTotal)}</div>
                            </div>
                            <div class="expense-summary-card total">
                                <div class="expense-summary-label">Total Expense</div>
                                <div class="expense-summary-value">${formatCurrency(materialTotal + transportTotal)}</div>
                            </div>
                        </div>

                        <!-- Category Breakdown -->
                        ${Object.keys(categoryTotals).length > 0 ? `
                            <h4 style="margin-top: 2rem; margin-bottom: 1rem;">By Category</h4>
                            ${Object.entries(categoryTotals).map(([category, data]) => `
                                <div class="category-card">
                                    <div class="category-header">
                                        <span class="category-name">${category}</span>
                                        <span class="category-amount">${formatCurrency(data.amount)}</span>
                                    </div>
                                    <div class="category-items">
                                        <table class="modal-items-table">
                                            <thead>
                                                <tr>
                                                    <th>PO ID</th>
                                                    <th>Item</th>
                                                    <th>Qty</th>
                                                    <th>Unit Cost</th>
                                                    <th style="text-align: right;">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.items.map(item => `
                                                    <tr>
                                                        <td>${item.po_id}</td>
                                                        <td>${item.item_name}</td>
                                                        <td>${item.quantity} ${item.unit}</td>
                                                        <td>${formatCurrency(item.unit_cost)}</td>
                                                        <td style="text-align: right;">${formatCurrency(item.subtotal)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `).join('')}
                        ` : '<p style="color: #64748b; text-align: center;">No material purchases recorded.</p>'}
                    </div>
                </div>
            </div>
        `;

        // Inject modal into DOM
        const existingModal = document.getElementById('expenseModal');
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML('beforeend', modalHTML);

    } catch (error) {
        console.error('[ProjectDetail] Expense modal failed:', error);
        showToast('Failed to load expense breakdown', 'error');
    } finally {
        showLoading(false);
    }
}

function closeExpenseModal() {
    const modal = document.getElementById('expenseModal');
    if (modal) modal.remove();
}
```

4. **Update init() to calculate expense on load** (after line 132, before renderProjectDetail):
```javascript
// Calculate initial expense
await refreshExpense();
```

5. **Update attachWindowFunctions()** (line 511-515) to include new functions:
```javascript
window.refreshExpense = refreshExpense;
window.showExpenseModal = showExpenseModal;
window.closeExpenseModal = closeExpenseModal;
```

6. **Update destroy()** (line 165-168) to delete new window functions:
```javascript
delete window.refreshExpense;
delete window.showExpenseModal;
delete window.closeExpenseModal;
```

7. **Add required imports at top** (line 6):
```javascript
import { db, collection, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, getAggregateFromServer, sum, count } from '../firebase.js';
```

8. **Update Card 2 rendering** (in Task 1 changes) to display currentExpense.total:
```javascript
// In Expense field
<div style="font-weight: 600; color: #1e293b; font-size: 1.125rem; cursor: pointer;"
     onclick="window.showExpenseModal()">
    ${currentExpense.total > 0 ? formatCurrency(currentExpense.total) : 'â€”'}
</div>
```

**In `styles/views.css`:**

Add expense modal styling (reference `finance.js` patterns):
```css
/* Expense Summary Scorecards */
.expense-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.expense-summary-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.expense-summary-card.total {
    background: #1a73e8;
    color: white;
    border-color: #1557b0;
}

.expense-summary-label {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
}

.expense-summary-card.total .expense-summary-label {
    color: rgba(255, 255, 255, 0.9);
}

.expense-summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.expense-summary-card.total .expense-summary-value {
    color: white;
}

/* Category Breakdown Cards */
.category-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.category-header {
    background: #f8fafc;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
}

.category-name {
    font-weight: 600;
    color: #1e293b;
}

.category-amount {
    font-weight: 700;
    color: #1a73e8;
    font-size: 1.125rem;
}

.category-items {
    padding: 1rem;
}

.modal-items-table {
    width: 100%;
    border-collapse: collapse;
}

.modal-items-table th {
    text-align: left;
    padding: 0.5rem;
    background: #f8fafc;
    font-weight: 600;
    font-size: 0.875rem;
    color: #475569;
    border-bottom: 2px solid #e5e7eb;
}

.modal-items-table td {
    padding: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.875rem;
}

.modal-items-table tbody tr:last-child td {
    border-bottom: none;
}

.modal-items-table tbody tr:hover {
    background: #f8fafc;
}
```

**Follow existing patterns:**
- Use `getAggregateFromServer()` from finance.js (line 367-370) for efficient aggregation
- Modal structure follows existing modal patterns from components.css
- Expense breakdown adapts finance.js expense modal pattern (line 442-520)
  </action>
  <verify>
1. `grep -n "getAggregateFromServer" app/views/project-detail.js`
2. `grep -n "showExpenseModal" app/views/project-detail.js`
3. `grep -n "expense-summary-card" styles/views.css`
4. Navigate to project detail page and click Refresh button next to Expense
5. Verify expense total updates and displays formatted currency
6. Click Expense amount and verify modal opens with category breakdown
7. Verify modal shows Material Purchases, Transport Fees, and Total Expense scorecards
8. Close modal with X button and verify modal disappears
  </verify>
  <done>
- refreshExpense() function calculates PO + TR totals using getAggregateFromServer
- showExpenseModal() displays scorecard summary and category breakdown tables
- Expense field displays total with click handler and refresh button
- Remaining Budget calculates and displays with color coding
- Modal styling matches app design system (scorecards, category cards, tables)
- All imports and window functions properly registered and cleaned up
  </done>
</task>

<task type="auto">
  <name>Task 3: Update active toggle to badge style with confirmation</name>
  <files>
    app/views/project-detail.js
  </files>
  <action>
**Update `toggleActive()` function** (line 439-457):

Replace checkbox-based toggle with badge-style toggle and add confirmation for deactivation:

```javascript
async function toggleActive(newValue) {
    // Guard: check edit permission
    if (window.canEditTab?.('projects') === false) {
        showToast('You do not have permission to edit projects', 'error');
        return;
    }

    // Confirm deactivation only (Active â†’ Inactive)
    if (!newValue) {
        const confirmed = confirm('Deactivate this project? Inactive projects cannot be selected for MRFs.');
        if (!confirmed) return;
    }

    try {
        const projectRef = doc(db, 'projects', currentProject.id);
        await updateDoc(projectRef, {
            active: newValue,
            updated_at: new Date().toISOString()
        });
        showToast(`Project ${newValue ? 'activated' : 'deactivated'}`, 'success');
        console.log('[ProjectDetail] Active status updated to:', newValue);
    } catch (error) {
        console.error('[ProjectDetail] Toggle failed:', error);
        showToast('Failed to update status', 'error');
    }
}
```

**Update Active toggle rendering** (modified in Task 1):

Badge should:
- Use existing `.status-badge` classes from components.css
- Add `.approved` class for active, `.rejected` for inactive
- Include icon: `âœ“ Active` or `âœ— Inactive`
- Pass opposite state to toggle: `onclick="window.toggleActive(${!currentProject.active})"`
- Style with `cursor: pointer` and transition
- Helper text explains: "Click to deactivate (requires confirmation)" or "Click to activate"

**DO NOT:**
- Remove checkbox entirely until badge is working
- Skip confirmation on deactivation
- Confirm on activation (instant toggle for activating)
  </action>
  <verify>
1. Navigate to project detail page with active project
2. Click Active badge and verify confirmation modal appears: "Deactivate this project?"
3. Click Cancel and verify project remains Active
4. Click Active badge again, click OK, verify project becomes Inactive with toast
5. Click Inactive badge and verify NO confirmation modal (instant activation)
6. Verify project becomes Active with toast message
7. Verify badge styling changes between Active (green) and Inactive (red)
  </verify>
  <done>
- toggleActive() shows confirmation modal only for deactivation
- Activating project is instant (no confirmation)
- Confirmation message is specific: "Deactivate this project? Inactive projects cannot be selected for MRFs."
- Toast feedback shows "Project activated" or "Project deactivated"
- Badge styling uses .status-badge.approved (green) and .status-badge.rejected (red)
- Helper text guides user on expected behavior
  </done>
</task>

</tasks>

<verification>
## Overall Phase Verification

**Visual inspection:**
1. Navigate to any project detail page
2. Verify layout structure:
   - Active toggle badge at top (separate row, very prominent)
   - Card 1: Project Code (plain text), Name (editable), Client (plain text), Personnel (datalist)
   - Card 2: Budget (editable), Contract Cost (editable), Expense (clickable with refresh), Remaining Budget (color-coded)
   - Card 3: Internal Status (dropdown), Project Status (dropdown)
   - Delete button at bottom (below all cards)

**Functional verification:**
1. Click Refresh button next to Expense - verify calculation updates
2. Click Expense amount - verify modal opens with category breakdown
3. Close modal with X button - verify modal disappears
4. Edit Budget field - verify Remaining Budget recalculates (Budget - Expense)
5. Toggle Active badge (deactivate) - verify confirmation modal appears
6. Toggle Active badge (activate) - verify NO confirmation modal
7. Edit any field and verify inline auto-save still works
8. Verify focus preservation during real-time updates

**Permission verification:**
1. Test as view-only user - verify all editable fields disabled, no delete button, no toggle interaction
2. Test as admin user - verify all edit functionality works

**Responsive verification:**
1. Resize browser to mobile width
2. Verify cards stack vertically
3. Verify two-column grids within cards become single-column on mobile
</verification>

<success_criteria>
## Phase Complete When:

- [ ] Active toggle appears as clickable badge ABOVE all cards
- [ ] 3 distinct cards display with correct field groupings per success criteria
- [ ] Project Code and Client display as plain text (not disabled inputs)
- [ ] Expense calculates using getAggregateFromServer for POs and TRs
- [ ] Clicking Expense amount opens modal with category breakdown
- [ ] Modal displays scorecards: Material Purchases, Transport Fees, Total Expense
- [ ] Modal displays detailed tables grouped by category
- [ ] Remaining Budget calculates (Budget - Expense) with color coding
- [ ] Deactivating project shows confirmation modal
- [ ] Activating project has NO confirmation (instant toggle)
- [ ] Delete button appears BELOW all cards
- [ ] All existing inline editing functionality preserved
- [ ] Permission guards and view-only mode still work
- [ ] Focus preservation during real-time updates still works
- [ ] Layout responsive (cards stack on mobile, grids become single-column)
</success_criteria>

<output>
After completion, create `.planning/phases/16-project-detail-page-restructure/16-01-SUMMARY.md` using the summary template.
</output>
