---
phase: 01-clients-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/clients.js
autonomous: true

must_haves:
  truths:
    - "User can see a list of all clients in a table"
    - "User can add a new client with client_code, company_name, contact_person, contact_details"
    - "Client codes are automatically uppercase and validated for uniqueness"
    - "User can edit existing client information inline"
    - "User can delete clients with confirmation dialog"
  artifacts:
    - path: "app/views/clients.js"
      provides: "Client CRUD view module"
      min_lines: 600
      exports: ["render", "init", "destroy"]
  key_links:
    - from: "app/views/clients.js"
      to: "Firebase clients collection"
      via: "onSnapshot listener"
      pattern: "onSnapshot\\(collection\\(db, 'clients'\\)"
    - from: "window functions"
      to: "CRUD operations"
      via: "onclick handlers"
      pattern: "window\\.(addClient|editClient|saveEdit|deleteClient)"
---

<objective>
Create the clients view module with full CRUD operations following the established supplier management pattern.

Purpose: Provide client database foundation for project code generation (Phase 2 depends on clients existing).
Output: Working client management interface with create, read, update, delete, and uniqueness validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-clients-foundation/01-RESEARCH.md

# Codebase patterns
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@CLAUDE.md

# Reference implementation (supplier management pattern to clone)
@app/views/procurement.js
@app/firebase.js
@app/utils.js
</context>

<tasks>

<task type="auto">
  <name>Create clients view module with CRUD operations</name>
  <files>app/views/clients.js</files>
  <action>
Create `app/views/clients.js` following the exact pattern from supplier management in procurement.js (lines 1626-1884 from research).

**Implementation requirements:**

1. **Module structure** (render/init/destroy lifecycle):
   - Export `render(activeTab)` returning HTML template string
   - Export async `init(activeTab)` setting up listeners
   - Export async `destroy()` cleaning up listeners and window functions
   - Module-scoped state: `clientsData = []`, `editingClient = null`, `currentPage = 1`, `itemsPerPage = 15`, `listeners = []`

2. **Firestore schema** - `clients` collection documents:
   ```javascript
   {
     client_code: "ACME",              // String, uppercase, manually entered
     company_name: "ACME Corporation", // String
     contact_person: "John Doe",       // String
     contact_details: "email | phone", // String (freetext)
     created_at: ISO string,
     updated_at: ISO string (optional)
   }
   ```

3. **Real-time data loading** with onSnapshot:
   - Load clients collection on init
   - Store unsubscribe function in listeners array
   - Sort alphabetically by company_name
   - Auto-render table on data change

4. **CRUD operations**:
   - **CREATE**: addClient() - validate all fields required, check duplicate client_code (case-insensitive by converting to uppercase), use addDoc
   - **READ**: renderClientsTable() - pagination 15/page, inline edit mode, action buttons
   - **UPDATE**: saveEdit(clientId) - validate fields, check duplicate excluding current record, use updateDoc
   - **DELETE**: deleteClient(clientId, companyName) - confirm dialog, clear editingClient if deleting edited row, use deleteDoc

5. **Uniqueness validation** (CRITICAL):
   - Convert client_code to uppercase on input: `.toUpperCase()`
   - Check `clientsData.find(c => c.client_code === client_code)` BEFORE addDoc
   - For edit: exclude current record `c.id !== clientId`
   - Show error toast if duplicate found, return early

6. **UI elements**:
   - Header with "Client Management" title and "Add Client" button
   - Collapsible add form (hidden by default) with 4 fields
   - Table with columns: Client Code, Company Name, Contact Person, Contact Details, Actions
   - Inline edit mode (replace row with inputs)
   - Pagination controls (prev/next + page numbers with ellipsis)
   - Empty state message: "No clients yet. Add your first client!"

7. **Window functions** (attach in attachWindowFunctions()):
   - toggleAddClientForm, addClient, editClient, cancelEdit, saveEdit, deleteClient, changeClientsPage
   - Clean up ALL window functions in destroy()

8. **Error handling**:
   - Try-catch around all Firebase operations
   - showLoading(true/false) for async operations
   - showToast(message, type) for user feedback
   - Console.log with '[Clients]' prefix for debugging

**What NOT to do:**
- Do NOT use getDocs - use onSnapshot for real-time updates
- Do NOT check uniqueness after write - check BEFORE
- Do NOT forget to delete window functions in destroy()
- Do NOT use data attributes for DOM selection - use CSS classes
- Do NOT create custom pagination - use exact pattern from research template
- Do NOT add tabs - clients view is single-tab only

**Use complete template from research lines 557-925** - this is proven, working code. Replace "supplier" with "client" and ensure client_code uniqueness validation.
  </action>
  <verify>
1. File exists: `ls app/views/clients.js`
2. Exports correct functions: `grep -E "^export (function|async function) (render|init|destroy)" app/views/clients.js`
3. Has onSnapshot listener: `grep "onSnapshot(collection(db, 'clients')" app/views/clients.js`
4. Has uniqueness validation: `grep "clientsData.find.*client_code" app/views/clients.js`
5. Window cleanup in destroy: `grep "delete window" app/views/clients.js`
6. No syntax errors: Open in browser DevTools, check console for errors
  </verify>
  <done>
- `app/views/clients.js` exists with 600-800 lines
- File exports render, init, destroy functions
- CRUD operations implemented: addClient, editClient, saveEdit, deleteClient
- Client code uniqueness validation working (checks before write)
- Pagination implemented (15 items per page)
- Window functions attached in init, cleaned in destroy
- Console shows "[Clients] Module loaded" with no errors
  </done>
</task>

</tasks>

<verification>
**Manual verification checklist:**
1. Run dev server: `python -m http.server 8000`
2. Open DevTools console, check for "[Clients] Module loaded"
3. No JavaScript errors in console
4. File structure matches conventions (camelCase, 4-space indent)

**Integration verification (after Plan 02):**
- Navigation to #/clients loads view
- All CRUD operations work
- Uniqueness validation blocks duplicates
</verification>

<success_criteria>
**Measurable completion:**
- [ ] `app/views/clients.js` file exists
- [ ] File exports render, init, destroy functions
- [ ] onSnapshot listener configured for clients collection
- [ ] addClient creates documents with all required fields
- [ ] Client code converted to uppercase automatically
- [ ] Uniqueness validation prevents duplicate client codes
- [ ] editClient enables inline editing with Save/Cancel buttons
- [ ] saveEdit updates Firestore with validation
- [ ] deleteClient removes document after confirmation
- [ ] Pagination controls present and functional
- [ ] Window functions attached in init, cleaned in destroy
- [ ] No console errors when module loads
</success_criteria>

<output>
After completion, create `.planning/phases/01-clients-foundation/01-01-SUMMARY.md`
</output>
