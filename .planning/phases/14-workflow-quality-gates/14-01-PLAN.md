---
phase: 14-workflow-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "Clicking View Details on PO with missing fields shows form modal"
    - "Form modal requires Payment Terms, Condition, and Delivery Date"
    - "Submitting form updates PO in Firestore"
    - "After filling fields, PO details modal opens"
    - "PO with all fields filled shows details immediately (no form)"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Quality gate validation and form modal functions"
      contains: "hasRequiredPOFields"
    - path: "app/views/procurement.js"
      provides: "Form submission handler"
      contains: "handleRequiredFieldsSubmit"
  key_links:
    - from: "viewPODetails()"
      to: "hasRequiredPOFields()"
      via: "gate check before details modal"
      pattern: "if.*!hasRequiredPOFields"
    - from: "handleRequiredFieldsSubmit()"
      to: "updateDoc()"
      via: "Firestore update"
      pattern: "updateDoc.*db.*pos"
    - from: "handleRequiredFieldsSubmit()"
      to: "viewPODetails()"
      via: "recursive call after save"
      pattern: "viewPODetails\\(poId\\)"
---

<objective>
Add quality gate to PO viewing that requires Payment Terms, Condition, and Delivery Date fields to be filled before showing PO details.

Purpose: Ensures data completeness for POs before procurement staff views or prints them. Prevents incomplete documents from being used in the workflow.

Output: Modified procurement.js with validation gate in viewPODetails(), form modal for collecting missing fields, and proper window function lifecycle management.
</objective>

<execution_context>
@C:\Users\Admin\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Admin\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-workflow-quality-gates/14-RESEARCH.md

# Relevant source
@app/views/procurement.js
@app/components.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quality gate validation and form modal functions</name>
  <files>app/views/procurement.js</files>
  <action>
Add three new functions before the viewPODetails function (around line 3950):

1. `hasRequiredPOFields(poData)` - Validation helper:
```javascript
function hasRequiredPOFields(poData) {
    const defaults = {
        payment_terms: ['As per agreement', '', null, undefined],
        condition: ['Standard terms apply', '', null, undefined],
        delivery_date: ['TBD', '', null, undefined]
    };

    return !(
        defaults.payment_terms.includes(poData.payment_terms) ||
        defaults.condition.includes(poData.condition) ||
        defaults.delivery_date.includes(poData.delivery_date)
    );
}
```

2. `showPORequiredFieldsForm(poId, poData)` - Form modal:
- Create modal using createModal() from components.js
- Modal ID: `poRequiredFieldsModal`
- Three form fields:
  - Payment Terms (textarea, required)
  - Condition (textarea, required)
  - Delivery Date (date input, required)
- Pre-fill existing values (skip known defaults)
- Cancel button calls closeModal('poRequiredFieldsModal')
- Save button calls handleRequiredFieldsSubmit(poId)
- Add explanatory text: "This PO requires additional information before viewing details. Please fill the required fields below:"

3. `handleRequiredFieldsSubmit(poId)` - Form handler:
- Get values from form fields (getElementById for payment_terms, condition, delivery_date)
- Trim whitespace
- Validate all fields are non-empty (show alert if any missing)
- Call updateDoc to save to Firestore pos collection
- Close modal with closeModal('poRequiredFieldsModal')
- Show success toast
- Call viewPODetails(poId) recursively (now will pass gate)
- Wrap in try/catch, show error toast on failure

Style the form consistently with existing modals:
- padding: 1.5rem on container
- 1rem gap between form groups
- margin-top: 2rem on button row
- flex with gap: 1rem, justify-content: flex-end for buttons
- Use existing btn-primary and btn-secondary classes
  </action>
  <verify>
Functions exist in procurement.js:
- Search for "hasRequiredPOFields" - should find function definition
- Search for "showPORequiredFieldsForm" - should find function definition
- Search for "handleRequiredFieldsSubmit" - should find function definition
  </verify>
  <done>
Three functions added: hasRequiredPOFields validates PO data, showPORequiredFieldsForm displays form modal, handleRequiredFieldsSubmit saves data and reopens details.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire quality gate into viewPODetails and update lifecycle functions</name>
  <files>app/views/procurement.js</files>
  <action>
1. Modify viewPODetails() function (around line 3954):
   - After fetching PO from Firestore (line ~3967: `const po = { id: poDoc.id, ...poDoc.data() };`)
   - Add gate check BEFORE existing logic:
   ```javascript
   // Quality gate: require complete PO information
   if (!hasRequiredPOFields(po)) {
       showLoading(false);
       showPORequiredFieldsForm(poId, po);
       return;
   }
   ```
   - This must be BEFORE the items parsing and modal display

2. Update attachWindowFunctions() (around line 45):
   - Add after line 80 (window.showSupplierPurchaseHistory):
   ```javascript
   window.handleRequiredFieldsSubmit = handleRequiredFieldsSubmit;
   ```

3. Update destroy() function (around line 501):
   - Add cleanup after line 556 (delete window.viewPODetails):
   ```javascript
   delete window.handleRequiredFieldsSubmit;
   ```

4. Add to render() function modal container:
   - After the existing timeline modal container (around line 330), add:
   ```javascript
   <!-- PO Required Fields Modal -->
   <div id="poRequiredFieldsModal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h3>Complete PO Information</h3>
               <button class="close-btn" onclick="closeModal('poRequiredFieldsModal')">&times;</button>
           </div>
           <div class="modal-body" id="poRequiredFieldsBody">
               <!-- Form content inserted dynamically -->
           </div>
       </div>
   </div>
   ```

IMPORTANT: The form content in showPORequiredFieldsForm should set innerHTML of poRequiredFieldsBody, not create a new modal. This follows the pattern used by other modals in procurement.js (e.g., supplierHistoryModal).
  </action>
  <verify>
1. Start local server: `python -m http.server 8000`
2. Login as Procurement user
3. Navigate to Procurement > PR-PO Records tab
4. Find a PO with default field values (payment_terms: "As per agreement")
5. Click View Details button
6. Expected: Form modal appears asking for Payment Terms, Condition, Delivery Date
7. Fill all three fields with real values
8. Click Save & View Details
9. Expected: Form closes, PO details modal opens with filled values
10. Click View Details on same PO again
11. Expected: PO details modal opens immediately (no form - fields already filled)
  </verify>
  <done>
Quality gate integrated: viewPODetails checks hasRequiredPOFields, shows form if missing, handleRequiredFieldsSubmit attached to window, cleanup in destroy(), modal container in render().
  </done>
</task>

</tasks>

<verification>
1. **PO with defaults blocked:** Click View Details on PO with "As per agreement" payment terms - form modal appears
2. **Form validation works:** Try to submit with empty field - alert shows
3. **Save persists data:** Fill fields, submit, check Firestore - PO document updated
4. **Details load after save:** After form submission, PO details modal opens automatically
5. **Gate bypassed for complete POs:** PO with all real values shows details immediately
6. **Window function lifecycle:** Navigate away and back to Procurement tab, click View Details - works without errors
7. **No console errors:** Browser console shows no JavaScript errors during flow
</verification>

<success_criteria>
- [ ] PO with default payment_terms ("As per agreement") triggers form modal
- [ ] PO with default condition ("Standard terms apply") triggers form modal
- [ ] PO with default delivery_date ("TBD") triggers form modal
- [ ] Form modal has all three required fields
- [ ] Cancel button closes modal without saving
- [ ] Save button validates all fields non-empty
- [ ] Save button updates Firestore pos document
- [ ] Save button shows success toast
- [ ] After save, PO details modal opens
- [ ] PO with all fields filled opens details immediately (no form)
- [ ] No "is not a function" errors on tab navigation
</success_criteria>

<output>
After completion, create `.planning/phases/14-workflow-quality-gates/14-01-SUMMARY.md`
</output>
