---
phase: 22-bug-fixes-and-ux-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/finance.js
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "PO Issued Date column in Finance Purchase Orders tab shows a valid formatted date (not 'Invalid Date') for POs created via both legacy and signature approval paths"
    - "View PO document in Finance shows blank/empty fields for payment_terms, condition, and delivery_date when procurement has not filled them (no hardcoded defaults)"
    - "View PO document in Procurement shows blank/empty fields for payment_terms, condition, and delivery_date when not filled (no hardcoded defaults)"
    - "PO list in Finance sorts correctly by date (newest first) regardless of date_issued storage format"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Fixed PO date rendering and blank document defaults"
      contains: "formatTimestamp"
    - path: "app/views/procurement.js"
      provides: "Fixed blank document defaults"
  key_links:
    - from: "app/views/finance.js"
      to: "app/utils.js"
      via: "import formatTimestamp"
      pattern: "formatTimestamp"
---

<objective>
Fix PO date rendering ("Invalid Date") and blank document details (hardcoded fallback defaults) in Finance and Procurement views.

Purpose: Two related display bugs affect the Finance user experience -- PO dates show "Invalid Date" for POs created via the Phase 18 signature approval path (which uses serverTimestamp()), and PO documents show hardcoded defaults like "As per agreement" when fields should be blank.

Output: Finance PO list renders valid dates for all POs, PO documents show empty fields when procurement hasn't filled them.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-bug-fixes-and-ux-improvements/22-RESEARCH.md

@app/utils.js (lines 29-62 -- formatDate and formatTimestamp functions)
@app/views/finance.js (line 7 -- imports, line 487-489 -- document defaults, line 2157 -- sort, line 2208 -- date render)
@app/views/procurement.js (lines 4953-4955 -- document defaults)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PO date rendering and sort in Finance view</name>
  <files>app/views/finance.js</files>
  <action>
  Three changes in finance.js:

  1. **Update import** (line 7): Add `formatTimestamp` to the utils.js import:
     Change: `import { showToast, showLoading, formatCurrency, formatDate } from '../utils.js';`
     To: `import { showToast, showLoading, formatCurrency, formatDate, formatTimestamp } from '../utils.js';`

  2. **Fix PO date display** (line 2208): Replace `formatDate(po.date_issued)` with `formatTimestamp(po.date_issued)`.
     The `formatTimestamp()` function (utils.js:49-62) handles both Firestore Timestamp objects (`.toDate()`) and ISO strings via `new Date()`, so it works for POs created via both the legacy path (string dates) and the Phase 18 signature path (serverTimestamp).

  3. **Fix PO sort comparator** (line 2157): Replace the sort line:
     ```javascript
     poData.sort((a, b) => new Date(b.date_issued) - new Date(a.date_issued));
     ```
     With a Timestamp-aware comparator:
     ```javascript
     poData.sort((a, b) => {
         const dateA = a.date_issued?.toDate ? a.date_issued.toDate() : new Date(a.date_issued || 0);
         const dateB = b.date_issued?.toDate ? b.date_issued.toDate() : new Date(b.date_issued || 0);
         return dateB - dateA;
     });
     ```
     This handles both Firestore Timestamp objects and ISO string dates for correct newest-first ordering.
  </action>
  <verify>
  Open the app in browser, navigate to Finance > Purchase Orders tab. Check:
  - All PO rows display a valid formatted date in the "Date Issued" column (no "Invalid Date")
  - POs are sorted newest-first
  - Browser console has no errors related to date formatting
  </verify>
  <done>
  PO Issued Date column displays valid formatted dates for all POs regardless of how date_issued was stored. PO list sorts correctly by date.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove hardcoded document defaults in Finance and Procurement</name>
  <files>app/views/finance.js, app/views/procurement.js</files>
  <action>
  Two files need the same type of fix -- replacing hardcoded fallback values with empty strings.

  **finance.js** (lines 487-489 in `generatePODocument()`):
  Change:
  ```javascript
  PAYMENT_TERMS: po.payment_terms || 'As per agreement',
  CONDITION: po.condition || 'Standard terms apply',
  DELIVERY_DATE: formatDocumentDate(po.delivery_date || 'TBD'),
  ```
  To:
  ```javascript
  PAYMENT_TERMS: po.payment_terms || '',
  CONDITION: po.condition || '',
  DELIVERY_DATE: po.delivery_date ? formatDocumentDate(po.delivery_date) : '',
  ```

  **procurement.js** (lines 4953-4955 in `generatePODocument()`):
  Apply the exact same change:
  ```javascript
  PAYMENT_TERMS: po.payment_terms || '',
  CONDITION: po.condition || '',
  DELIVERY_DATE: po.delivery_date ? formatDocumentDate(po.delivery_date) : '',
  ```

  Note: The `delivery_date` change uses a ternary instead of `||` because `formatDocumentDate('')` would produce an unwanted formatted result -- only call it when a real value exists.
  </action>
  <verify>
  Open the app in browser. In Finance > Purchase Orders, click "View PO" on a PO that has NOT had payment_terms, condition, or delivery_date filled in by procurement. Verify:
  - The document shows blank/empty for Payment Terms (not "As per agreement")
  - The document shows blank/empty for Condition (not "Standard terms apply")
  - The document shows blank/empty for Delivery Date (not "TBD")
  - POs that DO have these fields filled should still display them normally
  </verify>
  <done>
  PO documents in both Finance and Procurement views show blank fields when procurement hasn't filled payment_terms, condition, and delivery_date. No hardcoded default text appears.
  </done>
</task>

</tasks>

<verification>
1. Navigate to Finance > Purchase Orders -- all PO dates display correctly (no "Invalid Date")
2. Click "View PO" on a PO without document details filled -- fields are blank, not defaulted
3. Navigate to Procurement > PO Tracking -- click "View PO" on a PO without document details -- same blank behavior
4. Browser console shows no date-related errors or warnings
</verification>

<success_criteria>
- PO Issued Date renders correctly for POs with both string and Timestamp date_issued values
- PO sort works correctly across mixed date formats
- View PO documents show blank fields when payment_terms, condition, delivery_date are not filled
- No regressions in PO display or document generation
</success_criteria>

<output>
After completion, create `.planning/phases/22-bug-fixes-and-ux-improvements/22-01-SUMMARY.md`
</output>
