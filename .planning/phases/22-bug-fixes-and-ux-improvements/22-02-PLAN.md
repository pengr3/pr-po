---
phase: 22-bug-fixes-and-ux-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/projects.js
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "Procurement users navigating to Projects tab see no Firestore permission-denied errors in browser console"
    - "Procurement users can view projects in read-only mode without the users collection listener firing"
    - "Personnel editing on Projects tab continues to work for authorized users (super_admin, operations_admin)"
    - "When a PO is marked as Delivered with a delivery fee, the PO's total_amount is updated to include the delivery fee"
    - "Project expense totals in Finance automatically reflect delivery fees without any aggregation query changes"
  artifacts:
    - path: "app/views/projects.js"
      provides: "Permission guard on loadActiveUsers()"
      contains: "canEditTab"
    - path: "app/views/procurement.js"
      provides: "Delivery fee added to total_amount at write time"
      contains: "total_amount"
  key_links:
    - from: "app/views/projects.js"
      to: "app/permissions.js"
      via: "window.canEditTab('projects')"
      pattern: "canEditTab.*projects"
    - from: "app/views/procurement.js"
      to: "app/views/finance.js"
      via: "delivery_fee included in total_amount consumed by sum('total_amount') aggregation"
      pattern: "total_amount.*delivery"
  notes:
    - "Success criterion 4 (status persistence) was verified during research -- PO status dropdown persistence already works correctly. No code changes needed for that item."
---

<objective>
Fix Firestore permission errors for procurement users on Projects tab and ensure delivery fees are included in project expense totals.

Purpose: Procurement users get console errors when viewing Projects because the users collection listener fires without proper permissions. Delivery fees saved during "Delivered" status change are not reflected in expense aggregation queries which only sum total_amount.

Output: No permission errors for read-only project viewers, delivery fees automatically captured in all expense totals.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-bug-fixes-and-ux-improvements/22-RESEARCH.md

@app/views/projects.js (lines 370-396 -- loadActiveUsers with users collection listener)
@app/views/procurement.js (lines 3860-3903 -- updatePOStatus with delivery_fee)
@app/views/finance.js (lines 788-804 -- expense aggregation using sum('total_amount'))
</context>

<tasks>

<task type="auto">
  <name>Task 1: Guard users collection listener with edit permission check</name>
  <files>app/views/projects.js</files>
  <action>
  Modify the `loadActiveUsers()` function (projects.js, around line 371) to check edit permissions before setting up the onSnapshot listener on the users collection.

  The users list is only needed for the personnel pill selector (Phase 20 edit feature). Read-only users (like procurement role) don't need it and will get Firestore permission-denied errors because security rules only allow super_admin and operations_admin to list users.

  **Add permission guard at the top of `loadActiveUsers()`:**
  ```javascript
  async function loadActiveUsers() {
      // Personnel pill selector is an edit feature - skip for view-only users
      // Firestore rules only allow super_admin/operations_admin to list users
      const canEdit = window.canEditTab?.('projects');
      if (canEdit === false) {
          console.log('[Projects] Skipping user load (view-only mode)');
          return;
      }

      try {
          // ... existing code unchanged
      }
  }
  ```

  Also add an error callback to the existing `onSnapshot` call (line 378) as a safety net, so that even if the guard is somehow bypassed, the error is handled gracefully instead of throwing an unhandled exception:
  ```javascript
  const listener = onSnapshot(usersQuery, (snapshot) => {
      // ... existing success handler unchanged
  }, (error) => {
      console.warn('[Projects] Users listener error (likely permissions):', error.message);
  });
  ```

  This follows the pattern established in the project where `canEditTab` returns `false` for users without edit permission and `undefined` when permissions haven't loaded yet (backward compatible -- `undefined !== false`, so the listener still fires for users whose permissions are loading).
  </action>
  <verify>
  1. Log in as a procurement user and navigate to Projects tab
  2. Browser console should show "[Projects] Skipping user load (view-only mode)" instead of permission-denied errors
  3. Log in as super_admin and navigate to Projects tab -- personnel pill selector loads normally with user list
  4. No Firestore permission-denied errors in browser console for either role
  </verify>
  <done>
  Procurement users can view the Projects tab without Firestore permission errors. The users collection listener only fires for roles that have edit permission on projects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Include delivery fee in PO total_amount at write time</name>
  <files>app/views/procurement.js</files>
  <action>
  Modify the `updatePOStatus()` function in procurement.js to add the delivery fee to `total_amount` when status changes to "Delivered". This ensures all expense aggregation queries (which use `sum('total_amount')`) automatically include delivery fees.

  `getDoc` is already imported (line 7). Two changes are needed:

  **Change 1: Move `poRef` declaration before the if/else block.**

  BEFORE (current code, lines 3859-3888):
  ```javascript
  try {
      const updateData = {
          procurement_status: newStatus,
          updated_at: new Date().toISOString()
      };

      if (isSubcon) {
          // ... subcon branches ...
      } else {
          // ... material branches ...
          } else if (newStatus === 'Delivered') {
              updateData.delivered_at = serverTimestamp();
              updateData.delivered_date = new Date().toISOString().split('T')[0];
              updateData.delivery_fee = deliveryFee;
          }
      }

      const poRef = doc(db, 'pos', poId);
      await updateDoc(poRef, updateData);
  ```

  AFTER (revised code):
  ```javascript
  try {
      const poRef = doc(db, 'pos', poId);  // Moved up: needed in Delivered branch for getDoc

      const updateData = {
          procurement_status: newStatus,
          updated_at: new Date().toISOString()
      };

      if (isSubcon) {
          // ... subcon branches unchanged ...
      } else {
          // ... other material branches unchanged ...
          } else if (newStatus === 'Delivered') {
              updateData.delivered_at = serverTimestamp();
              updateData.delivered_date = new Date().toISOString().split('T')[0];
              updateData.delivery_fee = deliveryFee;
              // Add delivery fee to total_amount so expense aggregation
              // queries (sum('total_amount')) automatically include delivery costs
              if (deliveryFee > 0) {
                  const poDoc = await getDoc(poRef);
                  const currentTotal = poDoc.data()?.total_amount || 0;
                  updateData.total_amount = currentTotal + deliveryFee;
              }
          }
      }

      await updateDoc(poRef, updateData);  // poRef now defined above, same variable
  ```

  Summary of the two edits:
  1. Cut `const poRef = doc(db, 'pos', poId);` from line 3887 and paste it at line 3860 (right after `try {`, before `const updateData`)
  2. Add 5 lines inside the Delivered branch (after `updateData.delivery_fee = deliveryFee;`): the `if (deliveryFee > 0)` block that reads current total and adds the fee

  The `delivery_fee` field is preserved separately for display purposes (PO details modal shows it at procurement.js:4119-4123), while `total_amount` now represents the complete cost including delivery.
  </action>
  <verify>
  1. In Procurement, change a PO's status to "Delivered" and enter a delivery fee (e.g., 500)
  2. Check Firestore directly (browser console or Firebase console) -- the PO document should show `total_amount` = original item total + 500
  3. Navigate to Finance > Project List and click Refresh -- the project's Total Expense should include the delivery fee
  4. Click the project to open expense modal -- materials total should include the delivery fee
  5. Verify the PO details modal still shows the delivery fee separately
  </verify>
  <done>
  Delivery fees are added to total_amount at write time. All expense aggregation queries across Finance and Project Detail views automatically include delivery fees without modification. The delivery_fee field remains for display purposes.
  </done>
</task>

</tasks>

<verification>
1. Log in as procurement user -- navigate to Projects tab -- no console errors
2. Log in as super_admin -- navigate to Projects tab -- personnel pill selector works normally
3. Mark a PO as Delivered with a delivery fee -- total_amount in Firestore includes the fee
4. Finance Project List shows expense totals that include delivery fees
5. Project detail expense calculation includes delivery fees
</verification>

<success_criteria>
- Zero Firestore permission-denied errors for procurement users viewing Projects
- Delivery fees are reflected in all project expense totals via total_amount inclusion
- No double-counting of delivery fees (only added once at write time)
- No regressions in PO status tracking or project permissions
</success_criteria>

<output>
After completion, create `.planning/phases/22-bug-fixes-and-ux-improvements/22-02-SUMMARY.md`
</output>
