---
phase: 22-bug-fixes-and-ux-improvements
plan: 03
type: execute
wave: 2
depends_on: ["22-01", "22-02"]
files_modified:
  - app/views/finance.js
  - app/views/clients.js
autonomous: true

must_haves:
  truths:
    - "Clicking a column header in Finance Project List table sorts rows by that column (ascending on first click, descending on second click)"
    - "Clicking a column header in Finance Purchase Orders table sorts rows by that column"
    - "Clicking a column header in Clients table sorts rows by that column"
    - "Sort indicators (arrows) appear next to the active sort column and show direction"
    - "Inactive columns show a neutral sort indicator (double arrow)"
    - "Sorting resets to page 1 where pagination exists"
    - "Real-time onSnapshot updates preserve the user's current sort selection for POs"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Sortable headers for Project List and Purchase Orders tables"
      contains: "sortProjectExpenses"
    - path: "app/views/clients.js"
      provides: "Sortable headers for Clients table"
      contains: "sortClients"
  key_links:
    - from: "app/views/finance.js"
      to: "app/views/projects.js"
      via: "Replicates sort pattern (state vars, click handler, comparator, indicators)"
      pattern: "sort-indicator"
    - from: "app/views/clients.js"
      to: "app/views/projects.js"
      via: "Replicates sort pattern"
      pattern: "sort-indicator"
---

<objective>
Add sortable table headers (click-to-sort) to Finance and Clients views following the existing projects.js pattern.

Purpose: Users need to sort data in Finance (Project List, Purchase Orders) and Clients tables to find information quickly. The projects.js view already has a working implementation to replicate.

Output: Sortable column headers with visual indicators across Finance and Clients views.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-bug-fixes-and-ux-improvements/22-RESEARCH.md

@app/views/projects.js (lines 19-23 -- sort state vars, lines 220-238 -- header HTML with onclick, lines 722-793 -- sort comparator + indicators)
@app/views/finance.js (lines 836-899 -- renderProjectExpensesTable, lines 2145-2164 -- loadPOs with onSnapshot sort, lines 2169-2219 -- renderPOs)
@app/views/clients.js (lines 30-99 -- render with table headers, lines 145-165 -- loadClients with onSnapshot sort, lines 170-227 -- renderClientsTable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sortable headers to Finance Project List table</name>
  <files>app/views/finance.js</files>
  <action>
  Add sortable table headers to the Project List table in finance.js, following the projects.js pattern exactly.

  **A. Add sort state variables** near the top of the file (after the existing state variables around line 16):
  ```javascript
  // Sort state for Project List
  let projectExpenseSortColumn = 'projectName';
  let projectExpenseSortDirection = 'asc';
  ```

  **B. Add window function** in `attachWindowFunctions()` (around line 25):
  ```javascript
  window.sortProjectExpenses = sortProjectExpenses;
  ```

  **C. Add cleanup** in `destroy()` -- delete the window function:
  ```javascript
  delete window.sortProjectExpenses;
  ```

  **D. Update Project List table headers** in `renderProjectExpensesTable()` (replace the `<thead>` section around lines 853-862):
  ```html
  <thead>
      <tr>
          <th onclick="window.sortProjectExpenses('projectName')" style="cursor: pointer; user-select: none;">
              Project Name <span class="sort-indicator" data-col="projectName"></span>
          </th>
          <th onclick="window.sortProjectExpenses('clientCode')" style="cursor: pointer; user-select: none;">
              Client <span class="sort-indicator" data-col="clientCode"></span>
          </th>
          <th onclick="window.sortProjectExpenses('budget')" style="cursor: pointer; user-select: none; text-align: right;">
              Budget <span class="sort-indicator" data-col="budget"></span>
          </th>
          <th onclick="window.sortProjectExpenses('totalExpense')" style="cursor: pointer; user-select: none; text-align: right;">
              Total Expense <span class="sort-indicator" data-col="totalExpense"></span>
          </th>
          <th onclick="window.sortProjectExpenses('remainingBudget')" style="cursor: pointer; user-select: none; text-align: right;">
              Remaining <span class="sort-indicator" data-col="remainingBudget"></span>
          </th>
          <th onclick="window.sortProjectExpenses('status')" style="cursor: pointer; user-select: none; text-align: center;">
              Status <span class="sort-indicator" data-col="status"></span>
          </th>
      </tr>
  </thead>
  ```

  **E. Add `sortProjectExpenses()` function** (place near `renderProjectExpensesTable()`):
  ```javascript
  function sortProjectExpenses(column) {
      if (projectExpenseSortColumn === column) {
          projectExpenseSortDirection = projectExpenseSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
          projectExpenseSortColumn = column;
          projectExpenseSortDirection = 'asc';
      }
      // Sort the data
      projectExpenses.sort((a, b) => {
          let aVal = a[column];
          let bVal = b[column];
          if (aVal == null) return projectExpenseSortDirection === 'asc' ? 1 : -1;
          if (bVal == null) return projectExpenseSortDirection === 'asc' ? -1 : 1;
          if (typeof aVal === 'string') {
              return projectExpenseSortDirection === 'asc'
                  ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return projectExpenseSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      });
      renderProjectExpensesTable();
  }
  ```

  **F. Add sort indicator update** at the END of `renderProjectExpensesTable()` (after `container.innerHTML = tableHTML`):
  ```javascript
  // Update sort indicators for project expenses table
  container.querySelectorAll('.sort-indicator').forEach(indicator => {
      const col = indicator.dataset.col;
      if (col === projectExpenseSortColumn) {
          indicator.textContent = projectExpenseSortDirection === 'asc' ? ' \u2191' : ' \u2193';
          indicator.style.color = '#1a73e8';
      } else {
          indicator.textContent = ' \u21C5';
          indicator.style.color = '#94a3b8';
      }
  });
  ```

  NOTE: The Pending Approvals tables (Material PRs and Transport Requests) are NOT sorted by the user because they show only pending items and are typically a small list. Skip adding sort to those tables.
  </action>
  <verify>
  Navigate to Finance > Project List -- click "Project Name" header, rows sort A-Z. Click again, sorts Z-A. Arrow indicator changes direction. Click "Budget" header, rows sort by budget ascending. Active column shows blue arrow, others show neutral double-arrow. No console errors.
  </verify>
  <done>
  Finance Project List table has clickable sortable headers with visual direction indicators for all 6 data columns. Sort toggles between ascending and descending on repeated clicks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sortable headers to Finance Purchase Orders table and fix onSnapshot sort</name>
  <files>app/views/finance.js</files>
  <action>
  Add sortable table headers to the Purchase Orders table and ensure real-time onSnapshot updates preserve the user's sort selection.

  **A. Add sort state variables** near the top of the file (alongside the Project List sort state added in Task 1):
  ```javascript
  // Sort state for Purchase Orders
  let poSortColumn = 'date_issued';
  let poSortDirection = 'desc';
  ```

  **B. Add window function** in `attachWindowFunctions()`:
  ```javascript
  window.sortPOs = sortPOs;
  ```

  **C. Add cleanup** in `destroy()`:
  ```javascript
  delete window.sortPOs;
  ```

  **D. Replace the hardcoded sort in `loadPOs()` onSnapshot callback** (line 2157).

  Plan 01 will have already changed line 2157 to a Timestamp-aware comparator. Replace that comparator with one that uses the dynamic sort state variables so onSnapshot preserves the user's selected sort order:

  Replace the sort block at line 2157 (whatever Plan 01 left there) with:
  ```javascript
  // Sort using current user-selected sort state (default: date_issued desc)
  poData.sort((a, b) => {
      let aVal = a[poSortColumn];
      let bVal = b[poSortColumn];
      if (poSortColumn === 'date_issued') {
          aVal = aVal?.toDate ? aVal.toDate() : new Date(aVal || 0);
          bVal = bVal?.toDate ? bVal.toDate() : new Date(bVal || 0);
      }
      if (aVal == null) return poSortDirection === 'asc' ? 1 : -1;
      if (bVal == null) return poSortDirection === 'asc' ? -1 : 1;
      if (typeof aVal === 'string') {
          return poSortDirection === 'asc'
              ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      }
      return poSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
  });
  ```

  This ensures that when Firestore pushes a real-time update (e.g., PO status change), the PO list re-sorts using whatever column/direction the user has currently selected, instead of always reverting to newest-first.

  **E. Update Purchase Orders table headers** in `renderPOs()` (replace the `<thead>` section around lines 2188-2198):
  ```html
  <thead>
      <tr>
          <th onclick="window.sortPOs('po_id')" style="cursor: pointer; user-select: none;">
              PO ID <span class="sort-indicator" data-col="po_id"></span>
          </th>
          <th onclick="window.sortPOs('pr_id')" style="cursor: pointer; user-select: none;">
              PR ID <span class="sort-indicator" data-col="pr_id"></span>
          </th>
          <th onclick="window.sortPOs('supplier_name')" style="cursor: pointer; user-select: none;">
              Supplier <span class="sort-indicator" data-col="supplier_name"></span>
          </th>
          <th onclick="window.sortPOs('project_name')" style="cursor: pointer; user-select: none;">
              Project <span class="sort-indicator" data-col="project_name"></span>
          </th>
          <th onclick="window.sortPOs('total_amount')" style="cursor: pointer; user-select: none;">
              Amount <span class="sort-indicator" data-col="total_amount"></span>
          </th>
          <th onclick="window.sortPOs('date_issued')" style="cursor: pointer; user-select: none;">
              Date Issued <span class="sort-indicator" data-col="date_issued"></span>
          </th>
          <th onclick="window.sortPOs('procurement_status')" style="cursor: pointer; user-select: none;">
              Status <span class="sort-indicator" data-col="procurement_status"></span>
          </th>
          <th>Actions</th>
      </tr>
  </thead>
  ```

  **F. Add `sortPOs()` function** (place near `renderPOs()`):
  ```javascript
  function sortPOs(column) {
      if (poSortColumn === column) {
          poSortDirection = poSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
          poSortColumn = column;
          poSortDirection = 'asc';
      }
      // Sort poData - handle Firestore Timestamps for date_issued
      poData.sort((a, b) => {
          let aVal = a[column];
          let bVal = b[column];
          if (column === 'date_issued') {
              aVal = aVal?.toDate ? aVal.toDate() : new Date(aVal || 0);
              bVal = bVal?.toDate ? bVal.toDate() : new Date(bVal || 0);
          }
          if (aVal == null) return poSortDirection === 'asc' ? 1 : -1;
          if (bVal == null) return poSortDirection === 'asc' ? -1 : 1;
          if (typeof aVal === 'string') {
              return poSortDirection === 'asc'
                  ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return poSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      });
      renderPOs();
  }
  ```

  **G. Add sort indicator update** at the END of `renderPOs()` (after `container.innerHTML = ...`):
  ```javascript
  // Update sort indicators for PO table
  container.querySelectorAll('.sort-indicator').forEach(indicator => {
      const col = indicator.dataset.col;
      if (col === poSortColumn) {
          indicator.textContent = poSortDirection === 'asc' ? ' \u2191' : ' \u2193';
          indicator.style.color = '#1a73e8';
      } else {
          indicator.textContent = ' \u21C5';
          indicator.style.color = '#94a3b8';
      }
  });
  ```
  </action>
  <verify>
  1. Navigate to Finance > Purchase Orders -- click "Supplier" header, sorts alphabetically. Click "Amount" header, sorts by amount. Click "Date Issued", sorts by date. Click "Status", sorts by status text.
  2. Sort by Supplier ascending, then trigger a real-time update (e.g., change a PO status in another tab). Verify the PO list stays sorted by Supplier ascending (not reverting to date descending).
  3. No console errors during sorting.
  </verify>
  <done>
  Finance Purchase Orders table has clickable sortable headers with visual direction indicators. Real-time onSnapshot updates preserve the user's current sort selection instead of reverting to hardcoded newest-first.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sortable headers to Clients table</name>
  <files>app/views/clients.js</files>
  <action>
  Add sortable table headers to the Clients view following the same projects.js pattern.

  **A. Add sort state variables** near the top of the file (after `let listeners = [];` around line 14):
  ```javascript
  // Sort state
  let sortColumn = 'company_name';
  let sortDirection = 'asc';
  ```

  **B. Add window function** in `attachWindowFunctions()` (around line 17):
  ```javascript
  window.sortClients = sortClients;
  ```

  **C. Add cleanup** in `destroy()`:
  ```javascript
  delete window.sortClients;
  ```

  **D. Update table headers** in `render()` (replace the `<thead>` section around lines 82-89):
  ```html
  <thead>
      <tr>
          <th onclick="window.sortClients('client_code')" style="cursor: pointer; user-select: none;">
              Client Code <span class="sort-indicator" data-col="client_code"></span>
          </th>
          <th onclick="window.sortClients('company_name')" style="cursor: pointer; user-select: none;">
              Company Name <span class="sort-indicator" data-col="company_name"></span>
          </th>
          <th onclick="window.sortClients('contact_person')" style="cursor: pointer; user-select: none;">
              Contact Person <span class="sort-indicator" data-col="contact_person"></span>
          </th>
          <th>Contact Details</th>
          <th>Actions</th>
      </tr>
  </thead>
  ```
  Note: Contact Details and Actions columns are NOT sortable (contact details is freeform text, actions is just buttons).

  **E. Add `sortClients()` function** (place after `loadClients()` or before `renderClientsTable()`):
  ```javascript
  function sortClients(column) {
      if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
          sortColumn = column;
          sortDirection = 'asc';
      }
      // Reset pagination
      currentPage = 1;
      // Sort the data
      clientsData.sort((a, b) => {
          let aVal = a[column];
          let bVal = b[column];
          if (aVal == null) return sortDirection === 'asc' ? 1 : -1;
          if (bVal == null) return sortDirection === 'asc' ? -1 : 1;
          if (typeof aVal === 'string') {
              return sortDirection === 'asc'
                  ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      });
      renderClientsTable();
  }
  ```

  **F. Replace the hardcoded sort in `loadClients()` onSnapshot callback** (around line 158).

  Replace:
  ```javascript
  clientsData.sort((a, b) => a.company_name.localeCompare(b.company_name));
  ```
  With an inline sort that uses the dynamic sort state variables:
  ```javascript
  // Sort by current user-selected column (default: company_name ascending)
  clientsData.sort((a, b) => {
      let aVal = a[sortColumn];
      let bVal = b[sortColumn];
      if (aVal == null) return sortDirection === 'asc' ? 1 : -1;
      if (bVal == null) return sortDirection === 'asc' ? -1 : 1;
      if (typeof aVal === 'string') {
          return sortDirection === 'asc'
              ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      }
      return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
  });
  ```
  This preserves the existing data flow (onSnapshot -> sort -> renderClientsTable) but uses the dynamic sort state instead of hardcoded company_name ascending, so real-time updates don't override the user's sort selection.

  **G. Add sort indicator update** at the END of `renderClientsTable()` (after `updatePaginationControls(...)`, before the closing brace):
  ```javascript
  // Update sort indicators
  document.querySelectorAll('.sort-indicator').forEach(indicator => {
      const col = indicator.dataset.col;
      if (col === sortColumn) {
          indicator.textContent = sortDirection === 'asc' ? ' \u2191' : ' \u2193';
          indicator.style.color = '#1a73e8';
      } else {
          indicator.textContent = ' \u21C5';
          indicator.style.color = '#94a3b8';
      }
  });
  ```

  **H. Reset sort state** in `destroy()` (to reset for next visit):
  ```javascript
  sortColumn = 'company_name';
  sortDirection = 'asc';
  ```
  </action>
  <verify>
  1. Navigate to Clients tab -- table loads sorted by Company Name ascending (default). The Company Name column header shows a blue up arrow. Other sortable columns show neutral double arrows.
  2. Click "Client Code" header -- rows sort by client code. Arrow indicator updates.
  3. Click "Client Code" again -- sort reverses (descending). Arrow changes to down.
  4. Click "Contact Person" -- sorts by contact person name.
  5. If more than 15 clients exist, verify sorting resets pagination to page 1.
  6. Verify "Contact Details" and "Actions" columns are NOT clickable (no cursor change).
  </verify>
  <done>
  Clients table has sortable headers for Client Code, Company Name, and Contact Person with visual sort indicators. Pagination resets on sort. Default sort is Company Name ascending.
  </done>
</task>

</tasks>

<verification>
1. Finance > Project List -- all 6 data columns are sortable with click-to-toggle and visual indicators
2. Finance > Purchase Orders -- 7 data columns (all except Actions) are sortable with click-to-toggle
3. Finance > Purchase Orders -- sort by a non-default column, trigger a real-time update, sort is preserved
4. Clients -- Client Code, Company Name, Contact Person are sortable; Contact Details and Actions are not
5. Sort indicators show blue arrow for active column, gray double-arrow for inactive columns
6. Sorting in Clients resets pagination to page 1
7. No console errors during any sort operations
</verification>

<success_criteria>
- All target tables have clickable sortable column headers
- Sort toggles between ascending and descending on repeated clicks
- Visual sort indicators (arrows) correctly reflect current sort state
- Real-time onSnapshot updates preserve user's sort selection (not reverting to hardcoded sort)
- Pagination resets on sort where applicable
- No regressions in table rendering or data display
</success_criteria>

<output>
After completion, create `.planning/phases/22-bug-fixes-and-ux-improvements/22-03-SUMMARY.md`
</output>
