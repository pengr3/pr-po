---
phase: 21-personnel-assignment-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/firebase.js
  - app/utils.js
  - app/views/projects.js
  - app/views/project-detail.js
autonomous: true

must_haves:
  truths:
    - "Adding a user as personnel on a project adds the project code to their assigned_project_codes"
    - "Removing a user as personnel removes the project code from their assigned_project_codes"
    - "Operations users immediately see projects they were assigned to via personnel field"
    - "Editing personnel in project-detail.js also syncs assignments"
    - "Project Assignments admin panel continues to work (manual overrides preserved)"
    - "Users with all_projects: true are not affected by sync"
  artifacts:
    - path: "app/firebase.js"
      provides: "arrayUnion and arrayRemove imports and exports"
      contains: "arrayUnion"
    - path: "app/utils.js"
      provides: "syncPersonnelToAssignments utility function"
      exports: ["syncPersonnelToAssignments"]
    - path: "app/views/projects.js"
      provides: "Sync calls in addProject and saveEdit"
      contains: "syncPersonnelToAssignments"
    - path: "app/views/project-detail.js"
      provides: "Sync calls in selectDetailPersonnel and removeDetailPersonnel"
      contains: "syncPersonnelToAssignments"
  key_links:
    - from: "app/utils.js"
      to: "app/firebase.js"
      via: "import arrayUnion, arrayRemove"
      pattern: "import.*arrayUnion.*arrayRemove.*from.*firebase"
    - from: "app/views/projects.js"
      to: "app/utils.js"
      via: "import syncPersonnelToAssignments"
      pattern: "import.*syncPersonnelToAssignments.*from.*utils"
    - from: "app/views/project-detail.js"
      to: "app/utils.js"
      via: "import syncPersonnelToAssignments"
      pattern: "import.*syncPersonnelToAssignments.*from.*utils"
    - from: "app/utils.js syncPersonnelToAssignments"
      to: "Firestore users collection"
      via: "arrayUnion/arrayRemove on assigned_project_codes field"
      pattern: "arrayUnion\\(projectCode\\)"
---

<objective>
Implement automatic synchronization between project personnel assignments and user `assigned_project_codes`. When personnel are added or removed from a project (via either projects.js or project-detail.js), the affected users' `assigned_project_codes` arrays are atomically updated using Firestore `arrayUnion`/`arrayRemove`.

Purpose: Currently, admins must manually update user assignments via the Project Assignments panel after changing personnel on a project. This creates a data consistency gap where operations users cannot see projects they were added to as personnel. This plan closes that gap with automatic sync.

Output: A `syncPersonnelToAssignments()` utility function in utils.js, called from all 4 personnel mutation paths, with proper `all_projects` user skipping and fire-and-forget error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-personnel-assignment-sync/21-RESEARCH.md
@app/firebase.js
@app/utils.js
@app/views/projects.js
@app/views/project-detail.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add arrayUnion/arrayRemove to firebase.js and create syncPersonnelToAssignments in utils.js</name>
  <files>app/firebase.js, app/utils.js</files>
  <action>
**firebase.js changes:**
1. Add `arrayUnion` and `arrayRemove` to the existing Firestore import statement (line 8-30). They are named exports from the same CDN URL already imported.
2. Add `arrayUnion` and `arrayRemove` to the ES module export block (lines 63-84).
3. Add `arrayUnion` and `arrayRemove` to the `window.firestore` object (lines 97-118).

**utils.js changes:**
1. Add `arrayUnion, arrayRemove, getDoc, updateDoc, doc` to the import from `'./firebase.js'` at line 6. Note: `db` is NOT currently imported in utils.js -- it must also be added. Current import is: `import { db, collection, getDocs, query, where, orderBy, limit } from './firebase.js';` -- add `getDoc, updateDoc, doc, arrayUnion, arrayRemove` to this.
2. Add the `syncPersonnelToAssignments` function BEFORE the final console.log at line 496. The function signature: `export async function syncPersonnelToAssignments(projectCode, previousUserIds, newUserIds)`

**syncPersonnelToAssignments implementation (follow the research code example closely):**
- Guard: if `!projectCode`, log warning and return early (Pitfall 5: legacy projects without codes)
- Compute `addedUserIds` = items in newUserIds not in previousUserIds (use Set for O(n))
- Compute `removedUserIds` = items in previousUserIds not in newUserIds (use Set for O(n))
- Filter out falsy values from both input arrays using `.filter(Boolean)` before creating Sets
- Log the diff counts with `[PersonnelSync]` prefix
- If no additions and no removals, return early
- For each addedUserId:
  - `getDoc(doc(db, 'users', userId))` to check `all_projects` flag
  - If `all_projects === true`, skip (log with [PersonnelSync] prefix)
  - Otherwise: `updateDoc(doc(db, 'users', userId), { assigned_project_codes: arrayUnion(projectCode) })`
  - Wrap in try/catch, collect errors but do not throw
- For each removedUserId:
  - `updateDoc(doc(db, 'users', userId), { assigned_project_codes: arrayRemove(projectCode) })`
  - No need to check `all_projects` -- arrayRemove on non-existent value is a no-op
  - Wrap in try/catch, collect errors but do not throw
- If errors occurred, log warning with count
- Return the errors array (caller can inspect but should not block on it)

**Do NOT:**
- Use `writeBatch` -- individual `updateDoc` with `arrayUnion`/`arrayRemove` is already atomic and simpler for 1-3 users
- Read-modify-write the array -- `arrayUnion`/`arrayRemove` are the correct primitives
- Block the caller on sync errors -- the function is meant to be called fire-and-forget
  </action>
  <verify>
Open browser DevTools console and verify:
- `window.firestore.arrayUnion` is a function (not undefined)
- `window.firestore.arrayRemove` is a function (not undefined)
- No import errors in console on page load
  </verify>
  <done>
`arrayUnion` and `arrayRemove` are exported from firebase.js (ES module + window.firestore). `syncPersonnelToAssignments` is exported from utils.js with proper diff logic, `all_projects` skip, and fire-and-forget error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire syncPersonnelToAssignments into all 4 personnel mutation paths</name>
  <files>app/views/projects.js, app/views/project-detail.js</files>
  <action>
**projects.js changes:**

1. Update the import line (line 7) to add `syncPersonnelToAssignments`:
   Current: `import { showLoading, showToast, generateProjectCode, normalizePersonnel } from '../utils.js';`
   New: `import { showLoading, showToast, generateProjectCode, normalizePersonnel, syncPersonnelToAssignments } from '../utils.js';`

2. In `addProject()` function (~line 654, after the `addDoc` succeeds and before `showToast`):
   - The `project_code` variable is already available from line 636.
   - All personnel are "added" (no previous state), so pass `[]` as previousUserIds.
   - Add fire-and-forget sync call:
   ```javascript
   // Sync personnel to user assignments (fire-and-forget)
   const newUserIds = selectedPersonnel.map(u => u.id).filter(Boolean);
   syncPersonnelToAssignments(project_code, [], newUserIds)
       .catch(err => console.error('[Projects] Assignment sync failed:', err));
   ```
   Place this AFTER the `addDoc` call (line 654) and BEFORE `showToast` (line 656).

3. In `saveEdit()` function:
   - BEFORE the try block (~line 979), capture the old personnel state:
   ```javascript
   // Capture old personnel BEFORE save for sync diff
   const existingProject = allProjects.find(p => p.id === editingProject);
   const oldNormalized = normalizePersonnel(existingProject);
   const oldUserIds = oldNormalized.userIds;
   ```
   - AFTER the `updateDoc` succeeds (~line 991, after line `await updateDoc(projectRef, {...})`) and BEFORE `showToast` (line 993):
   ```javascript
   // Sync personnel assignment changes (fire-and-forget)
   const newUserIds = selectedPersonnel.map(u => u.id).filter(Boolean);
   const projectCode = existingProject?.project_code;
   syncPersonnelToAssignments(projectCode, oldUserIds, newUserIds)
       .catch(err => console.error('[Projects] Assignment sync failed:', err));
   ```

**project-detail.js changes:**

1. Update the import line (line 7) to add `syncPersonnelToAssignments`:
   Current: `import { formatCurrency, formatDate, showLoading, showToast, normalizePersonnel } from '../utils.js';`
   New: `import { formatCurrency, formatDate, showLoading, showToast, normalizePersonnel, syncPersonnelToAssignments } from '../utils.js';`

2. In `selectDetailPersonnel()` function (~line 484):
   - BEFORE the push to `detailSelectedPersonnel` (line 488), capture previous state:
   ```javascript
   // Capture old state for sync diff
   const previousUserIds = detailSelectedPersonnel.map(u => u.id).filter(Boolean);
   ```
   - AFTER the `updateDoc` succeeds (line 499, after the console.log), add sync:
   ```javascript
   // Sync assignment (fire-and-forget)
   const newUserIds = detailSelectedPersonnel.map(u => u.id).filter(Boolean);
   syncPersonnelToAssignments(currentProject.project_code, previousUserIds, newUserIds)
       .catch(err => console.error('[ProjectDetail] Assignment sync failed:', err));
   ```

3. In `removeDetailPersonnel()` function (~line 517):
   - The `previousState` is ALREADY captured at line 520 as `[...detailSelectedPersonnel]`.
   - AFTER the `updateDoc` succeeds (line 538, after the console.log), add sync:
   ```javascript
   // Sync assignment (fire-and-forget)
   const previousUserIds = previousState.map(u => u.id).filter(Boolean);
   const newUserIds = detailSelectedPersonnel.map(u => u.id).filter(Boolean);
   syncPersonnelToAssignments(currentProject.project_code, previousUserIds, newUserIds)
       .catch(err => console.error('[ProjectDetail] Assignment sync failed:', err));
   ```

**Do NOT:**
- Add sync logic to the error/rollback paths -- only sync after successful Firestore write
- Make the sync call awaited in the main flow -- use `.catch()` fire-and-forget pattern
- Add sync to the Project Assignments admin panel (project-assignments.js) -- that system directly writes to `assigned_project_codes` already
  </action>
  <verify>
Manual test sequence:
1. Start local server: `python -m http.server 8000`
2. Log in as admin user
3. Navigate to Projects tab, create a new project with a personnel user
4. Check browser console for `[PersonnelSync] Syncing for project:` log with `Added: 1`
5. Open Firebase Console > Firestore > users collection > check the assigned user's `assigned_project_codes` array includes the new project code
6. Navigate to a project detail page, add a new personnel user
7. Check console for `[PersonnelSync]` log and verify Firestore update
8. Remove a personnel user from project detail
9. Check console for `[PersonnelSync]` log with `Removed: 1` and verify Firestore update
10. No errors in console (especially no `syncPersonnelToAssignments is not a function` or `arrayUnion is not a function`)
  </verify>
  <done>
All 4 personnel mutation paths (projects.js addProject, projects.js saveEdit, project-detail.js selectDetailPersonnel, project-detail.js removeDetailPersonnel) call syncPersonnelToAssignments after successful Firestore write. Operations users assigned as personnel immediately see the project in their project list via the existing auth observer reactivity chain.
  </done>
</task>

</tasks>

<verification>
1. Create a project with personnel user A -- user A's `assigned_project_codes` includes the new project code
2. Edit the project and remove user A, add user B -- user A loses the code, user B gains it
3. In project detail, add user C as personnel -- user C gains the code
4. In project detail, remove user C -- user C loses the code
5. Test with a user who has `all_projects: true` -- their `assigned_project_codes` should NOT be modified
6. Test with a legacy project that has no `project_code` -- sync should skip gracefully (console warning, no error)
7. Project Assignments admin panel still works independently for manual overrides
8. No console errors on any page load or navigation
</verification>

<success_criteria>
- arrayUnion and arrayRemove are properly imported, exported, and available on window.firestore
- syncPersonnelToAssignments is exported from utils.js and handles add/remove diff correctly
- All 4 mutation paths in projects.js and project-detail.js call sync after successful personnel save
- Users with all_projects: true are skipped during sync add operations
- Projects without project_code trigger a warning log but no error
- Sync failures do not block or roll back the personnel save (fire-and-forget)
- Existing Project Assignments admin panel is unmodified and continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/21-personnel-assignment-sync/21-01-SUMMARY.md`
</output>
