---
phase: 07-project-assignment-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/utils.js
  - app/auth.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "getAssignedProjectCodes() returns null for all roles except operations_user"
    - "getAssignedProjectCodes() returns the assigned array (or null for all_projects) for operations_user"
    - "getAssignedProjectCodes() treats missing fields as empty array for operations_user"
    - "auth.js dispatches assignmentsChanged event when assigned_project_codes or all_projects changes on the user document"
  artifacts:
    - path: "app/utils.js"
      provides: "Shared utility for reading project assignments from current user"
      contains: "getAssignedProjectCodes"
    - path: "app/auth.js"
      provides: "assignmentsChanged event dispatch in user-doc onSnapshot callback"
      contains: "assignmentsChanged"
  key_links:
    - from: "app/utils.js (getAssignedProjectCodes)"
      to: "window.getCurrentUser"
      via: "direct call to read currentUser.role, currentUser.all_projects, currentUser.assigned_project_codes"
      pattern: "getCurrentUser"
    - from: "app/auth.js (onSnapshot callback)"
      to: "assignmentsChanged CustomEvent"
      via: "window.dispatchEvent after detecting assignment field change"
      pattern: "dispatchEvent.*assignmentsChanged"
---

<objective>
Add the shared assignment utility and the real-time event dispatch that all downstream plans depend on.

Purpose: Every view that filters by project assignment calls getAssignedProjectCodes() to get the current user's scope. Every view that reacts to assignment changes listens for the assignmentsChanged event. Both must exist before any view filter or admin panel can work. This plan creates exactly those two pieces and nothing else.

Output: A single exported utility function in utils.js and a single new event dispatch block in auth.js's user-document onSnapshot callback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-project-assignment-system/07-RESEARCH.md
@app/utils.js
@app/auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAssignedProjectCodes utility to utils.js</name>
  <files>app/utils.js</files>
  <action>
Add a new exported function to app/utils.js. Place it in the DATA UTILITIES section (after generateProjectCode, before getActiveProjects -- around line 218).

```javascript
/**
 * Get the set of project codes the current user is allowed to see.
 * Returns null if no filtering should be applied (all roles except operations_user,
 * or operations_user with all_projects flag set).
 * Returns an array of project_code strings if the user is scoped to specific projects.
 * Returns an empty array if the user is operations_user with no assignments at all.
 *
 * @returns {string[]|null} Array of allowed project_codes, or null for "no filter"
 */
export function getAssignedProjectCodes() {
    const user = window.getCurrentUser?.();
    if (!user) return null;                          // Not logged in -- no filter
    if (user.role !== 'operations_user') return null; // Only operations_user is scoped

    if (user.all_projects === true) return null;     // "All projects" escape hatch

    // Return the array if present, otherwise empty array (zero assignments)
    return Array.isArray(user.assigned_project_codes) ? user.assigned_project_codes : [];
}
```

Also expose it on window at the bottom of the file, in the existing window.utils object (add it to that object alongside the other exports around line 405-425):

```javascript
window.utils = {
    // ... all existing entries ...
    getAssignedProjectCodes,
    // ...
};
```

And add a standalone window exposure after the utils object:
```javascript
window.getAssignedProjectCodes = getAssignedProjectCodes;
```

Do NOT remove or reorder any existing code. This is a pure addition.
  </action>
  <verify>
Open browser console and run:
```javascript
import('./app/utils.js').then(m => console.log('exported:', typeof m.getAssignedProjectCodes));
```
Should print: `exported: function`

Also confirm window.getAssignedProjectCodes is available:
```javascript
console.log('window:', typeof window.getAssignedProjectCodes);
```
  </verify>
  <done>
getAssignedProjectCodes exported from utils.js and exposed on window. Returns null for non-operations_user roles and for all_projects flag; returns assigned_project_codes array (or empty array) for operations_user without all_projects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add assignmentsChanged event dispatch to auth.js user-doc listener</name>
  <files>app/auth.js</files>
  <action>
Modify the user-document onSnapshot callback in auth.js (the block starting at line 253) to detect assignment changes and dispatch a custom event.

The current callback structure is (simplified):
```
line 253: userDocUnsubscribe = onSnapshot(doc(db, 'users', user.uid), async (docSnapshot) => {
line 254:     if (docSnapshot.exists()) {
line 255:         const updatedUserData = docSnapshot.data();
line 257-258:     // Detect role change (PERM-19)
line 258:         const previousRole = currentUser?.role;
line 259:         currentUser = { uid: user.uid, ...updatedUserData };
line 261:         console.log(...)
line 263-273:   // role change block
line 275-292:   // AUTH-09 deactivation block
```

You need to:

1. BEFORE line 259 (before currentUser is reassigned), capture the previous assignment state:
```javascript
                            // Capture previous assignment state for change detection (Phase 7)
                            const previousAssignedCodes = currentUser?.assigned_project_codes;
                            const previousAllProjects = currentUser?.all_projects;
```

   Place these two lines right after `const previousRole = currentUser?.role;` (line 258) and before `currentUser = { uid: user.uid, ...updatedUserData };` (line 259).

2. AFTER the role-change block (after line 273, the closing brace of the `if (previousRole !== updatedUserData.role)` block) and BEFORE the AUTH-09 deactivation block (line 275), add the assignment change detection:

```javascript
                            // Phase 7: Detect assignment change and dispatch event
                            // Compares serialized arrays because array reference equality is always false
                            const newAssignedCodes = updatedUserData.assigned_project_codes;
                            const newAllProjects = updatedUserData.all_projects;
                            if (JSON.stringify(newAssignedCodes) !== JSON.stringify(previousAssignedCodes) ||
                                newAllProjects !== previousAllProjects) {
                                console.log('[Auth] Assignments changed, dispatching event');
                                window.dispatchEvent(new CustomEvent('assignmentsChanged', {
                                    detail: { user: currentUser }
                                }));
                            }
```

That is the complete change to auth.js. Do not modify anything else in the file. The role-change block and the AUTH-09 deactivation block remain exactly as they are.

IMPORTANT: The event fires on ANY change to either field, including the very first time an admin sets assignments on a new operations_user document. The JSON.stringify comparison correctly handles undefined vs missing vs empty array transitions.
  </action>
  <verify>
1. Grep auth.js for "assignmentsChanged" -- should appear in exactly two places: the dispatchEvent call and the console.log.
2. Grep auth.js for "previousAssignedCodes" -- should appear in two places: the capture line and the comparison.
3. Visually confirm the placement: previousAssignedCodes capture is AFTER previousRole capture and BEFORE currentUser reassignment. The assignmentsChanged block is AFTER the role-change closing brace and BEFORE the AUTH-09 deactivation block.
  </verify>
  <done>
auth.js user-doc onSnapshot callback now captures previous assignment state before updating currentUser, then compares and dispatches assignmentsChanged CustomEvent when either assigned_project_codes or all_projects changes. Placement is between the role-change block and the AUTH-09 block.
  </done>
</task>

</tasks>

<verification>
1. app/utils.js exports getAssignedProjectCodes function
2. window.getAssignedProjectCodes is available globally
3. app/auth.js contains previousAssignedCodes capture before currentUser reassignment
4. app/auth.js dispatches assignmentsChanged event after role-change block, before AUTH-09 block
5. No other changes to auth.js -- role change detection and deactivation handling unchanged
6. Browser console shows no import errors when loading either module
</verification>

<success_criteria>
- getAssignedProjectCodes() utility exists and is exported + on window
- assignmentsChanged event is dispatched in auth.js when assignment fields change on the user document
- Zero changes to existing functionality -- both additions are purely additive
- The auth.js onSnapshot callback structure remains: capture previous state -> update currentUser -> check role change -> check assignment change -> check deactivation
</success_criteria>

<output>
After completion, create `.planning/phases/07-project-assignment-system/07-01-SUMMARY.md`
</output>
