---
phase: 07-project-assignment-system
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - app/views/projects.js
  - app/views/project-detail.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Operations Users see only assigned projects in the project list"
    - "Operations Users with all_projects flag see all projects (no filtering)"
    - "Non-operations_user roles see all projects regardless of assignment fields"
    - "Legacy projects without project_code are always shown to operations_user (defensive)"
    - "Operations User on a project detail page whose assignment is removed sees an access denied message with a link back to the project list"
    - "Project list re-filters immediately when assignments change (no logout)"
    - "Project detail re-checks access immediately when assignments change"
  artifacts:
    - path: "app/views/projects.js"
      provides: "Project list with assignment-scoped filtering for operations_user"
      contains: "getAssignedProjectCodes"
    - path: "app/views/project-detail.js"
      provides: "Project detail with access denied on assignment removal"
      contains: "assignmentsChanged"
  key_links:
    - from: "app/views/projects.js (applyFilters)"
      to: "getAssignedProjectCodes()"
      via: "call at start of applyFilters, filter allProjects before existing filters run"
      pattern: "getAssignedProjectCodes"
    - from: "app/views/projects.js (init)"
      to: "assignmentsChanged event"
      via: "window.addEventListener in init, calls applyFilters on fire"
      pattern: "addEventListener.*assignmentsChanged"
    - from: "app/views/project-detail.js (onSnapshot callback)"
      to: "getAssignedProjectCodes()"
      via: "access check after currentProject is set"
      pattern: "getAssignedProjectCodes"
    - from: "app/views/project-detail.js (init)"
      to: "assignmentsChanged event"
      via: "window.addEventListener, re-runs access check"
      pattern: "addEventListener.*assignmentsChanged"
---

<objective>
Add assignment-based filtering to the project list view and access-denied enforcement to the project detail view.

Purpose: When an Operations User opens the Projects page, they should only see projects they are assigned to. If they navigate to a project detail page and an admin removes that project from their assignments, they see an access denied message in place (not a silent redirect). Both views react to assignmentsChanged events dispatched by auth.js (from 07-01) without requiring a page reload.

Output: projects.js filters its display list through getAssignedProjectCodes() before applying existing search/status/client filters. project-detail.js checks assignment access after loading the project and on every assignmentsChanged event.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-project-assignment-system/07-RESEARCH.md
@.planning/phases/07-project-assignment-system/07-01-SUMMARY.md
@app/views/projects.js
@app/views/project-detail.js
@app/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add assignment filter to projects.js</name>
  <files>app/views/projects.js</files>
  <action>
Two changes to projects.js. Both are purely additive -- no existing code is removed or rewritten.

**Change A: Add assignment pre-filter at the top of applyFilters()**

The applyFilters() function is at line 459. Its current first action is reading filter values from DOM elements (searchTerm, internalStatusFilter, etc.) at lines 460-463, then filtering allProjects at line 465.

Insert the following block BEFORE the existing `filteredProjects = allProjects.filter(...)` line (before line 465), but AFTER the DOM reads (after line 463):

```javascript
    // Phase 7: Scope to assigned projects for operations_user
    // getAssignedProjectCodes() returns null (no filter) for all roles except
    // operations_user without all_projects. Returns [] if zero assignments.
    const assignedCodes = window.getAssignedProjectCodes?.();
    let scopedProjects = allProjects;
    if (assignedCodes !== null) {
        // Filter to assigned projects only. Defensively include any project that
        // lacks a project_code field (legacy pre-Phase-4 data) so they are never
        // accidentally hidden.
        scopedProjects = allProjects.filter(project =>
            !project.project_code || assignedCodes.includes(project.project_code)
        );
    }
```

Then change the existing filter line from:
```javascript
    filteredProjects = allProjects.filter(project => {
```
to:
```javascript
    filteredProjects = scopedProjects.filter(project => {
```

That is the only change to the filter predicate. The rest of applyFilters() (the search/status/client conditions, pagination reset, sort, render) stays exactly as written.

**Change B: Subscribe to assignmentsChanged in init() and clean up in destroy()**

In init() (line 233), there is already a permissionsChanged handler registered at lines 238-247 with the guard pattern:
```javascript
    const permissionChangeHandler = () => { ... };
    window.addEventListener('permissionsChanged', permissionChangeHandler);
    if (!window._projectsPermissionHandler) {
        window._projectsPermissionHandler = permissionChangeHandler;
    }
```

Add an identical block immediately after it (after line 247, before the `await loadClients()` call at line 249) for assignments:

```javascript
    // Phase 7: Re-filter when assignments change
    const assignmentChangeHandler = () => {
        console.log('[Projects] Assignments changed, re-filtering...');
        applyFilters();
    };
    window.addEventListener('assignmentsChanged', assignmentChangeHandler);
    if (!window._projectsAssignmentHandler) {
        window._projectsAssignmentHandler = assignmentChangeHandler;
    }
```

In destroy() (line 254), there is already cleanup for _projectsPermissionHandler at lines 258-261. Add the assignment handler cleanup immediately after it (after line 261, before `listeners.forEach`):

```javascript
    // Phase 7: Remove assignment change listener
    if (window._projectsAssignmentHandler) {
        window.removeEventListener('assignmentsChanged', window._projectsAssignmentHandler);
        delete window._projectsAssignmentHandler;
    }
```

That completes projects.js. Three insertion points, no deletions except the single word change from `allProjects` to `scopedProjects` in the filter predicate.
  </action>
  <verify>
1. grep projects.js for "getAssignedProjectCodes" -- should appear once in applyFilters
2. grep projects.js for "scopedProjects" -- should appear in the declaration and the filter line
3. grep projects.js for "_projectsAssignmentHandler" -- should appear in init (register) and destroy (cleanup)
4. grep projects.js for "assignmentsChanged" -- should appear in addEventListener and the console.log
5. Confirm applyFilters still calls sortFilteredProjects() and renderProjectsTable() at the end -- nothing removed
  </verify>
  <done>
projects.js applyFilters() pre-filters allProjects through getAssignedProjectCodes() before the existing filter predicate runs. Legacy projects without project_code are always included. assignmentsChanged listener registered in init() and cleaned up in destroy() using the same guard pattern as the existing permissionsChanged handler.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add access check and assignmentsChanged handler to project-detail.js</name>
  <files>app/views/project-detail.js</files>
  <action>
Two changes to project-detail.js. Both are purely additive.

**Change A: Add access check inside the onSnapshot callback**

The project-detail onSnapshot callback is at line 79. After the project is loaded (line 94-96), renderProjectDetail() is called immediately. The current code is:

```javascript
        const docSnap = snapshot.docs[0];
        currentProject = { id: docSnap.id, ...docSnap.data() };
        renderProjectDetail();
```

Insert an access check BETWEEN setting currentProject and calling renderProjectDetail(). Replace those three lines with:

```javascript
        const docSnap = snapshot.docs[0];
        currentProject = { id: docSnap.id, ...docSnap.data() };

        // Phase 7: Check project assignment access for operations_user
        if (checkProjectAccess()) {
            renderProjectDetail();
        }
        // If checkProjectAccess() returns false, it already rendered the access denied message
```

**Change B: Add the checkProjectAccess() helper function**

Add this function to the module (place it after the destroy() function, before any other function definitions, or at the bottom before window exposures -- anywhere at module scope is fine):

```javascript
/**
 * Check if the current user has access to the current project.
 * For operations_user without all_projects, the project must be in assigned_project_codes.
 * Returns true if access is allowed (or if no filtering applies).
 * Returns false and renders an access denied message if access is denied.
 */
function checkProjectAccess() {
    const assignedCodes = window.getAssignedProjectCodes?.();

    // null means no filtering -- all roles except scoped operations_user
    if (assignedCodes === null) return true;

    // If current project has no project_code (legacy), allow access defensively
    if (!currentProject?.project_code) return true;

    // Check if this project is in the assigned set
    if (assignedCodes.includes(currentProject.project_code)) return true;

    // Access denied -- render message in place (do NOT redirect silently)
    const container = document.getElementById('projectDetailContainer');
    if (container) {
        container.innerHTML = `
            <div class="container" style="margin-top: 2rem;">
                <div class="card">
                    <div class="card-body">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ”’</div>
                            <h3>Access Denied</h3>
                            <p>You do not have access to this project.</p>
                            <p style="color: #64748b; font-size: 0.875rem;">This project has been removed from your assigned projects.</p>
                            <a href="#/projects" class="btn btn-primary" style="margin-top: 1rem;">Back to Projects</a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    console.log('[ProjectDetail] Access denied for project:', currentProject?.project_code);
    return false;
}
```

**Change C: Subscribe to assignmentsChanged in init() and clean up in destroy()**

In init() (line 46), there is already a permissionsChanged handler at lines 52-61 with the guard pattern. Add the assignment handler immediately after it (after line 61, before the `if (!projectCode)` block at line 63):

```javascript
    // Phase 7: Re-check access when assignments change
    const assignmentChangeHandler = () => {
        console.log('[ProjectDetail] Assignments changed, re-checking access...');
        if (currentProject) {
            checkProjectAccess(); // Will render access denied if project no longer assigned
        }
    };
    window.addEventListener('assignmentsChanged', assignmentChangeHandler);
    if (!window._projectDetailAssignmentHandler) {
        window._projectDetailAssignmentHandler = assignmentChangeHandler;
    }
```

In destroy() (line 101), add cleanup after the existing permissionsChanged cleanup (after line 108):

```javascript
    // Phase 7: Remove assignment change listener
    if (window._projectDetailAssignmentHandler) {
        window.removeEventListener('assignmentsChanged', window._projectDetailAssignmentHandler);
        delete window._projectDetailAssignmentHandler;
    }
```
  </action>
  <verify>
1. grep project-detail.js for "checkProjectAccess" -- should appear in the onSnapshot callback and in the function definition
2. grep project-detail.js for "_projectDetailAssignmentHandler" -- in init (register) and destroy (cleanup)
3. grep project-detail.js for "assignmentsChanged" -- in addEventListener and console.log
4. Confirm the access denied HTML contains a link back to #/projects (not a silent redirect)
5. Confirm renderProjectDetail() is only called when checkProjectAccess() returns true
  </verify>
  <done>
project-detail.js checks assignment access after loading the project document. If access is denied, renders an in-place access denied message with a Back to Projects link. Subscribes to assignmentsChanged to re-check access in real time. Cleanup registered in destroy().
  </done>
</task>

</tasks>

<verification>
1. projects.js applyFilters() calls getAssignedProjectCodes() and pre-filters before existing filters
2. projects.js treats missing project_code on legacy projects as always-show
3. projects.js assignmentsChanged listener calls applyFilters() and is cleaned up in destroy()
4. project-detail.js checkProjectAccess() returns true for non-operations_user, all_projects, and assigned projects
5. project-detail.js checkProjectAccess() renders access denied with Back to Projects link when project not assigned
6. project-detail.js assignmentsChanged listener re-runs checkProjectAccess() when assignments change
7. Both files: no existing functionality removed, all changes are additive insertions
</verification>

<success_criteria>
- Operations Users see only assigned projects in the list (plus any legacy projects without project_code)
- All other roles see all projects unchanged
- Operations User on a removed project's detail page sees access denied with navigation back to project list
- Both views react to assignmentsChanged events without page reload
- Guard pattern (check before re-registering) used for both event listeners
- home.js is not touched
</success_criteria>

<output>
After completion, create `.planning/phases/07-project-assignment-system/07-03-SUMMARY.md`
</output>
