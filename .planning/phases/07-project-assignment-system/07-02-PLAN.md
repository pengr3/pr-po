---
phase: 07-project-assignment-system
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - app/views/project-assignments.js
  - app/router.js
  - index.html
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Super Admin and Operations Admin can navigate to the Project Assignments page"
    - "The page lists all Operations Users with their current assignment state"
    - "Checking/unchecking project checkboxes for a user writes immediately to Firestore"
    - "The All Projects checkbox disables the individual project checkboxes"
    - "Unchecking All Projects re-enables individual project checkboxes with current state"
    - "Users with zero assigned projects show a visible No projects assigned state"
  artifacts:
    - path: "app/views/project-assignments.js"
      provides: "Standalone admin view for managing Operations User project assignments"
      contains: "project-assignments"
      min_lines: 150
    - path: "app/router.js"
      provides: "Route entry and permission gate for /project-assignments"
      contains: "project-assignments"
    - path: "index.html"
      provides: "Nav link to Project Assignments page"
      contains: "project-assignments"
  key_links:
    - from: "app/views/project-assignments.js"
      to: "users collection (read all operations_user docs)"
      via: "onSnapshot on users collection with where role == operations_user"
      pattern: "onSnapshot.*users"
    - from: "app/views/project-assignments.js"
      to: "users/{targetUserId} (write assignments)"
      via: "updateDoc on target user document"
      pattern: "updateDoc.*users"
    - from: "app/views/project-assignments.js"
      to: "projects collection (read active projects)"
      via: "onSnapshot on projects collection"
      pattern: "onSnapshot.*projects"
    - from: "app/router.js"
      to: "project-assignments view module"
      via: "dynamic import in route definition"
      pattern: "project-assignments"
---

<objective>
Create the standalone admin panel where Super Admin and Operations Admin assign projects to Operations Users, and wire it into the router and navigation.

Purpose: This is the write side of the assignment system. An admin opens this page, sees a list of all Operations Users, and for each user either checks "All Projects" or selects individual projects. Each checkbox change saves immediately. The page uses two real-time listeners (users collection, projects collection) that are cleaned up on destroy.

Output: A fully functional project-assignments view module, a route in router.js, and a nav link in index.html. The nav link shares the role_config permission gate so it is visible under the same conditions as Settings. Access within the view itself is guarded by a direct role check (super_admin or operations_admin) rather than adding a new permission key -- this keeps the permission matrix unchanged and is revisitable in Phase 9.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-project-assignment-system/07-RESEARCH.md
@.planning/phases/07-project-assignment-system/07-01-SUMMARY.md
@app/router.js
@index.html
@app/auth.js
@app/views/role-config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project-assignments.js view module</name>
  <files>app/views/project-assignments.js</files>
  <action>
Create a new view module at app/views/project-assignments.js following the standard SPA view pattern (render, init, destroy). This is the admin panel for assigning projects to Operations Users.

**Module structure and imports:**
```javascript
import { db, collection, onSnapshot, updateDoc, doc, query, where } from '../firebase.js';
import { showToast } from '../utils.js';
```

**Module-level state:**
```javascript
let usersListener = null;
let projectsListener = null;
let opsUsers = [];        // All operations_user documents
let allProjects = [];     // All active projects (for checkboxes)
```

**render() function:**
Returns a simple container. The content is populated dynamically by init() after listeners fire.
```javascript
export function render() {
    // Role gate: only super_admin and operations_admin
    const user = window.getCurrentUser?.();
    if (!user || (user.role !== 'super_admin' && user.role !== 'operations_admin')) {
        return `
            <div class="container" style="padding: 4rem 2rem;">
                <div class="card">
                    <div class="card-body">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ”’</div>
                            <h3>Access Denied</h3>
                            <p>Only Super Admin and Operations Admin can manage project assignments.</p>
                            <button class="btn btn-primary" onclick="location.hash='#/'">Go to Dashboard</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    return `
        <div class="container" style="margin-top: 2rem;">
            <div class="card">
                <div class="suppliers-header">
                    <h2>Project Assignments</h2>
                </div>
                <p style="color: #64748b; margin-bottom: 1.5rem;">Assign projects to Operations Users. Changes save automatically.</p>
                <div id="assignmentsList">
                    <p style="color: #64748b; padding: 1rem;">Loading users...</p>
                </div>
            </div>
        </div>
    `;
}
```

**init() function:**
Sets up two onSnapshot listeners. When either fires, call renderAssignmentsList() to rebuild the UI.
```javascript
export async function init() {
    console.log('[ProjectAssignments] Initializing...');

    // Role gate check (defense in depth -- render() already checked)
    const user = window.getCurrentUser?.();
    if (!user || (user.role !== 'super_admin' && user.role !== 'operations_admin')) {
        console.warn('[ProjectAssignments] Access denied -- not super_admin or operations_admin');
        return;
    }

    // Listener 1: all operations_user documents
    const usersQuery = query(collection(db, 'users'), where('role', '==', 'operations_user'));
    usersListener = onSnapshot(usersQuery, (snapshot) => {
        opsUsers = [];
        snapshot.forEach(d => opsUsers.push({ id: d.id, ...d.data() }));
        opsUsers.sort((a, b) => (a.full_name || a.email).localeCompare(b.full_name || b.email));
        console.log('[ProjectAssignments] Ops users loaded:', opsUsers.length);
        renderAssignmentsList();
    });

    // Listener 2: all active projects
    const projQuery = query(collection(db, 'projects'), where('active', '==', true));
    projectsListener = onSnapshot(projQuery, (snapshot) => {
        allProjects = [];
        snapshot.forEach(d => allProjects.push({ id: d.id, ...d.data() }));
        allProjects.sort((a, b) => (a.project_code || '').localeCompare(b.project_code || ''));
        console.log('[ProjectAssignments] Projects loaded:', allProjects.length);
        renderAssignmentsList();
    });
}
```

**renderAssignmentsList() function:**
Renders the full list of Operations Users with their assignment checkboxes. Called whenever either listener fires.

```javascript
function renderAssignmentsList() {
    const container = document.getElementById('assignmentsList');
    if (!container) return;

    if (opsUsers.length === 0) {
        container.innerHTML = '<p style="color: #64748b; padding: 1rem;">No Operations Users found.</p>';
        return;
    }

    let html = '';
    opsUsers.forEach(user => {
        const isAllProjects = user.all_projects === true;
        const assignedCodes = Array.isArray(user.assigned_project_codes) ? user.assigned_project_codes : [];

        html += `
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-body" style="padding: 1rem 1.5rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                        <div>
                            <strong style="font-size: 1rem;">${user.full_name || 'Unknown'}</strong>
                            <span style="color: #64748b; font-size: 0.875rem; margin-left: 0.5rem;">${user.email || ''}</span>
                        </div>
                        <span class="status-badge ${isAllProjects ? 'approved' : (assignedCodes.length > 0 ? 'pending' : 'rejected')}">
                            ${isAllProjects ? 'All Projects' : (assignedCodes.length > 0 ? assignedCodes.length + ' project(s)' : 'No projects')}
                        </span>
                    </div>

                    <!-- All Projects checkbox -->
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                            <input type="checkbox"
                                   class="all-projects-checkbox"
                                   data-userid="${user.id}"
                                   ${isAllProjects ? 'checked' : ''}
                                   onchange="handleAllProjectsChange(this)">
                            All Projects (includes future projects automatically)
                        </label>
                    </div>

                    <!-- Individual project checkboxes -->
                    <div id="projects-${user.id}" style="display: ${isAllProjects ? 'none' : 'block'}; padding-left: 1.5rem;">
                        ${allProjects.length === 0
                            ? '<p style="color: #64748b; font-size: 0.875rem;">No active projects available.</p>'
                            : allProjects.map(project => {
                                const isAssigned = assignedCodes.includes(project.project_code);
                                return `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem 0;">
                                        <input type="checkbox"
                                               class="project-checkbox"
                                               data-userid="${user.id}"
                                               data-projectcode="${project.project_code}"
                                               ${isAssigned ? 'checked' : ''}
                                               onchange="handleProjectCheckboxChange('${user.id}')">
                                        ${project.project_code} - ${project.project_name}
                                    </label>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}
```

**handleAllProjectsChange() function:**
When the "All Projects" checkbox is toggled, writes to Firestore immediately and toggles visibility of the individual project checkboxes.
```javascript
async function handleAllProjectsChange(checkbox) {
    const userId = checkbox.dataset.userid;
    const isChecked = checkbox.checked;

    // Toggle individual project checkboxes visibility
    const projectsDiv = document.getElementById('projects-' + userId);
    if (projectsDiv) {
        projectsDiv.style.display = isChecked ? 'none' : 'block';
    }

    // Write to Firestore
    try {
        if (isChecked) {
            // Set all_projects flag. Clear assigned_project_codes to keep doc clean.
            await updateDoc(doc(db, 'users', userId), {
                all_projects: true,
                assigned_project_codes: []
            });
        } else {
            // Unset all_projects. Read current individual checkboxes to build the array.
            const codes = readCheckedProjectCodes(userId);
            await updateDoc(doc(db, 'users', userId), {
                all_projects: false,
                assigned_project_codes: codes
            });
        }
        console.log('[ProjectAssignments] Updated all_projects for', userId, ':', isChecked);
    } catch (error) {
        console.error('[ProjectAssignments] Error updating assignments:', error);
        showToast('Error saving assignment change', 'error');
    }
}
```

**handleProjectCheckboxChange() function:**
When any individual project checkbox changes, reads all checked project checkboxes for that user and writes the full array to Firestore. This is auto-save -- no batch button.
```javascript
async function handleProjectCheckboxChange(userId) {
    const codes = readCheckedProjectCodes(userId);

    try {
        await updateDoc(doc(db, 'users', userId), {
            all_projects: false,
            assigned_project_codes: codes
        });
        console.log('[ProjectAssignments] Updated assigned_project_codes for', userId, ':', codes);
    } catch (error) {
        console.error('[ProjectAssignments] Error updating assignments:', error);
        showToast('Error saving assignment change', 'error');
    }
}
```

**readCheckedProjectCodes() helper:**
Reads the DOM to collect currently-checked project codes for a given user.
```javascript
function readCheckedProjectCodes(userId) {
    const checkboxes = document.querySelectorAll(
        `.project-checkbox[data-userid="${userId}"]:checked`
    );
    const codes = [];
    checkboxes.forEach(cb => codes.push(cb.dataset.projectcode));
    return codes;
}
```

**destroy() function:**
```javascript
export async function destroy() {
    console.log('[ProjectAssignments] Destroying...');
    if (usersListener) { usersListener(); usersListener = null; }
    if (projectsListener) { projectsListener(); projectsListener = null; }
    opsUsers = [];
    allProjects = [];

    // Clean up window functions
    delete window.handleAllProjectsChange;
    delete window.handleProjectCheckboxChange;

    console.log('[ProjectAssignments] Destroyed');
}
```

**Window exposure (at bottom of file, before the closing log):**
```javascript
window.handleAllProjectsChange = handleAllProjectsChange;
window.handleProjectCheckboxChange = handleProjectCheckboxChange;

console.log('[ProjectAssignments] View module loaded');
```

IMPORTANT: The `onchange` handlers in the HTML use bare function names (handleAllProjectsChange, handleProjectCheckboxChange). These MUST be on window for onclick/onchange to find them. The window exposure block above handles this.
  </action>
  <verify>
1. File exists at app/views/project-assignments.js
2. File exports render, init, destroy functions
3. File contains handleAllProjectsChange and handleProjectCheckboxChange on window
4. File contains two onSnapshot listeners (users with role filter, projects with active filter)
5. File contains updateDoc calls for both all_projects and assigned_project_codes
6. No syntax errors (check by importing in browser console)
  </verify>
  <done>
project-assignments.js view module created with user-centric layout, auto-save on checkbox change, two real-time listeners, role gate in render() and init(), and proper cleanup in destroy().
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire route and navigation link</name>
  <files>app/router.js, index.html</files>
  <action>
Two small changes to wire the new view into the SPA.

**Part A: router.js -- add route definition and permission gate**

1. Add route to the `routes` object. Place it after the `/role-config` entry (around line 86, before the closing `};` of routes):

```javascript
    '/project-assignments': {
        name: 'Project Assignments',
        load: () => import('./views/project-assignments.js'),
        title: 'Project Assignments | CLMC Procurement'
    }
```

2. Add permission gate to `routePermissionMap` (around line 17, after the `/role-config` entry):

```javascript
    '/project-assignments': 'role_config'   // Shares role_config gate with Settings
```

This means the router's permission check uses the same `role_config` tab access key as Settings. The view itself does the finer-grained super_admin/operations_admin check in render().

**Part B: index.html -- add nav link**

Add a nav link for Project Assignments. Place it after the Settings link (line 32) and before the logout button (line 33). Use the same `data-route="role_config"` attribute as Settings so it shares the permission gate visibility:

```html
                <a href="#/project-assignments" class="nav-link" data-route="role_config">Assignments</a>
```

The result in the nav-links div should look like:
```html
                <a href="#/role-config" class="nav-link" data-route="role_config">Settings</a>
                <a href="#/project-assignments" class="nav-link" data-route="role_config">Assignments</a>
                <button id="logoutBtn" ...>
```

Using data-route="role_config" means the Assignments link appears and disappears in sync with Settings -- both are hidden for roles without role_config access. The view-level role check then further restricts to super_admin and operations_admin.
  </action>
  <verify>
1. grep router.js for "project-assignments" -- should appear in both routes object and routePermissionMap
2. grep index.html for "project-assignments" -- should appear in the nav link href
3. Navigate to #/project-assignments in browser -- page loads without error
4. Confirm nav link appears between Settings and Log Out
  </verify>
  <done>
Route /project-assignments added to router.js with role_config permission gate. Nav link added to index.html between Settings and Log Out, sharing the role_config data-route attribute.
  </done>
</task>

</tasks>

<verification>
1. app/views/project-assignments.js exists with render/init/destroy exports
2. router.js routes object contains /project-assignments
3. routePermissionMap contains /project-assignments -> role_config
4. index.html nav contains Assignments link with data-route="role_config"
5. Navigating to #/project-assignments as super_admin loads the page
6. Navigating to #/project-assignments as a non-admin role shows Access Denied
7. Two Firebase listeners created on init, both cleaned up on destroy
8. Checking "All Projects" hides individual project checkboxes and writes to Firestore
9. Unchecking "All Projects" re-shows individual checkboxes
10. Toggling an individual project checkbox writes the updated array to Firestore
</verification>

<success_criteria>
- Project Assignments view is reachable via navigation and direct URL
- Nav link visibility is gated by role_config permission (same as Settings)
- View-level access check blocks non-super_admin/non-operations_admin users
- Auto-save writes all_projects and assigned_project_codes to the target user document on every checkbox change
- Two listeners (users, projects) created in init and cleaned up in destroy
- No changes to any existing view or to the permission matrix
</success_criteria>

<output>
After completion, create `.planning/phases/07-project-assignment-system/07-02-SUMMARY.md`
</output>
