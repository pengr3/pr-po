---
phase: 03-projects-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/views/projects.js
autonomous: true

must_haves:
  truths:
    - "User can filter projects by Internal Status dropdown"
    - "User can filter projects by Project Status dropdown"
    - "User can filter projects by Client dropdown"
    - "User can search projects by typing in search input"
    - "User can click column headers to sort the table"
    - "Project list shows most recent projects first by default"
    - "User can click a project row to navigate to detail view"
  artifacts:
    - path: "app/views/projects.js"
      provides: "Filter dropdowns, debounced search, column sorting, row click navigation"
      contains: "applyFilters"
  key_links:
    - from: "filter dropdowns"
      to: "applyFilters function"
      via: "onchange event handlers"
      pattern: "onchange=\"window\\.applyFilters"
    - from: "search input"
      to: "debouncedFilter function"
      via: "oninput event handler"
      pattern: "oninput=\"window\\.debouncedFilter"
    - from: "table headers"
      to: "sortProjects function"
      via: "onclick event handlers"
      pattern: "onclick=\"window\\.sortProjects"
    - from: "table rows"
      to: "hash navigation"
      via: "onclick navigation"
      pattern: "#/projects/detail/"
---

<objective>
Add powerful list management capabilities to the projects view including filter dropdowns, debounced search, interactive column sorting, and row click navigation to detail view.

Purpose: Enable users to quickly find and filter projects from a growing list, satisfying PROJ-10 through PROJ-15 requirements. With detail routes established in Plan 01, clicking a row now navigates to the full detail view.

Output: Enhanced projects.js with filtering, searching, sorting, and navigation capabilities.
</objective>

<execution_context>
@C:\Users\Admin\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Admin\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-projects-management/03-CONTEXT.md
@.planning/phases/03-projects-management/03-RESEARCH.md
@.planning/phases/03-projects-management/03-01-SUMMARY.md
@app/views/projects.js
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter dropdowns and debounced search</name>
  <files>app/views/projects.js</files>
  <action>
Modify the render() function to add a filter/search bar above the table and implement client-side filtering.

**1. Add module-level state variables at top of file (after existing state):**
```javascript
let allProjects = [];           // Unfiltered data from Firebase
let filteredProjects = [];      // Filtered subset for display
let sortColumn = 'created_at';  // Default sort column
let sortDirection = 'desc';     // Most recent first (PROJ-15)
```

**2. Add debounce utility function (after status option arrays):**
```javascript
function debounce(callback, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            callback(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
```

**3. Modify render() function to add filter bar above table:**
Insert this HTML after the Add Project form div and before the Projects Table comment:

```javascript
<!-- Filter Bar -->
<div class="filter-bar" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
    <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
        <label style="font-size: 0.875rem; margin-bottom: 0.25rem;">Internal Status</label>
        <select id="internalStatusFilter" onchange="window.applyFilters()" style="width: 100%;">
            <option value="">All Internal Statuses</option>
            ${INTERNAL_STATUS_OPTIONS.map(s =>
                `<option value="${s}">${s}</option>`
            ).join('')}
        </select>
    </div>

    <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
        <label style="font-size: 0.875rem; margin-bottom: 0.25rem;">Project Status</label>
        <select id="projectStatusFilter" onchange="window.applyFilters()" style="width: 100%;">
            <option value="">All Project Statuses</option>
            ${PROJECT_STATUS_OPTIONS.map(s =>
                `<option value="${s}">${s}</option>`
            ).join('')}
        </select>
    </div>

    <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
        <label style="font-size: 0.875rem; margin-bottom: 0.25rem;">Client</label>
        <select id="clientFilter" onchange="window.applyFilters()" style="width: 100%;">
            <option value="">All Clients</option>
        </select>
    </div>

    <div class="form-group" style="margin: 0; flex: 2; min-width: 200px;">
        <label style="font-size: 0.875rem; margin-bottom: 0.25rem;">Search</label>
        <input type="text"
               id="searchInput"
               placeholder="Search by code or name..."
               oninput="window.debouncedFilter()"
               style="width: 100%;">
    </div>
</div>
```

**4. Add applyFilters() function:**
```javascript
function applyFilters() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const internalStatusFilter = document.getElementById('internalStatusFilter')?.value || '';
    const projectStatusFilter = document.getElementById('projectStatusFilter')?.value || '';
    const clientFilter = document.getElementById('clientFilter')?.value || '';

    filteredProjects = allProjects.filter(project => {
        // Search filter (OR across code and name)
        const matchesSearch = !searchTerm ||
            (project.project_code && project.project_code.toLowerCase().includes(searchTerm)) ||
            (project.project_name && project.project_name.toLowerCase().includes(searchTerm));

        // Status filters (exact match)
        const matchesInternalStatus = !internalStatusFilter ||
            project.internal_status === internalStatusFilter;
        const matchesProjectStatus = !projectStatusFilter ||
            project.project_status === projectStatusFilter;

        // Client filter (match by ID)
        const matchesClient = !clientFilter ||
            project.client_id === clientFilter;

        // AND logic - all conditions must be true
        return matchesSearch && matchesInternalStatus &&
               matchesProjectStatus && matchesClient;
    });

    // Reset pagination when filters change
    currentPage = 1;

    // Apply current sort
    sortFilteredProjects();

    renderProjectsTable();
}
```

**5. Add sortFilteredProjects() helper function:**
```javascript
function sortFilteredProjects() {
    filteredProjects.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];

        // Handle null/undefined (sort to end)
        if (aVal == null) return sortDirection === 'asc' ? 1 : -1;
        if (bVal == null) return sortDirection === 'asc' ? -1 : 1;

        // Handle dates
        if (sortColumn === 'created_at' || sortColumn === 'updated_at') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
        }

        // Handle booleans
        if (sortColumn === 'active') {
            // Active first when descending, inactive first when ascending
            return sortDirection === 'asc'
                ? (aVal === bVal ? 0 : aVal ? 1 : -1)
                : (aVal === bVal ? 0 : aVal ? -1 : 1);
        }

        // String comparison
        if (typeof aVal === 'string') {
            return sortDirection === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        }

        // Numeric/date comparison
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
    });
}
```

**6. Create debouncedFilter and attach window functions:**
After defining applyFilters, create the debounced version:
```javascript
const debouncedFilter = debounce(applyFilters, 300);
```

In attachWindowFunctions(), add:
```javascript
window.applyFilters = applyFilters;
window.debouncedFilter = debouncedFilter;
```

**7. Modify loadProjects() function:**
Change to use allProjects instead of projectsData and call applyFilters:
```javascript
async function loadProjects() {
    try {
        const listener = onSnapshot(collection(db, 'projects'), (snapshot) => {
            allProjects = [];
            snapshot.forEach(doc => {
                allProjects.push({ id: doc.id, ...doc.data() });
            });

            console.log('[Projects] Loaded:', allProjects.length);

            // Apply filters (which will also sort and render)
            applyFilters();
        });

        listeners.push(listener);
    } catch (error) {
        console.error('[Projects] Error loading projects:', error);
    }
}
```

**8. Modify renderClientDropdown() to also update the filter dropdown:**
At the end of the function, add:
```javascript
// Also update client filter dropdown
const filterSelect = document.getElementById('clientFilter');
if (filterSelect) {
    const currentFilterValue = filterSelect.value;
    let filterOptionsHtml = '<option value="">All Clients</option>';
    clientsData.forEach(client => {
        const selected = client.id === currentFilterValue ? 'selected' : '';
        filterOptionsHtml += `<option value="${client.id}" ${selected}>${client.company_name}</option>`;
    });
    filterSelect.innerHTML = filterOptionsHtml;
}
```

**9. Update destroy() to reset new state:**
Add to destroy():
```javascript
allProjects = [];
filteredProjects = [];
sortColumn = 'created_at';
sortDirection = 'desc';

delete window.applyFilters;
delete window.debouncedFilter;
```
  </action>
  <verify>
Load #/projects in browser:
1. Three filter dropdowns visible (Internal Status, Project Status, Client)
2. Search input visible with placeholder text
3. Select "For Inspection" from Internal Status: only matching projects shown
4. Select a Client: further filters the list (AND logic working)
5. Type in search box: table updates after 300ms pause (debounce working)
6. Clear all filters: all projects return
7. Default displays most recent projects first (check created_at order)
8. Console shows no errors
  </verify>
  <done>
Filter dropdowns and debounced search functional, projects display most recent first by default, filters combine with AND logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Add column header sorting with indicators</name>
  <files>app/views/projects.js</files>
  <action>
**1. Add sortProjects(column) function:**
```javascript
function sortProjects(column) {
    // Toggle direction if clicking same column
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc'; // Default to ascending on new column
    }

    // Reset pagination (per RESEARCH.md Pitfall 3)
    currentPage = 1;

    // Sort the filtered data
    sortFilteredProjects();

    // Re-render table with updated headers
    renderProjectsTable();
}
```

**2. Attach sortProjects to window in attachWindowFunctions():**
```javascript
window.sortProjects = sortProjects;
```

**3. Modify the table header in render() to be sortable:**
Replace the static table header with dynamic sortable headers:
```javascript
<thead>
    <tr>
        <th onclick="window.sortProjects('project_code')" style="cursor: pointer; user-select: none;">
            Code <span class="sort-indicator" data-col="project_code"></span>
        </th>
        <th onclick="window.sortProjects('project_name')" style="cursor: pointer; user-select: none;">
            Name <span class="sort-indicator" data-col="project_name"></span>
        </th>
        <th onclick="window.sortProjects('client_code')" style="cursor: pointer; user-select: none;">
            Client <span class="sort-indicator" data-col="client_code"></span>
        </th>
        <th onclick="window.sortProjects('internal_status')" style="cursor: pointer; user-select: none;">
            Internal Status <span class="sort-indicator" data-col="internal_status"></span>
        </th>
        <th onclick="window.sortProjects('project_status')" style="cursor: pointer; user-select: none;">
            Project Status <span class="sort-indicator" data-col="project_status"></span>
        </th>
        <th onclick="window.sortProjects('active')" style="cursor: pointer; user-select: none;">
            Active <span class="sort-indicator" data-col="active"></span>
        </th>
        <th>Actions</th>
    </tr>
</thead>
```

**4. Add updateSortIndicators() function to update arrows after sort:**
```javascript
function updateSortIndicators() {
    document.querySelectorAll('.sort-indicator').forEach(indicator => {
        const col = indicator.dataset.col;
        if (col === sortColumn) {
            indicator.textContent = sortDirection === 'asc' ? ' ↑' : ' ↓';
            indicator.style.color = '#1a73e8';
        } else {
            indicator.textContent = ' ⇅';
            indicator.style.color = '#94a3b8';
        }
    });
}
```

**5. Call updateSortIndicators() at the end of renderProjectsTable():**
After the `paginationDiv.innerHTML = paginationHTML;` line, add:
```javascript
// Update sort indicators
updateSortIndicators();
```

**6. Update destroy() to clean up sortProjects:**
```javascript
delete window.sortProjects;
```
  </action>
  <verify>
Load #/projects in browser:
1. All column headers (except Actions) show ⇅ indicator
2. Click "Code" header: table sorts by code alphabetically, arrow shows ↑
3. Click "Code" again: toggles to descending, arrow shows ↓
4. Click "Name" header: switches to name sort, ascending (↑)
5. After sorting, if on page 2+, returns to page 1
6. Sort indicators are blue for active column, gray for others
7. Console shows no errors
  </verify>
  <done>
All columns sortable with click, visual indicators show current sort state, pagination resets on sort
  </done>
</task>

<task type="auto">
  <name>Task 3: Make table rows clickable for detail navigation</name>
  <files>app/views/projects.js</files>
  <action>
**1. Modify the table row rendering in renderProjectsTable():**
Update the row template to make rows clickable and prevent action button propagation:

Replace the existing row mapping with:
```javascript
tbody.innerHTML = pageItems.map(project => {
    // Find client name
    const client = clientsData.find(c => c.id === project.client_id);
    const clientName = client ? client.company_name : project.client_code;

    return `
        <tr onclick="window.location.hash = '#/projects/detail/${project.project_code}'"
            style="cursor: pointer;"
            class="clickable-row">
            <td><strong>${project.project_code}</strong></td>
            <td>${project.project_name}</td>
            <td>${clientName}</td>
            <td>${project.internal_status}</td>
            <td>${project.project_status}</td>
            <td>
                <span class="status-badge ${project.active ? 'approved' : 'rejected'}">
                    ${project.active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td style="white-space: nowrap;" onclick="event.stopPropagation()">
                <button class="btn btn-sm btn-primary" onclick="editProject('${project.id}')">Edit</button>
                <button class="btn btn-sm btn-secondary" onclick="toggleProjectActive('${project.id}', ${project.active})">${project.active ? 'Deactivate' : 'Activate'}</button>
                <button class="btn btn-sm btn-danger" onclick="deleteProject('${project.id}', '${project.project_name.replace(/'/g, "\\'")}')">Delete</button>
            </td>
        </tr>
    `;
}).join('');
```

Key changes:
- Added onclick handler on <tr> to navigate to detail route
- Added style="cursor: pointer;" and class="clickable-row"
- Added onclick="event.stopPropagation()" on the Actions <td> to prevent row click when clicking buttons

**2. Verify badge styling is correct:**
The existing code uses `class="status-badge ${project.active ? 'approved' : 'rejected'}"`.
Per CONTEXT.md, Active should be green (approved class) and Inactive should be gray (rejected class).
Check styles/components.css has appropriate styles - this should already be working from existing code.

**3. (Optional) Add hover style for clickable rows:**
If not already present, you can add inline hover effect using CSS class. The existing table styling in styles/components.css likely handles tr:hover already. Verify this works.

Note: The Actions column has onclick="event.stopPropagation()" on the <td> which prevents row navigation when clicking any button inside.
  </action>
  <verify>
Load #/projects in browser:
1. Hover over a row: cursor changes to pointer (shows it's clickable)
2. Click on a row (not on buttons): URL changes to #/projects/detail/PROJECT_CODE
3. Detail view loads (from Plan 01)
4. Click browser back: returns to #/projects with list
5. Click Edit button: edit form shows, row navigation does NOT trigger
6. Click Toggle button: confirmation shows, row navigation does NOT trigger
7. Click Delete button: confirmation shows, row navigation does NOT trigger
8. Active projects show green badge, Inactive show gray badge
  </verify>
  <done>
Clicking project row navigates to detail route, button clicks work independently without triggering navigation, badge styling correct
  </done>
</task>

</tasks>

<verification>
1. **Filter functionality:**
   - Select "For Inspection" from Internal Status: only matching projects shown
   - Select "Completed" from Project Status: further filters the list (AND logic)
   - Select a specific Client: further filters
   - Clear all filters: all projects return

2. **Search functionality:**
   - Type part of a project code: matching projects shown
   - Type part of a project name: matching projects shown
   - Search + filter: both apply together (AND logic)
   - Clear search: returns to filter-only state
   - Debounce working (300ms delay before filtering)

3. **Sort functionality:**
   - Click Name header: sorts alphabetically
   - Click Code header: sorts by code
   - Click Status headers: sorts by status text
   - Default on load: most recent first (created_at desc)
   - Sort indicators show current state

4. **Navigation:**
   - Click any row: navigates to #/projects/detail/CODE
   - Detail view loads with project data
   - Browser back returns to list with filters preserved within session
</verification>

<success_criteria>
- [ ] PROJ-10: List displays Code, Name, Client, Internal Status, Project Status columns
- [ ] PROJ-11: User can filter by Internal Status dropdown
- [ ] PROJ-12: User can filter by Project Status dropdown
- [ ] PROJ-13: User can filter by Client dropdown
- [ ] PROJ-14: Search by code or name works with debounce
- [ ] PROJ-15: Default sort is most recent first
- [ ] Row click navigates to #/projects/detail/CODE (detail view from Plan 01)
- [ ] Action buttons work without triggering row navigation
</success_criteria>

<output>
After completion, create `.planning/phases/03-projects-management/03-02-SUMMARY.md`
</output>
