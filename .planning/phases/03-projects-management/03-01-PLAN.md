---
phase: 03-projects-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/router.js
  - app/views/project-detail.js
autonomous: true

must_haves:
  truths:
    - "User can navigate to #/projects/detail/CODE and see project details"
    - "User can edit project fields inline (except project_code and client)"
    - "Changes auto-save on blur with silent success"
    - "Validation errors display inline without blocking other fields"
    - "User can delete project with confirmation and return to list"
    - "Browser back button returns to projects list"
  artifacts:
    - path: "app/router.js"
      provides: "Extended parseHash for detail routes"
      contains: "subpath"
    - path: "app/views/project-detail.js"
      provides: "Full-page project detail view with inline editing"
      exports: ["render", "init", "destroy"]
  key_links:
    - from: "app/router.js"
      to: "app/views/project-detail.js"
      via: "route definition with load()"
      pattern: "project-detail"
    - from: "app/views/project-detail.js"
      to: "firebase updateDoc"
      via: "saveField function on blur"
      pattern: "updateDoc.*projects"
---

<objective>
Extend router to support detail routes and create full-page project detail view with inline editing.

Purpose: Enable users to view complete project information and edit fields directly without modal friction. Auto-save on blur provides modern UX while keeping data current. This is foundational for PROJ-09 and PROJ-16.

Output: Router supporting `#/projects/detail/CODE` routes and a new `project-detail.js` view module with category-grouped fields, inline editing, validation, and delete functionality.
</objective>

<execution_context>
@C:\Users\Admin\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Admin\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-projects-management/03-CONTEXT.md
@.planning/phases/03-projects-management/03-RESEARCH.md
@app/router.js
@app/views/projects.js
@app/utils.js
@app/firebase.js
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend router for detail routes</name>
  <files>app/router.js</files>
  <action>
Extend the router to support three-segment hash routes for detail views.

1. Modify `parseHash()` function to extract additional segments. Currently returns `{ path, tab }`. Update to also return subpath for the third segment:
   ```javascript
   function parseHash() {
       const hash = window.location.hash.slice(1) || '/';
       const parts = hash.split('/').filter(Boolean);

       if (parts.length === 0) {
           return { path: '/', tab: null, subpath: null };
       }

       const path = '/' + parts[0];
       const tab = parts[1] || null;
       const subpath = parts[2] || null;

       return { path, tab, subpath };
   }
   ```

2. Add route for project-detail view in routes object (after /projects):
   ```javascript
   '/project-detail': {
       name: 'Project Detail',
       load: () => import('./views/project-detail.js'),
       title: 'Project Details | CLMC Procurement'
   }
   ```

3. Modify `handleHashChange()` to detect detail route pattern and redirect:
   ```javascript
   function handleHashChange() {
       const { path, tab, subpath } = parseHash();

       // Handle detail routes: #/projects/detail/CODE -> navigate to /project-detail with param
       if (path === '/projects' && tab === 'detail' && subpath) {
           navigate('/project-detail', null, subpath);
           return;
       }

       navigate(path, tab);
   }
   ```

4. Update `navigate()` function signature to accept optional param (third argument):
   - Add `param = null` as third parameter
   - Pass param to render: `appContainer.innerHTML = module.render(activeTab, param);`
   - Pass param to init: `await module.init(activeTab, param);`
   - Store currentParam: `currentParam = param;` (add `let currentParam = null;` at top)

IMPORTANT: Preserve all existing functionality. Test that existing routes (#/, #/clients, #/projects, #/procurement/mrfs, etc.) still work correctly.
  </action>
  <verify>
1. Start dev server: `python -m http.server 8000`
2. Open browser to http://localhost:8000
3. Navigate to #/projects - list view loads normally
4. Navigate to #/ - home loads
5. Navigate to #/procurement/mrfs - procurement view with MRFs tab loads
6. Manually change URL to #/projects/detail/TEST_CODE
7. Check console for "[Router]" logs showing navigation to /project-detail with param
8. Expected: 404 or error since project-detail.js doesn't exist yet (that's Task 2)
  </verify>
  <done>
Router parses `#/projects/detail/CODE` correctly and attempts to navigate to project-detail view with project code as param. Existing routes continue to work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create project detail view with inline editing</name>
  <files>app/views/project-detail.js</files>
  <action>
Create new file `app/views/project-detail.js` implementing full-page detail view with inline editing per CONTEXT.md decisions.

**Module structure:**
```javascript
import { db, collection, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where } from '../firebase.js';
import { formatCurrency, formatDate, showLoading, showToast } from '../utils.js';

let currentProject = null;
let projectCode = null;
let listener = null;

const INTERNAL_STATUS_OPTIONS = [
    'For Inspection', 'For Proposal', 'For Internal Approval', 'Ready to Submit'
];

const PROJECT_STATUS_OPTIONS = [
    'Pending Client Review', 'Under Client Review', 'Approved by Client',
    'For Mobilization', 'On-going', 'Completed', 'Loss'
];
```

**render(activeTab, param) function:**
- Return a container div with id="projectDetailContainer"
- Show loading placeholder: "Loading project details..."

**init(activeTab, param) function:**
```javascript
export async function init(activeTab = null, param = null) {
    console.log('[ProjectDetail] Initializing with param:', param);
    projectCode = param;
    attachWindowFunctions();

    if (!projectCode) {
        document.getElementById('projectDetailContainer').innerHTML =
            '<div class="container"><div class="card"><p>No project specified.</p></div></div>';
        return;
    }

    // Find project by project_code field (not document ID)
    const q = query(collection(db, 'projects'), where('project_code', '==', projectCode));
    listener = onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
            document.getElementById('projectDetailContainer').innerHTML =
                '<div class="container"><div class="card"><p>Project not found.</p><a href="#/projects">Back to Projects</a></div></div>';
            return;
        }

        const docSnap = snapshot.docs[0];
        currentProject = { id: docSnap.id, ...docSnap.data() };
        renderProjectDetail();
    });
}
```

**renderProjectDetail() function:**
Per CONTEXT.md, create category-grouped layout with cards. Skip re-rendering focused field (per RESEARCH.md Pitfall 7):

```javascript
function renderProjectDetail() {
    const container = document.getElementById('projectDetailContainer');
    if (!container || !currentProject) return;

    const focusedField = document.activeElement?.dataset?.field;

    container.innerHTML = `
        <div class="container" style="margin-top: 2rem;">
            <!-- Header -->
            <div style="margin-bottom: 1.5rem;">
                <h2>${currentProject.project_code}</h2>
                <p style="color: #64748b; margin-top: 0.25rem;">
                    ${currentProject.project_name}
                </p>
                <p style="color: #94a3b8; font-size: 0.875rem;">
                    Created: ${formatDate(currentProject.created_at)}
                    ${currentProject.updated_at ? ' | Updated: ' + formatDate(currentProject.updated_at) : ''}
                </p>
            </div>

            <!-- Basic Info Card -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-body">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Basic Information</h3>

                    <div class="form-group">
                        <label>Project Code</label>
                        <input type="text" value="${currentProject.project_code}" disabled
                               style="background: #f5f5f5; cursor: not-allowed;">
                        <small class="form-hint" style="color: #64748b;">Cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label>Project Name *</label>
                        <input type="text"
                               data-field="project_name"
                               value="${currentProject.project_name || ''}"
                               onblur="window.saveField('project_name', this.value)"
                               placeholder="Enter project name">
                    </div>

                    <div class="form-group">
                        <label>Client</label>
                        <input type="text" value="${currentProject.client_code || ''}" disabled
                               style="background: #f5f5f5; cursor: not-allowed;">
                        <small class="form-hint" style="color: #64748b;">Linked to project code - cannot be changed</small>
                    </div>
                </div>
            </div>

            <!-- Financial Details Card -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-body">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Financial Details</h3>

                    <div class="form-group">
                        <label>Budget</label>
                        <input type="number"
                               data-field="budget"
                               value="${currentProject.budget || ''}"
                               onblur="window.saveField('budget', this.value)"
                               placeholder="(Not set)"
                               min="0" step="0.01">
                        ${currentProject.budget ? `<small class="form-hint" style="color: #64748b;">PHP ${formatCurrency(currentProject.budget)}</small>` : ''}
                    </div>

                    <div class="form-group">
                        <label>Contract Cost</label>
                        <input type="number"
                               data-field="contract_cost"
                               value="${currentProject.contract_cost || ''}"
                               onblur="window.saveField('contract_cost', this.value)"
                               placeholder="(Not set)"
                               min="0" step="0.01">
                        ${currentProject.contract_cost ? `<small class="form-hint" style="color: #64748b;">PHP ${formatCurrency(currentProject.contract_cost)}</small>` : ''}
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-body">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Status</h3>

                    <div class="form-group">
                        <label>Internal Status</label>
                        <select data-field="internal_status"
                                onchange="window.saveField('internal_status', this.value)">
                            ${INTERNAL_STATUS_OPTIONS.map(s =>
                                `<option value="${s}" ${currentProject.internal_status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Project Status</label>
                        <select data-field="project_status"
                                onchange="window.saveField('project_status', this.value)">
                            ${PROJECT_STATUS_OPTIONS.map(s =>
                                `<option value="${s}" ${currentProject.project_status === s ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Active Status</label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="checkbox"
                                   id="activeToggle"
                                   ${currentProject.active ? 'checked' : ''}
                                   onchange="window.toggleActive(this.checked)"
                                   style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                            <span style="color: ${currentProject.active ? '#059669' : '#64748b'};">
                                ${currentProject.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personnel Card -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-body">
                    <h3 style="margin-bottom: 1rem; color: #1e293b;">Personnel</h3>

                    <div class="form-group">
                        <label>Assigned Personnel</label>
                        <input type="text"
                               data-field="personnel"
                               value="${currentProject.personnel || ''}"
                               onblur="window.saveField('personnel', this.value)"
                               placeholder="(Not set)">
                        <small class="form-hint" style="color: #64748b;">Freetext field for personnel assignment</small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 2rem;">
                <button class="btn btn-danger" onclick="window.confirmDelete()">
                    Delete Project
                </button>
            </div>
        </div>
    `;

    // Restore focus if field was focused before re-render
    if (focusedField) {
        const field = document.querySelector(\`[data-field="\${focusedField}"]\`);
        if (field) field.focus();
    }
}
```

**saveField(fieldName, newValue) function:**
```javascript
async function saveField(fieldName, newValue) {
    // Reject locked fields
    if (['project_code', 'client_id', 'client_code'].includes(fieldName)) {
        console.error('[ProjectDetail] Attempted to edit locked field:', fieldName);
        return false;
    }

    clearFieldError(fieldName);

    // Validation
    if (fieldName === 'project_name' && !newValue.trim()) {
        showFieldError(fieldName, 'Project name is required');
        return false;
    }

    if ((fieldName === 'budget' || fieldName === 'contract_cost') && newValue) {
        const num = parseFloat(newValue);
        if (isNaN(num) || num <= 0) {
            showFieldError(fieldName, 'Must be a positive number (greater than 0)');
            return false;
        }
    }

    // Prepare value
    let valueToSave = newValue;
    if (fieldName === 'budget' || fieldName === 'contract_cost') {
        valueToSave = newValue ? parseFloat(newValue) : null;
    } else if (fieldName === 'personnel') {
        valueToSave = newValue.trim() || null;
    } else if (fieldName === 'project_name') {
        valueToSave = newValue.trim();
    }

    try {
        const projectRef = doc(db, 'projects', currentProject.id);
        await updateDoc(projectRef, {
            [fieldName]: valueToSave,
            updated_at: new Date().toISOString()
        });
        // Silent success per CONTEXT.md
        console.log('[ProjectDetail] Saved', fieldName);
        return true;
    } catch (error) {
        console.error('[ProjectDetail] Save failed:', error);
        showFieldError(fieldName, 'Failed to save. Please try again.');
        return false;
    }
}
```

**toggleActive(newValue) function:**
```javascript
async function toggleActive(newValue) {
    try {
        const projectRef = doc(db, 'projects', currentProject.id);
        await updateDoc(projectRef, {
            active: newValue,
            updated_at: new Date().toISOString()
        });
        console.log('[ProjectDetail] Active status updated to:', newValue);
    } catch (error) {
        console.error('[ProjectDetail] Toggle failed:', error);
        showToast('Failed to update status', 'error');
    }
}
```

**confirmDelete() function:**
```javascript
async function confirmDelete() {
    const confirmed = confirm(\`Delete project "\${currentProject.project_name}"? This cannot be undone.\`);
    if (!confirmed) return;

    showLoading(true);
    try {
        await deleteDoc(doc(db, 'projects', currentProject.id));
        showToast('Project deleted', 'success');
        window.location.hash = '#/projects';
    } catch (error) {
        console.error('[ProjectDetail] Delete failed:', error);
        showToast('Failed to delete project', 'error');
    } finally {
        showLoading(false);
    }
}
```

**Error display functions:**
```javascript
function showFieldError(fieldName, message) {
    const field = document.querySelector(\`[data-field="\${fieldName}"]\`);
    if (!field) return;

    clearFieldError(fieldName);

    const errorEl = document.createElement('div');
    errorEl.className = 'field-error-message';
    errorEl.textContent = message;
    errorEl.style.cssText = 'color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;';

    field.parentNode.appendChild(errorEl);
    field.style.borderColor = '#ef4444';
}

function clearFieldError(fieldName) {
    const field = document.querySelector(\`[data-field="\${fieldName}"]\`);
    if (!field) return;

    const errorMsg = field.parentNode.querySelector('.field-error-message');
    if (errorMsg) errorMsg.remove();

    field.style.borderColor = '';
}
```

**attachWindowFunctions():**
```javascript
function attachWindowFunctions() {
    window.saveField = saveField;
    window.toggleActive = toggleActive;
    window.confirmDelete = confirmDelete;
}
```

**destroy() function:**
```javascript
export async function destroy() {
    console.log('[ProjectDetail] Destroying view...');

    if (listener) {
        listener();
        listener = null;
    }

    currentProject = null;
    projectCode = null;

    delete window.saveField;
    delete window.toggleActive;
    delete window.confirmDelete;

    console.log('[ProjectDetail] View destroyed');
}
```

**Export statements:**
```javascript
export { render, init, destroy };
```

Add console.log at end: `console.log('[ProjectDetail] Module loaded');`
  </action>
  <verify>
1. Ensure dev server running: `python -m http.server 8000`
2. Navigate to #/projects - note a project code (e.g., CLMC_TEST_2026001)
3. Navigate to #/projects/detail/CLMC_TEST_2026001 (use actual code from step 2)
4. Verify: Detail view loads with all project data in 4 cards
5. Edit project name, blur - should save silently (check console for "[ProjectDetail] Saved")
6. Edit budget with invalid value (0 or -5) - should show error
7. Edit budget with valid value (1000) - should save, formatted currency shows below
8. Change Internal Status dropdown - should save immediately
9. Toggle Active checkbox - should update status display
10. Click Delete, confirm - should delete and redirect to #/projects
11. Test browser back button from detail view - should return to list
  </verify>
  <done>
Project detail view loads for valid project codes, displays all fields in 4 category cards, saves changes on blur/change with validation, allows deletion with navigation back to list.
  </done>
</task>

</tasks>

<verification>
1. Router correctly parses #/projects/detail/CODE routes
2. Detail view loads project data from Firestore via query on project_code
3. Inline editing works for all editable fields
4. Locked fields (project_code, client_code) are visibly disabled
5. Validation prevents invalid saves with inline error messages
6. Delete removes project and navigates to list
7. Browser back button works (returns to #/projects)
8. Real-time updates reflected (except for focused field)
</verification>

<success_criteria>
- [ ] PROJ-09: Click project navigates to detail view with full project info
- [ ] PROJ-16: Detail uses full page UI (not modal)
- [ ] #/projects/detail/CODE navigates to detail view with correct project
- [ ] All project fields displayed in 4 category cards (Basic Info, Financial, Status, Personnel)
- [ ] project_code and client fields show as disabled with explanatory hints
- [ ] Text fields save on blur (silent success, no toast)
- [ ] Dropdowns save on change immediately
- [ ] Budget/contract_cost validation rejects <= 0 with inline error
- [ ] project_name validation rejects empty with inline error
- [ ] Delete button with confirm removes project and redirects to #/projects
- [ ] Browser back button returns to #/projects
</success_criteria>

<output>
After completion, create `.planning/phases/03-projects-management/03-01-SUMMARY.md`
</output>
