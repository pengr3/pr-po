---
phase: 23-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/finance.js
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "TR approval captures actual approver name from getCurrentUser() instead of hardcoded value"
    - "HTML comment at procurement.js line 228 says MRF Records Section (not PR-PO Records Section)"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Dynamic TR approver attribution using getCurrentUser()"
      contains: "finance_approver_name"
    - path: "app/views/procurement.js"
      provides: "Corrected HTML comment matching section content"
      contains: "MRF Records Section"
  key_links:
    - from: "app/views/finance.js approveTR()"
      to: "window.getCurrentUser()"
      via: "function call to get current user identity"
      pattern: "getCurrentUser.*finance_approver_name"
---

<objective>
Fix TR approval attribution to capture actual approver identity and correct a stale HTML comment in procurement.js.

Purpose: Close tech debt items 1, 2, and 5 from the v2.2 milestone audit. The TR attribution fix ensures transport request audit trails record who actually approved (matching the PR signature-based pattern from Phase 18). The comment fix is a trivial cosmetic correction.

Output: Modified finance.js with dynamic TR approver and modified procurement.js with corrected comment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v2.2-MILESTONE-AUDIT.md
@app/views/finance.js
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TR approval to use getCurrentUser() instead of hardcoded name</name>
  <files>app/views/finance.js</files>
  <action>
  In the `approveTR()` function (starts at line 1715), add a getCurrentUser() call and replace the hardcoded approver fields with dynamic user identity. Follow the exact same pattern used by `approvePRWithSignature()` at line 1551-1561.

  Specific changes to `approveTR()`:

  1. **Add getCurrentUser() call** after the permission check (after line 1718) and before the confirm dialog:
     ```javascript
     const currentUser = window.getCurrentUser();
     if (!currentUser) {
         showToast('Session expired. Please log in again.', 'error');
         return;
     }
     ```

  2. **Replace the hardcoded fields** in the updateDoc call at lines 1736-1741. Change from:
     ```javascript
     finance_status: 'Approved',
     finance_approver: 'Ma. Thea Angela R. Lacsamana',
     date_approved: new Date().toISOString().split('T')[0],
     approved_at: new Date().toISOString()
     ```
     To:
     ```javascript
     finance_status: 'Approved',
     finance_approver: currentUser.full_name || currentUser.email || 'Finance User',
     finance_approver_user_id: currentUser.uid,
     finance_approver_name: currentUser.full_name || currentUser.email || 'Finance User',
     date_approved: new Date().toISOString().split('T')[0],
     approved_at: new Date().toISOString()
     ```

  **Why keep both `finance_approver` AND `finance_approver_name`:** The legacy `finance_approver` field is used by existing code that reads TR data (backward compatibility). The new `finance_approver_name` and `finance_approver_user_id` fields match the pattern established by `approvePRWithSignature()` at line 1588-1589 for consistency. The fallback chain `full_name || email || 'Finance User'` also matches exactly.

  **Do NOT** add signature capture to TR approval. Decision v2.2 (18-04) explicitly states: "TR approval uses simple confirm dialog with no signature capture."
  </action>
  <verify>
  Open app/views/finance.js and confirm:
  1. `approveTR()` calls `window.getCurrentUser()` with null check
  2. The updateDoc writes `finance_approver_user_id: currentUser.uid`
  3. The updateDoc writes `finance_approver_name: currentUser.full_name || currentUser.email || 'Finance User'`
  4. The updateDoc writes `finance_approver: currentUser.full_name || currentUser.email || 'Finance User'`
  5. No hardcoded name 'Ma. Thea Angela R. Lacsamana' remains anywhere in the function
  6. No signature capture code was added (confirm dialog remains)
  </verify>
  <done>approveTR() dynamically captures the actual approver identity using getCurrentUser(), writing user_id, name, and legacy approver field. No hardcoded names remain.</done>
</task>

<task type="auto">
  <name>Task 2: Fix stale HTML comment in procurement.js</name>
  <files>app/views/procurement.js</files>
  <action>
  At line 228 of procurement.js, change the HTML comment from:
  ```
  <!-- PR-PO Records Section -->
  ```
  To:
  ```
  <!-- MRF Records Section -->
  ```

  This is the only occurrence of "PR-PO Records" in procurement.js (verified by grep). The `<h2>` at line 233 already correctly reads "MRF Records" -- only the comment is stale.
  </action>
  <verify>
  Search procurement.js for "PR-PO" -- zero results expected. Search for "MRF Records Section" -- should find the comment at line 228.
  </verify>
  <done>HTML comment at procurement.js line 228 reads "MRF Records Section", matching the actual section heading.</done>
</task>

</tasks>

<verification>
1. `grep -n "Ma. Thea" app/views/finance.js` returns zero results
2. `grep -n "getCurrentUser" app/views/finance.js` includes a match inside `approveTR()`
3. `grep -n "finance_approver_user_id" app/views/finance.js` shows the field in `approveTR()` updateDoc
4. `grep -n "PR-PO" app/views/procurement.js` returns zero results
5. `grep -n "MRF Records Section" app/views/procurement.js` returns the comment at line 228
</verification>

<success_criteria>
- TR approval writes actual approver identity (user_id + name) from getCurrentUser(), not a hardcoded string
- Zero occurrences of "Ma. Thea Angela R. Lacsamana" remain in finance.js
- Zero occurrences of "PR-PO Records" remain in procurement.js
- The HTML comment at procurement.js line 228 says "MRF Records Section"
</success_criteria>

<output>
After completion, create `.planning/phases/23-tech-debt-cleanup/23-01-SUMMARY.md`
</output>
