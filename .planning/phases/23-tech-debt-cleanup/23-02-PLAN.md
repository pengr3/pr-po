---
phase: 23-tech-debt-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - app/views/finance.js
  - .planning/phases/20-multi-personnel-pill-selection/20-VERIFICATION.md
autonomous: true

must_haves:
  truths:
    - "Legacy approvePR() and generatePOsForPR() dead code removed from finance.js"
    - "Phase 20 VERIFICATION.md exists documenting the 14/14 UAT results"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Cleaned finance.js without orphaned legacy functions"
    - path: ".planning/phases/20-multi-personnel-pill-selection/20-VERIFICATION.md"
      provides: "Formal verification documentation for Phase 20"
      contains: "14/14"
  key_links:
    - from: "app/views/finance.js attachWindowFunctions()"
      to: "window.approvePR"
      via: "removal of window attachment"
      pattern: "window\\.approvePRWithSignature"
---

<objective>
Remove orphaned legacy functions from finance.js and create the missing Phase 20 VERIFICATION.md.

Purpose: Close tech debt items 3 and 4 from the v2.2 milestone audit. The dead code removal reduces finance.js by ~130 lines of unreachable code (legacy `approvePR()` and `generatePOsForPR()` superseded by signature-based versions). The verification doc fills a documentation gap for Phase 20 which has comprehensive UAT (14/14 passed) but no formal VERIFICATION.md.

Output: Leaner finance.js and new 20-VERIFICATION.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/v2.2-MILESTONE-AUDIT.md
@app/views/finance.js
@.planning/phases/20-multi-personnel-pill-selection/20-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead approvePR() and generatePOsForPR() from finance.js</name>
  <files>app/views/finance.js</files>
  <action>
  Remove three pieces of dead code from finance.js:

  **1. Remove the `approvePR()` function (lines 1480-1544)**
  This is the legacy approval function that hardcodes the finance approver name and redirects to PO tab. It was superseded by `approvePRWithSignature()` (line 1551) which captures signatures and user identity. The function spans from the JSDoc comment at line 1480 through the closing `};` at line 1544.

  **2. Remove the `generatePOsForPR()` function (lines 1956-2045)**
  This is the legacy PO generation function. Its only caller was the dead `approvePR()` at line 1525. It was superseded by `generatePOsForPRWithSignature()` (line 1631) which embeds signatures and user attribution. The function spans from the section comment at line 1956 through the closing `}` at line 2045.

  Also remove the section comment block above it (lines 1956-1958):
  ```
  // ========================================
  // PO GENERATION
  // ========================================
  ```
  Because the signature-based version `generatePOsForPRWithSignature()` (line 1631) already has its own context.

  **3. Remove the window attachment and cleanup for approvePR**
  - Line 61: `window.approvePR = approvePR;` -- remove this line
  - Line 1011: `delete window.approvePR;` -- remove this line

  Note: `generatePOsForPR` has NO window attachment (it was only called internally by `approvePR`), so no window cleanup needed for it.

  **Do NOT remove:**
  - `approvePRWithSignature()` (line 1551) -- this is the ACTIVE signature-based replacement
  - `generatePOsForPRWithSignature()` (line 1631) -- this is the ACTIVE PO generation function
  - `approveTR()` (line 1715) -- this is ACTIVE (just fixed in Plan 23-01)
  - `window.approvePRWithSignature` attachment (line 67) -- this is ACTIVE
  - `delete window.approvePRWithSignature` cleanup (line 1024) -- this is ACTIVE

  **After removal**, verify the comment on line 1607 (inside `approvePRWithSignature`) that references `generatePOsForPR`. It reads:
  ```
  // Generate PO using existing generatePOsForPR with signature data
  ```
  Update this comment to:
  ```
  // Generate POs with signature data
  ```
  Since the function it referenced no longer exists.
  </action>
  <verify>
  1. `grep -n "function approvePR(" app/views/finance.js` returns zero results (only `approvePRWithSignature` should exist)
  2. `grep -n "function generatePOsForPR(" app/views/finance.js` returns zero results (only `generatePOsForPRWithSignature` should exist)
  3. `grep -n "window.approvePR " app/views/finance.js` returns zero results (note the space -- `window.approvePRWithSignature` should still exist)
  4. `grep -n "delete window.approvePR;" app/views/finance.js` returns zero results (note semicolon right after -- `delete window.approvePRWithSignature` should still exist)
  5. `grep -n "approvePRWithSignature" app/views/finance.js` still returns matches (confirming active function preserved)
  6. `grep -n "generatePOsForPRWithSignature" app/views/finance.js` still returns matches (confirming active function preserved)
  7. finance.js line count should drop by approximately 130 lines (from ~2207 to ~2077)
  </verify>
  <done>Legacy approvePR() (~62 lines), generatePOsForPR() (~82 lines), and their window attachment/cleanup removed. Active signature-based versions preserved. Stale comment updated.</done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 20 VERIFICATION.md from UAT results</name>
  <files>.planning/phases/20-multi-personnel-pill-selection/20-VERIFICATION.md</files>
  <action>
  Create a formal VERIFICATION.md for Phase 20 based on the comprehensive UAT at 20-UAT.md (14/14 tests passed).

  Follow the exact format of existing verification files (e.g., 22-VERIFICATION.md). The document should include:

  **Frontmatter:**
  ```yaml
  ---
  phase: 20-multi-personnel-pill-selection
  verified: 2026-02-09T18:35:00Z
  status: passed
  score: 6/6 must-haves verified
  ---
  ```
  Use the UAT completion timestamp (2026-02-09T18:35:00Z from 20-UAT.md frontmatter).

  **Observable Truths (from Phase 20 ROADMAP success criteria):**
  Map the 6 success criteria from ROADMAP.md Phase 20 to verification evidence from the UAT results:

  1. "Personnel field in project creation allows selecting multiple users" -- UAT tests 1-4 passed (pill input renders, typing filters, selecting adds pill, multiple users work)
  2. "Selected users appear as removable pills/chips" -- UAT tests 3, 5 passed (blue pill with X button, click X removes)
  3. "Typing in personnel field filters available users" -- UAT test 2 passed (dropdown shows matching users by name/email)
  4. "Project stores array of personnel (personnel_user_ids + personnel_names)" -- UAT tests 7, 9 passed (Firebase Console confirms array format on create and edit)
  5. "Project detail page displays all assigned personnel as pills" -- UAT tests 10-12 passed (detail page shows pills, inline add/remove works)
  6. "Existing single-personnel projects remain backward compatible" -- UAT tests 8, 14 passed (legacy projects show pills, freetext shows gray pill)

  **Required Artifacts:**
  - app/utils.js -- normalizePersonnel() utility function
  - app/views/projects.js -- pill multi-select in project creation/edit form
  - app/views/project-detail.js -- pill display/edit on project detail page
  - styles/components.css -- .personnel-pill, .pill-input-container CSS classes

  **Key Links:**
  - projects.js -> utils.js normalizePersonnel() for reading legacy data
  - project-detail.js -> utils.js normalizePersonnel() for reading legacy data
  - projects.js -> Firestore personnel_user_ids/personnel_names arrays on save
  - project-detail.js -> Firestore personnel_user_ids/personnel_names arrays on save

  **Source:** Note this verification was derived from UAT results (20-UAT.md, 14/14 passed) rather than automated code inspection, since the UAT was comprehensive.
  </action>
  <verify>
  1. File exists at `.planning/phases/20-multi-personnel-pill-selection/20-VERIFICATION.md`
  2. Contains frontmatter with `status: passed` and `score: 6/6`
  3. Contains all 6 observable truths from ROADMAP.md Phase 20 success criteria
  4. Each truth references specific UAT test numbers as evidence
  5. Contains Required Artifacts and Key Links sections
  </verify>
  <done>Phase 20 VERIFICATION.md exists with 6/6 must-haves verified, each mapped to specific UAT test results as evidence.</done>
</task>

</tasks>

<verification>
1. `grep -rn "function approvePR(" app/views/finance.js` returns zero results
2. `grep -rn "function generatePOsForPR(" app/views/finance.js` returns zero results
3. `grep -rn "approvePRWithSignature" app/views/finance.js` returns multiple results (active function preserved)
4. `ls .planning/phases/20-multi-personnel-pill-selection/20-VERIFICATION.md` succeeds
5. finance.js has no orphaned window attachments (no `window.approvePR =` without corresponding function)
</verification>

<success_criteria>
- Legacy approvePR() function removed from finance.js (zero matches for "function approvePR(")
- Legacy generatePOsForPR() function removed from finance.js (zero matches for "function generatePOsForPR(")
- Window attachment and cleanup for approvePR removed
- Active signature-based functions (approvePRWithSignature, generatePOsForPRWithSignature) preserved
- Phase 20 VERIFICATION.md exists with passed status documenting 14/14 UAT results mapped to 6 success criteria
</success_criteria>

<output>
After completion, create `.planning/phases/23-tech-debt-cleanup/23-02-SUMMARY.md`
</output>
