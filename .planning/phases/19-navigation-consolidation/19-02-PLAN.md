---
phase: 19-navigation-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - index.html
  - styles/components.css
  - app/auth.js
autonomous: true

must_haves:
  truths:
    - "Navigation shows single 'Admin' text instead of 3 separate links (Settings, Assignments, Users)"
    - "Clicking Admin text toggles a dropdown menu with 3 items: User Management, Assignments, Settings"
    - "Clicking a dropdown item navigates to #/admin and closes the dropdown"
    - "Clicking outside the dropdown closes it"
    - "Navigating to any non-admin route closes the dropdown"
    - "Non-admin users do not see the Admin nav item at all"
    - "Dropdown has no chevron/arrow -- just the text 'Admin'"
  artifacts:
    - path: "index.html"
      provides: "Admin dropdown HTML replacing 3 separate nav links"
      contains: "nav-dropdown"
    - path: "styles/components.css"
      provides: "Dropdown CSS styles"
      contains: "nav-dropdown-menu"
    - path: "app/auth.js"
      provides: "Permission filtering for dropdown container"
      contains: "nav-dropdown"
  key_links:
    - from: "index.html"
      to: "app/auth.js"
      via: "data-route attribute on .nav-dropdown for permission filtering"
      pattern: "nav-dropdown.*data-route"
    - from: "index.html"
      to: "app/router.js"
      via: "href=#/admin on dropdown items triggers hashchange"
      pattern: "href.*#/admin"
    - from: "index.html"
      to: "app/views/admin.js"
      via: "setAdminSection sets window._pendingAdminSection which admin.js init() reads"
      pattern: "_pendingAdminSection"
    - from: "styles/components.css"
      to: "index.html"
      via: "CSS classes matching dropdown HTML structure"
      pattern: "nav-dropdown-menu"
---

<objective>
Replace the 3 separate admin navigation links with a single "Admin" dropdown menu and ensure permission-based visibility works for the new dropdown structure.

Purpose: This is the user-facing half of Phase 19 -- the navigation cleanup. Users see one "Admin" item instead of three, with a click-to-toggle dropdown for section selection. The permission system is extended to show/hide the entire dropdown container based on role_config access.

Output: Updated index.html with dropdown, dropdown CSS in components.css, and auth.js permission filtering for dropdown containers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-navigation-consolidation/19-CONTEXT.md
@.planning/phases/19-navigation-consolidation/19-RESEARCH.md
@.planning/phases/19-navigation-consolidation/19-01-SUMMARY.md
@index.html
@styles/components.css
@app/auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace nav links with dropdown and add CSS</name>
  <files>index.html, styles/components.css</files>
  <action>
**index.html changes:**

Replace the 3 admin nav links (lines 35-37):
```html
<a href="#/role-config" class="nav-link" data-route="role_config">Settings</a>
<a href="#/project-assignments" class="nav-link" data-route="role_config">Assignments</a>
<a href="#/user-management" class="nav-link" data-route="role_config">Users</a>
```

With a single dropdown:
```html
<div class="nav-dropdown" data-route="role_config">
    <button class="nav-link nav-dropdown-trigger" data-route="role_config" onclick="toggleAdminDropdown(event)">Admin</button>
    <div class="nav-dropdown-menu" id="adminDropdownMenu">
        <a href="#/admin" class="nav-dropdown-item" onclick="setAdminSection('users')">User Management</a>
        <a href="#/admin" class="nav-dropdown-item" onclick="setAdminSection('assignments')">Assignments</a>
        <a href="#/admin" class="nav-dropdown-item" onclick="setAdminSection('settings')">Settings</a>
    </div>
</div>
```

Add an inline script block (inside the existing `<script type="module">` or as a separate small `<script>` before it) that defines these global functions:

```javascript
// Admin dropdown toggle
window.toggleAdminDropdown = function(event) {
    event.stopPropagation();
    const menu = document.getElementById('adminDropdownMenu');
    menu.classList.toggle('open');
};

// Set admin section before navigation
window.setAdminSection = function(section) {
    // Store desired section so admin.js can read it on init
    window._pendingAdminSection = section;
    const menu = document.getElementById('adminDropdownMenu');
    if (menu) menu.classList.remove('open');

    // If already on admin route, switch section directly
    if (window.location.hash === '#/admin' || window.location.hash.startsWith('#/admin/')) {
        if (window.switchAdminSection) {
            window.switchAdminSection(section);
        }
    }
    // Otherwise, navigation happens via href="#/admin"
};

// Close dropdown on outside click
document.addEventListener('click', function(e) {
    if (!e.target.closest('.nav-dropdown')) {
        const menu = document.getElementById('adminDropdownMenu');
        if (menu) menu.classList.remove('open');
    }
});

// Close dropdown on navigation
window.addEventListener('hashchange', function() {
    const menu = document.getElementById('adminDropdownMenu');
    if (menu) menu.classList.remove('open');
});
```

IMPORTANT: This script must NOT be `type="module"` because window functions need to be available globally for onclick attributes. Use a regular `<script>` tag placed before the module script.

**Coordination with admin.js (Plan 01):** The `setAdminSection` function stores `window._pendingAdminSection`. Plan 01 already wired admin.js `init()` to read and clear `_pendingAdminSection`. This means:
- If user is NOT on #/admin: `_pendingAdminSection` is set, then href navigates to #/admin, router calls admin.js init(), which reads `_pendingAdminSection` and opens the correct section.
- If user IS on #/admin: `switchAdminSection` is called directly (the window function from admin.js), switching the section without a full re-init.

**Dropdown section order** (per CONTEXT.md, most used first): User Management, Assignments, Settings.

**No chevron/arrow** on the Admin button (per CONTEXT.md).

**styles/components.css changes:**

Add after the existing `.nav-logout-btn:hover` block (after the navigation section):

```css
/* Admin Dropdown */
.nav-dropdown {
    position: relative;
}

.nav-dropdown-trigger {
    background: none;
    border: none;
    cursor: pointer;
    /* Inherits .nav-link styles */
}

.nav-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    min-width: 180px;
    z-index: 200;
    padding: 0.25rem 0;
}

.nav-dropdown-menu.open {
    display: block;
}

.nav-dropdown-item {
    display: block;
    padding: 0.5rem 1rem;
    color: var(--gray-700);
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: background 0.15s;
    white-space: nowrap;
}

.nav-dropdown-item:hover {
    background: var(--gray-50);
    color: var(--gray-900);
}
```

The dropdown should feel native to the existing nav -- same colors, same font sizes, same hover effects. No special visual treatment beyond the box shadow on the dropdown menu.
  </action>
  <verify>
1. Load app in browser -- nav shows "Admin" where Settings/Assignments/Users used to be
2. Click "Admin" -- dropdown opens with 3 items (User Management, Assignments, Settings)
3. Click "Admin" again -- dropdown closes (toggle behavior)
4. Click outside dropdown -- dropdown closes
5. Click a dropdown item -- navigates to #/admin and dropdown closes
6. Navigate to any other page -- dropdown is closed
7. No chevron or arrow visible on Admin button
8. Dropdown visually matches nav style (same colors, fonts, hover effects)
9. Click "Settings" dropdown item -- admin page opens with Settings section active (not default Users)
  </verify>
  <done>Three admin nav links replaced with single Admin dropdown button, dropdown CSS matches design system, toggle/close behavior works correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Extend permission filtering for dropdown container</name>
  <files>app/auth.js</files>
  <action>
Modify `updateNavForAuth()` in `app/auth.js` (around line 397-426).

**When user is authenticated (inside the `if (user)` block):**

After the existing `navLinks.forEach(...)` loop that filters `.nav-link[data-route]` elements, add handling for dropdown containers:

```javascript
// Handle dropdown containers (Admin dropdown)
const dropdowns = document.querySelectorAll('.nav-dropdown[data-route]');
dropdowns.forEach(dropdown => {
    const route = dropdown.getAttribute('data-route');
    const hasAccess = permissions?.tabs?.[route]?.access ?? true;
    dropdown.style.display = hasAccess ? '' : 'none';
});
```

**When user is NOT authenticated (inside the `else` block):**

After the existing `navLinks.forEach(...)` that hides all nav links, add:

```javascript
// Also hide dropdown containers
const dropdowns = document.querySelectorAll('.nav-dropdown[data-route]');
dropdowns.forEach(dropdown => {
    dropdown.style.display = 'none';
});
```

**Why this is needed (Research pitfall 3):** The existing `updateNavForAuth()` queries `.nav-link[data-route]` elements. The dropdown's outer `<div class="nav-dropdown">` is NOT a `.nav-link`, so it would not be filtered without this addition. The trigger button inside IS a `.nav-link` but hiding just the button leaves the container visible. We need to hide the entire `.nav-dropdown` container.

**ALSO:** The trigger button has both `class="nav-link nav-dropdown-trigger"` and `data-route="role_config"`. The existing navLinks.forEach will try to show/hide it independently. This is fine -- if the container is hidden, the button inside is hidden too. But to avoid any double-processing edge cases, consider whether the existing loop should skip elements inside `.nav-dropdown`. The simplest approach: let both the existing loop and the new dropdown loop run. The container-level hide/show will take visual precedence. No code change needed for this -- just be aware.
  </action>
  <verify>
1. Log in as admin user -- Admin dropdown is visible in nav
2. Log in as non-admin user (e.g., Operations User without role_config access) -- Admin dropdown is completely hidden
3. Log out -- Admin dropdown is hidden (along with all other nav items)
4. Log back in as admin -- Admin dropdown reappears
5. No console errors related to permission filtering
  </verify>
  <done>Permission filtering correctly shows/hides the entire Admin dropdown container based on role_config access, matching existing per-link filtering behavior.</done>
</task>

</tasks>

<verification>
1. Nav shows "Admin" instead of Settings/Assignments/Users -- visually cleaner
2. Dropdown opens on click, closes on outside click, closes on navigation
3. Admin dropdown hidden for non-admin users
4. Admin dropdown hidden for unauthenticated users
5. Dropdown items navigate to #/admin correctly
6. Clicking specific dropdown item opens correct section (not always default)
7. No visual glitches (z-index issues, positioning problems)
</verification>

<success_criteria>
- Single "Admin" nav item replaces 3 separate links
- Click-to-toggle dropdown with 3 items (User Management, Assignments, Settings)
- No chevron/arrow on Admin button
- Outside click and hashchange close the dropdown
- Permission filtering hides entire dropdown for non-admin users
- Dropdown CSS matches existing design system
- setAdminSection stores _pendingAdminSection which admin.js reads on init
</success_criteria>

<output>
After completion, create `.planning/phases/19-navigation-consolidation/19-02-SUMMARY.md`
</output>
