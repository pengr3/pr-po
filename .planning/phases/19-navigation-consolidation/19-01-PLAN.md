---
phase: 19-navigation-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/admin.js
  - app/router.js
autonomous: true

must_haves:
  truths:
    - "Navigating to #/admin loads the admin wrapper view with User Management section by default"
    - "Clicking section buttons within admin switches between User Management, Assignments, and Settings without hash change"
    - "Switching sections properly destroys the previous section's listeners and window functions before loading the next"
    - "Old routes #/role-config, #/project-assignments, #/user-management no longer resolve (redirect to home)"
    - "Admin route is gated by role_config permission (non-admin users see Access Denied)"
    - "Admin nav item shows active state when on #/admin route"
  artifacts:
    - path: "app/views/admin.js"
      provides: "Admin wrapper view with section switching"
      min_lines: 60
    - path: "app/router.js"
      provides: "Consolidated admin route, removed old routes"
      contains: "'/admin'"
  key_links:
    - from: "app/views/admin.js"
      to: "app/views/user-management.js"
      via: "dynamic import in SECTIONS config"
      pattern: "import.*user-management"
    - from: "app/views/admin.js"
      to: "app/views/project-assignments.js"
      via: "dynamic import in SECTIONS config"
      pattern: "import.*project-assignments"
    - from: "app/views/admin.js"
      to: "app/views/role-config.js"
      via: "dynamic import in SECTIONS config"
      pattern: "import.*role-config"
    - from: "app/router.js"
      to: "app/views/admin.js"
      via: "route definition lazy import"
      pattern: "import.*views/admin"
---

<objective>
Create the admin wrapper view and consolidate routing from 3 separate admin routes into a single #/admin route.

Purpose: The admin wrapper view is the core of Phase 19 -- it manages the lifecycle (render/init/destroy) of the three child views (user-management.js, project-assignments.js, role-config.js) as internal sections. The router changes remove the old routes and add the new consolidated one.

Output: New admin.js view module and updated router.js with single admin route.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-navigation-consolidation/19-CONTEXT.md
@.planning/phases/19-navigation-consolidation/19-RESEARCH.md
@app/router.js
@app/views/user-management.js
@app/views/project-assignments.js
@app/views/role-config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin.js wrapper view with section switching</name>
  <files>app/views/admin.js</files>
  <action>
Create `app/views/admin.js` that follows the existing view module pattern (render/init/destroy exports).

**SECTIONS config object** with 3 entries in this order (per CONTEXT.md "most used first"):
1. `users` -> label "User Management", loads `./user-management.js`
2. `assignments` -> label "Assignments", loads `./project-assignments.js`
3. `settings` -> label "Settings", loads `./role-config.js`

**render(activeSection = 'users'):**
- Returns HTML with a section navigation bar (3 buttons with class `admin-section-btn`, `data-section` attribute, onclick calling `switchAdminSection('sectionId')`)
- Active button gets `.active` class
- Contains `<div id="adminContent"></div>` container where child view HTML renders
- Style the section nav as a horizontal button bar (similar to existing tab navs in procurement.js/finance.js)

**init(activeSection = 'users'):**
- Set `currentSection = activeSection`
- Load the section module via `SECTIONS[activeSection].load()` (dynamic import)
- Store loaded module in `currentModule`
- Render child view: `document.getElementById('adminContent').innerHTML = currentModule.render()`
- Init child view: `await currentModule.init()`
- Attach `window.switchAdminSection = switchAdminSection`

**destroy():**
- Call `currentModule.destroy()` if exists
- Set `currentModule = null`, `currentSection = null`
- Delete `window.switchAdminSection`

**switchAdminSection(sectionId):**
- If `sectionId === currentSection`, return early (no-op)
- Call `currentModule.destroy()` if exists (CRITICAL for listener cleanup -- see Research pitfall 5)
- Load new section module via dynamic import
- Update `currentModule` and `currentSection`
- Render child view into `#adminContent`
- Init child view
- Update active state on section buttons: `document.querySelectorAll('.admin-section-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.section === sectionId))`

**IMPORTANT:**
- Section switching is entirely internal (no hash changes). The route stays `#/admin` always (per CONTEXT.md: no deep links).
- Do NOT modify the 3 child view modules. They must work unchanged.
- Each child view's `destroy()` already cleans up its own window functions and listeners. Just ensure `destroy()` is always called before loading a new section.
  </action>
  <verify>
Open browser console, navigate to `#/admin`. Verify:
1. Section nav shows 3 buttons (User Management, Assignments, Settings)
2. User Management content loads by default
3. Click Assignments button -> User Management content replaced with Assignments content (no console errors)
4. Click Settings button -> Assignments content replaced with Settings content (no console errors)
5. Click User Management button again -> Settings content replaced with User Management content
6. No "Cannot set innerHTML of null" errors in console during section switching
  </verify>
  <done>Admin wrapper view loads all 3 child views via section switching, properly calling destroy() between switches, with no modifications to child view modules.</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate router routes and update navigation active state</name>
  <files>app/router.js</files>
  <action>
Modify `app/router.js` with these changes:

**1. Remove old routes from `routes` object (lines 84-98):**
Remove these 3 entries:
- `'/role-config': { ... }`
- `'/project-assignments': { ... }`
- `'/user-management': { ... }`

**2. Add new admin route to `routes` object:**
```javascript
'/admin': {
    name: 'Admin',
    load: () => import('./views/admin.js'),
    title: 'Admin | CLMC Procurement',
    defaultTab: 'users'
}
```
Note: `defaultTab: 'users'` will be passed as the `activeTab` parameter to `admin.js render()` and `init()`, which admin.js treats as `activeSection`.

**3. Update `routePermissionMap` (lines 8-19):**
Remove:
- `'/role-config': 'role_config'`
- `'/project-assignments': 'role_config'`
- `'/user-management': 'role_config'`

Add:
- `'/admin': 'role_config'`

**4. Update `updateNavigation()` function (line 146):**
After the existing `document.querySelectorAll('.nav-link').forEach(...)` loop, add handling for the admin dropdown trigger:

```javascript
// Handle admin dropdown active state
const adminDropdown = document.querySelector('.nav-dropdown-trigger');
if (adminDropdown) {
    if (path === '/admin') {
        adminDropdown.classList.add('active');
    } else {
        adminDropdown.classList.remove('active');
    }
}
```

This ensures the Admin nav item stays highlighted when on the admin page (per CONTEXT.md).
  </action>
  <verify>
1. In browser, navigate to `#/admin` -> page loads correctly, title shows "Admin | CLMC Procurement"
2. Navigate to `#/role-config` -> redirects to home (route not found)
3. Navigate to `#/project-assignments` -> redirects to home (route not found)
4. Navigate to `#/user-management` -> redirects to home (route not found)
5. When on `#/admin`, the Admin nav item has the `.active` class
6. When navigating away from `#/admin`, the Admin nav item loses the `.active` class
  </verify>
  <done>Router has single /admin route replacing 3 old admin routes, permission map updated, navigation active state works for dropdown trigger.</done>
</task>

</tasks>

<verification>
1. Navigate to `#/admin` -- admin wrapper loads with User Management as default section
2. Switch between all 3 sections -- each loads and unloads cleanly (check console for errors)
3. Navigate to `#/role-config`, `#/project-assignments`, `#/user-management` -- all redirect to home
4. Permission check: non-admin user cannot access `#/admin` (sees Access Denied)
5. No console errors during normal usage
</verification>

<success_criteria>
- admin.js wrapper view exists and manages 3 child views as internal sections
- Router has single /admin route with role_config permission gate
- Old routes completely removed (no redirects, just "not found" -> home)
- Section switching calls destroy() before loading new section
- Admin nav item shows active state on /admin route
</success_criteria>

<output>
After completion, create `.planning/phases/19-navigation-consolidation/19-01-SUMMARY.md`
</output>
