---
phase: 17-procurement-workflow-overhaul
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "MRF Status shows 'Awaiting PR' in red when no PRs exist"
    - "MRF Status shows '0/n PO Issued' in yellow when PRs exist but no POs"
    - "MRF Status shows 'n/n PO Issued' in green when all POs issued"
    - "Timeline displays timestamps with time precision for workflow efficiency tracking"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "MRF status calculation and visual badge rendering"
      min_lines: 4360
      contains: "calculateMRFStatus"
  key_links:
    - from: "renderPRPORecords()"
      to: "calculateMRFStatus()"
      via: "Status calculation for each MRF row"
      pattern: "calculateMRFStatus"
    - from: "PO status updates"
      to: "serverTimestamp() fields"
      via: "Timeline tracking with millisecond precision"
      pattern: "serverTimestamp\\(\\)"
---

<objective>
Implement comprehensive MRF status tracking with visual indicators showing PR/PO progress and enhance timeline tracking with precise timestamps.

Purpose: Provide at-a-glance visibility into MRF workflow progress using color-coded badges. Enable efficiency measurement with millisecond-precision timestamps for procurement timeline analysis.

Output: Color-coded status badges (red/yellow/green) in MRF Status column and enhanced PO status updates with serverTimestamp() for accurate timeline tracking.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\17-procurement-workflow-overhaul\17-RESEARCH.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\17-procurement-workflow-overhaul\17-02-SUMMARY.md
@C:\Users\franc\dev\projects\pr-po\CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MRF status calculation function</name>
  <files>app/views/procurement.js</files>
  <action>
Add a new helper function to calculate MRF status based on PRs and POs:

1. Add this function before `renderPRPORecords()` (around line 2280):
```javascript
/**
 * Calculate MRF status based on PR/PO state
 * Returns status text and color for badge rendering
 */
function calculateMRFStatus(prs, pos) {
    const prCount = prs.length;
    const poCount = pos.length;

    if (prCount === 0) {
        // No PRs generated yet
        return {
            status: 'Awaiting PR',
            color: '#ef4444', // Red
            description: 'No PRs generated yet'
        };
    } else if (poCount === 0) {
        // PRs exist but no POs
        return {
            status: '0/' + prCount + ' PO Issued',
            color: '#f59e0b', // Yellow
            description: 'PRs approved, awaiting PO generation'
        };
    } else if (poCount === prCount) {
        // All POs issued
        return {
            status: prCount + '/' + prCount + ' PO Issued',
            color: '#22c55e', // Green
            description: 'All POs issued'
        };
    } else {
        // Partial PO issuance
        return {
            status: poCount + '/' + prCount + ' PO Issued',
            color: '#f59e0b', // Yellow
            description: 'Partial PO issuance'
        };
    }
}

/**
 * Render MRF status badge with color coding
 */
function renderMRFStatusBadge(statusObj) {
    return `<span style="
        background: ${statusObj.color};
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
        display: inline-block;
    ">${statusObj.status}</span>`;
}
```

2. **Color coding rationale:**
   - Red (#ef4444): Urgent action needed (no PRs yet)
   - Yellow (#f59e0b): In progress (waiting for POs)
   - Green (#22c55e): Complete (all POs issued)

3. **Pattern:** Follows existing badge pattern in procurement.js (inline styles, self-contained).
  </action>
  <verify>
```bash
# Verify functions exist
grep "function calculateMRFStatus" app/views/procurement.js
grep "function renderMRFStatusBadge" app/views/procurement.js

# Verify color values
grep "#ef4444" app/views/procurement.js  # Red
grep "#f59e0b" app/views/procurement.js  # Yellow
grep "#22c55e" app/views/procurement.js  # Green
```
  </verify>
  <done>
- calculateMRFStatus() function created with PR/PO count logic
- renderMRFStatusBadge() function created with inline styles
- Color coding implemented: red (no PRs), yellow (waiting for POs), green (all POs issued)
- Badge styling uses existing pattern (inline styles, proper spacing)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate status calculation into table rendering</name>
  <files>app/views/procurement.js</files>
  <action>
Update `renderPRPORecords()` to calculate and display MRF status for each row:

1. The function already fetches PRs and POs for each MRF in the `Promise.all` loop (around line 2314-2380). This data is available in the row mapping.

2. Locate where the table rows are constructed (in the `Promise.all` mapping that builds the `rows` array).

3. For each MRF row, after fetching PRs and POs:
```javascript
// Calculate MRF status
const statusObj = calculateMRFStatus(prs, pos);
const statusBadge = renderMRFStatusBadge(statusObj);
```

4. In the table cell for "MRF Status" column (replace the placeholder from Plan 02):
```javascript
<td style="padding: 0.75rem 1rem;">
    ${statusBadge}
</td>
```

5. **Performance consideration:** Per Research Pitfall #4, this implementation already batch-fetches PRs/POs in the rendering loop. This avoids N+1 query problem. If needed, optimize further by fetching ALL PRs and POs once, then grouping by mrf_id in JavaScript.

**Critical:** Ensure PRs and POs arrays are available in the row context. The current implementation should already have these from the existing PR/PO fetching logic.
  </action>
  <verify>
```bash
# Verify status calculation is called in rendering
grep -A 5 "calculateMRFStatus" app/views/procurement.js | grep "renderMRFStatusBadge"

# Verify status badge is rendered in table cell
grep -B 2 -A 2 "statusBadge" app/views/procurement.js
```
  </verify>
  <done>
- renderPRPORecords() calls calculateMRFStatus() for each MRF row
- Status badge is rendered in MRF Status table column
- Badge displays color-coded status based on PR/PO counts
- Performance optimized (batch fetch, not N+1 queries)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add serverTimestamp to PO status updates</name>
  <files>app/views/procurement.js</files>
  <action>
Enhance the `updatePOStatus()` function to capture precise timestamps for timeline tracking:

1. Locate the `updatePOStatus(poId, newStatus, oldStatus, isSubcon)` function (search for "async function updatePOStatus").

2. The function already has an `updates` object that gets passed to `updateDoc()`. Enhance it with serverTimestamp fields based on status:

```javascript
async function updatePOStatus(poId, newStatus, oldStatus, isSubcon) {
    // ... existing permission and validation logic ...

    const updates = {
        procurement_status: newStatus
    };

    // Add timestamp fields based on status transition
    if (newStatus === 'Procuring' && !isSubcon) {
        updates.procurement_started_at = serverTimestamp(); // NEW
    } else if (newStatus === 'Procured' && !isSubcon) {
        updates.procured_at = serverTimestamp(); // NEW
        updates.procured_date = new Date().toISOString().split('T')[0]; // Keep for backward compat
    } else if (newStatus === 'Delivered') {
        updates.delivered_at = serverTimestamp(); // NEW
        updates.delivered_date = new Date().toISOString().split('T')[0]; // Keep for backward compat
    }

    // ... rest of function (updateDoc call) ...
}
```

3. **Why both _at and _date fields:**
   - `_at` fields: serverTimestamp() for millisecond precision, used for efficiency metrics
   - `_date` fields: ISO date strings for backward compatibility with existing code

4. **Backward compatibility:** Timeline display logic should handle both formats:
   - If timestamp has `.toDate()` method → Firestore Timestamp (new)
   - If string → ISO date (old)

5. **CRITICAL:** This task depends on Plan 17-01 which adds `serverTimestamp` to the firebase imports. Verify import exists before using.
  </action>
  <verify>
```bash
# Verify serverTimestamp fields added to updatePOStatus
grep -A 20 "async function updatePOStatus" app/views/procurement.js | grep "serverTimestamp"

# Verify backward compat fields preserved
grep "procured_date" app/views/procurement.js
grep "delivered_date" app/views/procurement.js

# Verify all three status transitions covered
grep "procurement_started_at" app/views/procurement.js
grep "procured_at" app/views/procurement.js
grep "delivered_at" app/views/procurement.js
```
  </verify>
  <done>
- updatePOStatus() adds serverTimestamp() fields for status transitions
- procurement_started_at added when status → 'Procuring'
- procured_at added when status → 'Procured'
- delivered_at added when status → 'Delivered'
- Backward compatibility fields (procured_date, delivered_date) preserved
- serverTimestamp imported and used correctly
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Visual Status Badges:**
   - Navigate to Procurement → MRF Records
   - Find MRF with no PRs → Status should show red "Awaiting PR" badge
   - Find MRF with PRs but no POs → Status should show yellow "0/n PO Issued" badge
   - Find MRF with all POs issued → Status should show green "n/n PO Issued" badge

2. **Timestamp Precision:**
   - Update a PO status from "Pending Procurement" → "Procuring"
   - Check Firestore console → PO document should have `procurement_started_at` field (Timestamp type)
   - Verify `procured_date` string field still exists for backward compat

3. **Timeline Display:**
   - Click Timeline button for an MRF
   - Timeline should display dates with times (not just dates)
   - Old POs should still display correctly (backward compat)

4. **Performance:**
   - Load MRF Records tab with 20+ MRFs
   - Should render in <2 seconds
   - Check Network tab: should NOT see hundreds of individual PR/PO queries
</verification>

<success_criteria>
- [x] MRF Status shows "Awaiting PR" (red) when no PRs exist
- [x] MRF Status shows "0/n PO Issued" (yellow) when PRs exist but no POs
- [x] MRF Status shows "n/n PO Issued" (green) when all POs issued
- [x] Partial PO issuance shows "m/n PO Issued" (yellow)
- [x] Timeline displays timestamps with time precision for efficiency tracking
- [x] Timeline captures serverTimestamp() for status transitions
- [x] Backward compatibility maintained (old _date fields preserved)
- [x] Status calculation performs efficiently (no N+1 queries)
- [x] Visual badges use consistent color coding (red/yellow/green)
</success_criteria>

<output>
After completion, create `.planning/phases/17-procurement-workflow-overhaul/17-03-SUMMARY.md`
</output>
