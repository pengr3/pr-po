---
phase: 17-procurement-workflow-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/procurement.js
autonomous: true

must_haves:
  truths:
    - "Generated PRs bear the name of user who clicked Generate PR button"
    - "PR creator information is captured and stored for audit trail"
    - "PR documents display the creator's name when generated"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Enhanced PR generation with user attribution"
      min_lines: 4360
      contains: "pr_creator_user_id"
  key_links:
    - from: "app/views/procurement.js"
      to: "window.getCurrentUser()"
      via: "auth.js getCurrentUser() call"
      pattern: "window\\.getCurrentUser\\(\\)"
    - from: "PR document"
      to: "pr_creator_name field"
      via: "Firestore prs collection"
      pattern: "pr_creator_name"
---

<objective>
Capture and store the identity of users who generate PRs for audit trail and accountability.

Purpose: Enable tracking of who created each PR for workflow transparency and accountability. This supports audit requirements and helps operations teams understand workflow history.

Output: Enhanced PR generation functions that capture user identity (user_id + full_name) and store it in PR documents using the denormalization pattern from Phase 15.
</objective>

<execution_context>
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\franc\dev\projects\pr-po\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\franc\dev\projects\pr-po\.planning\PROJECT.md
@C:\Users\franc\dev\projects\pr-po\.planning\ROADMAP.md
@C:\Users\franc\dev\projects\pr-po\.planning\STATE.md
@C:\Users\franc\dev\projects\pr-po\.planning\phases\17-procurement-workflow-overhaul\17-RESEARCH.md
@C:\Users\franc\dev\projects\pr-po\CLAUDE.md
@C:\Users\franc\dev\projects\pr-po\app\auth.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user attribution to generatePR function</name>
  <files>app/views/procurement.js</files>
  <action>
Enhance the `generatePR()` function (starts around line 2869) to capture user identity:

1. At the start of the function (after permission check), add:
```javascript
const currentUser = window.getCurrentUser();

if (!currentUser) {
    showToast('Session expired. Please log in again.', 'error');
    return;
}
```

2. In the PR document creation (where `addDoc(collection(db, 'prs'), {...})` is called), add these fields to the document object:
```javascript
pr_creator_user_id: currentUser.uid,
pr_creator_name: currentUser.full_name || currentUser.email || 'Unknown User',
created_at: serverTimestamp(),
```

3. Keep the existing `date_generated: new Date().toISOString().split('T')[0]` field for backward compatibility.

4. Add `serverTimestamp` to the imports at the top of the file:
```javascript
import { db, collection, ..., serverTimestamp } from '../firebase.js';
```

**Pattern to follow:** Phase 15 denormalization pattern (personnel_user_id + personnel_name). Store both ID and name to avoid lookup overhead and maintain historical accuracy if user is deleted/renamed.

**Why getCurrentUser():** auth.js provides `window.getCurrentUser()` which returns full user object with uid, email, full_name, role. Don't parse auth.currentUser manually.

**Why serverTimestamp():** Server-side timestamp prevents client clock skew and provides millisecond precision for efficiency metrics. Research shows this is critical for timeline accuracy.
  </action>
  <verify>
```bash
# Check that serverTimestamp is imported
grep "serverTimestamp" app/views/procurement.js

# Check that getCurrentUser is called in generatePR
grep -A 5 "async function generatePR" app/views/procurement.js | grep "getCurrentUser"

# Check that pr_creator fields are added
grep "pr_creator_user_id" app/views/procurement.js
grep "pr_creator_name" app/views/procurement.js
```
  </verify>
  <done>
- generatePR() function calls getCurrentUser() and validates user session
- PR documents include pr_creator_user_id, pr_creator_name, and created_at (serverTimestamp)
- Existing date_generated field preserved for backward compatibility
- serverTimestamp imported from firebase.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Add user attribution to generatePRandTR function</name>
  <files>app/views/procurement.js</files>
  <action>
Enhance the `generatePRandTR()` function (starts around line 3154) with the same user attribution pattern:

1. At the start of the function (after permission check), add:
```javascript
const currentUser = window.getCurrentUser();

if (!currentUser) {
    showToast('Session expired. Please log in again.', 'error');
    return;
}
```

2. In the PR document creation loop (where PRs are created for each supplier), add to the PR document object:
```javascript
pr_creator_user_id: currentUser.uid,
pr_creator_name: currentUser.full_name || currentUser.email || 'Unknown User',
created_at: serverTimestamp(),
```

3. Keep the existing `date_generated` field for backward compatibility.

**Important:** This function creates both PRs and TRs. Only add user attribution to PRs. TRs don't need pr_creator fields (they have their own tr_creator fields which should be handled separately if needed in future).
  </action>
  <verify>
```bash
# Check that getCurrentUser is called in generatePRandTR
grep -A 5 "async function generatePRandTR" app/views/procurement.js | grep "getCurrentUser"

# Verify pr_creator fields are in the PR creation part
grep -A 30 "async function generatePRandTR" app/views/procurement.js | grep "pr_creator"
```
  </verify>
  <done>
- generatePRandTR() function calls getCurrentUser() and validates user session
- All PRs created in this function include pr_creator_user_id, pr_creator_name, and created_at fields
- TRs are not modified (TR attribution is separate concern)
  </done>
</task>

<task type="auto">
  <name>Task 3: Display PR creator in PR Details modal</name>
  <files>app/views/procurement.js</files>
  <action>
Update the `viewPRDetails()` function to display the PR creator's name in the modal:

1. Locate the `viewPRDetails(prDocId)` function (search for "function viewPRDetails").

2. In the modal HTML generation, add a new read-only field after the "Supplier" field:
```javascript
<div style="margin-bottom: 1rem;">
    <label style="font-weight: 600; display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #475569;">Prepared By</label>
    <div style="padding: 0.5rem 0.75rem; background: #f8f9fa; border-radius: 4px; color: #1e293b; font-size: 0.875rem;">
        ${pr.pr_creator_name || 'Unknown User'}
    </div>
</div>
```

3. Use plain text display (not disabled input) following Phase 16 pattern for locked fields.

**Backward compatibility:** Use `pr.pr_creator_name || 'Unknown User'` to handle old PRs that don't have this field yet.
  </action>
  <verify>
```bash
# Check that viewPRDetails includes pr_creator_name
grep -A 20 "function viewPRDetails" app/views/procurement.js | grep "pr_creator_name"

# Verify the display follows Phase 16 pattern (plain text, not input)
grep -B 2 -A 2 "pr_creator_name" app/views/procurement.js | grep "background: #f8f9fa"
```
  </verify>
  <done>
- PR Details modal displays "Prepared By" field showing pr_creator_name
- Display uses plain text with gray background (Phase 16 pattern)
- Falls back to "Unknown User" for old PRs without pr_creator_name field
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Test PR Generation:**
   - Log in as a user
   - Navigate to Procurement → MRF Processing
   - Select an MRF with items
   - Click "Generate PR"
   - Check browser console: should see logged user's name
   - Open Firestore console → prs collection → verify new PR has pr_creator_user_id and pr_creator_name fields

2. **Test PR Details Modal:**
   - Navigate to Procurement → MRF Records
   - Click "View" on a PR in the PRs column
   - Modal should display "Prepared By" field with user's name
   - Old PRs should show "Unknown User"

3. **Test Generate PR & TR:**
   - Select an MRF with mixed items (materials + transport)
   - Click "Generate PR & TR"
   - Verify both PRs have pr_creator fields in Firestore

4. **Backward Compatibility:**
   - View details of old PRs (created before this update)
   - Modal should display "Unknown User" without errors
</verification>

<success_criteria>
- [x] Generated PRs bear the name of user who clicked Generate PR button
- [x] PR documents capture pr_creator_user_id and pr_creator_name fields
- [x] PR Details modal displays "Prepared By" field
- [x] serverTimestamp() used for created_at field (millisecond precision)
- [x] Backward compatibility maintained (old PRs show "Unknown User")
- [x] Both generatePR() and generatePRandTR() enhanced with user attribution
</success_criteria>

<output>
After completion, create `.planning/phases/17-procurement-workflow-overhaul/17-01-SUMMARY.md`
</output>
