---
phase: 17-procurement-workflow-overhaul
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [app/views/procurement.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When user updates rejected PR, system captures current user's identity"
    - "When user merges items into approved PR, system captures current user's identity"
    - "PR Details modal displays current user's name in Prepared By field (not 'Unknown User')"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "pr_creator_user_id and pr_creator_name in rejected PR update path"
      min_lines: 2
      location: "lines 3086-3092"
    - path: "app/views/procurement.js"
      provides: "pr_creator_user_id and pr_creator_name in approved PR merge path"
      min_lines: 2
      location: "lines 3109-3115"
  key_links:
    - from: "generatePR() rejected PR update"
      to: "updateDoc() call"
      via: "pr_creator fields added"
      pattern: "pr_creator_user_id.*pr_creator_name"
    - from: "generatePR() approved PR merge"
      to: "updateDoc() call"
      via: "pr_creator fields added"
      pattern: "pr_creator_user_id.*pr_creator_name"
---

<objective>
Complete PR creator attribution implementation by adding user identity capture to rejected PR update and approved PR merge paths.

Purpose: Fix UAT Gap 1 - PR creator attribution currently only works for NEW PRs, missing in update/merge paths, causing "Unknown User" display for existing PR workflows.
Output: All three PR generation paths capture pr_creator_user_id and pr_creator_name for complete audit trail.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 17 prior work
@.planning/phases/17-procurement-workflow-overhaul/17-01-SUMMARY.md

# Gap diagnosis
@.planning/debug/pr-creator-shows-unknown-user.md

# Current implementation
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Add pr_creator fields to rejected PR update path</name>
  <files>app/views/procurement.js</files>
  <action>
In generatePR() function, locate the rejected PR update path (lines 3086-3092).

Add pr_creator_user_id and pr_creator_name to the updateDoc() call:

```javascript
await updateDoc(prRef, {
    items_json: JSON.stringify(supplierItems),
    total_amount: supplierTotal,
    finance_status: 'Pending',
    updated_at: new Date().toISOString(),
    resubmitted_at: new Date().toISOString(),
    pr_creator_user_id: currentUser.uid,
    pr_creator_name: currentUser.full_name
});
```

IMPORTANT: currentUser variable is already defined at top of generatePR() function (line 2933). Do NOT redeclare it.

Follow Phase 17-01 pattern: Store both uid and full_name for denormalized audit trail.

Rationale: When reusing rejected PR, the current user who clicked "Generate PR" should be recorded as the creator of this version. Old pr_creator values should be overwritten with current user.
  </action>
  <verify>
Search for "pr_creator_user_id" in rejected PR update path (lines 3086-3092):
```bash
sed -n '3086,3092p' app/views/procurement.js | grep -c "pr_creator_user_id"
```
Should return 1 (field present in updateDoc call).
  </verify>
  <done>
Rejected PR update path includes pr_creator_user_id and pr_creator_name fields. When user resubmits rejected PR, their identity is captured.
  </done>
</task>

<task type="auto">
  <name>Add pr_creator fields to approved PR merge path</name>
  <files>app/views/procurement.js</files>
  <action>
In generatePR() function, locate the approved PR merge path (lines 3109-3115).

Add pr_creator_user_id and pr_creator_name to the updateDoc() call:

```javascript
await updateDoc(prRef, {
    items_json: JSON.stringify(mergedItems),
    total_amount: mergedTotal,
    updated_at: new Date().toISOString(),
    items_merged: true,
    pr_creator_user_id: currentUser.uid,
    pr_creator_name: currentUser.full_name
});
```

IMPORTANT: currentUser variable is already defined at top of generatePR() function (line 2933). Do NOT redeclare it.

Follow Phase 17-01 pattern: Store both uid and full_name for denormalized audit trail.

Rationale: When merging items into approved PR, the current user who added new items should be recorded. This captures who extended the PR beyond the original creator.

Note: This updates pr_creator to current user, effectively showing who last modified the PR. If original creator tracking is needed in future, add pr_original_creator fields separately.
  </action>
  <verify>
Search for "pr_creator_user_id" in approved PR merge path (lines 3109-3115):
```bash
sed -n '3109,3115p' app/views/procurement.js | grep -c "pr_creator_user_id"
```
Should return 1 (field present in updateDoc call).
  </verify>
  <done>
Approved PR merge path includes pr_creator_user_id and pr_creator_name fields. When user adds items to approved PR, their identity is captured.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete PR creator attribution across all three PR generation paths:
1. New PR creation (already working from Plan 17-01)
2. Rejected PR update (fixed in Task 1)
3. Approved PR merge (fixed in Task 2)
  </what-built>
  <how-to-verify>
**Test Scenario 1: New PR (baseline - should already work)**
1. Navigate to Procurement ‚Üí MRF Processing
2. Select MRF without existing PRs
3. Click "Generate PR" button
4. In generated PRs list, click View button on PR
5. Verify "Prepared By" field shows YOUR NAME (not "Unknown User")

**Test Scenario 2: Rejected PR Update**
1. Find or create MRF with a rejected PR
2. Navigate to Procurement ‚Üí MRF Processing
3. Select that MRF and click "Generate PR" button again
4. System should reuse rejected PR (check console for "‚ôªÔ∏è Reusing rejected PR" message)
5. Click View button on the PR
6. Verify "Prepared By" field shows YOUR NAME (not "Unknown User")

**Test Scenario 3: Approved PR Merge**
1. Find or create MRF with an approved PR
2. Navigate to Procurement ‚Üí MRF Processing
3. Add NEW items to that MRF (items not in approved PR)
4. Click "Generate PR" button
5. System should merge into approved PR (check console for "üîó Merging items into approved PR" message)
6. Click View button on the PR
7. Verify "Prepared By" field shows YOUR NAME (not "Unknown User")

**Success Criteria:**
- All three scenarios show current user's name in "Prepared By" field
- No "Unknown User" displayed for any PR generation path
- Console logs confirm correct path taken (new/reuse/merge)
  </how-to-verify>
  <resume-signal>Type "approved" if all three scenarios pass, or describe which scenario failed</resume-signal>
</task>

</tasks>

<verification>
## Code Verification
- [ ] Lines 3086-3092: pr_creator_user_id and pr_creator_name present in rejected PR updateDoc
- [ ] Lines 3109-3115: pr_creator_user_id and pr_creator_name present in approved PR updateDoc
- [ ] currentUser variable not redeclared (already exists at line 2933)
- [ ] Pattern matches Phase 17-01: currentUser.uid and currentUser.full_name

## Functional Verification
- [ ] Test Scenario 1: New PR shows user name (baseline)
- [ ] Test Scenario 2: Rejected PR update shows user name (Gap 1a fixed)
- [ ] Test Scenario 3: Approved PR merge shows user name (Gap 1b fixed)
- [ ] No regressions: existing PR functionality still works
</verification>

<success_criteria>
## Observable Outcomes
1. Rejected PR update captures current user's identity (not old/null values)
2. Approved PR merge captures current user's identity (shows who added items)
3. PR Details modal "Prepared By" field displays user name for all paths
4. UAT Test 1 passes: "prepared by displays [YOUR NAME]" not "Unknown User"

## File State
- app/views/procurement.js modified with 4 lines added (2 fields √ó 2 paths)
- No other files changed
- Git commit created with atomic changes
</success_criteria>

<output>
After completion, create `.planning/phases/17-procurement-workflow-overhaul/17-05-SUMMARY.md`
</output>
