---
phase: 17-procurement-workflow-overhaul
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [app/views/procurement.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking supplier name in Supplier Management tab opens purchase history modal"
    - "Modal is visible and displays supplier purchase history data"
    - "Modal appears regardless of which tab user is currently viewing"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "supplierHistoryModal HTML outside tab-specific sections"
      location: "after line 344 (after all sections close)"
      contains: "<div id=\"supplierHistoryModal\" class=\"modal\">"
  key_links:
    - from: "Supplier Management table"
      to: "window.showSupplierPurchaseHistory()"
      via: "onclick handler"
      pattern: "onclick=\"window.showSupplierPurchaseHistory"
    - from: "showSupplierPurchaseHistory()"
      to: "#supplierHistoryModal"
      via: "classList.add('active')"
      pattern: "getElementById.*supplierHistoryModal.*classList.*active"
    - from: "#supplierHistoryModal"
      to: "viewport"
      via: "not inside display:none parent"
      pattern: "Modal HTML at container level, not nested in section"
---

<objective>
Fix supplier purchase history modal visibility by moving modal HTML outside tab-specific sections.

Purpose: Fix UAT Gap 2 - Modal HTML currently nested inside #records-section which has display:none when Supplier Management tab is active, preventing modal from appearing despite function executing correctly.
Output: Supplier purchase history modal appears when clicked from Supplier Management tab.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 17 prior work
@.planning/phases/17-procurement-workflow-overhaul/17-02-SUMMARY.md
@.planning/phases/17-procurement-workflow-overhaul/17-04-SUMMARY.md

# Gap diagnosis
@.planning/debug/supplier-modal-not-appearing.md

# Current implementation
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Move supplierHistoryModal outside tab sections</name>
  <files>app/views/procurement.js</files>
  <action>
In render() function, locate the supplierHistoryModal HTML (currently at lines 333-343).

**Current structure (WRONG):**
```javascript
<section id="records-section" class="section">
    <!-- MRF Records table content -->

    <!-- Supplier Purchase History Modal -->
    <div id="supplierHistoryModal" class="modal">
        ...
    </div>
</section>
```

**Move modal to (CORRECT):**
```javascript
</section> <!-- close records-section -->
</section> <!-- close suppliers-section -->
</section> <!-- close pr-po-section -->
</section> <!-- close mrfs-section -->

<!-- Supplier Purchase History Modal -->
<div id="supplierHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="supplierHistoryModalTitle">Supplier Purchase History</h2>
            <button class="modal-close" onclick="window.closeSupplierHistoryModal()">&times;</button>
        </div>
        <div class="modal-body" id="supplierHistoryModalBody">
            <!-- Dynamically populated -->
        </div>
    </div>
</div>

</div> <!-- close container -->
```

**Exact steps:**
1. Cut lines 333-343 (entire modal HTML block including comment)
2. Find the closing `</div>` for the main container (after all sections close, around line 344-346)
3. Paste modal HTML BEFORE the container's closing `</div>`

Rationale: Modals should be at container level, not nested inside tab sections. Parent section's `display:none` prevents modal from appearing even when modal has `active` class. This follows standard modal placement pattern.

**Why this fixes the issue:** CSS specificity - parent's `display:none` overrides child's `display:flex` from `.modal.active`. By placing modal outside sections, it's no longer affected by tab visibility logic.
  </action>
  <verify>
Check modal is outside all sections:
```bash
# Find modal location (should be after all </section> tags)
grep -n "id=\"supplierHistoryModal\"" app/views/procurement.js

# Verify modal is NOT inside any section
# (Line number should be AFTER all section closing tags)
```

Count section depth at modal location:
```bash
# Extract lines around modal
sed -n '340,350p' app/views/procurement.js | grep -E '(<section|</section>|supplierHistoryModal)'
```
Should show supplierHistoryModal AFTER all `</section>` tags close.
  </verify>
  <done>
supplierHistoryModal HTML is outside all tab-specific sections. Modal is at container level, not nested in any section with conditional display:none.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Supplier purchase history modal relocated from inside #records-section to container level, making it visible from all tabs.
  </what-built>
  <how-to-verify>
**Test Scenario 1: Supplier Management Tab**
1. Navigate to Procurement → Supplier Management
2. Locate any supplier in the supplier list table
3. Click the supplier's name (clickable link)
4. Verify modal appears with title "Supplier Purchase History"
5. Verify modal content shows list of purchases (or "No purchases found" if supplier has no POs)
6. Close modal using × button or ESC key

**Test Scenario 2: Modal Content Accuracy**
1. Click supplier name known to have purchase history
2. Verify modal displays PO list with columns: PO ID, Date, Items, Total Amount
3. Verify total amount calculations are correct
4. Verify "Total Purchases" summary at bottom shows correct aggregate

**Test Scenario 3: Modal from Different Starting Points**
1. Navigate to Procurement → MRF Processing tab
2. Switch to Supplier Management tab
3. Click supplier name
4. Verify modal appears (test that tab switching doesn't break modal)

**Success Criteria:**
- Modal appears when supplier name clicked (no console activity without visible modal)
- Modal content displays correctly (purchase history or "no purchases" message)
- Modal can be closed via × button or ESC key
- No console errors when opening/closing modal
  </how-to-verify>
  <resume-signal>Type "approved" if modal appears and displays correctly, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
## Code Verification
- [ ] supplierHistoryModal HTML moved outside all `<section>` tags
- [ ] Modal HTML is inside main container but not nested in any section
- [ ] Modal HTML is complete (no missing closing tags)
- [ ] Modal structure unchanged (only location changed)

## Functional Verification
- [ ] Test Scenario 1: Modal appears from Supplier Management tab
- [ ] Test Scenario 2: Modal displays accurate purchase history data
- [ ] Test Scenario 3: Modal works after tab switching
- [ ] Modal close button works (window.closeSupplierHistoryModal)
- [ ] ESC key closes modal (if implemented)
- [ ] No console errors
</verification>

<success_criteria>
## Observable Outcomes
1. Clicking supplier name in Supplier Management opens visible modal
2. Modal displays supplier purchase history data correctly
3. Modal is not affected by parent section's display:none state
4. UAT Test 7 passes: "Modal appears" not "console cooking but no modal"

## File State
- app/views/procurement.js modified (modal HTML relocated ~10 lines)
- No structural changes to modal HTML (only position changed)
- Git commit created with clear "fix modal visibility" message
</success_criteria>

<output>
After completion, create `.planning/phases/17-procurement-workflow-overhaul/17-06-SUMMARY.md`
</output>
