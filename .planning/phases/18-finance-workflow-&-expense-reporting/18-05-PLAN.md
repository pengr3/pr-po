---
phase: 18-finance-workflow-&-expense-reporting
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/procurement.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PO Tracking table has a 'View PO' button in Actions column for each PO row"
    - "PO document shows only 'Approved by' section with finance signature -- no 'Prepared by' box"
    - "PR document shows only 'Prepared by' with creator name as plain text -- no signature images, no 'Approved by' section"
    - "Clicking 'View PO' on a PO row prompts for Payment Terms, Condition, and Delivery Date before generating the document"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Updated PO tracking table, PO document template, PR document template, dynamic field input"
      contains: "View PO"
  key_links:
    - from: "PO Tracking table row"
      to: "generatePODocument or prompt modal"
      via: "View PO button onclick"
      pattern: "View PO"
    - from: "generatePOHTML signature-section"
      to: "only Approved by box"
      via: "single signature-box"
      pattern: "Approved by"
    - from: "generatePRHTML"
      to: "no signature section"
      via: "simple text prepared by"
      pattern: "Prepared by"
---

<objective>
Fix PO/PR document layouts and add dynamic fields for PO document generation.

Purpose: UAT found four issues: (1) no direct "View PO Document" button in PO Tracking table, (2) PO document has unnecessary "Prepared by" section, (3) PR document has unnecessary "Approved by" section and signature infrastructure, (4) Payment Terms, Condition, and Delivery Date are hardcoded in PO documents. These fixes make documents match business requirements and allow per-document customization of terms.

Output: Updated `app/views/procurement.js` with corrected document templates, View PO button in table, and dynamic field input for PO document generation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/18-document-layout.md
@.planning/debug/18-pr-signature-removal.md
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add View PO button to PO Tracking table and add dynamic fields prompt</name>
  <files>app/views/procurement.js</files>
  <action>
  Make these changes to `app/views/procurement.js`:

  **1. Add "View PO" button to PO Tracking table (renderPOTrackingTable, around line 3717-3718):**

  In the `<td>` actions column (line 3717), add a "View PO" button BEFORE the existing Timeline button. The actions column should become:
  ```html
  <td>
      <button class="btn btn-sm btn-secondary" onclick="promptPODocument('${po.id}')" style="margin-right: 4px;">View PO</button>
      <button class="btn btn-sm btn-primary" onclick="viewPOTimeline('${po.id}')">Timeline</button>
  </td>
  ```

  **2. Create `promptPODocument()` function:**

  This function shows a prompt dialog before generating the PO document, allowing the user to fill in Payment Terms, Condition, and Delivery Date. Place it near the other PO document functions (around line 5027).

  ```javascript
  /**
   * Prompt for PO document fields then generate document
   * Shows a modal with input fields for payment terms, condition, and delivery date
   * @param {string} poDocId - Firestore document ID of the PO
   */
  async function promptPODocument(poDocId) {
      // Fetch current PO data to pre-fill fields
      try {
          const poRef = doc(db, 'pos', poDocId);
          const poDoc = await getDoc(poRef);
          if (!poDoc.exists()) {
              showToast('PO not found', 'error');
              return;
          }
          const po = poDoc.data();

          // Create prompt modal using the codebase's createModal pattern
          let modalContainer = document.getElementById('poDocFieldsModalContainer');
          if (!modalContainer) {
              modalContainer = document.createElement('div');
              modalContainer.id = 'poDocFieldsModalContainer';
              document.body.appendChild(modalContainer);
          }

          const modalBody = `
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Payment Terms</label>
                      <input type="text" id="poDocPaymentTerms" value="${po.payment_terms || ''}" placeholder="e.g., 50% down payment, 50% upon delivery"
                             style="width: 100%; padding: 0.75rem; border: 1.5px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.875rem;">
                  </div>
                  <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Condition</label>
                      <input type="text" id="poDocCondition" value="${po.condition || ''}" placeholder="e.g., Items must meet quality standards"
                             style="width: 100%; padding: 0.75rem; border: 1.5px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.875rem;">
                  </div>
                  <div>
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">Delivery Date</label>
                      <input type="date" id="poDocDeliveryDate" value="${po.delivery_date || ''}"
                             style="width: 100%; padding: 0.75rem; border: 1.5px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.875rem;">
                  </div>
              </div>
          `;

          modalContainer.innerHTML = createModal({
              id: 'poDocFieldsModal',
              title: `PO Document Details: ${po.po_id}`,
              body: modalBody,
              footer: `
                  <button class="btn btn-secondary" onclick="closeModal('poDocFieldsModal')">Cancel</button>
                  <button class="btn btn-primary" onclick="generatePOWithFields('${poDocId}')">Generate PO Document</button>
              `,
              size: 'medium'
          });

          openModal('poDocFieldsModal');

      } catch (error) {
          console.error('Error loading PO for document prompt:', error);
          showToast('Failed to load PO details', 'error');
      }
  }
  ```

  **3. Create `generatePOWithFields()` function:**

  This function reads the field values from the prompt modal, saves them to Firestore, then generates the document.

  ```javascript
  /**
   * Save PO document fields and generate the document
   * @param {string} poDocId - Firestore document ID of the PO
   */
  async function generatePOWithFields(poDocId) {
      const paymentTerms = document.getElementById('poDocPaymentTerms')?.value?.trim() || '';
      const condition = document.getElementById('poDocCondition')?.value?.trim() || '';
      const deliveryDate = document.getElementById('poDocDeliveryDate')?.value || '';

      try {
          // Save fields to Firestore so they persist for future views
          const updateData = {};
          if (paymentTerms) updateData.payment_terms = paymentTerms;
          if (condition) updateData.condition = condition;
          if (deliveryDate) updateData.delivery_date = deliveryDate;

          if (Object.keys(updateData).length > 0) {
              const poRef = doc(db, 'pos', poDocId);
              await updateDoc(poRef, updateData);
          }

          // Close the fields modal
          closeModal('poDocFieldsModal');

          // Generate the document (it will re-read from Firestore with updated fields)
          await generatePODocument(poDocId);

      } catch (error) {
          console.error('Error saving PO fields:', error);
          showToast('Failed to save PO details', 'error');
      }
  }
  ```

  **4. Register window functions for the new functions:**

  In `attachWindowFunctions()` (or wherever window functions are attached for procurement), add:
  - `window.promptPODocument = promptPODocument;`
  - `window.generatePOWithFields = generatePOWithFields;`

  Find where procurement.js attaches window functions and add these. Search for where `viewPOTimeline` or `generatePODocument` are attached to window.

  In the corresponding destroy/cleanup, add:
  - `delete window.promptPODocument;`
  - `delete window.generatePOWithFields;`

  **5. Also update the viewPODetails modal "View PO" button (line 4163):**

  Change the footer button in viewPODetails from calling `generatePODocument` directly to calling `promptPODocument` so the same dynamic fields prompt appears:
  ```html
  <button class="btn btn-primary" onclick="window.promptPODocument('${po.id}')">
  ```
  Keep the SVG icon and text as-is.
  </action>
  <verify>
  - Search procurement.js for "promptPODocument" -- should appear in PO table row, viewPODetails footer, function declaration, and window attachment
  - Search for "generatePOWithFields" -- should appear in the modal button, function declaration, and window attachment
  - Search for "poDocPaymentTerms" -- should appear in the prompt modal HTML
  - Verify PO table row now has two buttons: "View PO" and "Timeline"
  </verify>
  <done>
  - PO Tracking table has a "View PO" button in each row's Actions column
  - Clicking "View PO" (from table or from PO details modal) shows a prompt for Payment Terms, Condition, and Delivery Date
  - Values are saved to Firestore before document generation so they persist
  - Previously entered values are pre-filled when prompt appears again
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix PO document template (remove Prepared by) and PR document template (remove signatures)</name>
  <files>app/views/procurement.js</files>
  <action>
  Make these changes to `app/views/procurement.js`:

  **1. Fix PO document template -- remove "Prepared by" box (generatePOHTML, lines 4854-4872):**

  Replace the signature-section div. Remove the "Prepared by" signature-box (lines 4855-4860) and keep only the "Approved by" box. Change the layout from flex space-between to centered since there's only one box:

  ```html
  <div class="signature-section" style="justify-content: flex-end;">
      <div class="signature-box">
          <p class="sig-label">Approved by:</p>
          ${data.FINANCE_SIGNATURE_URL ? `
              <img src="${data.FINANCE_SIGNATURE_URL}" alt="Finance Signature">
          ` : `
              <div class="sig-placeholder"></div>
          `}
          <div class="sig-line"></div>
          <p>${data.FINANCE_APPROVER}</p>
      </div>
  </div>
  ```

  The CSS for `.signature-section` (lines 4776-4782) already uses flex display. Adding `justify-content: flex-end` via inline style positions the single box on the right side.

  **2. Remove PROCUREMENT_PIC from PO document data assembly (generatePODocument, line 5009):**

  Remove the line `PROCUREMENT_PIC: po.procurement_pic || 'Procurement Team',` from the documentData object since PO template no longer uses it.

  **3. Fix PR document template -- remove ALL signature infrastructure (generatePRHTML, lines 4430-4662):**

  a) **Remove signature CSS (lines 4543-4591):** Delete ALL CSS rules for: `.signatures`, `.signature-row`, `.signature-box`, `.signature-box p`, `.signature-box .sig-label`, `.signature-box img`, `.signature-box .sig-line`, `.signature-box .sig-placeholder`, `.signature-line`, `.signature-line .label`. This is approximately 50 lines of CSS.

  b) **Replace signature HTML section (lines 4632-4657):** Replace the entire `<div class="signatures">` block with a simple "Prepared by" text line. The header at line 4614 already shows "Prepared by: [name]", so the bottom section should just show "Requested By" and a simple prepared by line:

  ```html
  <div style="margin-top: 40px; page-break-inside: avoid;">
      <div style="margin: 8px 0;">
          <span style="font-weight: bold; display: inline-block; width: 150px;">Requested By:</span> ${data.REQUESTOR}
      </div>
      <div style="margin-top: 30px;">
          <div style="text-align: left; min-width: 200px; display: inline-block;">
              <p style="font-weight: bold; font-size: 10pt; margin-bottom: 0.5rem;">Prepared by:</p>
              <div style="border-top: 1px solid #000; width: 200px; margin: 0.5rem 0 0.25rem 0;"></div>
              <p style="margin: 0.25rem 0; font-size: 0.875rem;">${data.PREPARED_BY}</p>
          </div>
      </div>
  </div>
  ```

  This keeps "Requested By" (the MRF requestor) and "Prepared by" (the PR creator) as simple text with an underline -- no signature images, no "Approved by" section.

  **4. Remove unnecessary data fields from PR document assembly (generatePRDocument, lines 4951-4956):**

  Keep only PREPARED_BY. Remove these four lines:
  - `PROCUREMENT_PIC: pr.procurement_pic || 'Procurement Team',` (line 4952)
  - `FINANCE_PIC: pr.finance_approver_name || pr.finance_approver || DOCUMENT_CONFIG.defaultFinancePIC,` (line 4953)
  - `FINANCE_SIGNATURE_URL: pr.finance_signature_url || '',` (line 4954)
  - `DATE_APPROVED: pr.date_approved ? formatDocumentDate(pr.date_approved) : 'Pending',` (line 4955)
  - `IS_APPROVED: pr.finance_status === 'Approved' || pr.date_approved,` (line 4956)

  The documentData object for PR should have these fields remaining: PR_ID, MRF_ID, DATE, PROJECT, ADDRESS, SUPPLIER, ITEMS_TABLE, TOTAL_COST, REQUESTOR, PREPARED_BY, company_info.
  </action>
  <verify>
  - Search generatePOHTML for "Prepared by" -- should NOT appear (only "Approved by" remains)
  - Search generatePRHTML for "Approved by" -- should NOT appear
  - Search generatePRHTML for ".signature-row" or ".signature-box" CSS -- should NOT appear
  - Search generatePRDocument for "FINANCE_PIC" or "FINANCE_SIGNATURE_URL" or "IS_APPROVED" -- should NOT appear
  - Verify generatePRHTML still has "Prepared by" as simple text with creator name
  - Verify generatePOHTML still has the "Approved by" box with conditional signature image rendering
  </verify>
  <done>
  - PO document shows only "Approved by" section with finance signature on the right side
  - PR document shows only "Prepared by" with creator name as simple text (no signature images, no "Approved by")
  - All signature CSS removed from PR template
  - Unnecessary data fields (FINANCE_PIC, FINANCE_SIGNATURE_URL, DATE_APPROVED, IS_APPROVED, PROCUREMENT_PIC) removed from PR document data assembly
  - PROCUREMENT_PIC removed from PO document data assembly
  </done>
</task>

</tasks>

<verification>
1. Go to Procurement > PO Tracking. Each PO row should have a "View PO" button alongside the existing "Timeline" button.
2. Click "View PO" on any PO. A prompt modal should appear with Payment Terms, Condition, and Delivery Date fields.
3. Fill in the fields and click "Generate PO Document". Document opens in new tab.
4. In the PO document: only "Approved by" section visible on the right (no "Prepared by" box). Payment Terms, Condition, and Delivery Date show the values you entered.
5. Generate a PR document. Only "Prepared by: [creator name]" appears as text at the bottom. No signature images, no "Approved by" section, no signature boxes.
6. Click "View PO" on the same PO again -- the fields should be pre-filled with previously entered values.
7. No console errors during any of these flows.
</verification>

<success_criteria>
- "View PO" button exists in PO Tracking table for every PO row
- PO document generation prompts for Payment Terms, Condition, Delivery Date
- Entered values persist in Firestore and pre-fill on subsequent views
- PO document template shows only "Approved by" (no "Prepared by" box)
- PR document template shows only "Prepared by" as text (no signature infrastructure)
- No JavaScript errors in console
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-05-SUMMARY.md`
</output>
