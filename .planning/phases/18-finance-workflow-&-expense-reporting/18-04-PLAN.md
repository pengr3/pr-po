---
phase: 18-finance-workflow-&-expense-reporting
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/views/finance.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking 'Approve & Generate PO' on PR review modal closes review modal and opens a NEW separate approval modal with signature canvas"
    - "TR approval modal has NO signature canvas -- only simple Approve and Reject buttons"
    - "ESC key closes the approval modal"
    - "Signature pad initializes correctly in the new approval modal"
  artifacts:
    - path: "app/views/finance.js"
      provides: "Approval modal HTML, TR modal cleanup, window function cleanup"
      contains: "approvalModal"
  key_links:
    - from: "viewPRDetails() Approve button"
      to: "showApprovalModal()"
      via: "onclick handler"
      pattern: "showApprovalModal"
    - from: "showApprovalModal()"
      to: "approvalModal"
      via: "classList.add('active')"
      pattern: "approvalModal.*active"
    - from: "approvalModal Confirm button"
      to: "approvePRWithSignature()"
      via: "onclick handler"
      pattern: "approvePRWithSignature"
    - from: "viewTRDetails() Approve button"
      to: "approveTR()"
      via: "onclick handler"
      pattern: "window\\.approveTR\\("
---

<objective>
Fix PR approval signature modal placement and remove TR signature capture.

Purpose: UAT found two issues in the finance approval workflow: (1) signature canvas is embedded directly in the PR review modal instead of appearing in a separate approval modal, and (2) TR approval incorrectly has signature capture when it should be a simple approve/reject flow. These fixes restore the intended UX where review and approval are separate steps for PRs, and TRs have a simple approval flow.

Output: Updated `app/views/finance.js` with a new approvalModal, cleaned-up PR review modal, and simplified TR review modal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/18-signature-modal-placement.md
@.planning/debug/18-tr-signature-removal.md
@app/views/finance.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add approvalModal and restructure PR review modal footer</name>
  <files>app/views/finance.js</files>
  <action>
  Make these changes to `app/views/finance.js`:

  **1. Add approvalModal to render() function (after rejectionModal, before projectExpenseModal around line 309):**

  Add a new modal following the exact pattern of rejectionModal (lines 294-309). The new modal should have:
  - `id="approvalModal"` with `class="modal"`
  - Modal header: "Approve & Sign" with a close button calling `window.closeApprovalModal()`
  - Modal body containing:
    - Instructions text: "Please draw your signature below to confirm approval."
    - The signature canvas: `<canvas id="approvalSignatureCanvas" style="border: 1.5px solid #e2e8f0; border-radius: 8px; background: white; width: 100%; max-width: 400px; height: 150px; cursor: crosshair; display: block;"></canvas>`
    - "Clear Signature" button calling `window.clearApprovalSignature()`
  - Modal footer with:
    - "Cancel" button (btn btn-secondary) calling `window.closeApprovalModal()`
    - "Confirm Approval" button (btn btn-primary) calling `window.confirmApproval()`. This button's text should dynamically be set later but start as "Confirm Approval".

  **2. Remove signature canvas from viewPRDetails() footer (lines 1006-1034):**

  Replace the entire footer.innerHTML block. Remove the signature canvas div (lines 1008-1021). The footer should now only contain:
  - A flex row with gap and justify-content: flex-end
  - "Reject" button (btn btn-danger) calling `window.rejectPR('${pr.id}')` -- KEEP this unchanged
  - "Approve & Generate PO" button (btn btn-primary) calling `window.showApprovalModal('${pr.id}', 'pr')` instead of `window.approvePRWithSignature`
  - "Close" button (btn btn-secondary) calling `window.closePRModal()`
  - Wrap in the same `showEditControls` conditional

  **3. Remove signature pad initialization from viewPRDetails() (lines 1039-1043):**

  Delete the `if (showEditControls) { requestAnimationFrame(() => { ... }) }` block that initializes the signature pad in viewPRDetails. The signature pad will now be initialized when approvalModal opens.

  **4. Create new functions `showApprovalModal()`, `closeApprovalModal()`, and `confirmApproval()`:**

  `showApprovalModal(id, type)`:
  - Store the id and type in a module-level variable: `let currentApprovalTarget = null;` (add near top with other state variables around line 16). Set `currentApprovalTarget = { id, type };`
  - Close prModal: `closePRModal();` (this cleans up any existing signature pad)
  - Open approvalModal: `document.getElementById('approvalModal').classList.add('active');`
  - Initialize signature pad after a short delay: `requestAnimationFrame(() => { approvalSignaturePad = initializeApprovalSignaturePad(); });`

  `closeApprovalModal()`:
  - Clean up signature pad: `if (approvalSignaturePad) { approvalSignaturePad.off(); approvalSignaturePad = null; }`
  - Close modal: `document.getElementById('approvalModal').classList.remove('active');`
  - Clear target: `currentApprovalTarget = null;`

  `confirmApproval()`:
  - If `currentApprovalTarget` is null, show error toast and return
  - If `currentApprovalTarget.type === 'pr'`, call `approvePRWithSignature(currentApprovalTarget.id)`
  - The approvePRWithSignature function already handles signature validation, so no changes needed there
  - After approvePRWithSignature completes (it calls closePRModal which cleans up signature pad), also close approvalModal: modify approvePRWithSignature to call `closeApprovalModal()` after `closePRModal()` at line 1341. OR better: modify approvePRWithSignature to call closeApprovalModal() instead of closePRModal() since the prModal is already closed by showApprovalModal. Actually, simplest approach: in approvePRWithSignature success path (around line 1341), replace `closePRModal()` with `closeApprovalModal()` since by the time we get to approvePRWithSignature, the prModal is already closed and the approvalModal is what's open.

  **5. Update ESC key handler (around line 73-88):**

  Add `approvalModal` to the ESC key handler chain in setupModalListeners(). After checking projectExpenseModal (line 84), add:
  ```
  else if (approvalModal?.classList.contains('active')) {
      closeApprovalModal();
  }
  ```
  Also add `const approvalModal = document.getElementById('approvalModal');` near the other modal lookups.

  **6. Update attachWindowFunctions() (around lines 24-54):**

  Add these window function attachments:
  - `window.showApprovalModal = showApprovalModal;`
  - `window.closeApprovalModal = closeApprovalModal;`
  - `window.confirmApproval = confirmApproval;`

  Remove: `window.approveTRWithSignature = approveTRWithSignature;` (line 38)

  **7. Update destroy() (around lines 669-719):**

  Add cleanup for new window functions:
  - `delete window.showApprovalModal;`
  - `delete window.closeApprovalModal;`
  - `delete window.confirmApproval;`

  Remove: `delete window.approveTRWithSignature;` (line 716)

  Also add cleanup for `currentApprovalTarget`:
  - `currentApprovalTarget = null;`

  **8. Update closePRModal() (lines 1576-1585):**

  The signature pad cleanup in closePRModal is still fine -- it's called by showApprovalModal before the new modal opens, so it safely no-ops if pad doesn't exist. No changes needed here.
  </action>
  <verify>
  - Search finance.js for "approvalModal" -- should find the new modal in render(), the ESC handler, show/close functions
  - Search for "approveTRWithSignature" -- should NOT appear in attachWindowFunctions or destroy, but the function itself should still exist (removed in Task 2)
  - Search for "showApprovalModal" -- should appear in attachWindowFunctions, viewPRDetails footer, and as a function declaration
  - Verify the approvalSignatureCanvas is in the approvalModal HTML (render function), NOT in viewPRDetails footer
  </verify>
  <done>
  - PR review modal footer has Reject, Approve & Generate PO, and Close buttons only (no signature canvas)
  - Clicking "Approve & Generate PO" closes review modal and opens a new approvalModal with signature canvas
  - Signature pad initializes in the new approvalModal
  - Confirming approval in the new modal triggers approvePRWithSignature
  - ESC key closes the approvalModal
  - All new window functions properly attached and cleaned up
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove TR signature capture and clean up approveTRWithSignature</name>
  <files>app/views/finance.js</files>
  <action>
  Make these changes to `app/views/finance.js`:

  **1. Simplify viewTRDetails() footer (lines 1159-1197):**

  Replace the footer.innerHTML block (lines 1160-1188). Remove ALL signature canvas HTML (lines 1161-1176). The footer should now be:
  ```javascript
  footer.innerHTML = `
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          ${showEditControls ? `
              <button class="btn btn-danger" onclick="window.rejectPR('${tr.id}')">
                  Reject
              </button>
              <button class="btn btn-primary" onclick="window.approveTR('${tr.id}')">
                  Approve Transport Request
              </button>
          ` : ''}
          <button class="btn btn-secondary" onclick="window.closePRModal()">Close</button>
      </div>
  `;
  ```

  Key change: The approve button calls `window.approveTR('${tr.id}')` (original simple function) instead of `window.approveTRWithSignature('${tr.id}')`.

  **2. Remove signature pad initialization from viewTRDetails() (lines 1192-1197):**

  Delete the entire block:
  ```javascript
  if (showEditControls) {
      requestAnimationFrame(() => {
          approvalSignaturePad = initializeApprovalSignaturePad();
      });
  }
  ```

  **3. Delete approveTRWithSignature() function (lines 1498-1571):**

  Remove the entire `approveTRWithSignature` function. The original `approveTR()` function (lines 1442-1496) is the correct handler and already exists.

  **4. Verify window.approveTRWithSignature was already removed from attachWindowFunctions and destroy in Task 1.** If not done yet, ensure:
  - Line 38: Remove `window.approveTRWithSignature = approveTRWithSignature;`
  - Line 716: Remove `delete window.approveTRWithSignature;`
  </action>
  <verify>
  - Search finance.js for "approveTRWithSignature" -- should return ZERO results (function deleted, window attachment removed, destroy cleanup removed)
  - Search for "approvalSignatureCanvas" in viewTRDetails -- should NOT appear
  - Search for "window.approveTR(" in viewTRDetails -- should appear in the approve button onclick
  - Verify approveTR function still exists (lines ~1442-1496)
  </verify>
  <done>
  - TR review modal has only Reject, Approve Transport Request, and Close buttons (no signature canvas)
  - Approve button calls the original simple `approveTR()` function
  - `approveTRWithSignature()` function is completely removed
  - No signature pad initialization in TR modal flow
  - All window function references to approveTRWithSignature cleaned up
  </done>
</task>

</tasks>

<verification>
1. Open Finance > Pending Approvals > click "Review" on a PR. Modal should show Reject, Approve & Generate PO, and Close buttons. NO signature canvas visible.
2. Click "Approve & Generate PO". The review modal closes and a NEW approval modal opens with a signature canvas, Clear Signature button, Cancel button, and Confirm Approval button.
3. Press ESC -- approval modal closes.
4. Open Finance > Pending Approvals > click "Review" on a TR. Modal should show Reject, Approve Transport Request, and Close buttons. NO signature canvas visible.
5. Clicking "Approve Transport Request" on TR should use the simple confirm dialog from approveTR() -- no signature required.
6. No console errors during any of these flows.
</verification>

<success_criteria>
- PR approval uses a two-step flow: review modal -> approval modal with signature
- TR approval is a simple one-step flow with no signature capture
- approveTRWithSignature function completely removed from codebase
- All modal ESC handlers work correctly
- No JavaScript errors in console during approval flows
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-04-SUMMARY.md`
</output>
