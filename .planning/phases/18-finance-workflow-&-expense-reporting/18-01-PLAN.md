---
phase: 18-finance-workflow-&-expense-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/views/finance.js, index.html]
autonomous: true

must_haves:
  truths:
    - "Finance user sees signature canvas when opening PR/TR approval modal"
    - "Finance user can draw signature with mouse or touch"
    - "Finance user can clear signature and redraw"
    - "Approve button validates signature exists before creating PO"
    - "PO document stores signature as base64 data URL"
    - "PO document stores finance approver name and user ID"
  artifacts:
    - path: "index.html"
      provides: "signature_pad library loaded via CDN"
      contains: "signature_pad@5.0.3"
    - path: "app/views/finance.js"
      provides: "Signature canvas initialization with high-DPI support"
      min_lines: 30
      exports: ["initializeApprovalSignaturePad", "clearApprovalSignature", "approvePRWithSignature", "approveTRWithSignature"]
  key_links:
    - from: "app/views/finance.js"
      to: "SignaturePad global"
      via: "window.SignaturePad constructor"
      pattern: "new SignaturePad\\("
    - from: "approvePRWithSignature"
      to: "signaturePad.isEmpty()"
      via: "validation check"
      pattern: "isEmpty\\(\\)"
    - from: "PO document creation"
      to: "signaturePad.toDataURL()"
      via: "signature export"
      pattern: "toDataURL\\("
---

<objective>
Add signature capture to Finance approval workflow with user attribution

Purpose: Enable Finance team to electronically sign PO approvals for audit compliance. Capture signature in approval modal, validate before PO creation, and store signature data URL with finance approver identity (user ID + name) following Phase 17 denormalization pattern.

Output: PR/TR approval modals with signature canvas, validation, and user attribution stored in PO documents
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-finance-workflow-&-expense-reporting/18-RESEARCH.md
@.planning/phases/17-procurement-workflow-overhaul/17-01-SUMMARY.md
@app/views/finance.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Add signature_pad library to index.html</name>
  <files>index.html</files>
  <action>
Add signature_pad v5.0.3 CDN script to index.html head section (after Firebase SDK imports):

```html
<!-- Signature capture library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.3/dist/signature_pad.umd.min.js"></script>
```

Place after Firebase scripts but before app module imports. This makes SignaturePad available globally for finance.js.
  </action>
  <verify>
1. Read index.html and confirm signature_pad script tag exists
2. Verify placement is after Firebase, before app modules
3. Start dev server: `python -m http.server 8000`
4. Open browser console, type `typeof SignaturePad` → should return "function"
  </verify>
  <done>
SignaturePad constructor is globally available in browser console
  </done>
</task>

<task type="auto">
  <name>Add signature canvas to PR/TR approval modals with validation</name>
  <files>app/views/finance.js</files>
  <action>
**1. Add global signature pad variable (after line 16):**
```javascript
let approvalSignaturePad = null;
```

**2. Update attachWindowFunctions() to include new signature functions (in existing function around line 23):**
```javascript
window.clearApprovalSignature = clearApprovalSignature;
window.approvePRWithSignature = approvePRWithSignature;
window.approveTRWithSignature = approveTRWithSignature;
```

**3. Create signature pad initialization function (after attachWindowFunctions, around line 50):**
```javascript
/**
 * Initialize signature pad with high-DPI support
 * Source: https://github.com/szimek/signature_pad README
 */
function initializeApprovalSignaturePad() {
    const canvas = document.getElementById('approvalSignatureCanvas');
    if (!canvas) return null;

    const signaturePad = new SignaturePad(canvas, {
        minWidth: 0.5,
        maxWidth: 2.5,
        penColor: 'rgb(0, 0, 0)',
        backgroundColor: 'rgb(255, 255, 255)',
        throttle: 16 // 60fps
    });

    // Handle high-DPI displays (retina scaling)
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const { width, height } = canvas.getBoundingClientRect();

        // Save signature data before resize to prevent clearing
        const data = signaturePad.toData();

        canvas.width = width * ratio;
        canvas.height = height * ratio;
        canvas.getContext("2d").scale(ratio, ratio);

        // Restore signature after resize
        if (data && data.length > 0) {
            signaturePad.fromData(data);
        }
    }

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    return signaturePad;
}

/**
 * Clear signature canvas
 */
function clearApprovalSignature() {
    if (approvalSignaturePad) {
        approvalSignaturePad.clear();
    }
}
```

**4. Modify viewPRDetails() function (around line 370) to add signature canvas:**

Find the section that builds modal footer HTML. Replace existing approve/reject buttons with:

```javascript
// Add signature canvas and buttons to modal footer
const modalFooter = document.getElementById('prModalFooter');
modalFooter.innerHTML = `
    <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b;">
            Finance Signature <span style="color: #ef4444;">*</span>
        </label>
        <canvas id="approvalSignatureCanvas"
                style="border: 1.5px solid #e2e8f0; border-radius: 8px; background: white;
                       width: 100%; max-width: 400px; height: 150px; cursor: crosshair; display: block;">
        </canvas>
        <button class="btn btn-secondary"
                onclick="window.clearApprovalSignature()"
                style="margin-top: 0.5rem; font-size: 0.875rem; padding: 0.5rem 1rem;">
            Clear Signature
        </button>
    </div>
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        ${showEditControls ? `
            <button class="btn btn-secondary" onclick="window.openRejectionModal('${prId}', 'PR')">
                Reject
            </button>
            <button class="btn btn-primary" onclick="window.approvePRWithSignature('${prId}')">
                Approve & Generate PO
            </button>
        ` : ''}
        <button class="btn btn-secondary" onclick="window.closePRModal()">Close</button>
    </div>
`;

// Initialize signature pad after DOM update
requestAnimationFrame(() => {
    approvalSignaturePad = initializeApprovalSignaturePad();
});
```

**5. Do the same for viewTRDetails() function (around line 470) - identical signature canvas HTML and initialization.**

**6. Create approvePRWithSignature() function (replace existing approvePR):**
```javascript
/**
 * Approve PR with signature validation and user attribution
 * Creates PO with embedded signature and finance approver identity
 */
async function approvePRWithSignature(prId) {
    if (window.canEditTab?.('finance') === false) {
        showToast('You do not have permission to approve PRs', 'error');
        return;
    }

    const currentUser = window.getCurrentUser();
    if (!currentUser) {
        showToast('Session expired. Please log in again.', 'error');
        return;
    }

    // Validate signature exists
    if (!approvalSignaturePad || approvalSignaturePad.isEmpty()) {
        showToast('Please provide your signature before approving', 'error');
        return;
    }

    // Export signature as base64 PNG
    const signatureDataURL = approvalSignaturePad.toDataURL('image/png');

    showLoading(true);

    try {
        // Get PR document
        const prRef = doc(db, 'prs', prId);
        const prDoc = await getDoc(prRef);

        if (!prDoc.exists()) {
            throw new Error('PR not found');
        }

        const pr = prDoc.data();

        // Update PR status with finance approver attribution
        await updateDoc(prRef, {
            finance_status: 'Approved',
            finance_approver_user_id: currentUser.uid,
            finance_approver_name: currentUser.full_name || currentUser.email || 'Finance User',
            finance_approved_at: serverTimestamp(),
            date_approved: new Date().toISOString().split('T')[0] // Legacy compatibility
        });

        // Generate PO ID
        const posRef = collection(db, 'pos');
        const posSnapshot = await getDocs(posRef);
        let maxNum = 0;
        posSnapshot.forEach(docSnap => {
            const parts = docSnap.data().po_id.split('-');
            if (parts[1] === new Date().getFullYear().toString()) {
                maxNum = Math.max(maxNum, parseInt(parts[2]));
            }
        });
        const poId = `PO-${new Date().getFullYear()}-${String(maxNum + 1).padStart(3, '0')}`;

        // Create PO with signature and finance approver
        await addDoc(posRef, {
            po_id: poId,
            pr_id: pr.pr_id,
            mrf_id: pr.mrf_id,
            project_name: pr.project_name,
            project_code: pr.project_code,
            supplier_name: pr.supplier_name,
            items_json: pr.items_json,
            total_amount: pr.total_amount,
            delivery_address: pr.delivery_address,
            procurement_status: 'Pending Procurement',
            is_subcon: false,
            finance_approver_user_id: currentUser.uid,
            finance_approver_name: currentUser.full_name || currentUser.email || 'Finance User',
            finance_signature_url: signatureDataURL, // Base64 signature image
            date_issued: serverTimestamp(),
            date_issued_legacy: new Date().toISOString().split('T')[0]
        });

        showToast(`PO ${poId} created successfully!`, 'success');

        // Refresh PR list and close modal - STAY on approvals tab
        await refreshPRs();
        closePRModal();

    } catch (error) {
        console.error('[Finance] Error approving PR:', error);
        showToast('Failed to approve PR: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}
```

**7. Create approveTRWithSignature() function (similar to approvePR, for transport requests):**

Copy the same pattern as approvePRWithSignature but:
- Use transport_requests collection
- Generate TR ID instead of PO ID
- Update TR status instead of creating PO
- Store signature in TR document

**8. Update closePRModal() to clean up signature pad (around line 410):**
```javascript
function closePRModal() {
    // Clean up signature pad
    if (approvalSignaturePad) {
        approvalSignaturePad.off(); // Remove event listeners
        approvalSignaturePad = null;
    }

    const modal = document.getElementById('prModal');
    modal?.classList.remove('active');
}
```

**9. Do the same cleanup for closeTRModal().**

**Import serverTimestamp at top if not already imported:**
```javascript
import { db, collection, query, where, onSnapshot, getDocs, getDoc, doc, updateDoc, addDoc, getAggregateFromServer, sum, count, serverTimestamp } from '../firebase.js';
```

**Why these changes:**
- Signature validation prevents approval without signature (audit requirement)
- High-DPI scaling ensures signatures look sharp on retina displays
- devicePixelRatio handling prevents canvas clearing on resize
- User attribution follows Phase 17 pattern: uid + name denormalization
- serverTimestamp() provides clock-skew protection (Phase 17 decision)
- Stay on approvals tab after PO creation (better UX for batch processing)
- signaturePad.off() prevents memory leaks from event listeners
  </action>
  <verify>
1. Start dev server: `python -m http.server 8000`
2. Navigate to Finance > Pending Approvals
3. Click Review on a Material Purchase Request
4. Confirm signature canvas appears with white background and black border
5. Draw signature with mouse → should see smooth black lines
6. Click "Clear Signature" → canvas clears
7. Click "Approve & Generate PO" without signing → should see error toast "Please provide your signature"
8. Draw signature and click Approve → should create PO and close modal
9. Open browser DevTools > Application > IndexedDB > firestore > pos collection
10. Find newly created PO → verify fields exist: finance_signature_url (base64 string starting with "data:image/png;base64,"), finance_approver_user_id, finance_approver_name, date_issued (timestamp)
11. Repeat for Transport Request approval
  </verify>
  <done>
PR/TR approval modals display signature canvas with validation, PO documents contain signature data URL and finance approver attribution
  </done>
</task>

</tasks>

<verification>
1. SignaturePad library loads without console errors
2. Signature canvas renders in PR/TR approval modals
3. Drawing on canvas produces smooth black lines
4. Clear button empties canvas
5. Approval without signature shows validation error
6. Approval with signature creates PO/TR with:
   - finance_signature_url (base64 PNG)
   - finance_approver_user_id
   - finance_approver_name
   - date_issued (serverTimestamp)
7. Modal closes after approval, user stays on Pending Approvals tab
8. Opening approval modal multiple times doesn't leak event listeners (check DevTools Performance)
</verification>

<success_criteria>
1. Finance user sees signature canvas when opening PR/TR approval modal
2. Finance user can draw signature with mouse or touch input
3. Clicking "Clear Signature" empties canvas for redrawing
4. Clicking "Approve" without signature shows error toast
5. PO document in Firestore contains finance_signature_url field with base64 image
6. PO document contains finance_approver_user_id and finance_approver_name fields
7. After PO generation, user stays on Pending Approvals tab (no auto-redirect)
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-01-SUMMARY.md`
</output>
