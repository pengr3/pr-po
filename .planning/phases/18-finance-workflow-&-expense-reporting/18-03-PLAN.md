---
phase: 18-finance-workflow-&-expense-reporting
plan: 03
type: execute
wave: 3
depends_on: []
files_modified: [app/views/finance.js]
autonomous: true

must_haves:
  truths:
    - "Finance user sees Project List table with all projects"
    - "Project List shows: Project Name (Code + Name), Budget, Total Expense, Remaining Budget, Status"
    - "Clicking project row opens expense breakdown modal"
    - "Expense modal shows scorecards: Material Purchases, Transport Fees, Subcon Cost, Total Project Cost"
    - "Expense modal has view switcher: Category / Materials / Transport"
    - "All project expenses accurately calculated from POs and TRs"
    - "Historical Data tab removed from Finance navigation"
  artifacts:
    - path: "app/views/finance.js"
      provides: "refreshProjectExpenses() function with aggregation"
      contains: "getAggregateFromServer"
      min_lines: 40
    - path: "app/views/finance.js"
      provides: "showProjectExpenseModal() with category breakdown"
      contains: "materialTotal"
      min_lines: 50
    - path: "app/views/finance.js"
      provides: "Updated render() without Historical Data tab"
      contains: "finance/projects"
  key_links:
    - from: "refreshProjectExpenses"
      to: "getAggregateFromServer(posQuery)"
      via: "aggregation query"
      pattern: "getAggregateFromServer\\("
    - from: "refreshProjectExpenses"
      to: "sum('total_amount')"
      via: "expense calculation"
      pattern: "sum\\("
    - from: "showProjectExpenseModal"
      to: "multiple collection queries"
      via: "category breakdown"
      pattern: "collection\\(db, 'transport_requests'\\)"
---

<objective>
Create comprehensive project expense reporting and remove unused Historical Data tab

Purpose: Give Finance team detailed visibility into project expenses with category breakdowns (materials, transport, subcon). Use Firestore aggregation for efficient server-side calculation. Remove placeholder Historical Data tab since Project List provides the analytics functionality.

Output: Project List table with expense totals, detailed breakdown modal with scorecards and view switcher, Historical Data tab removed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-finance-workflow-&-expense-reporting/18-RESEARCH.md
@.planning/phases/13-finance-dashboard-&-audit-trails/13-01-SUMMARY.md
@app/views/finance.js
@app/views/projects.js
</context>

<tasks>

<task type="auto">
  <name>Remove Historical Data tab from Finance navigation</name>
  <files>app/views/finance.js</files>
  <action>
**1. Find render() function (around line 90):**

Remove the Historical Data tab link from the tabs-nav section:

```javascript
export function render(activeTab = 'approvals') {
    const canEdit = window.canEditTab?.('finance');
    const showEditControls = canEdit !== false;

    return `
        <!-- Tab Navigation -->
        <div style="background: white; border-bottom: 2px solid var(--gray-200);">
            <div style="max-width: 1600px; margin: 0 auto; padding: 0 2rem;">
                <div class="tabs-nav">
                    <a href="#/finance/approvals" class="tab-btn ${activeTab === 'approvals' ? 'active' : ''}">
                        üìã Pending Approvals
                    </a>
                    <a href="#/finance/pos" class="tab-btn ${activeTab === 'pos' ? 'active' : ''}">
                        üìÑ Purchase Orders
                    </a>
                    <!-- REMOVED: Historical Data tab -->
                    <a href="#/finance/projects" class="tab-btn ${activeTab === 'projects' ? 'active' : ''}">
                        üí∞ Project List
                    </a>
                </div>
            </div>
        </div>
```

**2. Remove the entire history-section block (around line 212):**

Delete the section:
```javascript
<!-- Tab 3: Historical Data -->
<section id="history-section" class="section ${activeTab === 'history' ? 'active' : ''}">
    <!-- ... entire Historical Data section ... -->
</section>
```

**Why these changes:**
- Historical Data tab was a placeholder ("Coming soon")
- Project List tab provides the actual analytics functionality
- Removing unused UI reduces navigation clutter (Phase 19 goal preview)
  </action>
  <verify>
1. Read app/views/finance.js
2. Confirm no references to "Historical Data" or "history" tab
3. Confirm only 3 tabs remain: Pending Approvals, Purchase Orders, Project List
4. Start dev server and navigate to Finance
5. Verify only 3 tabs visible in navigation
  </verify>
  <done>
Finance view has 3 tabs: Pending Approvals, Purchase Orders, Project List
  </done>
</task>

<task type="auto">
  <name>Implement Project List table with expense aggregation</name>
  <files>app/views/finance.js</files>
  <action>
**Step 0: Verify formatCurrency is imported**
Check that line 7 of finance.js includes formatCurrency in the import statement:
```javascript
import { showToast, showLoading, formatCurrency, formatDate } from '../utils.js';
```
If formatCurrency is NOT in the import, add it to the existing import statement.

**1. Update the Project List section HTML in render() function (around line 228):**

Replace the existing projects-section with:

```javascript
<!-- Tab 3: Project List (was Tab 4) -->
<section id="projects-section" class="section ${activeTab === 'projects' ? 'active' : ''}">
    ${!showEditControls ? '<div class="view-only-notice"><span class="notice-icon">üëÅÔ∏è</span> <span>View-only mode: You can view project expenses.</span></div>' : ''}
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2>üí∞ Project List & Expenses</h2>
            <button class="btn btn-secondary" onclick="window.refreshProjectExpenses()" style="font-size: 0.875rem;">
                üîÑ Refresh Totals
            </button>
        </div>
        <div id="projectExpensesContainer">
            <div style="text-align: center; padding: 2rem;">Loading project expenses...</div>
        </div>
    </div>
</section>

<!-- Project Expense Modal -->
<div id="projectExpenseModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="projectExpenseModalTitle">Project Expense Breakdown</h2>
            <button class="modal-close" onclick="window.closeProjectExpenseModal()">&times;</button>
        </div>
        <div class="modal-body" id="projectExpenseModalBody">
            <div style="text-align: center; padding: 2rem;">Loading expense details...</div>
        </div>
    </div>
</div>
```

**2. Create refreshProjectExpenses() function (after refreshPOs, around line 700):**

**NOTE:** The projectExpenses variable already exists at line 16 of finance.js. We will populate this existing array with aggregated data.

```javascript
/**
 * Calculate project expenses using server-side aggregation
 * Source: Phase 13 pattern (getAggregateFromServer)
 * Note: Uses existing projectExpenses array declared at line 16
 */
async function refreshProjectExpenses() {
    console.log('[Finance] Refreshing project expenses...');
    showLoading(true);

    try {
        // Get all projects
        const projectsSnapshot = await getDocs(collection(db, 'projects'));
        projectExpenses = []; // Reset existing array

        for (const projectDoc of projectsSnapshot.docs) {
            const project = projectDoc.data();

            // Aggregate PO totals for this project (all POs)
            const posQuery = query(
                collection(db, 'pos'),
                where('project_name', '==', project.project_name)
            );
            const posAgg = await getAggregateFromServer(posQuery, {
                totalExpense: sum('total_amount'),
                poCount: count()
            });

            // Aggregate Transport Request totals (approved only)
            const trQuery = query(
                collection(db, 'transport_requests'),
                where('project_name', '==', project.project_name),
                where('finance_status', '==', 'Approved')
            );
            const trAgg = await getAggregateFromServer(trQuery, {
                transportTotal: sum('total_amount'),
                trCount: count()
            });

            const totalExpense = (posAgg.data().totalExpense || 0) + (trAgg.data().transportTotal || 0);
            const budget = project.budget || 0;
            const remainingBudget = budget - totalExpense;

            projectExpenses.push({
                projectCode: project.project_code || 'N/A',
                projectName: project.project_name,
                clientCode: project.client_code || 'N/A',
                totalExpense: totalExpense,
                budget: budget,
                remainingBudget: remainingBudget,
                poCount: posAgg.data().poCount || 0,
                trCount: trAgg.data().trCount || 0,
                status: project.status || 'active'
            });
        }

        renderProjectExpensesTable();
        console.log(`[Finance] ‚úÖ Loaded ${projectExpenses.length} project expense records`);

    } catch (error) {
        console.error('[Finance] Error calculating project expenses:', error);
        showToast('Failed to calculate project expenses: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

/**
 * Render project expenses table
 * Uses formatCurrency() imported from utils.js
 */
function renderProjectExpensesTable() {
    const container = document.getElementById('projectExpensesContainer');
    if (!container) return;

    if (projectExpenses.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>No projects found</p>
            </div>
        `;
        return;
    }

    // Build table
    let tableHTML = `
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Project Name</th>
                        <th>Client</th>
                        <th style="text-align: right;">Budget</th>
                        <th style="text-align: right;">Total Expense</th>
                        <th style="text-align: right;">Remaining</th>
                        <th style="text-align: center;">Status</th>
                    </tr>
                </thead>
                <tbody>
    `;

    projectExpenses.forEach(proj => {
        const isOverBudget = proj.remainingBudget < 0;
        const remainingStyle = isOverBudget ? 'color: #ef4444; font-weight: 600;' : '';

        tableHTML += `
            <tr onclick="window.showProjectExpenseModal('${proj.projectName}')" style="cursor: pointer;">
                <td>
                    <div style="font-weight: 600;">${proj.projectName}</div>
                    <div style="font-size: 0.75rem; color: #64748b;">${proj.projectCode}</div>
                </td>
                <td>${proj.clientCode}</td>
                <td style="text-align: right;">‚Ç±${formatCurrency(proj.budget)}</td>
                <td style="text-align: right;">‚Ç±${formatCurrency(proj.totalExpense)}</td>
                <td style="text-align: right; ${remainingStyle}">
                    ${isOverBudget ? '‚ö†Ô∏è ' : ''}‚Ç±${formatCurrency(Math.abs(proj.remainingBudget))}
                    ${isOverBudget ? ' over' : ''}
                </td>
                <td style="text-align: center;">
                    <span class="badge badge-${proj.status === 'active' ? 'success' : 'secondary'}">
                        ${proj.status === 'active' ? 'Active' : 'Inactive'}
                    </span>
                </td>
            </tr>
        `;
    });

    tableHTML += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = tableHTML;
}
```

**3. Create showProjectExpenseModal() function (after renderProjectExpensesTable):**

```javascript
/**
 * Show detailed expense breakdown modal with category scorecards
 * Uses formatCurrency() imported from utils.js
 */
async function showProjectExpenseModal(projectName) {
    console.log(`[Finance] Loading expense breakdown for: ${projectName}`);
    showLoading(true);

    try {
        // Get project details
        const projectQuery = query(
            collection(db, 'projects'),
            where('project_name', '==', projectName)
        );
        const projectSnapshot = await getDocs(projectQuery);
        if (projectSnapshot.empty) {
            throw new Error('Project not found');
        }
        const project = projectSnapshot.docs[0].data();

        // Material POs (non-subcon)
        const materialQuery = query(
            collection(db, 'pos'),
            where('project_name', '==', projectName),
            where('is_subcon', '==', false)
        );
        const materialAgg = await getAggregateFromServer(materialQuery, {
            materialTotal: sum('total_amount'),
            materialCount: count()
        });

        // Subcon POs
        const subconQuery = query(
            collection(db, 'pos'),
            where('project_name', '==', projectName),
            where('is_subcon', '==', true)
        );
        const subconAgg = await getAggregateFromServer(subconQuery, {
            subconTotal: sum('total_amount'),
            subconCount: count()
        });

        // Transport Requests (approved only)
        const transportQuery = query(
            collection(db, 'transport_requests'),
            where('project_name', '==', projectName),
            where('finance_status', '==', 'Approved')
        );
        const transportAgg = await getAggregateFromServer(transportQuery, {
            transportTotal: sum('total_amount'),
            transportCount: count()
        });

        const expenses = {
            materials: materialAgg.data().materialTotal || 0,
            materialCount: materialAgg.data().materialCount || 0,
            transport: transportAgg.data().transportTotal || 0,
            transportCount: transportAgg.data().transportCount || 0,
            subcon: subconAgg.data().subconTotal || 0,
            subconCount: subconAgg.data().subconCount || 0,
            totalCost: (materialAgg.data().materialTotal || 0) +
                      (transportAgg.data().transportTotal || 0) +
                      (subconAgg.data().subconTotal || 0),
            budget: project.budget || 0,
            remainingBudget: (project.budget || 0) -
                           ((materialAgg.data().materialTotal || 0) +
                            (transportAgg.data().transportTotal || 0) +
                            (subconAgg.data().subconTotal || 0))
        };

        // Update modal title
        document.getElementById('projectExpenseModalTitle').textContent =
            `Expense Breakdown: ${projectName}`;

        // Render scorecards
        const modalBody = document.getElementById('projectExpenseModalBody');
        modalBody.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="scorecard" style="background: #f0fdf4; border-left: 4px solid #22c55e;">
                    <div style="font-size: 0.875rem; color: #166534; font-weight: 600; margin-bottom: 0.5rem;">
                        Project Budget
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #166534;">
                        ‚Ç±${formatCurrency(expenses.budget)}
                    </div>
                </div>
                <div class="scorecard" style="background: ${expenses.remainingBudget >= 0 ? '#f0fdf4' : '#fef2f2'}; border-left: 4px solid ${expenses.remainingBudget >= 0 ? '#22c55e' : '#ef4444'};">
                    <div style="font-size: 0.875rem; color: ${expenses.remainingBudget >= 0 ? '#166534' : '#991b1b'}; font-weight: 600; margin-bottom: 0.5rem;">
                        Remaining Budget
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: ${expenses.remainingBudget >= 0 ? '#166534' : '#991b1b'};">
                        ${expenses.remainingBudget >= 0 ? '' : '‚ö†Ô∏è '}‚Ç±${formatCurrency(Math.abs(expenses.remainingBudget))}
                        ${expenses.remainingBudget < 0 ? ' over' : ''}
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="scorecard">
                    <div style="font-size: 0.875rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">
                        Material Purchases
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">
                        ‚Ç±${formatCurrency(expenses.materials)}
                    </div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                        ${expenses.materialCount} POs
                    </div>
                </div>
                <div class="scorecard">
                    <div style="font-size: 0.875rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">
                        Transport Fees
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">
                        ‚Ç±${formatCurrency(expenses.transport)}
                    </div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                        ${expenses.transportCount} TRs
                    </div>
                </div>
                <div class="scorecard">
                    <div style="font-size: 0.875rem; color: #64748b; font-weight: 600; margin-bottom: 0.5rem;">
                        Subcon Cost
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">
                        ‚Ç±${formatCurrency(expenses.subcon)}
                    </div>
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                        ${expenses.subconCount} POs
                    </div>
                </div>
            </div>

            <div class="scorecard" style="background: #eff6ff; border: 2px solid #3b82f6;">
                <div style="font-size: 0.875rem; color: #1e40af; font-weight: 600; margin-bottom: 0.5rem;">
                    Total Project Cost
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: #1e40af;">
                    ‚Ç±${formatCurrency(expenses.totalCost)}
                </div>
                <div style="font-size: 0.75rem; color: #1e40af; margin-top: 0.25rem;">
                    ${expenses.materialCount + expenses.transportCount + expenses.subconCount} documents
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0; text-align: center;">
                <p style="color: #64748b; font-size: 0.875rem; margin: 0;">
                    üí° Click "Refresh Totals" button to update expense calculations
                </p>
            </div>
        `;

        // Show modal
        document.getElementById('projectExpenseModal').classList.add('active');

    } catch (error) {
        console.error('[Finance] Error loading project expense breakdown:', error);
        showToast('Failed to load expense breakdown: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

/**
 * Close project expense modal
 */
function closeProjectExpenseModal() {
    const modal = document.getElementById('projectExpenseModal');
    modal?.classList.remove('active');
}
```

**4. Update init() function (around line 1050) to call refreshProjectExpenses when on projects tab:**

```javascript
export async function init(activeTab = 'approvals') {
    console.log('[Finance] Initializing view, active tab:', activeTab);

    attachWindowFunctions();
    setupModalListeners();

    if (activeTab === 'approvals') {
        await refreshPRs();
    } else if (activeTab === 'pos') {
        await refreshPOs();
    } else if (activeTab === 'projects') {
        await refreshProjectExpenses();
    }

    // ... rest of init
}
```

**Why these changes:**
- Step 0 ensures formatCurrency is imported before using it throughout the code
- Comment acknowledges projectExpenses variable already exists at line 16
- getAggregateFromServer() calculates totals server-side (1 read per 1000 entries vs 1 per document)
- Manual refresh button follows Phase 13 pattern (Firebase doesn't support real-time aggregation)
- Separate queries for materials, transport, subcon enable category breakdown
- Clickable rows open detailed modal with scorecards
- Over-budget projects highlighted in red with ‚ö†Ô∏è warning icon
- Client code displayed (not name) since projects collection stores client_code not client_name
- Transport requests filtered by finance_status='Approved' to exclude rejected TRs
  </action>
  <verify>
1. Read finance.js imports (line 7) ‚Üí confirm formatCurrency is included
2. Read finance.js line 16 ‚Üí confirm projectExpenses variable already exists
3. Start dev server: `python -m http.server 8000`
4. Navigate to Finance view
5. Verify only 3 tabs visible: Pending Approvals, Purchase Orders, Project List
6. Click "Project List" tab
7. Verify table loads with columns: Project Name, Client, Budget, Total Expense, Remaining, Status
8. Verify "Refresh Totals" button exists in header
9. Click a project row
10. Verify expense modal opens with:
   - Modal title: "Expense Breakdown: [Project Name]"
   - 2 scorecards in top row: Project Budget, Remaining Budget
   - 3 scorecards in middle row: Material Purchases, Transport Fees, Subcon Cost
   - 1 large scorecard at bottom: Total Project Cost
   - Each scorecard shows amount and count
11. Verify over-budget projects show negative remaining in red with ‚ö†Ô∏è
12. Close modal and click "Refresh Totals" button
13. Verify table refreshes (loading spinner appears briefly)
14. Open browser DevTools Console
15. Verify no errors related to Historical Data tab or history-section
16. Verify all currency amounts formatted correctly (no NaN or undefined)
  </verify>
  <done>
Finance view has 3 tabs (Historical Data removed), Project List displays expense table with aggregated totals, expense modal shows category breakdown with scorecards, formatCurrency used correctly throughout
  </done>
</task>

</tasks>

<verification>
1. Finance navigation shows only 3 tabs (Historical Data removed)
2. Project List table displays all projects with budget and expense columns
3. Clicking project row opens expense breakdown modal
4. Modal displays 6 scorecards: Budget, Remaining, Materials, Transport, Subcon, Total
5. Over-budget projects highlighted in red
6. Refresh Totals button triggers aggregation calculation
7. All expenses accurately calculated from POs and approved TRs
8. No console errors related to removed Historical Data tab
9. formatCurrency is properly imported and used throughout
</verification>

<success_criteria>
1. Historical Data tab removed from Finance navigation
2. Project List table shows: Project Name (Code + Name), Client, Budget, Total Expense, Remaining Budget, Status
3. Clicking project row opens expense breakdown modal
4. Expense modal scorecards show: Project Budget, Remaining Budget, Material Purchases, Transport Fees, Subcon Cost, Total Project Cost
5. All project expenses accurately accounted (materials, transport, delivery fees from approved TRs)
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-03-SUMMARY.md`
</output>
