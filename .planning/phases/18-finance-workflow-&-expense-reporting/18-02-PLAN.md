---
phase: 18-finance-workflow-&-expense-reporting
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified: [app/views/procurement.js]
autonomous: true

must_haves:
  truths:
    - "Generated PO document displays finance approver name"
    - "Generated PO document displays embedded signature image"
    - "Generated PR document displays PR creator name (from Phase 17)"
    - "Signature appears in correct section with proper styling"
    - "Documents print correctly with signatures visible"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Updated generatePOHTML with signature section"
      contains: "finance_signature_url"
      min_lines: 20
    - path: "app/views/procurement.js"
      provides: "Updated generatePRHTML with creator attribution"
      contains: "pr_creator_name"
      min_lines: 10
  key_links:
    - from: "generatePOHTML"
      to: "po.finance_signature_url"
      via: "template replacement"
      pattern: "FINANCE_SIGNATURE_URL"
    - from: "generatePOHTML"
      to: "po.finance_approver_name"
      via: "template replacement"
      pattern: "FINANCE_APPROVER"
    - from: "generatePRHTML"
      to: "pr.pr_creator_name"
      via: "template replacement"
      pattern: "PREPARED_BY"
---

<objective>
Embed signatures and user attribution in PO and PR document templates

Purpose: Display captured signatures and user names in generated PDF documents for audit trail and compliance. Update existing HTML print templates to include signature section in PO documents and "Prepared By" field in PR documents.

Output: PO documents with embedded signature images, PR documents with creator names
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-finance-workflow-&-expense-reporting/18-RESEARCH.md
@.planning/phases/18-finance-workflow-&-expense-reporting/18-01-PLAN.md
@.planning/phases/17-procurement-workflow-overhaul/17-01-SUMMARY.md
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Update PO document template with signature section</name>
  <files>app/views/procurement.js</files>
  <action>
**1. Find generatePODocument() function (around line 4898):**

Update the function to extract signature and approver fields from PO document:

```javascript
async function generatePODocument(poDocId) {
    // ... existing logic to get PO document ...

    const po = poDoc.data();

    const documentData = {
        PO_ID: po.po_id,
        // ... existing fields ...
        FINANCE_APPROVER: po.finance_approver_name || 'Finance Team',
        FINANCE_SIGNATURE_URL: po.finance_signature_url || '',
        PROCUREMENT_PIC: po.procurement_pic || 'Procurement Team',
        // ... rest of fields
    };

    const html = generatePOHTML(documentData);
    openPrintWindow(html, documentData.PO_ID);
}
```

**2. Find generatePOHTML() function (around line 4930):**

Add signature section before closing body tag. This should be placed after the items table but before the </body> tag:

```javascript
function generatePOHTML(data) {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${data.PO_ID} - Purchase Order</title>
            <style>
                /* ... existing styles ... */
                .signature-section {
                    margin-top: 3rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-end;
                    padding: 0 2rem;
                    page-break-inside: avoid;
                }
                .signature-box {
                    text-align: center;
                    min-width: 200px;
                }
                .signature-box p {
                    margin: 0.25rem 0;
                    font-size: 0.875rem;
                }
                .signature-box img {
                    max-width: 200px;
                    height: auto;
                    margin-bottom: 0.5rem;
                    display: block;
                    margin-left: auto;
                    margin-right: auto;
                }
                .signature-line {
                    border-top: 1px solid #000;
                    width: 200px;
                    margin: 0.5rem auto 0.25rem auto;
                }
                .signature-placeholder {
                    height: 60px;
                    width: 200px;
                    margin: 0 auto 0.5rem auto;
                }
            </style>
        </head>
        <body>
            <!-- ... existing PO header, items table, etc. ... -->

            <div class="signature-section">
                <div class="signature-box">
                    <p><strong>Prepared by:</strong></p>
                    ${data.PROCUREMENT_PIC ? `
                        <div class="signature-placeholder"></div>
                        <p>${data.PROCUREMENT_PIC}</p>
                        <div class="signature-line"></div>
                    ` : `
                        <div class="signature-placeholder"></div>
                        <p>Procurement Team</p>
                        <div class="signature-line"></div>
                    `}
                </div>

                <div class="signature-box">
                    <p><strong>Approved by:</strong></p>
                    ${data.FINANCE_SIGNATURE_URL ? `
                        <img src="${data.FINANCE_SIGNATURE_URL}" alt="Finance Signature">
                        <p>${data.FINANCE_APPROVER}</p>
                        <div class="signature-line"></div>
                    ` : `
                        <div class="signature-placeholder"></div>
                        <p>${data.FINANCE_APPROVER}</p>
                        <div class="signature-line"></div>
                    `}
                </div>
            </div>
        </body>
        </html>
    `;
}
```

**3. Update generatePRDocument() function (around line 4815) to include PR creator:**

Find where documentData is constructed:

```javascript
async function generatePRDocument(prDocId) {
    // ... existing logic ...

    const pr = prDoc.data();

    const documentData = {
        PR_ID: pr.pr_id,
        // ... existing fields ...
        PREPARED_BY: pr.pr_creator_name || 'Procurement Team',
        // ... rest of fields
    };

    const html = generatePRHTML(documentData);
    openPrintWindow(html, documentData.PR_ID);
}
```

**4. Update generatePRHTML() function (around line 4850) to display PR creator:**

Add "Prepared by" line in the PR header section (after PR ID and date):

```javascript
function generatePRHTML(data) {
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${data.PR_ID} - Purchase Request</title>
            <style>
                /* ... existing styles ... */
            </style>
        </head>
        <body>
            <div class="document-header">
                <h1>Purchase Request</h1>
                <div class="document-info">
                    <p><strong>PR ID:</strong> ${data.PR_ID}</p>
                    <p><strong>Date Generated:</strong> ${data.DATE_GENERATED}</p>
                    <p><strong>Prepared by:</strong> ${data.PREPARED_BY}</p>
                </div>
            </div>

            <!-- ... rest of PR template ... -->
        </body>
        </html>
    `;
}
```

**Why these changes:**
- Signature section uses CSS flexbox for side-by-side layout (Prepared by | Approved by)
- Conditional rendering: show signature image if available, otherwise show placeholder
- page-break-inside: avoid prevents signature section from splitting across pages
- Fallback values ('Finance Team', 'Procurement Team') handle legacy documents without attribution
- PR creator name appears in document header for clear procurement audit trail
- min-width: 200px ensures signature boxes don't collapse on narrow prints
  </action>
  <verify>
1. Start dev server: `python -m http.server 8000`
2. Navigate to Finance > Pending Approvals
3. Approve a PR with signature (following 18-01 workflow)
4. Navigate to Finance > Purchase Orders
5. Find the newly created PO in the list
6. Click "View" button to generate PO document
7. Verify print preview shows:
   - "Prepared by: Procurement Team" on left side
   - "Approved by: [Your Name]" on right side
   - Signature image appears above approver name (black signature lines visible)
   - Signature line (horizontal rule) below both sections
8. Click Print > Save as PDF
9. Open PDF and verify signature is embedded and visible
10. Navigate to Procurement > MRF Processing
11. Generate a PR from an MRF (should have pr_creator_name from Phase 17)
12. Go to Procurement > MRF Records
13. Click "View PR" to generate PR document
14. Verify print preview shows "Prepared by: [Creator Name]" in header
  </verify>
  <done>
PO documents display finance approver name with embedded signature image in side-by-side layout, PR documents display creator name in header
  </done>
</task>

</tasks>

<verification>
1. Generated PO document opens in print window
2. PO document displays "Approved by: [Finance User Name]"
3. PO document displays signature image (black lines visible)
4. Signature section has two columns: Prepared by (left) and Approved by (right)
5. Signature line appears below both names
6. Print to PDF preserves signature image
7. Generated PR document displays "Prepared by: [PR Creator Name]" in header
8. Legacy documents without signatures show placeholder space with names
</verification>

<success_criteria>
1. Generated PO document includes captured signature as visible image
2. PO document shows finance approver name below signature
3. Generated PR document shows PR creator name who prepared/generated the PR
4. Documents print correctly with signatures embedded in PDF
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-02-SUMMARY.md`
</output>
