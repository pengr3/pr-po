---
phase: 18-finance-workflow-&-expense-reporting
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [app/views/procurement.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Dynamic fields prompt appears only once per PO - if payment_terms, condition, and delivery_date all exist, document generates directly"
    - "PO Details Modal has editable Document Details section for payment_terms, condition, delivery_date"
    - "PO document Approved by section is left-aligned"
    - "PR document has single inline Prepared by text with no underline or duplicate section"
  artifacts:
    - path: "app/views/procurement.js"
      provides: "Fixed promptPODocument with skip logic, editable fields in viewPODetails, corrected document templates"
  key_links:
    - from: "promptPODocument"
      to: "generatePODocument"
      via: "conditional skip when all 3 fields exist"
      pattern: "po\\.payment_terms && po\\.condition && po\\.delivery_date"
    - from: "savePODocumentFields"
      to: "Firestore pos collection"
      via: "updateDoc"
      pattern: "updateDoc.*pos.*payment_terms"
---

<objective>
Fix four UAT issues in procurement.js: (1) Add skip-prompt logic to promptPODocument so fields are only requested once, (2) Add editable Document Details to PO Details Modal, (3) Left-align PO document Approved by section, (4) Remove duplicate PR Prepared by section with underline.

Purpose: Close UAT gaps 1-4 (tests 8-11) in procurement.js before replicating View PO to finance.js.
Output: Corrected procurement.js with all four fixes applied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/18-r2-dynamic-fields-oneshot.md
@.planning/debug/18-r2-document-cosmetics.md
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add skip-prompt logic and editable Document Details to PO Details Modal</name>
  <files>app/views/procurement.js</files>
  <action>
  Two changes in procurement.js:

  **Change 1: Skip prompt when all fields exist (promptPODocument, line ~4962)**

  At the start of `promptPODocument(poDocId)`, after fetching the PO doc and getting `const po = poDoc.data()`, add a conditional check BEFORE the modal creation code:

  ```javascript
  // If all three document fields already exist, skip prompt and generate directly
  if (po.payment_terms && po.condition && po.delivery_date) {
      console.log('[Procurement] All PO document fields present - generating directly');
      await generatePODocument(poDocId);
      return;
  }
  ```

  This goes right after `const po = poDoc.data();` (line ~4971) and before the `// Create prompt modal` comment (line ~4973). The existing modal code continues unchanged for POs missing any field.

  **Change 2: Add editable Document Details section to viewPODetails modal (line ~4041)**

  In `viewPODetails(poId)`, after the metadata grid (which ends around line 4123 with the delivery_fee conditional), insert a new "Document Details" section BEFORE the Items table section (line ~4125). Add this HTML to `modalBodyContent`:

  ```javascript
  <!-- Document Details (Editable) -->
  <div style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
      <h4 style="margin-bottom: 1rem; color: #1e293b;">Document Details</h4>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
          <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.875rem;">Payment Terms</label>
              <input type="text" id="editPaymentTerms_${po.id}" value="${po.payment_terms || ''}"
                     placeholder="e.g., 50% down payment, 50% upon delivery"
                     style="width: 100%; padding: 0.5rem; border: 1.5px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem;">
          </div>
          <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.875rem;">Condition</label>
              <input type="text" id="editCondition_${po.id}" value="${po.condition || ''}"
                     placeholder="e.g., Items must meet quality standards"
                     style="width: 100%; padding: 0.5rem; border: 1.5px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem;">
          </div>
          <div style="grid-column: span 2;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #475569; font-size: 0.875rem;">Delivery Date</label>
              <input type="date" id="editDeliveryDate_${po.id}" value="${po.delivery_date || ''}"
                     style="width: 100%; padding: 0.5rem; border: 1.5px solid #cbd5e1; border-radius: 6px; font-size: 0.875rem;">
          </div>
      </div>
      <button class="btn btn-sm btn-primary" onclick="savePODocumentFields('${po.id}')"
              style="margin-top: 1rem;">
          Save Document Details
      </button>
  </div>
  ```

  **Create new function `savePODocumentFields`** (place it near `promptPODocument` around line ~5018):

  ```javascript
  async function savePODocumentFields(poId) {
      const paymentTerms = document.getElementById(`editPaymentTerms_${poId}`)?.value?.trim() || '';
      const condition = document.getElementById(`editCondition_${poId}`)?.value?.trim() || '';
      const deliveryDate = document.getElementById(`editDeliveryDate_${poId}`)?.value || '';

      try {
          const updateData = {};
          if (paymentTerms) updateData.payment_terms = paymentTerms;
          if (condition) updateData.condition = condition;
          if (deliveryDate) updateData.delivery_date = deliveryDate;

          if (Object.keys(updateData).length > 0) {
              await updateDoc(doc(db, 'pos', poId), updateData);
              showToast('Document details updated successfully', 'success');
          } else {
              showToast('No changes to save', 'info');
          }
      } catch (error) {
          console.error('Error saving document fields:', error);
          showToast('Failed to save document details', 'error');
      }
  }
  ```

  **Register `savePODocumentFields` on window** in `attachWindowFunctions()` (around line ~89):
  ```javascript
  window.savePODocumentFields = savePODocumentFields;
  ```

  **Clean up in `destroy()`** (around line ~562):
  ```javascript
  delete window.savePODocumentFields;
  ```
  </action>
  <verify>
  1. Search procurement.js for `po.payment_terms && po.condition && po.delivery_date` -- must find the skip check in promptPODocument
  2. Search for `savePODocumentFields` -- must find function definition, window attachment, and window deletion
  3. Search for `editPaymentTerms_` -- must find the editable inputs in viewPODetails modal
  4. Search for `window.savePODocumentFields` -- must find attachment in attachWindowFunctions and deletion in destroy
  </verify>
  <done>
  - promptPODocument skips modal and calls generatePODocument directly when all 3 fields exist
  - PO Details Modal shows editable Document Details section with Save button
  - savePODocumentFields properly attached to window and cleaned up in destroy
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix PO document left-alignment and PR document duplicate removal</name>
  <files>app/views/procurement.js</files>
  <action>
  Two cosmetic fixes in procurement.js document templates:

  **Fix 1: PO "Approved by" left-alignment (generatePOHTML, line ~4796)**

  Find this line in `generatePOHTML()`:
  ```javascript
  <div class="signature-section" style="justify-content: flex-end;">
  ```

  Change `flex-end` to `flex-start`:
  ```javascript
  <div class="signature-section" style="justify-content: flex-start;">
  ```

  This is a single word change on line ~4796.

  **Fix 2: Remove duplicate PR "Prepared by" section (generatePRHTML, lines ~4592-4598)**

  In `generatePRHTML()`, find and DELETE the entire duplicate "Prepared by" block (lines ~4592-4598). This is the `<div style="margin-top: 30px;">` block containing:
  - A `<p>` with "Prepared by:" label
  - A `<div>` with `border-top: 1px solid #000` (the underline)
  - A `<p>` with `${data.PREPARED_BY}`

  The surrounding code should go from:
  ```javascript
  <div style="margin-top: 40px; page-break-inside: avoid;">
      <div style="margin: 8px 0;">
          <span style="font-weight: bold; display: inline-block; width: 150px;">Requested By:</span> ${data.REQUESTOR}
      </div>
      <div style="margin-top: 30px;">          <!-- DELETE FROM HERE -->
          <div style="text-align: left; ...">
              <p ...>Prepared by:</p>
              <div style="border-top: 1px solid #000; ..."></div>
              <p ...>${data.PREPARED_BY}</p>
          </div>
      </div>                                    <!-- DELETE TO HERE -->
  </div>
  ```

  To:
  ```javascript
  <div style="margin-top: 40px; page-break-inside: avoid;">
      <div style="margin: 8px 0;">
          <span style="font-weight: bold; display: inline-block; width: 150px;">Requested By:</span> ${data.REQUESTOR}
      </div>
  </div>
  ```

  Keep the "Requested By" line. Delete only the inner `<div style="margin-top: 30px;">` block and its children. The correct inline "Prepared by:" already exists at line ~4570 in the document header fields section.
  </action>
  <verify>
  1. Search procurement.js for `justify-content: flex-start` in generatePOHTML -- must find the left-aligned signature section
  2. Search for `justify-content: flex-end` -- must NOT find it in the signature section (may exist elsewhere)
  3. Search for `border-top: 1px solid #000` in generatePRHTML -- must NOT find the underline div
  4. Count occurrences of `Prepared by` in generatePRHTML -- must be exactly 1 (at line ~4570 only)
  </verify>
  <done>
  - PO document "Approved by" section is left-aligned (flex-start)
  - PR document has only one "Prepared by" as inline text at line ~4570, no underline, no duplicate section
  </done>
</task>

</tasks>

<verification>
1. `grep -n "payment_terms && po.condition && po.delivery_date" app/views/procurement.js` returns the skip check
2. `grep -n "flex-start" app/views/procurement.js` shows left-aligned signature section
3. `grep -c "Prepared by" app/views/procurement.js` in the PR HTML section confirms single occurrence
4. `grep -n "savePODocumentFields" app/views/procurement.js` shows function, window attach, and window delete
</verification>

<success_criteria>
- promptPODocument skips modal when all 3 fields present, generates document directly
- PO Details Modal shows editable Document Details with Save button
- PO document Approved by section renders left-aligned
- PR document has exactly one Prepared by as inline text, no underline duplicate
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-06-SUMMARY.md`
</output>
