---
phase: 18-finance-workflow-&-expense-reporting
plan: 07
type: execute
wave: 2
depends_on: [18-06]
files_modified: [app/views/finance.js]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Finance user can click View PO button in Purchase Orders tab and see/generate PO document"
    - "View PO works from Finance without ever visiting Procurement"
    - "Dynamic fields prompt only appears if payment_terms, condition, or delivery_date is missing"
  artifacts:
    - path: "app/views/finance.js"
      provides: "View PO button in Purchase Orders table, PO document generation functions"
      contains: "promptPODocument"
  key_links:
    - from: "finance.js renderPOs()"
      to: "promptPODocument"
      via: "onclick button in PO table row"
      pattern: "promptPODocument.*po\\.id"
    - from: "finance.js promptPODocument"
      to: "generatePODocument"
      via: "skip logic or modal generate button"
      pattern: "generatePODocument"
    - from: "finance.js generatePODocument"
      to: "openPrintWindow"
      via: "PO HTML generation and print"
      pattern: "openPrintWindow"
---

<objective>
Add View PO document generation capability to Finance view so finance users can retrieve and generate PO documents from the Purchase Orders tab without needing to visit Procurement.

Purpose: Finance users need direct access to PO documents from their own view. Currently the button says "View in Procurement" and points to a non-existent route.
Output: Finance Purchase Orders tab with working View PO button that generates PO documents with dynamic fields prompt (one-time only).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/18-r2-view-po-location.md
@.planning/phases/18-finance-workflow-&-expense-reporting/18-06-SUMMARY.md
@app/views/finance.js
@app/views/procurement.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy PO document generation infrastructure to finance.js</name>
  <files>app/views/finance.js</files>
  <action>
  Add PO document generation capability to finance.js by duplicating the required functions from procurement.js. This is Option A from the debug analysis -- duplication is chosen over a shared module to avoid restructuring working procurement code.

  **Step 1: Add import for createModal, openModal, closeModal from components.js**

  At line 7 (after the existing utils.js import), add:
  ```javascript
  import { createModal, openModal, closeModal } from '../components.js';
  ```

  **Step 2: Add DOCUMENT_CONFIG and helper functions**

  After the `attachWindowFunctions()` and `setupModalListeners()` sections (around line ~100, before the PR/TR loading functions section), add a new section with these functions copied from procurement.js. Copy them EXACTLY as they exist in procurement.js after Plan 18-06 is applied:

  1. `DOCUMENT_CONFIG` constant (procurement.js line ~4370-4379) -- company info object
  2. `generateItemsTableHTML(items, type)` function (procurement.js line ~4387) -- HTML table builder for items
  3. `generatePOHTML(data)` function (procurement.js line ~4611) -- full PO document HTML template. **IMPORTANT**: This must already have `justify-content: flex-start` (the fix from Plan 18-06)
  4. `openPrintWindow(html, filename)` function (procurement.js line ~4819-4836) -- opens print window
  5. `formatDocumentDate(dateString)` function (procurement.js line ~4843-4853) -- date formatting
  6. `generatePODocument(poDocId)` function (procurement.js line ~4909-4955) -- fetches PO from Firestore and generates document
  7. `promptPODocument(poDocId)` function (procurement.js line ~4962) -- **IMPORTANT**: Must include the skip-prompt logic from Plan 18-06 (if all 3 fields exist, call generatePODocument directly)
  8. `generatePOWithFields(poDocId)` function (procurement.js line ~5024-5051) -- saves fields and generates document

  Add a clear section header comment:
  ```javascript
  // ========================================
  // PO DOCUMENT GENERATION (Finance View)
  // Duplicated from procurement.js for
  // independent finance access
  // ========================================
  ```

  Note: These functions use `db`, `doc`, `getDoc`, `updateDoc` from firebase.js and `showToast`, `showLoading`, `formatCurrency` from utils.js -- all already imported in finance.js. They also use `createModal`, `openModal`, `closeModal` from components.js -- added in Step 1.

  **Step 3: Register window functions in attachWindowFunctions()**

  In `attachWindowFunctions()` (line ~25), add to the `// PO Functions` section (after `window.refreshPOs = refreshPOs;`):
  ```javascript
  window.promptPODocument = promptPODocument;
  window.generatePOWithFields = generatePOWithFields;
  window.generatePODocument = generatePODocument;
  ```

  **Step 4: Clean up in destroy()**

  In `destroy()` (line ~703), add to the window function cleanup section (after `delete window.refreshPOs;`):
  ```javascript
  delete window.promptPODocument;
  delete window.generatePOWithFields;
  delete window.generatePODocument;
  ```
  </action>
  <verify>
  1. Search finance.js for `import.*createModal.*openModal.*closeModal.*components` -- must find the import
  2. Search finance.js for `DOCUMENT_CONFIG` -- must find the constant
  3. Search finance.js for `function generatePOHTML` -- must find the function
  4. Search finance.js for `function promptPODocument` -- must find the function
  5. Search finance.js for `function generatePODocument` -- must find the function
  6. Search finance.js for `payment_terms && po.condition && po.delivery_date` -- must find the skip check in promptPODocument
  7. Search finance.js for `window.promptPODocument` -- must find in attachWindowFunctions
  8. Search finance.js for `delete window.promptPODocument` -- must find in destroy
  </verify>
  <done>
  - finance.js has complete PO document generation infrastructure
  - All functions copied with Plan 18-06 fixes already applied (left-align, skip-prompt)
  - Window functions properly attached and cleaned up
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace "View in Procurement" button with "View PO" in Finance PO table</name>
  <files>app/views/finance.js</files>
  <action>
  In the `renderPOs()` function, find the PO table row Actions column (line ~1837-1839). Currently it renders:

  ```javascript
  <td>
      <button class="btn btn-sm btn-secondary" onclick="window.location.hash='#/procurement/tracking'">View in Procurement</button>
  </td>
  ```

  Replace with a View PO button that calls `promptPODocument`:

  ```javascript
  <td>
      <button class="btn btn-sm btn-secondary" onclick="promptPODocument('${po.id}')">View PO</button>
  </td>
  ```

  Also remove or update the text at line ~1844 that says "View all in Procurement > PO Tracking" since finance now has its own View PO. Change to:
  ```javascript
  ${poData.length > 20 ? `<p style="text-align: center; margin-top: 1rem; color: #666;">Showing 20 most recent POs</p>` : ''}
  ```

  Note: `po.id` is the Firestore document ID, available because the PO data includes it. Verify by checking `loadPOs()` to confirm the data structure includes `id`.
  </action>
  <verify>
  1. Search finance.js for `View in Procurement` -- must NOT find it (replaced)
  2. Search finance.js for `procurement/tracking` -- must NOT find it (removed)
  3. Search finance.js for `promptPODocument.*po` in renderPOs -- must find the View PO button
  4. Start local server and navigate to Finance > Purchase Orders. Confirm View PO button appears for each PO row.
  </verify>
  <done>
  - "View in Procurement" button replaced with "View PO" calling promptPODocument
  - Finance users can generate PO documents directly from Finance view
  - No broken links to non-existent procurement/tracking route
  </done>
</task>

</tasks>

<verification>
1. `grep -n "promptPODocument" app/views/finance.js` returns function definition, skip logic, window attach, window delete, and button onclick
2. `grep -n "View in Procurement" app/views/finance.js` returns NO results
3. `grep -n "createModal.*openModal.*closeModal" app/views/finance.js` returns the import line
4. `grep -n "DOCUMENT_CONFIG" app/views/finance.js` returns the constant definition
5. Finance View PO button works independently without visiting Procurement first
</verification>

<success_criteria>
- Finance Purchase Orders tab shows "View PO" button (not "View in Procurement")
- Clicking View PO on a PO with all 3 fields filled generates document directly (no prompt)
- Clicking View PO on a PO missing any field shows the fields prompt modal
- All document generation works from Finance view independently
</success_criteria>

<output>
After completion, create `.planning/phases/18-finance-workflow-&-expense-reporting/18-07-SUMMARY.md`
</output>
