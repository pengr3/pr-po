# Milestone v2.1: System Refinement

**Status:** ✅ SHIPPED 2026-02-06
**Phases:** 11-14
**Total Plans:** 10

## Overview

v2.1 fixes critical bugs and completes incomplete features from v2.0. The journey starts with security foundation fixes to enable proper testing, then resolves user-blocking workflow errors, builds out financial dashboards with aggregation features, and finishes with data quality gates. Each phase delivers observable improvements that make the system more reliable and complete.

## Phases

### Phase 11: Security & Permission Foundation

**Goal:** Super Admin can access all tabs and Operations Admin can be assigned to projects
**Depends on:** Phase 10
**Requirements:** SEC-01, SEC-02, SEC-03, SEC-04
**Plans:** 2 plans

Plans:
- [x] 11-01: Add clients collection Security Rules and tests
- [x] 11-02: Enable Operations Admin project assignment support

**Details:**

Phase 11 eliminated permission denied errors blocking Super Admin access to Clients and Projects tabs. Added Security Rules for clients collection following the projects collection pattern, enabling both Super Admin and Operations Admin to perform full CRUD operations. Integrated Operations Admin role into project assignment system using Firestore 'in' operator for efficient multi-role queries. Added comprehensive test suite with 11 test cases validating admin access patterns across both collections.

**Key Decisions:**
- Follow projects collection pattern exactly for clients access control (consistency across admin-managed collections)
- Use Firestore 'in' operator instead of client-side filtering for role queries (more efficient, follows best practices)

**Duration:** <1 day (2 plans in 12 minutes total)
**Completed:** 2026-02-05

---

### Phase 12: Finance Review Workflow

**Goal:** Finance can review and approve PRs and TRs without errors
**Depends on:** Phase 11
**Requirements:** FIN-01, FIN-02
**Plans:** 2 plans

Plans:
- [x] 12-01: Fix window function lifecycle for PR/TR review buttons
- [x] 12-02: Add modal ESC key handling with AbortController

**Details:**

Phase 12 restored Finance review workflow by fixing critical window function lifecycle bugs. Implemented attachWindowFunctions() pattern to ensure onclick handlers work correctly after tab navigation, resolving "window.viewTRDetails is not a function" errors. Added ESC key modal dismissal with modern AbortController pattern for proper event listener cleanup. Fixed MRF update permissions in Security Rules to allow Finance role to update finance_status during PR/TR approval. Moved modal close calls to after successful Firebase updates to prevent perceived data loss on failure.

**Key Decisions:**
- attachWindowFunctions() pattern prevents window function lifecycle bugs (router skips destroy on tab switch)
- AbortController pattern for event listeners (single abort() call, prevents memory leaks, idempotent)

**Duration:** <1 day (2 plans completed)
**Completed:** 2026-02-05

---

### Phase 13: Finance Dashboard & Audit Trails

**Goal:** Finance can view project expenses, supplier purchase history, and procurement timelines
**Depends on:** Phase 12
**Requirements:** FIN-03, PROC-01, PROC-02
**Plans:** 5 plans

Plans:
- [x] 13-01: Finance Project List tab with server-side aggregation
- [x] 13-02: Supplier purchase history modal in Procurement
- [x] 13-03: Procurement timeline modal using createTimeline component
- [x] 13-04: Add Firebase composite indexes for aggregation and timeline queries
- [x] 13-05: Move supplier purchase history to Supplier Management tab

**Details:**

Phase 13 built comprehensive financial dashboards and audit trails. Added Project List tab in Finance view with server-side aggregated expense totals using getAggregateFromServer for efficient calculation (1 read per 1000 PO entries vs 1 per PO). Implemented supplier purchase history modal showing aggregated totals and detailed purchase history accessible from clickable supplier names. Created procurement timeline modal displaying complete MRF → PR → TR → PO audit trail using reusable createTimeline component. Added composite Firestore indexes for efficient aggregation and timeline queries. Dashboard uses manual refresh button (Firebase doesn't support real-time aggregation queries).

**Key Decisions:**
- Use getAggregateFromServer for dashboard totals (1 read per 1000 entries vs 1 per PO, cost-efficient)
- Manual refresh button for aggregation instead of real-time listener (Firebase doesn't support real-time aggregation queries)
- Server-side aggregation for supplier purchase history (efficient for suppliers with many POs)
- Timeline component reuse for audit trails (DRY principle, consistent visual presentation)
- Move supplier purchase history to Supplier Management tab (matches user expectations, feature in logical location)

**Duration:** 2 days (5 plans completed)
**Completed:** 2026-02-06

---

### Phase 14: Workflow Quality Gates

**Goal:** PO details require complete information before viewing
**Depends on:** Phase 13
**Requirements:** PROC-03
**Plans:** 1 plan

Plans:
- [x] 14-01: Add PO quality gate with required fields form

**Details:**

Phase 14 implemented workflow quality gates enforcing data completeness. Added validation blocking PO details view until Payment Terms, Condition, and Delivery Date are filled. Default values ('As per agreement', 'Standard terms apply', 'TBD') treated as missing data. Form modal pattern collects required fields with seamless save + reopen workflow - form closes, details modal opens automatically after save. Quality gate pattern reusable for future workflow gates on PRs and other document types.

**Key Decisions:**
- Quality gate pattern for data completeness (block view until required fields filled, form modal for collection, recursive call after save)

**Duration:** 3 minutes (1 plan)
**Completed:** 2026-02-06

---

## Milestone Summary

**Decimal Phases:**

None - all phases numbered sequentially (11-14)

**Key Decisions:**

From phase summaries and PROJECT.md:
- Follow projects collection pattern for clients Security Rules (consistency across admin-managed collections)
- Use Firestore 'in' operator for multi-role queries instead of client-side filtering (more efficient)
- attachWindowFunctions() pattern prevents window function lifecycle bugs (router skips destroy on tab switch)
- AbortController pattern for event listeners (single abort() call, prevents memory leaks, idempotent)
- Use getAggregateFromServer for dashboard totals (1 read per 1000 entries vs 1 per PO)
- Manual refresh button for aggregation (Firebase doesn't support real-time aggregation queries)
- Server-side aggregation for supplier purchase history (efficient for suppliers with many POs)
- Timeline component reuse for audit trails (DRY principle, consistent visual presentation)
- Multi-collection audit trail queries by common identifier (mrf_id) for complete workflow visibility
- Move supplier purchase history to Supplier Management tab (matches user expectations)
- Quality gate pattern for data completeness (block view until required fields filled)

**Issues Resolved:**

- Fixed Security Rules permission errors blocking Super Admin access to Clients and Projects tabs
- Fixed "window.viewTRDetails is not a function" error in Finance review workflow
- Fixed window function lifecycle management preventing PR/TR review button functionality
- Fixed MRF update permissions for Finance role approval workflow
- Restored Finance Project List tab with financial overview
- Implemented supplier purchase history with aggregation queries
- Added procurement timeline showing complete MRF → PR → PO audit trail
- Implemented PO quality gates enforcing data completeness before viewing

**Issues Deferred:**

- PR workflow quality gates (deferred to future milestone)
- Real-time aggregation for dashboard totals (Firebase limitation, using manual refresh)
- Mobile responsive fixes (desktop-first constraint)

**Technical Debt Incurred:**

- Firebase emulator tests require manual setup (firebase-tools, emulator start, npm test)
- Aggregation queries require Firestore indexes (manual deployment via Firebase console)
- Modal pagination not implemented (assumes < 100 POs per supplier)

---

_For current project status, see .planning/ROADMAP.md_
