# Milestone v2.0: Authentication & Permissions

**Status:** âœ… SHIPPED 2026-02-04
**Phases:** 5-10
**Total Plans:** 26

## Overview

Secure the foundation with role-based access control, enabling multiple users with granular permissions across procurement workflows.

This milestone introduced a complete authentication and permissions system:
- 5-role system (Super Admin, Operations Admin, Operations User, Finance, Procurement)
- Self-registration with invitation codes and account approval workflow
- Tab-based access control with edit vs view-only permissions
- Project assignments for Operations Users (see only assigned projects)
- Super Admin dashboard for user and permission management
- Immediate permission changes with Firebase Auth session persistence
- Server-side Firebase Security Rules enforcement

## Phases

### Phase 5: Core Authentication

**Goal:** Users can register with invitation codes and authenticate securely
**Depends on:** Phase 4 (v1.0)
**Plans:** 4 plans

Plans:
- [x] 05-01: Firebase Auth foundation and auth utilities module
- [x] 05-02: Registration flow with invitation code validation
- [x] 05-03: Login page and session management
- [x] 05-04: Pending user page and logout integration

**Requirements:** AUTH-01 through AUTH-09
**Success Criteria:** User registration, login with persistent sessions, pending user workflow, deactivated user auto-logout

**Details:**
- Firebase Auth v10.7.1 integrated with existing Firestore v10.7.1
- browserLocalPersistence for 1-day session requirement
- Invitation codes in separate collection with usage tracking
- New users default to pending status with null role
- Generic login error messages (security best practice)
- Custom authStateChanged event for event-driven auth management
- Real-time user document listener enables AUTH-09 enforcement
- Auto-logout for deactivated users via onSnapshot listener

**Key files:** app/firebase.js, app/auth.js (416 lines), app/views/register.js (320 lines), app/views/login.js (176 lines), app/views/pending.js (219 lines)

---

### Phase 6: Role Infrastructure & Real-time Permissions

**Goal:** Permission system exists with configurable role templates and immediate updates
**Depends on:** Phase 5
**Plans:** 5 plans

Plans:
- [x] 06-01: Role templates foundation and permissions module
- [x] 06-02: Auth, router, and navigation permission integration
- [x] 06-03: Role configuration admin UI (checkbox matrix)
- [x] 06-04: Edit mode vs view-only enforcement (clients, projects, mrf-form)
- [x] 06-05: Edit mode vs view-only enforcement (procurement, finance) + CSS

**Requirements:** PERM-01 through PERM-07, PERM-13 through PERM-19
**Success Criteria:** 5 role templates with configurable permissions, Super Admin can edit via checkbox matrix, role changes apply immediately (no logout), navigation shows only permitted tabs, edit vs view-only enforced

**Details:**
- Permissions module with getCurrentPermissions, hasTabAccess, canEditTab utilities
- Real-time role template listener with onSnapshot
- Custom permissionsChanged event for UI reactivity
- Checkbox matrix displays 5 roles x 7 tabs x 2 permissions (70 checkboxes)
- Pending changes tracked locally before save, batch writes for atomicity
- Super Admin role_config permissions disabled in UI (prevents lockout)
- Strict equality (=== false) distinguishes no permission from loading state
- Guard functions double-check permissions before actions (defense in depth)
- View-only users see notice banners, buttons hidden, disabled selects replaced with badges
- Permission enforcement in 6 views with 39+ permission checks
- Role seeding utility (seed-roles.js) with verification function

**Key files:** app/permissions.js (133 lines), app/seed-roles.js (229 lines), app/views/role-config.js (430 lines), styles/views.css (view-only styles)

---

### Phase 7: Project Assignment System

**Goal:** Operations Users see only assigned projects with immediate filtering
**Depends on:** Phase 6
**Plans:** 5 plans

Plans:
- [x] 07-01: Assignment utility (getAssignedProjectCodes) and assignmentsChanged event dispatch
- [x] 07-02: Project Assignments admin panel (view module + route + nav link)
- [x] 07-03: Project list and detail assignment filtering
- [x] 07-04: MRF form dropdown and procurement MRF list filtering
- [x] 07-05: End-to-end verification checkpoint

**Requirements:** PERM-08 through PERM-12, ADMIN-06
**Success Criteria:** Super Admin can assign projects to Operations Users, Operations Users see only assigned projects in list, can only create/edit MRFs for assigned projects, all-projects toggle works, assignment changes immediate

**Details:**
- getAssignedProjectCodes returns null for "no filter" (applies to all roles except operations_user)
- Missing/malformed assigned_project_codes yields empty array (zero access, not unconstrained)
- JSON.stringify comparison for array change detection
- assignmentsChanged event fires on first assignment too (idempotent listeners)
- Project Assignments admin panel with auto-save checkboxes (255 lines)
- Assignment pre-filter in 4 views: projects.js, project-detail.js, mrf-form.js, procurement.js
- checkProjectAccess guard renders in-place access denied with back link
- Zero-assignment UX shows helpful message in MRF form dropdown
- Legacy data without project_code defensively included
- Assignment filter does not affect non-operations_user roles

**Key files:** app/utils.js (getAssignedProjectCodes), app/auth.js (event dispatch), app/views/project-assignments.js (255 lines)

---

### Phase 8: Security Rules Enforcement

**Goal:** Server-side Firebase Security Rules enforce all permissions and prevent client-side bypasses
**Depends on:** Phase 7
**Plans:** 4 plans

Plans:
- [x] 08-01: Firebase CLI infrastructure and test dependencies
- [x] 08-02: Complete Firestore Security Rules for all 9 collections
- [x] 08-03: Security rules test suite with emulator verification
- [x] 08-04: Production deployment and console bypass verification

**Requirements:** PERM-20 through PERM-23
**Success Criteria:** Security Rules validate user status, role permissions, project assignments; deployed and tested for all collections; console bypass blocked

**Details:**
- Manual firebase.json creation (avoids interactive prompts)
- Emulator ports 8080 (Firestore) and 4000 (UI)
- Test dependencies in /test subfolder (zero SPA impact)
- @firebase/rules-unit-testing v3.0.0 with ES modules
- 247 lines of Security Rules with 6 helper functions
- 10 collection match blocks (users, roles, invitation_codes, projects, mrfs, prs, pos, transport_requests, suppliers, deleted_mrfs)
- isActiveUser() checks status == active
- hasRole() and isRole() check getUserData().role
- isAssignedToProject() checks assigned_project_codes and all_projects
- 17 critical path tests (high-risk scenarios): unauthenticated blocked, pending restricted, RBAC enforced, project scoping, console bypass
- Java 21 installed as portable extraction (Firebase Emulator prerequisite)
- Human verification tests both blocking and success scenarios

**Key files:** firestore.rules (247 lines), firebase.json, test/firestore.test.js (336 lines, 17 tests)

---

### Phase 9: Super Admin User Management

**Goal:** Super Admin can manage users, approve registrations, and configure permissions
**Depends on:** Phase 8
**Plans:** 4 plans

Plans:
- [x] 09-01: User Management view foundation with invitation code generation
- [x] 09-02: Pending user approval with role assignment modal
- [x] 09-03: All Users list with search and user actions
- [x] 09-04: End-to-end verification checkpoint

**Requirements:** AUTH-10 through AUTH-15, ADMIN-01 through ADMIN-05, ADMIN-07
**Success Criteria:** Super Admin generates invitation codes, views pending registrations, approves with role assignment, views all users, deactivates/deletes accounts, prevents deactivating last Super Admin

**Details:**
- UUID format for invitation codes (crypto.randomUUID())
- Auto-copy to clipboard on generation
- 3-hour expiration for invitation codes
- Silent cleanup on init (no toast notifications)
- Tab structure: Invitation Codes, Pending Approvals, All Users
- Role assignment during approval (atomic operation)
- Default role selection to operations_user
- Immediate deletion for rejected users
- Firebase Auth accounts persist after rejection (acceptable limitation)
- Email confirmation for deactivation
- Last Super Admin count check (enforces minimum 2)
- Two-step delete (deactivate first)
- Kebab menu for actions (space-efficient)
- Document click listener for menu closing
- Defense in depth status checks (UI + function-level)
- 5 post-implementation security fixes applied (408ffd4, 52fa37d, f7634ca, f8e3c3e, 180afda)

**Key files:** app/views/user-management.js (1758 lines)

---

### Phase 10: Route Protection & Session Security

**Goal:** Unauthenticated and unauthorized users cannot access the system
**Depends on:** Phase 9
**Plans:** 4 plans

Plans:
- [x] 10-01: Route guards with unauthenticated redirect
- [x] 10-02: Deep link support and intended route restoration
- [x] 10-03: Navigation visibility and Super Admin safeguards
- [x] 10-04: End-to-end verification and security audit

**Requirements:** SEC-01 through SEC-06
**Success Criteria:** Unauthenticated users redirected to login, system saves intended route and restores after login, pending users restricted to /pending, deactivated users auto-logout, minimum 2 Super Admin accounts required, operations prevented if violate minimum

**Details:**
- Authentication guard before route loading (synchronous check prevents content flash)
- Deep link support via sessionStorage (intended route saved and restored)
- Navigation visibility control (hides all links for unauthenticated users)
- Minimum 2 active Super Admin enforced (prevents system lockout)
- Manual verification approach for security testing
- Real-time Firestore state used for deactivation testing
- Navigation visibility regression fixed in commit a7fb1f0
- Super Admin minimum logic confirmed correct (enforces min 2)
- 30+ security tests passed across all layers

**Key files:** app/router.js (route guards lines 207-234), app/auth.js (nav visibility lines 418-423), app/views/login.js (deep link lines 175-184)

---

## Milestone Summary

### Key Decisions

- **AUTH-01:** Firebase Auth v10.7.1 - Same version as Firestore for SDK consistency
- **AUTH-02:** browserLocalPersistence - 1-day session requirement
- **AUTH-03:** Invitation codes in separate collection - Track usage and prevent reuse
- **AUTH-04:** New users default to pending status with null role - Super Admin assigns during approval
- **AUTH-05:** Generic login error messages - Security best practice, prevents account enumeration
- **PERM-13:** Navigation filtered based on tab access permissions - Clean separation between routing logic and permission enforcement
- **PERM-20:** Checkbox matrix displays all 5 roles x 7 tabs x 2 permissions (70 checkboxes) - Complete visibility
- **PERM-25:** Strict equality (=== false) distinguishes no permission from loading state - Prevents UI flickering
- **ASSIGN-01:** getAssignedProjectCodes returns null for "no filter" - null sentinel means do not scope
- **INFRA-01:** Manual firebase.json creation instead of firebase init - Avoids interactive prompts
- **TEST-01:** 17 critical path tests (not exhaustive) - High-risk scenarios only
- **DEPLOY-01:** Deployment-only plan with no code commits - Infrastructure operations
- **USER-01:** UUID format for invitation codes - RFC 4122 compliant
- **APPROVAL-01:** Role assignment during approval (atomic operation) - Simplifies workflow
- **ROUTE-01:** Authentication guard before route loading - Synchronous check prevents content flash
- **ROUTE-02:** Deep link support via sessionStorage - Intended route saved and restored

### Issues Resolved

- Navigation visibility regression fixed (commit a7fb1f0)
- Super Admin minimum documentation corrected (code enforces min 2)
- 5 post-implementation security enhancements (Phase 9)
- Console bypass protection verified (Phase 8)
- Permission timing race condition fixed (commit 180afda)
- Deleted/deactivated user login blocked (commits 408ffd4, 52fa37d)

### Issues Deferred

- Firestore 'in' query limit of 10 items for project assignments (client-side filtering handles, server-side optimization deferred)
- Role template seeding requires manual browser console step (one-time 5-minute task)
- First Super Admin requires manual Firestore document edit (one-time 2-minute task)

### Technical Debt Incurred

None - all post-implementation fixes were security enhancements, not regressions.

---

_For current project status, see .planning/PROJECT.md and next milestone planning_

---
