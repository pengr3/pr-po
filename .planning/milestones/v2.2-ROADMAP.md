# Milestone v2.2: Workflow & UX Enhancements

**Status:** ✅ SHIPPED 2026-02-10
**Phases:** 15-25
**Total Plans:** 37

## Overview

Enhance workflows and UX across all major areas with auto-population, restructured interfaces, comprehensive status tracking, signature capture, and consolidated navigation.

**Target enhancements:**
- Auto-populate user data in MRF forms for efficiency
- Restrict project creation to admin roles only
- Restructure project detail page with card-based layout
- Comprehensive procurement status tracking with visual indicators (red/yellow/green)
- PR creator tracking and side-by-side PR/PO display
- Finance signature capture in approval workflow
- Detailed project expense breakdown with category/material/transport views
- Consolidated admin navigation (Settings/Assignments/Users merged)

## Phases

### Phase 15: User Data & Permission Improvements

**Goal**: Auto-populate user data and enforce proper project creation permissions
**Depends on**: Phase 13
**Plans**: 2 plans

**Success Criteria:**
1. MRF form auto-populates "Your Name" from logged-in user (field removed from form)
2. Only operation_admin and super_admin roles can create new projects
3. Personnel field is required when creating projects
4. Personnel field functions as proper user assignment (type name/email and select)
5. Project assignments work seamlessly with the new personnel selection

Plans:
- [x] 15-01-PLAN.md — Auto-populate MRF requestor name from logged-in user
- [x] 15-02-PLAN.md — Project creation permission guards and personnel user datalist

### Phase 16: Project Detail Page Restructure

**Goal**: Reorganize project detail page for clarity and better information hierarchy
**Depends on**: Phase 15
**Plans**: 1 plan

**Success Criteria:**
1. Active status toggle appears at top of detail page
2. Card 1 displays: Project Code, Name, Client, Assigned Personnel
3. Card 2 displays: Budget, Contract Cost, Expense, Remaining Budget
4. Card 3 displays: Internal Status, Project Status
5. Layout avoids redundancy and presents information logically

Plans:
- [x] 16-01-PLAN.md — Restructure into 3-card layout with expense calculation and breakdown modal

### Phase 17: Procurement Workflow Overhaul

**Goal**: Rename tabs, track PR creators, fix supplier modals, implement comprehensive MRF status tracking with visual indicators
**Depends on**: Phase 15
**Plans**: 6 plans (4 initial + 2 gap closure)

**Success Criteria:**
1. MRF Processing: Generated PRs bear the name of user who clicked Generate PR button
2. Supplier Management: Clicking supplier name always opens historical purchases modal
3. PR-PO tab renamed to "MRF Records"
4. MRF Records: Clickable supplier names removed from PRs/POs columns
5. MRF Records: "DATE" column renamed to "Date Needed"
6. MRF Records: "PO Timeline" column removed (timeline button remains in Actions)
7. MRF Records: PR and corresponding PO displayed side by side
8. MRF Records: MRF Status shows "Awaiting PR" (red), "0/n PO Issued" (yellow), "n/n PO Issued" (green)
9. MRF Records: "PO Status" column renamed to "Procurement Status"
10. MRF Records: Timeline captures timestamps (not just dates) for efficiency measurement
11. MRF Records: Columns ordered: MRF ID, Project, Date Needed, PRs, POs, MRF Status, Procurement Status, Actions

Plans:
- [x] 17-01-PLAN.md — Add user attribution to PR generation
- [x] 17-02-PLAN.md — Rename tab and restructure table columns
- [x] 17-03-PLAN.md — Implement MRF status tracking with visual badges
- [x] 17-04-PLAN.md — Remove inline supplier links and ensure modal consistency
- [x] 17-05-PLAN.md — Complete PR creator attribution (rejected/approved PR paths)
- [x] 17-06-PLAN.md — Fix supplier modal visibility (move outside sections)

### Phase 18: Finance Workflow & Expense Reporting

**Goal**: Add signature capture, improve approval flow, remove unused tabs, create comprehensive project expense breakdown
**Depends on**: Phase 15
**Plans**: 7 plans (3 initial + 4 gap closure)

**Success Criteria:**
1. Pending Approvals: Approval modal includes signature capture
2. Pending Approvals: After PO generation, user stays on Pending Approvals tab (no auto-redirect)
3. Pending Approvals: Generated PO document includes captured signature
4. PR documents capture and display the name of Procurement user who prepared/generated the PR from MRF
5. PO documents capture and display the name of Finance user who approved and created the PO
6. Historical Data tab removed from Finance navigation
7. Project List table shows: Project Name (Code + Name), Client Name, Total Expense, Budget, Remaining Budget, Status
8. Clicking project row opens expense breakdown modal
9. Expense modal scorecards show: Project Budget, Remaining Budget, Material Purchases, Transport Fees, Subcon Cost, Total Project Cost
10. All project expenses accurately accounted (materials, transport, delivery fees)

Plans:
- [x] 18-01-PLAN.md — Add signature capture to approval modals with user attribution
- [x] 18-02-PLAN.md — Embed signatures and user names in PO/PR documents
- [x] 18-03-PLAN.md — Project expense reporting with category breakdown and tab removal
- [x] 18-04-PLAN.md — Fix PR approval modal placement and remove TR signature capture
- [x] 18-05-PLAN.md — Fix PO/PR document layouts and add dynamic PO fields
- [x] 18-06-PLAN.md — Fix skip-prompt logic, editable PO details, and document cosmetics
- [x] 18-07-PLAN.md — Add View PO document generation to Finance view

### Phase 19: Navigation Consolidation

**Goal**: Merge admin tabs into single navigation item for cleaner interface
**Depends on**: Phase 16, 17, 18
**Plans**: 2 plans

**Success Criteria:**
1. Settings, Assignments, and Users tabs merged into single "Admin" navigation item
2. Admin navigation item opens submenu or dedicated page with 3 sections
3. All existing functionality preserved (no features lost)
4. Navigation is cleaner and less cluttered
5. Role-based visibility still enforced (only admins see Admin nav item)

Plans:
- [x] 19-01-PLAN.md — Create admin wrapper view and consolidate routing
- [x] 19-02-PLAN.md — Add admin dropdown nav and permission filtering

### Phase 20: Multi-Personnel Pill Selection

**Goal**: Transform project personnel field from single-select to multi-select with removable pill/chip UI
**Depends on**: Phase 15
**Plans**: 3 plans

**Success Criteria:**
1. Personnel field in project creation allows selecting multiple users
2. Selected users appear as removable pills/chips (click X to remove, not character-by-character delete)
3. Typing in personnel field filters available users (name or email)
4. Project stores array of personnel (personnel_user_ids + personnel_names)
5. Project detail page displays all assigned personnel as pills
6. Existing single-personnel projects remain backward compatible

Plans:
- [x] 20-01-PLAN.md — Add pill/chip CSS and normalizePersonnel utility function
- [x] 20-02-PLAN.md — Transform projects.js personnel to pill multi-select
- [x] 20-03-PLAN.md — Transform project-detail.js personnel to pill display/edit

### Phase 21: Personnel-Assignment Sync

**Goal**: Sync project assignments with personnel -- when a user is added/removed as personnel on a project, automatically update their `assigned_project_codes` on the user document so operations users can see assigned projects
**Depends on**: Phase 20
**Plans**: 1 plan

**Success Criteria:**
1. Adding a user as personnel on a project (via Projects tab) adds the project code to their `assigned_project_codes`
2. Removing a user as personnel removes the project code from their `assigned_project_codes`
3. Operations users can immediately see projects they were assigned to via personnel field
4. Editing personnel in project-detail.js also syncs assignments
5. Existing project-assignments admin panel continues to work (manual overrides preserved)
6. Users with `all_projects: true` are not affected by sync

Plans:
- [x] 21-01-PLAN.md — Add syncPersonnelToAssignments utility and wire into all mutation paths

### Phase 22: Bug Fixes & UX Improvements

**Goal**: Fix PO date rendering, blank document details for unfilled fields, Firestore permission errors, procurement status/delivery fee persistence, and add sortable table headers across views
**Depends on**: Phase 21
**Plans**: 3 plans

**Success Criteria:**
1. PO Issued Date renders correctly (no "Invalid Date") when approving in Finance
2. View PO in Finance shows blank fields for delivery_date, condition, payment_terms when procurement hasn't filled them (no default/assumed values)
3. No Firestore permission-denied errors on procurement account snapshot listeners
4. Procurement status changes (including Delivered with delivery fee) persist to Firestore and appear in history/timeline
5. Delivery fees are accounted in project expense totals
6. Sortable table headers (click-to-sort) implemented in Finance, Clients, and other applicable views

Plans:
- [x] 22-01-PLAN.md — Fix PO date rendering and blank document defaults
- [x] 22-02-PLAN.md — Fix Firestore permission errors and delivery fee expense totals
- [x] 22-03-PLAN.md — Add sortable table headers to Finance and Clients views

### Phase 23: Tech Debt Cleanup

**Goal**: Address accumulated tech debt from milestone audit — fix TR approval attribution, correct cosmetic regressions, remove dead code, and add missing documentation
**Depends on**: Phase 22
**Gap Closure**: Closes 5 tech debt items from v2.2-MILESTONE-AUDIT.md
**Plans**: 2 plans

**Success Criteria:**
1. TR approval captures actual approver name from getCurrentUser() instead of hardcoded value
2. Section header in procurement.js shows "MRF Records" (not "PR-PO Records")
3. Legacy approvePR() and generatePOsForPR() dead code removed from finance.js
4. HTML comment at procurement.js line 228 updated to "MRF Records Section"
5. Phase 20 VERIFICATION.md exists documenting UAT results

Plans:
- [x] 23-01-PLAN.md — Fix TR approval attribution and cosmetic regressions
- [x] 23-02-PLAN.md — Remove dead code and add missing verification doc

### Phase 24: PR/TR Rejection Reason Passthrough

**Goal**: When Finance rejects a PR or TR with a rejection reason, that reason must be stored and displayed back to Procurement users in MRF Processing view
**Depends on**: Phase 23
**Plans**: 1 plan

**Success Criteria:**
1. Finance rejection modal captures rejection reason text
2. Rejection reason is stored on the PR/TR document in Firestore
3. Procurement MRF Processing view displays the rejection reason (not "No reason provided")
4. MRF status reflects the rejection with reason visible
5. Existing rejections without reasons still display gracefully

Plans:
- [x] 24-01-PLAN.md — Fix field name mismatch, TR rejection visibility, and dynamic rejector attribution

### Phase 25: Project Edit History

**Goal**: Add an edit history button to Project Detail page that shows a complete audit trail of all changes — what changed, when, and by whom
**Depends on**: Phase 23
**Plans**: 2 plans

**Success Criteria:**
1. "Edit History" button appears in Project Information card, right-aligned with Active toggle
2. Button is clickable for all users with access to the Projects view
3. Clicking button opens a modal showing chronological list of all edits
4. Each history entry shows: what field changed, old value → new value, timestamp, and user who made the change
5. History captures changes from all edit paths (project-detail.js inline editing, projects.js creation)
6. History persists across sessions (stored in Firestore)

Plans:
- [x] 25-01-PLAN.md — Create edit history shared module and Firestore security rules
- [x] 25-02-PLAN.md — Wire edit history into all mutation points and add UI button

---

## Milestone Summary

**Key Decisions:**

From v2.2-MILESTONE-AUDIT.md and phase summaries:

- v2.2 (15-01): Use readonly (not disabled) for auto-populated form fields (ensures value submits with form)
- v2.2 (15-01): Auto-populate user identity fields in init(), resetForm(), and post-submission (persistent across all form lifecycle events)
- v2.2 (15-02): Personnel field required for new project creation (enforces accountability)
- v2.2 (15-02): Store both personnel_user_id and personnel_name (denormalization avoids extra lookups, historical record)
- v2.2 (16-01): Plain text display for locked fields instead of disabled inputs (cleaner UI, more obvious fields are truly locked)
- v2.2 (16-01): Manual refresh button for expense calculation (follows Phase 13 pattern, Firebase doesn't support real-time aggregation)
- v2.2 (17-01): Follow Phase 15 denormalization pattern for PR creator attribution (pr_creator_user_id + pr_creator_name for audit trail without lookup overhead)
- v2.2 (17-01): Use serverTimestamp() for created_at instead of client-side Date() (clock-skew protection and millisecond precision)
- v2.2 (18-01): Use signature_pad v5.0.3 via CDN for canvas-based signature capture (industry standard, zero dependencies, touch/stylus/mouse support)
- v2.2 (18-01): Store signature as base64 PNG data URL in Firestore documents (simple, small size, no separate file upload)
- v2.2 (19-01): Admin wrapper view pattern: parent view manages lifecycle of child views via dynamic import and internal section switching
- v2.2 (19-01): _pendingAdminSection coordination: dropdown sets window global before navigation, wrapper reads and clears in init()
- v2.2 (20-01): Parallel arrays (personnel_user_ids[] + personnel_names[]) over array of objects (consistent with assigned_project_codes pattern, simpler Firestore operations)
- v2.2 (20-01): normalizePersonnel() read-time migration handles 3 legacy formats (Phase 2 freetext, Phase 15 single-user, Phase 20 arrays)
- v2.2 (21-01): arrayUnion/arrayRemove for atomic personnel-to-assignment sync (idempotent, no race conditions)
- v2.2 (21-01): Fire-and-forget sync pattern (personnel save is primary, sync is secondary enhancement)
- v2.2 (22-01): formatTimestamp over formatDate for PO dates (handles both Firestore Timestamp and string dates)
- v2.2 (22-01): Empty string fallback for document fields (blank fields are honest, hardcoded defaults mislead)
- v2.2 (25-01): Fire-and-forget pattern for recordEditHistory (catches errors, never blocks primary save)
- v2.2 (25-01): Append-only subcollection rules for edit_history (allow create, deny update/delete)
- v2.2 (25-02): Field-level diffing in saveEdit() for intelligent change detection (only records actual changes)

**Issues Resolved:**

- Phase 17: Section header cosmetic regression (showed "PR-PO Records" instead of "MRF Records") - fixed in Phase 23
- Phase 19: Stale route references in user-management.js causing navigation errors - fixed in Plan 19-02
- Phase 18: Multiple UAT gaps requiring 4 additional plans (18-04 through 18-07) for signature modal placement, document layouts, skip-prompt logic, and Finance PO generation
- Phase 17: Two UAT gaps requiring 2 additional plans (17-05, 17-06) for PR creator attribution in rejected/approved paths and supplier modal visibility

**Issues Deferred:**

- Finance rejection attribution incomplete (rejection handlers still have hardcoded rejected_by name - moderate tech debt)
- Internal code comments using old "PR-PO" terminology (cosmetic, not user-visible)
- Edit history PDF export for audit compliance (planned for v2.3)

**Technical Debt Incurred:**

- DOCUMENT_CONFIG.defaultFinancePIC has hardcoded name (pre-existing, not in v2.2 scope)
- Finance submitRejection has hardcoded rejected_by for rejection flow (approval flow uses getCurrentUser, but rejection does not)
- Some internal code variables/comments still reference "PR-PO" terminology (refactoring deferred)

**Architectural Patterns Established:**

1. Fire-and-forget mutation instrumentation (recordEditHistory, syncPersonnelToAssignments) - never block primary operations
2. Dual field writes for migration (pr_rejection_reason + rejection_reason) - zero data migration required
3. Fallback chains (field1 || field2 || default) - graceful backward compatibility
4. Coordination via window globals (_pendingAdminSection) - cross-module navigation coordination
5. Denormalization for performance (personnel_user_ids + personnel_names, pr_creator_user_id + pr_creator_name) - eliminate lookup overhead
6. Parallel arrays over objects (consistent with Firebase patterns, simpler operations)

---

_For current project status, see .planning/ROADMAP.md (next milestone)_
_For complete audit report, see .planning/milestones/v2.2-MILESTONE-AUDIT.md_
