<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procurement Dashboard | CLMC Procurement</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a73e8;
            --danger: #ea4335;
            --warning: #fbbc04;
            --success: #34a853;
            --gray-50: #f8f9fa;
            --gray-100: #e8eaed;
            --gray-200: #dadce0;
            --gray-300: #bdc1c6;
            --gray-700: #5f6368;
            --gray-900: #202124;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-title h1 {
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        .header-title p {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            color: var(--gray-700);
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--gray-50);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* MRF Section */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

           .mrf-list {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                max-height: 70vh;
                overflow-y: auto;
                overflow-x: hidden;  /* Add this line */
        }

        .mrf-item {
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mrf-item:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .mrf-item.selected {
            border-color: var(--primary);
            background: #e8f0fe;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
            transform: translateX(4px);
        }

        /* Suppliers Section */
        .suppliers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-300);
            color: var(--gray-900);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .icon-btn:hover {
            background: var(--gray-50);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .add-form {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }

        .toast.show {
            display: flex;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .edit-row input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
        }

        .items-table {
            width: 100%;
            margin-top: 1rem;
        }

        .items-table input,
        .items-table select {
            width: 100%;
            padding: 0.5rem;
        }

        .timeline-item {
            padding: 1rem;
            border-left: 3px solid #dadce0;
            margin-left: 1rem;
            position: relative;
            margin-bottom: 1rem;
        }

        .timeline-item::before {
            content: '';
            width: 12px;
            height: 12px;
            background: #dadce0;
            border-radius: 50%;
            position: absolute;
            left: -7.5px;
            top: 1.5rem;
        }

        .timeline-item.completed::before {
            background: #34a853;
        }

        .timeline-item.current::before {
            background: #1a73e8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(26, 115, 232, 0); }
        }

        .status-select {
            padding: 0.5rem;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
        }

        .items-table {
            width: 100%;
            margin-top: 1rem;
        }

        .items-table input,
        .items-table select {
            width: 100%;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                   <img src="https://raw.githubusercontent.com/pengr3/pr-po/main/CLMC%20Registered%20Logo.png" alt="CLMC Logo" style="height: 50px;" onerror="this.style.display='none'">
                    <div class="header-title">
                        <h1>Procurement Dashboard</h1>
                        <p>CLMC Procurement</p>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('mrfs')">MRF Processing</button>
                    <button class="tab-btn" onclick="switchTab('suppliers')">Supplier Management</button>
                    <button class="tab-btn" onclick="switchTab('historical-mrfs')">Historical MRFs</button>
                    <button class="tab-btn" onclick="switchTab('po-tracking')">PO Tracking</button>
                </div>
            </div>
        </div>

    <div class="container">
        <!-- MRF Processing Section -->
        <section id="mrfs-section" class="section active">
            <div class="dashboard-grid">
                <!-- MRF List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Pending MRFs</h3>
                        <button class="btn btn-secondary" onclick="loadMRFs()" style="padding: 0.5rem 1rem; background: #dadce0; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;"> Refresh</button>
                    </div>
                    <div class="mrf-list" id="mrfList">
                        <div style="text-align: center; padding: 2rem; color: #999;">
                            Loading MRFs...
                        </div>
                    </div>
                </div>

                <!-- MRF Details -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">MRF Details</h3>
                        <div style="display: flex; gap: 0.5rem;" id="mrfActions">
                            <button class="btn btn-primary" onclick="saveProgress()">Save Progress</button>
                            <button class="btn btn-success" id="generatePRBtn" onclick="generatePR()" style="display: none;"> Generate PR</button>
                        </div>
                    </div>
                    <div id="mrfDetails">
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            Select an MRF to view details
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Supplier Management Section -->
        <section id="suppliers-section" class="section">
            <div class="card">
                <div class="suppliers-header">
                    <h2>Supplier Management</h2>
                    <button class="btn btn-primary" onclick="toggleAddForm()">Add Supplier</button>
                </div>

                <!-- Add Supplier Form -->
                <div id="addSupplierForm" class="add-form" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Add New Supplier</h3>
                    <div class="form-group">
                        <label>Supplier Name *</label>
                        <input type="text" id="newSupplierName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person *</label>
                        <input type="text" id="newContactPerson" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="newEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="text" id="newPhone" required>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="toggleAddForm()">Cancel</button>
                        <button class="btn btn-success" onclick="addSupplier()">Add Supplier</button>
                    </div>
                </div>

                <!-- Suppliers Table -->
                <table>
                    <thead>
                        <tr>
                            <th>Supplier Name</th>
                            <th>Contact Person</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">
                                Loading suppliers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>


        <!-- PO Tracking Section -->
        <section id="po-tracking-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Purchase Order Tracking & Delivery</h2>
                    <button class="btn btn-primary" onclick="refreshPOTracking()"> Refresh</button>
                </div>

                <!-- Delivery Status Scoreboard -->
                <div id="poScoreboard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; padding: 1.5rem; margin-bottom: 1rem;">
                    <!-- Pending -->
                    <div style="background: linear-gradient(135deg, #fee 0%, #fcc 100%); padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1); border-left: 4px solid #dc2626;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #991b1b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Pending</div>
                        <div id="scorePending" style="font-size: 2rem; font-weight: 700; color: #dc2626;">0</div>
                        <div style="font-size: 0.75rem; color: #991b1b; margin-top: 0.25rem;">Materials</div>
                    </div>

                    <!-- Procuring -->
                    <div style="background: linear-gradient(135deg, #fef9e7 0%, #fef3c7 100%); padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(234, 179, 8, 0.1); border-left: 4px solid #eab308;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #854d0e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Procuring</div>
                        <div id="scoreProcuring" style="font-size: 2rem; font-weight: 700; color: #ca8a04;">0</div>
                        <div style="font-size: 0.75rem; color: #854d0e; margin-top: 0.25rem;">Materials</div>
                    </div>

                    <!-- Procured -->
                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(34, 197, 94, 0.1); border-left: 4px solid #22c55e;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #14532d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Procured</div>
                        <div id="scoreProcured" style="font-size: 2rem; font-weight: 700; color: #16a34a;">0</div>
                        <div style="font-size: 0.75rem; color: #14532d; margin-top: 0.25rem;">Materials</div>
                    </div>

                    <!-- Delivered -->
                    <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 1.25rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #1e3a8a; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Delivered</div>
                        <div id="scoreDelivered" style="font-size: 2rem; font-weight: 700; color: #2563eb;">0</div>
                        <div style="font-size: 0.75rem; color: #1e3a8a; margin-top: 0.25rem;">Materials</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>PO ID</th>
                            <th>Supplier</th>
                            <th>Project</th>
                            <th>Amount</th>
                            <th>Issued Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="poTrackingBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                Loading POs...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>


        <!-- Historical MRFs Section -->
        <section id="historical-mrfs-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 style="font-size: 1.5rem; font-weight: 600;">Historical MRFs</h2>
                    <button class="btn btn-secondary" onclick="loadHistoricalMRFs()">Refresh</button>
                </div>

                <!-- Filters -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Search</label>
                        <input type="text" id="historicalSearch" placeholder="MRF ID or Project..." style="width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px;" oninput="filterHistoricalMRFs()">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Status</label>
                        <select id="historicalStatusFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px;" onchange="filterHistoricalMRFs()">
                            <option value="">All Statuses</option>
                            <option value="TR Submitted">TR Submitted</option>
                            <option value="PR Generated">PR Generated</option>
                            <option value="Finance Approved">Finance Approved</option>
                            <option value="PO Issued">PO Issued</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Type</label>
                        <select id="historicalTypeFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px;" onchange="filterHistoricalMRFs()">
                            <option value="">All Types</option>
                            <option value="material">Material</option>
                            <option value="service">Transport</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Date From</label>
                        <input type="date" id="historicalDateFrom" style="width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px;" onchange="filterHistoricalMRFs()">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Date To</label>
                        <input type="date" id="historicalDateTo" style="width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px;" onchange="filterHistoricalMRFs()">
                    </div>
                </div>

                <!-- Historical MRFs Table -->
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">MRF ID</th>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">Total Cost</th>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">PR ID(s)</th>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">PO ID(s)</th>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">Project Name</th>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">Date Submitted</th>
                            <th style="padding: 0.75rem; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; text-align: left;">Current Status</th>
                        </tr>
                    </thead>
                    <tbody id="historicalMRFsBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #999;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, orderBy, limit, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAlHcmPmkCk6CKsRbfpHpCheHb2GcLz0Oc",
            authDomain: "clmc-procurement.firebaseapp.com",
            projectId: "clmc-procurement",
            storageBucket: "clmc-procurement.firebasestorage.app",
            messagingSenderId: "946184501660",
            appId: "1:946184501660:web:6559c5de405e72100ab059"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        window.db = db;
        window.firestore = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot };
        let currentMRF = null;
        let suppliersData = [];
        let editingSupplier = null;

        // Initialize
        init();

        // Close modals when clicking outside
        window.onclick = function(event) {
            const timelineModal = document.getElementById('timelineModal');
            const documentsModal = document.getElementById('documentsModal');
            
            if (event.target === timelineModal) {
                closeTimelineModal();
            }
            if (event.target === documentsModal) {
                closeDocumentsModal();
            }
        };


        // PO Tracking Global
        let poData = [];

        // Load PO Tracking
        async function loadPOTracking() {
            const posRef = collection(db, 'pos');
            
            onSnapshot(posRef, (snapshot) => {
                poData = [];
                snapshot.forEach((doc) => {
                    poData.push({ id: doc.id, ...doc.data() });
                });
                // Sort by date issued
                poData.sort((a, b) => new Date(b.date_issued) - new Date(a.date_issued));
                renderPOTrackingTable(poData);
                console.log('POs updated:', poData.length);
            });
        }

        window.refreshPOTracking = async function() {
            await loadPOTracking();
            showToast('PO list refreshed', 'success');
        };

        // Render PO Tracking Table
        function renderPOTrackingTable(pos) {
            const tbody = document.getElementById('poTrackingBody');

            // Calculate scoreboard counts
            const counts = {
                pending: 0,
                procuring: 0,
                procured: 0,
                delivered: 0
            };

            pos.forEach(po => {
                const status = po.procurement_status || 'Pending Procurement';
                if (status === 'Pending Procurement') counts.pending++;
                else if (status === 'Procuring') counts.procuring++;
                else if (status === 'Procured') counts.procured++;
                else if (status === 'Delivered') counts.delivered++;
            });

            // Update scoreboard
            document.getElementById('scorePending').textContent = counts.pending;
            document.getElementById('scoreProcuring').textContent = counts.procuring;
            document.getElementById('scoreProcured').textContent = counts.procured;
            document.getElementById('scoreDelivered').textContent = counts.delivered;

            if (pos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No POs yet</td></tr>';
                return;
            }

            tbody.innerHTML = pos.map(po => `
                <tr>
                    <td><strong><a href="javascript:void(0)" onclick="viewPODetails('${po.id}')" style="color: #1a73e8; text-decoration: none; cursor: pointer;">${po.po_id}</a></strong></td>
                    <td>${po.supplier_name}</td>
                    <td>${po.project_name}</td>
                    <td>PHP ${parseFloat(po.total_amount).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td>${new Date(po.date_issued).toLocaleDateString()}</td>
                    <td>
                        <select class="status-select" data-po-id="${po.id}" 
                                onchange="updatePOStatus('${po.id}', this.value, '${po.procurement_status || 'Pending Procurement'}')">
                            <option value="Pending Procurement" ${(po.procurement_status || 'Pending Procurement') === 'Pending Procurement' ? 'selected' : ''}>Pending</option>
                            <option value="Procuring" ${po.procurement_status === 'Procuring' ? 'selected' : ''}>Procuring</option>
                            <option value="Procured" ${po.procurement_status === 'Procured' ? 'selected' : ''}>Procured</option>
                            <option value="Delivered" ${po.procurement_status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPOTimeline('${po.id}')">Timeline</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update PO Status
        window.updatePOStatus = async function(poId, newStatus, currentStatus) {
            if (newStatus === currentStatus) return;
            
            // If marking as Delivered, prompt for delivery fee
            let deliveryFee = 0;
            if (newStatus === 'Delivered') {
                const feeInput = prompt('Enter Delivery Fee (PHP):', '0');
                if (feeInput === null) {
                    // User cancelled
                    const select = document.querySelector(`select[data-po-id="${poId}"]`);
                    if (select) select.value = currentStatus;
                    return;
                }
                deliveryFee = parseFloat(feeInput) || 0;
                if (deliveryFee < 0) {
                    showToast('Delivery fee cannot be negative', 'error');
                    const select = document.querySelector(`select[data-po-id="${poId}"]`);
                    if (select) select.value = currentStatus;
                    return;
                }
            }
            
            if (!confirm(`Update status to "${newStatus}"?${newStatus === 'Delivered' ? '\nDelivery Fee: PHP ' + deliveryFee.toLocaleString('en-PH', {minimumFractionDigits: 2}) : ''}`)) {
                // Reset dropdown
                const select = document.querySelector(`select[data-po-id="${poId}"]`);
                if (select) select.value = currentStatus;
                return;
            }

            showLoading(true);

            try {
                const updateData = {
                    procurement_status: newStatus,
                    updated_at: new Date().toISOString()
                };

                if (newStatus === 'Procuring' && currentStatus !== 'Procuring') {
                    updateData.procurement_started_at = new Date().toISOString();
                } else if (newStatus === 'Procured') {
                    updateData.procured_date = new Date().toISOString().split('T')[0];
                } else if (newStatus === 'Delivered') {
                    updateData.delivered_date = new Date().toISOString().split('T')[0];
                    updateData.delivery_fee = deliveryFee;
                }

                const poRef = doc(db, 'pos', poId);
                await updateDoc(poRef, updateData);

                showToast(`PO status updated to ${newStatus}${newStatus === 'Delivered' ? ' with delivery fee: PHP ' + deliveryFee.toLocaleString('en-PH', {minimumFractionDigits: 2}) : ''}`, 'success');
            } catch (error) {
                console.error('Error updating PO status:', error);
                showToast('Failed to update status', 'error');
                // Reset dropdown
                const select = document.querySelector(`select[data-po-id="${poId}"]`);
                if (select) select.value = currentStatus;
            } finally {
                showLoading(false);
            }
        };


        // View PO Details
        window.viewPODetails = async function(poId) {
            console.log('Loading PO details for:', poId);
            showLoading(true);
            
            try {
                const poRef = doc(db, 'pos', poId);
                const poDoc = await getDoc(poRef);
                
                if (!poDoc.exists()) {
                    showToast('PO not found', 'error');
                    return;
                }
                
                const po = { id: poDoc.id, ...poDoc.data() };
                const items = JSON.parse(po.items_json || '[]');
                
                // Build modal content
                let modalContent = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">PO ID</div>
                            <div style="font-weight: 600;">${po.po_id}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">Supplier</div>
                            <div style="font-weight: 600;">${po.supplier_name}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">Project</div>
                            <div>${po.project_name}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">Date Issued</div>
                            <div>${new Date(po.date_issued).toLocaleDateString()}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">Status</div>
                            <div>${po.procurement_status || 'Pending'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">Total Amount</div>
                            <div style="font-weight: 600;">PHP ${parseFloat(po.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                        </div>
                `;
                
                // Add delivery fee if exists
                if (po.delivery_fee) {
                    modalContent += `
                        <div>
                            <div style="font-size: 0.75rem; color: #5f6368;">Delivery Fee</div>
                            <div style="font-weight: 600; color: #f59e0b;">PHP ${parseFloat(po.delivery_fee).toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                        </div>
                    `;
                }
                
                modalContent += `</div>`;
                
                // Items table
                modalContent += `
                    <div style="margin-top: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">Items</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Item</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Qty</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Unit Cost</th>
                                    <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                items.forEach(item => {
                    modalContent += `
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.item || item.item_name}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.qty || item.quantity} ${item.unit}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">PHP ${parseFloat(item.unit_cost || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">PHP ${parseFloat(item.subtotal || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
                
                modalContent += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add title wrapper
                const fullModal = `
                    <h2 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                        Purchase Order Details: ${po.po_id}
                    </h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        ${modalContent}
                    </div>
                `;
                
                // Show in documents modal
                document.getElementById('documentsContent').innerHTML = fullModal;
                document.getElementById('documentsModal').classList.add('active');
                
                console.log('PO Details:', po);
                
            } catch (error) {
                console.error('Error loading PO details:', error);
                showToast('Failed to load PO details', 'error');
            } finally {
                showLoading(false);
            }
        };

        // View PO Timeline
        window.viewPOTimeline = function(poId) {
            const po = poData.find(p => p.id === poId);
            if (!po) return;

            const calculateDays = (start, end) => {
                if (!start || !end) return 'N/A';
                const s = new Date(start);
                const e = new Date(end);
                return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + ' days';
            };

            const content = `
                <h3>${po.po_id} - Delivery Timeline</h3>
                <div style="margin-top: 1.5rem;">
                    <div class="timeline-item ${po.date_issued ? 'completed' : ''}">
                        <strong> PO Issued</strong><br>
                        <span style="font-size: 0.875rem; color: #5f6368;">
                            ${po.date_issued ? new Date(po.date_issued).toLocaleString() : 'Pending'}
                        </span>
                    </div>
                    
                    <div class="timeline-item ${po.procurement_started_at ? 'completed' : ((po.procurement_status || 'Pending Procurement') === 'Procuring' ? 'current' : '')}">
                        <strong> Procurement Started</strong><br>
                        <span style="font-size: 0.875rem; color: #5f6368;">
                            ${po.procurement_started_at ? new Date(po.procurement_started_at).toLocaleString() : 'Not started'}
                        </span>
                    </div>
                    
                    <div class="timeline-item ${po.procured_date ? 'completed' : (po.procurement_status === 'Procured' ? 'current' : '')}">
                        <strong> Items Procured</strong><br>
                        <span style="font-size: 0.875rem; color: #5f6368;">
                            ${po.procured_date ? new Date(po.procured_date).toLocaleDateString() : 'Not yet procured'}
                        </span>
                        ${po.procured_date && po.procurement_started_at ? `
                            <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #059669;">
                                Time: ${calculateDays(po.procurement_started_at, po.procured_date)}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="timeline-item ${po.delivered_date ? 'completed' : (po.procurement_status === 'Delivered' ? 'current' : '')}">
                        <strong> Delivered</strong><br>
                        <span style="font-size: 0.875rem; color: #5f6368;">
                            ${po.delivered_date ? new Date(po.delivered_date).toLocaleDateString() : 'Not yet delivered'}
                        </span>
                        ${po.delivered_date && po.procured_date ? `
                            <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #059669;">
                                Time: ${calculateDays(po.procured_date, po.delivered_date)}
                            </div>
                        ` : ''}
                    </div>
                </div>

                ${po.delivered_date && po.date_issued ? `
                    <div style="margin-top: 2rem; padding: 1rem; background: #d1fae5; border-radius: 6px;">
                        <strong>Total Time: ${calculateDays(po.date_issued, po.delivered_date)}</strong>
                    </div>
                ` : ''}
            `;

            document.getElementById('timelineContent').innerHTML = content;
            document.getElementById('timelineModal').classList.add('active');
        };

        window.closeTimelineModal = function() {
            document.getElementById('timelineModal').classList.remove('active');
        };

        window.closeDocumentsModal = function() {
            document.getElementById('documentsModal').classList.remove('active');
        };


        // Submit Transport Request
        window.submitTransportRequest = async function() {
            if (!currentMRF) {
                showToast('No MRF selected', 'error');
                return;
            }
            if (!currentMRF.id) {
                showToast('Invalid MRF data', 'error');
                return;
            }
            if (!confirm('Submit Transport Request to Finance for approval?')) return;

            showLoading(true);
            try {
                const { collection, getDocs, addDoc, doc, updateDoc } = window.firestore;
                const items = JSON.parse(currentMRF.items_json);

                // Get delivery address - ensure element exists
                const deliveryAddressEl = document.getElementById('deliveryAddress');
                const deliveryAddress = deliveryAddressEl ? deliveryAddressEl.value : (currentMRF.delivery_address || '');

                // Calculate total cost from items - read from DOM inputs like saveProgress does
                let totalCost = 0;
                const updatedItems = items.map((item, index) => {
                    const qty = parseFloat(item.qty || item.quantity || 0);
                    // Read unit_cost from DOM input field, fallback to stored value
                    const unitCostInput = document.querySelector(`input.unit-cost[data-index="${index}"]`);
                    const unitCost = unitCostInput ? (parseFloat(unitCostInput.value) || 0) : parseFloat(item.unit_cost || 0);
                    // Read supplier from DOM select field, fallback to stored value
                    const supplierSelect = document.querySelector(`select.supplier-select[data-index="${index}"]`);
                    const supplier = supplierSelect ? (supplierSelect.value || item.supplier || '') : (item.supplier || '');

                    totalCost += qty * unitCost;

                    return {
                        item: item.item || item.item_name,
                        qty: qty,
                        unit: item.unit,
                        category: item.category || 'N/A',
                        unit_cost: unitCost,
                        supplier: supplier,
                        subtotal: qty * unitCost
                    };
                });

                // Generate TR ID without orderBy to avoid index requirement
                const year = new Date().getFullYear();
                const trsRef = collection(window.db, 'transport_requests');
                const snapshot = await getDocs(trsRef);

                let maxNum = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.tr_id) {
                        const match = data.tr_id.match(/TR-\d{4}-(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (num > maxNum) maxNum = num;
                        }
                    }
                });

                const trId = `TR-${year}-${String(maxNum + 1).padStart(3, '0')}`;

                // Create transport_requests document for tracking
                // Store ONLY in transport_requests collection (no PR document needed for transport)
                // This matches how materials work - single collection with finance_status for approval workflow
                await addDoc(collection(window.db, 'transport_requests'), {
                    tr_id: trId,
                    mrf_id: currentMRF.mrf_id,
                    mrf_doc_id: currentMRF.id,
                    project_name: currentMRF.project_name,
                    requestor_name: currentMRF.requestor_name,
                    delivery_address: deliveryAddress,
                    items_json: JSON.stringify(updatedItems),  // Use updated items with costs from DOM
                    justification: currentMRF.justification || '',
                    cost: totalCost,
                    total_amount: totalCost,  // Also save as total_amount for consistency with materials
                    finance_status: 'Pending',  // Use finance_status like materials do
                    date_submitted: new Date().toISOString().split('T')[0],
                    created_at: new Date().toISOString()
                });

                await updateDoc(doc(window.db, 'mrfs', currentMRF.id), {
                    status: 'TR Submitted',
                    tr_id: trId,
                    items_json: JSON.stringify(updatedItems),  // Save updated items with costs from DOM
                    updated_at: new Date().toISOString()
                });

                showToast('TR ' + trId + ' submitted successfully!', 'success');

                // Update currentMRF with new status, tr_id, and updated items
                if (currentMRF) {
                    currentMRF.status = 'TR Submitted';
                    currentMRF.tr_id = trId;
                    currentMRF.items_json = JSON.stringify(updatedItems);  // Update in-memory items with costs
                    renderMRFDetails(currentMRF);
                }

            } catch (error) {
                console.error('Error submitting TR:', error);
                showToast('Failed to submit: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        async function init() {
            await loadSuppliers();
            await loadMRFs();
            await loadPOTracking();
            await loadHistoricalMRFs();
        }

        // Load suppliers with real-time updates
        async function loadSuppliers() {
            const suppliersRef = collection(db, 'suppliers');
            
            // Real-time listener
            onSnapshot(suppliersRef, (snapshot) => {
                suppliersData = [];
                snapshot.forEach((doc) => {
                    suppliersData.push({ id: doc.id, ...doc.data() });
                });
                renderSuppliersTable();
                console.log('Suppliers updated:', suppliersData.length);
            });
        }

        // Load MRFs with real-time updates
        window.loadMRFs = async function() {
            console.log('ðŸ” Setting up MRF listener...');
            const mrfsRef = collection(db, 'mrfs');
            const statuses = ['Pending', 'In Progress', 'PR Rejected', 'Finance Rejected'];
            console.log(' Querying statuses:', statuses);
            const q = query(mrfsRef, where('status', 'in', statuses));
            
            onSnapshot(q, (snapshot) => {
                console.log('ðŸ”” MRF snapshot received, documents:', snapshot.size);
                const allMRFs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('  ', doc.id, '- Status:', data.status, '- Type:', data.request_type, '- MRF ID:', data.mrf_id);
                    allMRFs.push({ id: doc.id, ...data });
                });
                
                // Separate by request type
                const materialMRFs = allMRFs.filter(m => m.request_type !== 'service');
                const transportMRFs = allMRFs.filter(m => m.request_type === 'service');
                
                // Sort by date_needed (nearest deadline first)
                const sortByDeadline = (a, b) => {
                    const dateA = new Date(a.date_needed);
                    const dateB = new Date(b.date_needed);
                    return dateA - dateB; // ascending order (nearest first)
                };
                
                materialMRFs.sort(sortByDeadline);
                transportMRFs.sort(sortByDeadline);
                
                console.log(' Rendering - Material:', materialMRFs.length, 'Transport:', transportMRFs.length);
                renderMRFList(materialMRFs, transportMRFs);
            }, (error) => {
                console.error(' MRF listener error:', error);
                showToast('Error loading MRFs: ' + error.message, 'error');
            });
        }

        // Render MRF list
       function renderMRFList(materialMRFs, transportMRFs) {
    console.log('ðŸŽ¨ Rendering MRF list...');
    console.log('  Material MRFs to render:', materialMRFs.length);
    console.log('  Transport MRFs to render:', transportMRFs.length);
    
    const mrfList = document.getElementById('mrfList');
    if (!mrfList) {
        console.error('âŒ mrfList element not found!');
        return;
    }
    
    let html = '';
    
    // Material Requests Section
    html += '<div style="font-weight: 600; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">Material Requests</div>';
    
    if (materialMRFs.length === 0) {
        html += '<div style="text-align: center; padding: 1rem; color: #999; font-size: 0.875rem;">No pending material requests</div>';
    } else {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        html += materialMRFs.map(mrf => {
        const dateNeeded = new Date(mrf.date_needed);
        dateNeeded.setHours(0, 0, 0, 0);
        const daysRemaining = Math.ceil((dateNeeded - today) / (1000 * 60 * 60 * 24));
        
        // Check if rejected
        const isRejected = mrf.status === 'PR Rejected';
        const rejectionStyle = isRejected ? 'border: 4px solid #dc2626; background: #fee2e2;' : '';
        
        let urgencyColor, urgencyBg;
        if (daysRemaining <= 3) {
            urgencyColor = '#dc2626';
            urgencyBg = '#fee2e2';
        } else if (daysRemaining <= 10) {
            urgencyColor = '#f59e0b';
            urgencyBg = '#fef3c7';
        } else {
            urgencyColor = '#059669';
            urgencyBg = '#d1fae5';
        }

        return `
            <div class="mrf-item" data-mrf-id="${mrf.id}" onclick="selectMRF('${mrf.id}', this)" 
                 style="${rejectionStyle} border-left: 4px solid ${urgencyColor};">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                    ${mrf.mrf_id}
                    ${isRejected ? '<span style="color: #dc2626; font-size: 0.75rem; margin-left: 0.5rem;">PR REJECTED</span>' : ''}
                </div>
                <div style="font-size: 0.875rem; color: #5f6368;">${mrf.project_name}</div>
                ${isRejected ? `
                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.75rem; color: #dc2626;">
                        <strong>Reason:</strong> ${mrf.pr_rejection_reason || 'No reason provided'}
                    </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
                    <span style="color: #999;">Needed: ${new Date(mrf.date_needed).toLocaleDateString()}</span>
                    <span style="background: ${urgencyBg}; color: ${urgencyColor}; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600;">
                        ${daysRemaining} days
                    </span>
                </div>
            </div>
        `;
    }).join('');
    }
    
    // Transport Requests Section
    html += '<div style="font-weight: 600; padding: 0.5rem; background: #fef3c7; border-radius: 4px; margin: 1rem 0 0.5rem 0;">Pending Transportation Requests</div>';
    
    if (transportMRFs.length === 0) {
        html += '<div style="text-align: center; padding: 1rem; color: #999; font-size: 0.875rem;">No pending transport requests</div>';
    } else {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        html += transportMRFs.map(mrf => {
            const dateNeeded = new Date(mrf.date_needed);
            dateNeeded.setHours(0, 0, 0, 0);
            const daysRemaining = Math.ceil((dateNeeded - today) / (1000 * 60 * 60 * 24));
            
            const isRejected = mrf.status === 'PR Rejected';
            const rejectionStyle = isRejected ? 'border: 4px solid #dc2626; background: #fee2e2;' : '';
            
            let urgencyColor = '#f59e0b';
            let urgencyBg = '#fef3c7';
            
            return `
                <div class="mrf-item" data-mrf-id="${mrf.id}" onclick="selectMRF('${mrf.id}', this)" 
                     style="${rejectionStyle} border-left: 4px solid ${urgencyColor};">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">
                        ${mrf.mrf_id}
                        ${isRejected ? '<span style="color: #dc2626; font-size: 0.75rem; margin-left: 0.5rem;">PR REJECTED</span>' : ''}
                    </div>
                    <div style="font-size: 0.875rem; color: #5f6368;">${mrf.project_name}</div>
                    ${isRejected ? `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.75rem; color: #dc2626;">
                            <strong>Reason:</strong> ${mrf.pr_rejection_reason || 'No reason provided'}
                        </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
                        <span style="color: #999;">Needed: ${new Date(mrf.date_needed).toLocaleDateString()}</span>
                        <span style="background: ${urgencyBg}; color: ${urgencyColor}; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600;">
                            ${daysRemaining} days
                        </span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    console.log('âœ… Setting innerHTML, total length:', html.length, 'chars');
    mrfList.innerHTML = html;
    console.log('âœ… MRF list rendered successfully');
    
    // Clear MRF details if no pending MRFs
    if (materialMRFs.length === 0 && transportMRFs.length === 0) {
        currentMRF = null;
        const mrfDetails = document.getElementById('mrfDetails');
        if (mrfDetails) {
            mrfDetails.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #999;">
                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">No pending MRFs</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">Select an MRF from the list to view details</div>
                </div>
            `;
        }
        // Hide Generate PR button
        const generatePRBtn = document.getElementById('generatePRBtn');
        if (generatePRBtn) {
            generatePRBtn.style.display = 'none';
        }
    }
}

        // Select MRF
            window.selectMRF = async function(mrfId, element) {
                const mrfsRef = collection(db, 'mrfs');
                const snapshot = await getDocs(mrfsRef);
    
                snapshot.forEach((doc) => {
                    if (doc.id === mrfId) {
                        currentMRF = { id: doc.id, ...doc.data() };
                }
            });

    if (currentMRF) {
        renderMRFDetails(currentMRF);
        
        // Update selected state
        document.querySelectorAll('.mrf-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
    }
};

        // Render MRF details
        function renderMRFDetails(mrf) {
            const items = JSON.parse(mrf.items_json);
            
            // Show correct button based on request type
            const isService = mrf.request_type === 'service';
            const canEdit = mrf.status === 'Pending' || mrf.status === 'In Progress';
            
            let buttons = '<button class="btn btn-primary" onclick="saveProgress()"> Save</button>';
            if (canEdit) {
                if (isService) {
                    buttons += ' <button class="btn btn-success" onclick="submitTransportRequest()"> Submit to Finance</button>';
                } else {
                    buttons += ' <button class="btn btn-success" onclick="generatePR()"> Generate PR</button>';
                }
            }
            document.getElementById('mrfActions').innerHTML = buttons;
            
            const requestTypeLabel = mrf.request_type === 'service' ? 
                'Delivery/Hauling/Transportation' : 'Material Request';
            
            const details = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: #5f6368;">MRF ID</div>
                        <div style="font-weight: 600;">${mrf.mrf_id}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #5f6368;">Request Type</div>
                        <div style="font-weight: 600;">${requestTypeLabel}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #5f6368;">Project</div>
                        <div style="font-weight: 600;">${mrf.project_name}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #5f6368;">Requestor</div>
                        <div>${mrf.requestor_name}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #5f6368;">Date Needed</div>
                        <div>${new Date(mrf.date_needed).toLocaleDateString()}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #5f6368;">Status</div>
                        <div>${mrf.status}</div>
                    </div>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="font-size: 0.875rem; font-weight: 500; display: block; margin-bottom: 0.5rem;">Delivery Address</label>
                    <textarea id="deliveryAddress" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #dadce0; border-radius: 4px;">${mrf.delivery_address || ''}</textarea>
                </div>

                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Qty</th>
                            <th>Unit</th>
                            <th>Unit Cost (PHP)</th>
                            <th>Supplier</th>
                            <th>Subtotal (PHP)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => `
                            <tr>
                                <td>${item.item || item.item_name}</td>
                                <td>${item.category || 'N/A'}</td>
                                <td>${item.qty || item.quantity}</td>
                                <td>${item.unit}</td>
                                <td>
                                    <input type="number" 
                                           class="unit-cost" 
                                           data-index="${index}" 
                                           value="${item.unit_cost || ''}"
                                           step="0.01"
                                           placeholder="0.00"
                                           oninput="calculateSubtotal(${index})">
                                </td>
                                <td>
                                    <select class="supplier-select" data-index="${index}">
                                        <option value="">Select Supplier</option>
                                        ${suppliersData.map(s => `
                                            <option value="${s.supplier_name}" ${s.supplier_name === item.supplier ? 'selected' : ''}>
                                                ${s.supplier_name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </td>
                                <td class="subtotal-cell" id="subtotal-${index}">
                                    PHP  ${((item.qty || item.quantity) * (item.unit_cost || 0)).toLocaleString('en-PH', {minimumFractionDigits: 2})}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" style="text-align: right; font-weight: 600;">TOTAL:</td>
                            <td id="grandTotal" style="font-weight: 600;">PHP  0.00</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            document.getElementById('mrfDetails').innerHTML = details;
            calculateGrandTotal();
        }

        // Calculate subtotal
        window.calculateSubtotal = function(index) {
            if (!currentMRF || !currentMRF.items_json) return;
            const items = JSON.parse(currentMRF.items_json);
            const qty = items[index].qty || items[index].quantity || 0;
            const unitCost = parseFloat(document.querySelector(`input.unit-cost[data-index="${index}"]`).value) || 0;
            const subtotal = qty * unitCost;
            
            document.getElementById(`subtotal-${index}`).textContent = `PHP  ${subtotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            calculateGrandTotal();
        };

        // Calculate grand total
        function calculateGrandTotal() {
            if (!currentMRF || !currentMRF.items_json) return;
            const items = JSON.parse(currentMRF.items_json);
            let total = 0;
            
            items.forEach((item, index) => {
                const qty = item.qty || item.quantity || 0;
                const unitCostInput = document.querySelector(`input.unit-cost[data-index="${index}"]`);
                const unitCost = unitCostInput ? (parseFloat(unitCostInput.value) || 0) : 0;
                total += qty * unitCost;
            });
            
            document.getElementById('grandTotal').textContent = `PHP  ${total.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
        }

        // Save progress
        window.saveProgress = async function() {
            if (!currentMRF) return;

            const items = JSON.parse(currentMRF.items_json);
            const updatedItems = items.map((item, index) => {
                const unitCost = parseFloat(document.querySelector(`input.unit-cost[data-index="${index}"]`).value) || 0;
                const supplier = document.querySelector(`select.supplier-select[data-index="${index}"]`).value;
                
                return {
                    item: item.item || item.item_name,
                    qty: item.qty || item.quantity,
                    unit: item.unit,
                    category: item.category || 'N/A',  // Add this line
                    unit_cost: unitCost,
                    supplier: supplier,
                    subtotal: (item.qty || item.quantity) * unitCost
                    };
            });

            const deliveryAddress = document.getElementById('deliveryAddress').value;

            showLoading(true);

            try {
                const mrfRef = doc(db, 'mrfs', currentMRF.id);
                await updateDoc(mrfRef, {
                    items_json: JSON.stringify(updatedItems),
                    delivery_address: deliveryAddress,
                    status: 'In Progress',
                    updated_at: new Date().toISOString()
                });

                showToast('Progress saved successfully', 'success');
            } catch (error) {
                console.error('Error saving progress:', error);
                showToast('Ã¢ÂÅ’ Failed to save progress', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Generate PR - handles creating new PRs, updating rejected PRs, and merging with approved PRs
        window.generatePR = async function() {
            if (!currentMRF) return;

            // Save a local copy of the MRF to avoid race conditions with onSnapshot
            // (when we update MRF status, it may be removed from the query results,
            // which could set currentMRF to null before we finish processing)
            const mrfData = { ...currentMRF };

            const items = JSON.parse(mrfData.items_json);

            // Validate all items have costs and suppliers
            for (let i = 0; i < items.length; i++) {
                const unitCostInput = document.querySelector(`input.unit-cost[data-index="${i}"]`);
                const supplierSelect = document.querySelector(`select.supplier-select[data-index="${i}"]`);
                
                const unitCost = parseFloat(unitCostInput?.value) || 0;
                const supplier = supplierSelect?.value || '';
                
                if (unitCost === 0) {
                    showToast(`Please enter unit cost for item: ${items[i].item || items[i].item_name}`, 'error');
                    return;
                }
                
                if (!supplier) {
                    showToast(`Please select supplier for item: ${items[i].item || items[i].item_name}`, 'error');
                    return;
                }
            }

            // Collect final items data with suppliers
            const prItems = items.map((item, index) => {
                const unitCost = parseFloat(document.querySelector(`input.unit-cost[data-index="${index}"]`).value) || 0;
                const supplier = document.querySelector(`select.supplier-select[data-index="${index}"]`).value;
                
                return {
                    item: item.item || item.item_name,
                    category: item.category || 'N/A',
                    qty: item.qty || item.quantity,
                    unit: item.unit,
                    unit_cost: unitCost,
                    supplier: supplier,
                    subtotal: (item.qty || item.quantity) * unitCost
                };
            });

            // Group items by supplier
            const itemsBySupplier = {};
            prItems.forEach(item => {
                if (!itemsBySupplier[item.supplier]) {
                    itemsBySupplier[item.supplier] = [];
                }
                itemsBySupplier[item.supplier].push(item);
            });


            const suppliers = Object.keys(itemsBySupplier);

            showLoading(true);

            try {
                const prsRef = collection(db, 'prs');

                // Check for existing PRs for this MRF
                const existingPRsQuery = query(prsRef, where('mrf_id', '==', mrfData.mrf_id));
                const existingPRsSnapshot = await getDocs(existingPRsQuery);

                // Organize existing PRs by supplier and status
                const existingPRsBySupplier = {};
                const rejectedPRs = [];
                const approvedPRs = [];

                existingPRsSnapshot.forEach((docSnap) => {
                    const pr = { id: docSnap.id, ...docSnap.data() };
                    const supplierName = pr.supplier_name;

                    if (!existingPRsBySupplier[supplierName]) {
                        existingPRsBySupplier[supplierName] = [];
                    }
                    existingPRsBySupplier[supplierName].push(pr);

                    if (pr.finance_status === 'Rejected') {
                        rejectedPRs.push(pr);
                    } else if (pr.finance_status === 'Approved') {
                        approvedPRs.push(pr);
                    }
                });

                console.log('ðŸ“‹ Existing PRs for this MRF:', existingPRsSnapshot.size);
                console.log('   Rejected PRs:', rejectedPRs.length);
                console.log('   Approved PRs:', approvedPRs.length);

                // Prepare confirmation message based on what will happen
                let updatedCount = 0;
                let mergedCount = 0;
                let newCount = 0;

                for (const supplier of suppliers) {
                    const existingForSupplier = existingPRsBySupplier[supplier] || [];
                    const rejectedForSupplier = existingForSupplier.filter(pr => pr.finance_status === 'Rejected');
                    const approvedForSupplier = existingForSupplier.filter(pr => pr.finance_status === 'Approved');

                    if (rejectedForSupplier.length > 0) {
                        updatedCount++;
                    } else if (approvedForSupplier.length > 0) {
                        mergedCount++;
                    } else {
                        newCount++;
                    }
                }

                const actions = [];
                if (updatedCount > 0) actions.push(`update ${updatedCount} rejected PR(s)`);
                if (mergedCount > 0) actions.push(`merge into ${mergedCount} approved PR(s)`);
                if (newCount > 0) actions.push(`create ${newCount} new PR(s)`);

                const confirmMsg = `Generate Purchase Request(s)? This will ${actions.join(', ')} for suppliers: ${suppliers.join(', ')}.`;

                showLoading(false);
                if (!confirm(confirmMsg)) {
                    return;
                }
                showLoading(true);

                // Get next PR numbers for current month (only needed for truly new PRs)
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const currentMonthPrefix = `PR_${year}_${month}`;
                const allPRsSnapshot = await getDocs(prsRef);

                let maxNum = 0;
                allPRsSnapshot.forEach((docSnap) => {
                    const pr = docSnap.data();
                    if (pr.pr_id && pr.pr_id.startsWith(currentMonthPrefix)) {
                        const match = pr.pr_id.match(/PR_\d{4}_\d{2}-(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (num > maxNum) {
                                maxNum = num;
                            }
                        }
                    }
                });

                let nextNum = maxNum + 1;
                const generatedPRIds = [];
                const updatedPRIds = [];
                const mergedPRIds = [];

                // Process each supplier
                for (const supplier of suppliers) {
                    const supplierItems = itemsBySupplier[supplier];
                    const supplierTotal = supplierItems.reduce((sum, item) => sum + item.subtotal, 0);

                    const existingForSupplier = existingPRsBySupplier[supplier] || [];
                    const rejectedForSupplier = existingForSupplier.filter(pr => pr.finance_status === 'Rejected');
                    const approvedForSupplier = existingForSupplier.filter(pr => pr.finance_status === 'Approved');

                    if (rejectedForSupplier.length > 0) {
                        // CASE 1: Update the rejected PR instead of creating new one
                        const rejectedPR = rejectedForSupplier[rejectedForSupplier.length - 1];

                        console.log(`ðŸ“ Updating rejected PR ${rejectedPR.pr_id} for supplier ${supplier}`);

                        const prRef = doc(db, 'prs', rejectedPR.id);
                        await updateDoc(prRef, {
                            items_json: JSON.stringify(supplierItems),
                            total_amount: supplierTotal,
                            finance_status: 'Pending',
                            delivery_address: document.getElementById('deliveryAddress').value,
                            date_generated: new Date().toISOString().split('T')[0],
                            updated_at: new Date().toISOString(),
                            reprocessed: true,
                            reprocessed_at: new Date().toISOString()
                        });

                        updatedPRIds.push(rejectedPR.pr_id);
                        generatedPRIds.push(rejectedPR.pr_id);

                    } else if (approvedForSupplier.length > 0) {
                        // CASE 2: Merge items into existing approved PR
                        const approvedPR = approvedForSupplier[approvedForSupplier.length - 1];

                        console.log(`ðŸ”— Merging items into approved PR ${approvedPR.pr_id} for supplier ${supplier}`);

                        const existingItems = JSON.parse(approvedPR.items_json || '[]');

                        // Add new items (avoid duplicates by checking item name)
                        const existingItemNames = existingItems.map(i => i.item || i.item_name);
                        const itemsToAdd = supplierItems.filter(newItem => {
                            const itemName = newItem.item || newItem.item_name;
                            return !existingItemNames.includes(itemName);
                        });

                        if (itemsToAdd.length > 0) {
                            const mergedItems = [...existingItems, ...itemsToAdd];
                            const mergedTotal = mergedItems.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);

                            const prRef = doc(db, 'prs', approvedPR.id);
                            await updateDoc(prRef, {
                                items_json: JSON.stringify(mergedItems),
                                total_amount: mergedTotal,
                                updated_at: new Date().toISOString(),
                                items_merged: true,
                                last_merge_date: new Date().toISOString()
                            });

                            mergedPRIds.push(approvedPR.pr_id);
                            console.log(`   Added ${itemsToAdd.length} new items to ${approvedPR.pr_id}`);
                        } else {
                            console.log(`   No new items to add to ${approvedPR.pr_id}`);
                        }

                        generatedPRIds.push(approvedPR.pr_id);

                    } else {
                        // CASE 3: Create new PR (no existing PR for this supplier)
                        const firstWord = supplier.split(/\s+/)[0] || supplier;
                        const supplierSlug = firstWord.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_').toUpperCase();
                        const prId = `PR_${year}_${month}-${String(nextNum).padStart(3, '0')}-${supplierSlug}`;

                        console.log(`âž• Creating new PR ${prId} for supplier ${supplier}`);

                        const prDoc = {
                            pr_id: prId,
                            mrf_id: mrfData.mrf_id,
                            mrf_doc_id: mrfData.id,
                            supplier_name: supplier,
                            project_name: mrfData.project_name,
                            requestor_name: mrfData.requestor_name,
                            delivery_address: document.getElementById('deliveryAddress').value,
                            items_json: JSON.stringify(supplierItems),
                            total_amount: supplierTotal,
                            finance_status: 'Pending',
                            date_generated: new Date().toISOString().split('T')[0],
                            created_at: new Date().toISOString()
                        };

                        await addDoc(collection(db, 'prs'), prDoc);
                        generatedPRIds.push(prId);
                        nextNum++;
                    }
                }

                // Delete rejected PRs that were NOT updated (supplier was changed)
                // These are rejected PRs for suppliers not in the new supplier list
                const deletedPRIds = [];
                for (const rejectedPR of rejectedPRs) {
                    // Skip if this rejected PR was updated (reused for the same supplier)
                    if (updatedPRIds.includes(rejectedPR.pr_id)) {
                        continue;
                    }
                    // Delete the orphaned rejected PR
                    console.log(`ðŸ—‘ï¸ Deleting orphaned rejected PR ${rejectedPR.pr_id} (supplier changed)`);
                    const prRef = doc(db, 'prs', rejectedPR.id);
                    await deleteDoc(prRef);
                    deletedPRIds.push(rejectedPR.pr_id);
                }

                // Update MRF status with all PR IDs
                const mrfRef = doc(db, 'mrfs', mrfData.id);
                const mrfUpdate = {
                    status: 'PR Generated',
                    pr_ids: generatedPRIds,
                    items_json: JSON.stringify(prItems),
                    updated_at: new Date().toISOString(),
                    // Clear rejection flags since we've reprocessed
                    pr_rejection_reason: null,
                    rejected_pr_id: null,
                    is_rejected: false
                };
                await updateDoc(mrfRef, mrfUpdate);

                // Build success message
                const msgParts = [];
                if (updatedPRIds.length > 0) {
                    msgParts.push(`Updated ${updatedPRIds.length} rejected PR(s): ${updatedPRIds.join(', ')}`);
                }
                if (mergedPRIds.length > 0) {
                    msgParts.push(`Merged items into ${mergedPRIds.length} approved PR(s): ${mergedPRIds.join(', ')}`);
                }
                const newPRIds = generatedPRIds.filter(id => !updatedPRIds.includes(id) && !mergedPRIds.includes(id));
                if (newPRIds.length > 0) {
                    msgParts.push(`Created ${newPRIds.length} new PR(s): ${newPRIds.join(', ')}`);
                }
                if (deletedPRIds.length > 0) {
                    msgParts.push(`Removed ${deletedPRIds.length} old rejected PR(s): ${deletedPRIds.join(', ')}`);
                }

                showToast(`PR(s) processed successfully! ${msgParts.join('. ')}`, 'success');

                // Refresh MRF data using our local copy (currentMRF may have been cleared by onSnapshot)
                mrfData.status = 'PR Generated';
                renderMRFDetails(mrfData);

            } catch (error) {
                console.error('Error generating PR:', error);
                showToast('âŒ Failed to generate PR', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Render suppliers table
        function renderSuppliersTable() {
            const tbody = document.getElementById('suppliersTableBody');
            
            if (suppliersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No suppliers yet. Add your first supplier!</td></tr>';
                return;
            }

            tbody.innerHTML = suppliersData.map(supplier => {
                if (editingSupplier === supplier.id) {
                    return `
                        <tr class="edit-row">
                            <td><input type="text" value="${supplier.supplier_name}" id="edit-name"></td>
                            <td><input type="text" value="${supplier.contact_person}" id="edit-contact"></td>
                            <td><input type="email" value="${supplier.email}" id="edit-email"></td>
                            <td><input type="text" value="${supplier.phone}" id="edit-phone"></td>
                            <td class="actions">
                                <button class="btn btn-success" onclick="saveEdit('${supplier.id}')">Save</button>
                                <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                            </td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td>${supplier.supplier_name}</td>
                            <td>${supplier.contact_person}</td>
                            <td>${supplier.email}</td>
                            <td>${supplier.phone}</td>
                            <td class="actions">
                                <button class="icon-btn" onclick="editSupplier('${supplier.id}')">Edit</button>
                                <button class="icon-btn" onclick="deleteSupplier('${supplier.id}', '${supplier.supplier_name}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }
            }).join('');
        }

        // Toggle add form
        window.toggleAddForm = function() {
            const form = document.getElementById('addSupplierForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
                clearAddForm();
            }
        };

        // Clear add form
        function clearAddForm() {
            document.getElementById('newSupplierName').value = '';
            document.getElementById('newContactPerson').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newPhone').value = '';
        }

        // Add supplier
        window.addSupplier = async function() {
            const supplier_name = document.getElementById('newSupplierName').value.trim();
            const contact_person = document.getElementById('newContactPerson').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const phone = document.getElementById('newPhone').value.trim();

            if (!supplier_name || !contact_person || !email || !phone) {
                showToast('Ã¢ÂÅ’ Please fill in all fields', 'error');
                return;
            }

            showLoading(true);

            try {
                await addDoc(collection(db, 'suppliers'), {
                    supplier_name,
                    contact_person,
                    email,
                    phone,
                    created_at: new Date().toISOString()
                });

                showToast(`Supplier "${supplier_name}" added successfully!`, 'success');
                toggleAddForm();
            } catch (error) {
                console.error('Error adding supplier:', error);
                showToast('Ã¢ÂÅ’ Failed to add supplier', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Edit supplier
        window.editSupplier = function(supplierId) {
            editingSupplier = supplierId;
            renderSuppliersTable();
        };

        // Cancel edit
        window.cancelEdit = function() {
            editingSupplier = null;
            renderSuppliersTable();
        };

        // Save edit
        window.saveEdit = async function(supplierId) {
            const supplier_name = document.getElementById('edit-name').value.trim();
            const contact_person = document.getElementById('edit-contact').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();

            if (!supplier_name || !contact_person || !email || !phone) {
                showToast('Ã¢ÂÅ’ Please fill in all fields', 'error');
                return;
            }

            showLoading(true);

            try {
                const supplierRef = doc(db, 'suppliers', supplierId);
                await updateDoc(supplierRef, {
                    supplier_name,
                    contact_person,
                    email,
                    phone,
                    updated_at: new Date().toISOString()
                });

                showToast('Supplier updated successfully', 'success');
                editingSupplier = null;
                // Explicitly render to immediately update UI (onSnapshot will also trigger)
                renderSuppliersTable();
            } catch (error) {
                console.error('Error updating supplier:', error);
                showToast('Ã¢ÂÅ’ Failed to update supplier', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Delete supplier
        window.deleteSupplier = async function(supplierId, supplierName) {
            if (!confirm(`Are you sure you want to delete supplier "${supplierName}"?`)) {
                return;
            }

            showLoading(true);

            try {
                await deleteDoc(doc(db, 'suppliers', supplierId));
                showToast(`Supplier "${supplierName}" deleted`, 'success');
            } catch (error) {
                console.error('Error deleting supplier:', error);
                showToast('Ã¢ÂÅ’ Failed to delete supplier', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Tab switching
        window.switchTab = function(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');
        };

        // Show toast
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        window.showToast = showToast;

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        window.showLoading = showLoading;

        // Historical MRFs functionality
        let allHistoricalMRFs = [];
        let filteredHistoricalMRFs = [];

        window.loadHistoricalMRFs = async function() {
            console.log('Loading historical MRFs...');
            try {
                const mrfsRef = collection(db, 'mrfs');
                // Load MRFs that have moved past "In Progress"
                const historicalStatuses = ['TR Submitted', 'PR Generated', 'Finance Approved', 'PO Issued', 'Delivered', 'Completed'];
                const q = query(mrfsRef, where('status', 'in', historicalStatuses));
                
                const snapshot = await getDocs(q);
                allHistoricalMRFs = [];
                
                snapshot.forEach((doc) => {
                    allHistoricalMRFs.push({ id: doc.id, ...doc.data() });
                });

                // Deduplicate by mrf_id - keep only unique MRFs
                const seenMrfIds = new Set();
                allHistoricalMRFs = allHistoricalMRFs.filter(mrf => {
                    if (seenMrfIds.has(mrf.mrf_id)) {
                        return false; // Skip duplicate
                    }
                    seenMrfIds.add(mrf.mrf_id);
                    return true;
                });

                console.log('Loaded historical MRFs:', allHistoricalMRFs.length);
                
                // Sort: non-completed first, then by date
                allHistoricalMRFs.sort((a, b) => {
                    // Completed status goes to bottom
                    if (a.status === 'Completed' && b.status !== 'Completed') return 1;
                    if (a.status !== 'Completed' && b.status === 'Completed') return -1;
                    
                    // Otherwise sort by date (most recent first)
                    const dateA = new Date(a.date_submitted || a.created_at);
                    const dateB = new Date(b.date_submitted || b.created_at);
                    return dateB - dateA;
                });
                
                filteredHistoricalMRFs = [...allHistoricalMRFs];
                renderHistoricalMRFs();
                
            } catch (error) {
                console.error('Error loading historical MRFs:', error);
                showToast('Failed to load historical MRFs', 'error');
            }
        };

        window.filterHistoricalMRFs = function() {
            const searchTerm = document.getElementById('historicalSearch').value.toLowerCase();
            const statusFilter = document.getElementById('historicalStatusFilter').value;
            const typeFilter = document.getElementById('historicalTypeFilter').value;
            const dateFrom = document.getElementById('historicalDateFrom').value;
            const dateTo = document.getElementById('historicalDateTo').value;
            
            filteredHistoricalMRFs = allHistoricalMRFs.filter(mrf => {
                // Search filter
                const matchSearch = !searchTerm || 
                    mrf.mrf_id.toLowerCase().includes(searchTerm) ||
                    mrf.project_name.toLowerCase().includes(searchTerm);
                
                // Status filter
                const matchStatus = !statusFilter || mrf.status === statusFilter;
                
                // Type filter
                const matchType = !typeFilter || mrf.request_type === typeFilter;
                
                // Date filters
                const mrfDate = new Date(mrf.date_submitted || mrf.created_at);
                const matchDateFrom = !dateFrom || mrfDate >= new Date(dateFrom);
                const matchDateTo = !dateTo || mrfDate <= new Date(dateTo);
                
                return matchSearch && matchStatus && matchType && matchDateFrom && matchDateTo;
            });
            
            renderHistoricalMRFs();
        }

        window.renderHistoricalMRFs = async function() {
            const tbody = document.getElementById('historicalMRFsBody');
            
            if (filteredHistoricalMRFs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #999;">No historical MRFs found</td></tr>';
                return;
            }
            
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #999;">Loading document references...</td></tr>';
            
            // Fetch PR and PO data for all MRFs
            const rows = await Promise.all(filteredHistoricalMRFs.map(async (mrf) => {
                const type = mrf.request_type === 'service' ? 'Transport' : 'Material';
                
                // Status badge color
                let statusColor = '#999';
                if (mrf.status === 'Completed') statusColor = '#34a853';
                else if (mrf.status === 'Delivered') statusColor = '#34a853';
                else if (mrf.status === 'PO Issued') statusColor = '#1a73e8';
                else if (mrf.status === 'Finance Approved') statusColor = '#1a73e8';
                else if (mrf.status === 'PR Generated' || mrf.status === 'TR Submitted') statusColor = '#fbbc04';
                
                // Fetch PRs for this MRF
                let prHtml = '<span style="color: #999; font-size: 0.875rem;">-</span>';
                let totalCost = 0;
                let prCount = 0;
                let prApprovedCount = 0;
                if (type === 'Material') {
                    try {
                        const prsRef = collection(db, 'prs');
                        const prQuery = query(prsRef, where('mrf_id', '==', mrf.mrf_id));
                        const prSnapshot = await getDocs(prQuery);

                        if (!prSnapshot.empty) {
                            const prDataArray = [];
                            prSnapshot.forEach((doc) => {
                                const prData = doc.data();
                                // Skip rejected PRs - they should not appear in Historical MRFs
                                if (prData.finance_status === 'Rejected') {
                                    return;
                                }
                                prCount++;
                                // Check finance_status field (not status)
                                if (prData.finance_status === 'Approved') {
                                    prApprovedCount++;
                                }
                                prDataArray.push({
                                    docId: doc.id,
                                    pr_id: prData.pr_id,
                                    total_amount: parseFloat(prData.total_amount || 0)
                                });
                                totalCost += parseFloat(prData.total_amount || 0);
                            });
                            // Sort PR IDs by number (extract number from PR_YYYY_MM-NNN-SUPPLIER format)
                            prDataArray.sort((a, b) => {
                                const numA = parseInt((a.pr_id.match(/-(\d+)-/) || ['', '0'])[1]);
                                const numB = parseInt((b.pr_id.match(/-(\d+)-/) || ['', '0'])[1]);
                                return numA - numB;
                            });
                            const prIds = prDataArray.map(pr =>
                                `<a href="javascript:void(0)" onclick="viewPRDetails('${pr.docId}')" style="color: #1a73e8; text-decoration: none; font-weight: 600; display: inline-block; margin-right: 0.5rem;">${pr.pr_id}</a>`
                            );
                            prHtml = prIds.join('<br>');
                        }
                    } catch (error) {
                        console.error('Error fetching PRs for', mrf.mrf_id, error);
                    }
                } else if (type === 'Transport') {
                    // Fetch cost from transport_requests collection
                    try {
                        const trsRef = collection(db, 'transport_requests');
                        const trQuery = query(trsRef, where('mrf_id', '==', mrf.mrf_id));
                        const trSnapshot = await getDocs(trQuery);

                        if (!trSnapshot.empty) {
                            trSnapshot.forEach((doc) => {
                                const trData = doc.data();
                                totalCost = parseFloat(trData.total_amount || 0);
                            });
                        }

                        // Fallback: Calculate from MRF items_json if cost not found in TR
                        if (totalCost === 0 && mrf.items_json) {
                            const items = JSON.parse(mrf.items_json);
                            items.forEach(item => {
                                const qty = parseFloat(item.qty || item.quantity || 0);
                                const unitCost = parseFloat(item.unit_cost || 0);
                                totalCost += qty * unitCost;
                            });
                        }
                    } catch (error) {
                        console.error('Error fetching transport request cost for', mrf.mrf_id, error);
                    }
                }

                const totalCostHtml = totalCost > 0
                    ? `<strong style="color: #1f2937;">â‚±${totalCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</strong>`
                    : '<span style="color: #999; font-size: 0.875rem;">-</span>';

                // Fetch POs for this MRF (only for Material requests)
                let poHtml = '<span style="color: #999; font-size: 0.875rem;">-</span>';
                let poCount = 0;
                let poApprovedCount = 0;
                if (type === 'Material') {
                    try {
                        const posRef = collection(db, 'pos');
                        const poQuery = query(posRef, where('mrf_id', '==', mrf.mrf_id));
                        const poSnapshot = await getDocs(poQuery);

                        if (!poSnapshot.empty) {
                            const poDataArray = [];
                            poSnapshot.forEach((doc) => {
                                const poData = doc.data();
                                poCount++;
                                // POs are generated after finance approval, so count all as approved
                                // The comparison should be: poCount vs prCount (expected POs = number of PRs)
                                poApprovedCount++;
                                poDataArray.push({
                                    docId: doc.id,
                                    po_id: poData.po_id
                                });
                            });
                            // Sort PO IDs by number (extract number from PO_YYYY_MM-NNN-SUPPLIER format)
                            poDataArray.sort((a, b) => {
                                const numA = parseInt((a.po_id.match(/-(\d+)-/) || ['', '0'])[1]);
                                const numB = parseInt((b.po_id.match(/-(\d+)-/) || ['', '0'])[1]);
                                return numA - numB;
                            });
                            const poIds = poDataArray.map(po =>
                                `<a href="javascript:void(0)" onclick="viewPODetails('${po.docId}')" style="color: #34a853; text-decoration: none; font-weight: 600; display: inline-block; margin-right: 0.5rem;">${po.po_id}</a>`
                            );
                            poHtml = poIds.join('<br>');
                        }
                    } catch (error) {
                        console.error('Error fetching POs for', mrf.mrf_id, error);
                    }
                }

                // Calculate detailed status
                let detailedStatus = mrf.status;
                if (type === 'Material') {
                    if (mrf.status === 'PR Generated' && prCount > 0) {
                        if (prApprovedCount < prCount) {
                            detailedStatus = `${prApprovedCount}/${prCount} PR Approved`;
                        } else {
                            detailedStatus = 'PRs Approved';
                        }
                    } else if ((mrf.status === 'Finance Approved' || mrf.status === 'PO Issued') && prCount > 0) {
                        // Compare POs generated vs PRs (expected: 1 PO per PR minimum)
                        if (poCount < prCount) {
                            detailedStatus = `${poCount}/${prCount} PO Issued`;
                        } else {
                            detailedStatus = `${poCount}/${prCount} PO Issued`;
                        }
                    }
                }
                
                // Display TR ID for transport requests, MRF ID for material requests
                const displayId = (type === 'Transport' && mrf.tr_id) ? mrf.tr_id : mrf.mrf_id;

                return `
                    <tr>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;"><strong>${displayId}</strong></td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${totalCostHtml}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${prHtml}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${poHtml}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${mrf.project_name}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">${new Date(mrf.date_submitted || mrf.created_at).toLocaleDateString()}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb;">
                            <span style="background: ${statusColor}20; color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                ${detailedStatus}
                            </span>
                        </td>
                    </tr>
                `;
            }));
            
            tbody.innerHTML = rows.join('');
        }

        window.viewPRDetails = async function(prDocId) {
            console.log('Loading PR details for:', prDocId);
            showLoading(true);
            
            try {
                const prRef = doc(db, 'prs', prDocId);
                const prDoc = await getDoc(prRef);
                
                if (!prDoc.exists()) {
                    showToast('PR not found', 'error');
                    return;
                }
                
                const pr = { id: prDoc.id, ...prDoc.data() };
                const items = JSON.parse(pr.items_json || '[]');
                
                // Build modal content
                let modalContent = `
                    <h2 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                        Purchase Request Details: ${pr.pr_id}
                    </h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">PR ID</div>
                                <div style="font-weight: 600;">${pr.pr_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">MRF Reference</div>
                                <div style="font-weight: 600;">${pr.mrf_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Supplier</div>
                                <div style="font-weight: 600;">${pr.supplier_name || 'Not specified'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Project</div>
                                <div>${pr.project_name}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Date Generated</div>
                                <div>${pr.date_generated}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Status</div>
                                <div><span style="background: ${pr.finance_status === 'Approved' ? '#d1fae5' : '#fef3c7'}; color: ${pr.finance_status === 'Approved' ? '#065f46' : '#92400e'}; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-block;">${pr.finance_status || 'Pending'}</span></div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Total Amount</div>
                                <div style="font-weight: 600;">PHP ${parseFloat(pr.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Requestor</div>
                                <div>${pr.requestor_name}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: #5f6368; margin-bottom: 0.5rem;">Delivery Address</div>
                            <div style="padding: 0.75rem; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${pr.delivery_address || 'N/A'}</div>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem;">Items</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f3f4f6;">
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Item</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Category</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Qty</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Unit Cost</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                items.forEach(item => {
                    modalContent += `
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.item || item.item_name}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.category || 'N/A'}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.qty || item.quantity} ${item.unit}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">PHP ${parseFloat(item.unit_cost || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">PHP ${parseFloat(item.subtotal || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
                
                modalContent += `
                                </tbody>
                                <tfoot>
                                    <tr style="font-weight: 600;">
                                        <td colspan="4" style="padding: 0.75rem; text-align: right; border-top: 2px solid #e5e7eb;">TOTAL:</td>
                                        <td style="padding: 0.75rem; border-top: 2px solid #e5e7eb;">PHP ${parseFloat(pr.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="viewPRDocument('${pr.id}')" style="padding: 0.75rem 1.5rem;">View PR Document</button>
                            <button class="btn btn-success" onclick="downloadPRDocument('${pr.id}')" style="padding: 0.75rem 1.5rem;">Download PR Document</button>
                        </div>
                    </div>
                `;
                
                // Show in documents modal
                document.getElementById('documentsContent').innerHTML = modalContent;
                document.getElementById('documentsModal').classList.add('active');
                
                console.log('PR Details:', pr);
                
            } catch (error) {
                console.error('Error loading PR details:', error);
                showToast('Failed to load PR details', 'error');
            } finally {
                showLoading(false);
            }
        };

        
        window.viewPRDocument = async function(prDocId) {
            console.log('Viewing PR document for:', prDocId);
            
            try {
                // Generate and open PR document directly
                await generatePRDocument(prDocId);
            } catch (error) {
                console.error('Error viewing PR document:', error);
                showToast('Failed to open PR document', 'error');
            }
        };

        window.downloadPRDocument = async function(prDocId) {
            console.log('Downloading PR document for:', prDocId);
            
            try {
                // Generate and open PR document (user will Save as PDF)
                await generatePRDocument(prDocId);
            } catch (error) {
                console.error('Error downloading PR document:', error);
                showToast('Failed to download PR document', 'error');
            }
        };

        
        
        // ========================================
        // NATIVE PDF DOCUMENT GENERATION SYSTEM
        // Pure JavaScript - No external libraries or services
        // Uses browser's native Print-to-PDF functionality
        // ========================================

        // Configuration
        const DOCUMENT_CONFIG = {
            // Default values
            defaultFinancePIC: 'Ma. Thea Angela R. Lacsamana',
            companyInfo: {
                name: 'C Lacsamana Management and Construction Corporation',
                address: '133 Pinatubo St., Mandaluyong City, Metro Manila',
                tel: '09178182993',
                email: 'cgl@consultclm.com'
            }
        };

        /**
         * Generate PR Document - Native Print-Based Approach
         * @param {string} prDocId - Firestore document ID of the PR
         * @returns {void} - Opens print dialog
         */
        window.generatePRDocument = async function(prDocId) {
            console.log('Generating PR document for:', prDocId);
            showLoading(true);
            
            try {
                // Fetch PR data from Firestore
                const prRef = doc(db, 'prs', prDocId);
                const prDoc = await getDoc(prRef);
                
                if (!prDoc.exists()) {
                    throw new Error('PR not found');
                }
                
                const pr = prDoc.data();
                const items = JSON.parse(pr.items_json || '[]');
                
                // Prepare document data
                const documentData = {
                    PR_ID: pr.pr_id,
                    MRF_ID: pr.mrf_id,
                    DATE: formatDocumentDate(pr.date_generated || new Date().toISOString()),
                    PROJECT: pr.project_name,
                    ADDRESS: pr.delivery_address,
                    SUPPLIER: pr.supplier_name || 'Not specified',
                    ITEMS_TABLE: generateItemsTableHTML(items, 'PR'),
                    TOTAL_COST: formatCurrency(pr.total_amount),
                    REQUESTOR: pr.requestor_name,
                    PROCUREMENT_PIC: pr.procurement_pic || 'Procurement Team', // Procurement person who processed
                    FINANCE_PIC: pr.finance_approver || DOCUMENT_CONFIG.defaultFinancePIC,
                    DATE_APPROVED: pr.date_approved ? formatDocumentDate(pr.date_approved) : 'Pending',
                    IS_APPROVED: pr.finance_status === 'Approved' || pr.date_approved, // Check if approved
                    company_info: DOCUMENT_CONFIG.companyInfo
                };
                
                // Generate HTML and open in print window
                const html = generatePRHTML(documentData);
                openPrintWindow(html, documentData.PR_ID);
                
                showToast('PR document opened. Use browser Print â†’ Save as PDF', 'success');
                
            } catch (error) {
                console.error('Error generating PR document:', error);
                showToast('Failed to generate PR document', 'error');
                throw error;
            } finally {
                showLoading(false);
            }
        };

        /**
         * Generate PO Document - Native Print-Based Approach
         * @param {string} poDocId - Firestore document ID of the PO
         * @returns {void} - Opens print dialog
         */
        window.generatePODocument = async function(poDocId) {
            console.log('Generating PO document for:', poDocId);
            showLoading(true);
            
            try {
                // Fetch PO data from Firestore
                const poRef = doc(db, 'pos', poDocId);
                const poDoc = await getDoc(poRef);
                
                if (!poDoc.exists()) {
                    throw new Error('PO not found');
                }
                
                const po = poDoc.data();
                const items = JSON.parse(po.items_json || '[]');
                
                // Prepare document data
                const documentData = {
                    PO_ID: po.po_id,
                    PROJECT: po.project_name,
                    DATE: formatDocumentDate(po.date_issued || new Date().toISOString()),
                    SUPPLIER: po.supplier_name,
                    QUOTE_REF: po.quote_ref || 'N/A',
                    ITEMS_TABLE: generateItemsTableHTML(items, 'PO'),
                    DELIVERY_ADDRESS: po.delivery_address,
                    PAYMENT_TERMS: po.payment_terms || 'As per agreement',
                    CONDITION: po.condition || 'Standard terms apply',
                    DELIVERY_DATE: formatDocumentDate(po.delivery_date || 'TBD'),
                    FINANCE_PIC: po.finance_approver || DOCUMENT_CONFIG.defaultFinancePIC,
                    SIGNATURE_PLACEHOLDER: po.finance_signature_url || '', // URL to signature image
                    company_info: DOCUMENT_CONFIG.companyInfo
                };
                
                // Generate HTML and open in print window
                const html = generatePOHTML(documentData);
                openPrintWindow(html, documentData.PO_ID);
                
                showToast('PO document opened. Use browser Print â†’ Save as PDF', 'success');
                
            } catch (error) {
                console.error('Error generating PO document:', error);
                showToast('Failed to generate PO document', 'error');
                throw error;
            } finally {
                showLoading(false);
            }
        };

        /**
         * Generate HTML table for items
         * @param {Array} items - Array of item objects
         * @param {string} type - 'PR' or 'PO'
         * @returns {string} - HTML table string
         */
        function generateItemsTableHTML(items, type) {
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 5%;">No.</th>
                            <th style="width: 25%;">Description</th>
                            ${type === 'PR' ? '<th style="width: 15%;">Category</th>' : ''}
                            <th style="width: 10%;">Qty</th>
                            <th style="width: 10%;">Unit</th>
                            <th style="width: 15%;">Unit Cost</th>
                            <th style="width: 15%;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            items.forEach((item, index) => {
                const qty = item.qty || item.quantity || 0;
                const unitCost = parseFloat(item.unit_cost || 0);
                const subtotal = qty * unitCost;
                
                tableHTML += `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${item.item || item.item_name}</td>
                        ${type === 'PR' ? `<td>${item.category || 'N/A'}</td>` : ''}
                        <td style="text-align: center;">${qty}</td>
                        <td>${item.unit}</td>
                        <td style="text-align: right;">â‚±${formatCurrency(unitCost)}</td>
                        <td style="text-align: right;">â‚±${formatCurrency(subtotal)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }

        /**
         * Generate PR HTML document
         * @param {Object} data - Document data with all placeholders
         * @returns {string} - Complete HTML document
         */
        function generatePRHTML(data) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${data.PR_ID} - Purchase Request</title>
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 0.5in;
                            }
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 11pt;
                            line-height: 1.4;
                            color: #000;
                            max-width: 8.5in;
                            margin: 0 auto;
                            padding: 0.5in;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 14pt;
                            font-weight: bold;
                        }
                        .header p {
                            margin: 2px 0;
                            font-size: 9pt;
                        }
                        .title {
                            text-align: center;
                            font-size: 16pt;
                            font-weight: bold;
                            margin: 20px 0;
                            text-decoration: underline;
                        }
                        .section {
                            margin: 15px 0;
                        }
                        .field {
                            margin: 8px 0;
                            page-break-inside: avoid;
                        }
                        .label {
                            font-weight: bold;
                            display: inline-block;
                            width: 150px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            page-break-inside: avoid;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                            font-size: 10pt;
                        }
                        td {
                            font-size: 10pt;
                        }
                        .total {
                            font-size: 12pt;
                            font-weight: bold;
                            margin: 15px 0;
                            text-align: right;
                        }
                        .signatures {
                            margin-top: 40px;
                            page-break-inside: avoid;
                        }
                        .signature-line {
                            margin: 25px 0;
                        }
                        .signature-line .label {
                            width: 120px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${data.company_info.name}</h1>
                        <p>${data.company_info.address}</p>
                        <p>Tel: ${data.company_info.tel} | Email: ${data.company_info.email}</p>
                    </div>

                    <div class="title">PURCHASE REQUEST FORM (PR)</div>

                    <div class="section">
                        <div class="field"><span class="label">Document No.:</span> ${data.PR_ID}</div>
                        <div class="field"><span class="label">MRF Reference:</span> ${data.MRF_ID}</div>
                        <div class="field"><span class="label">Date:</span> ${data.DATE}</div>
                    </div>

                    <div class="section">
                        <div class="field"><span class="label">Project:</span> ${data.PROJECT}</div>
                        <div class="field"><span class="label">Delivery Address:</span> ${data.ADDRESS}</div>
                        <div class="field"><span class="label">Supplier:</span> ${data.SUPPLIER}</div>
                    </div>

                    <div class="section">
                        <h3 style="margin: 10px 0;">Items Requested:</h3>
                        ${data.ITEMS_TABLE}
                    </div>

                    <div class="total">
                        TOTAL AMOUNT: â‚±${data.TOTAL_COST}
                    </div>

                    <div class="signatures">
                        <div class="signature-line">
                            <span class="label">Requested By:</span> ${data.REQUESTOR}
                        </div>
                        <div class="signature-line">
                            <span class="label">Prepared By:</span> ${data.PROCUREMENT_PIC}
                        </div>
                        ${data.IS_APPROVED ? `
                        <div class="signature-line">
                            <span class="label">Approved By:</span> ${data.FINANCE_PIC}
                        </div>
                        <div class="signature-line">
                            <span class="label">Date Approved:</span> ${data.DATE_APPROVED}
                        </div>
                        ` : `
                        <div class="signature-line" style="margin-top: 40px;">
                            <span class="label">Approved By:</span> _______________________________
                        </div>
                        <div class="signature-line">
                            <span class="label">Date Approved:</span> _______________________________
                        </div>
                        `}
                    </div>
                </body>
                </html>
            `;
        }

        /**
         * Generate PO HTML document
         * @param {Object} data - Document data with all placeholders
         * @returns {string} - Complete HTML document
         */
        function generatePOHTML(data) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${data.PO_ID} - Purchase Order</title>
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 0.5in;
                            }
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 11pt;
                            line-height: 1.4;
                            color: #000;
                            max-width: 8.5in;
                            margin: 0 auto;
                            padding: 0.5in;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 14pt;
                            font-weight: bold;
                        }
                        .header p {
                            margin: 2px 0;
                            font-size: 9pt;
                        }
                        .title {
                            text-align: center;
                            font-size: 16pt;
                            font-weight: bold;
                            margin: 20px 0;
                            text-decoration: underline;
                        }
                        .section {
                            margin: 15px 0;
                        }
                        .field {
                            margin: 8px 0;
                            page-break-inside: avoid;
                        }
                        .label {
                            font-weight: bold;
                            display: inline-block;
                            width: 150px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            page-break-inside: avoid;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                            font-size: 10pt;
                        }
                        td {
                            font-size: 10pt;
                        }
                        .signature {
                            margin-top: 60px;
                            page-break-inside: avoid;
                        }
                        .signature-image {
                            max-width: 200px;
                            max-height: 60px;
                            margin: 10px 0;
                        }
                        .signature-line {
                            height: 60px;
                            border-bottom: 1px solid #000;
                            width: 200px;
                            margin: 10px 0;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${data.company_info.name}</h1>
                        <p>${data.company_info.address}</p>
                        <p>Tel: ${data.company_info.tel} | Email: ${data.company_info.email}</p>
                    </div>

                    <div class="title">PURCHASE ORDER</div>

                    <div class="section">
                        <div class="field"><span class="label">P.O. No.:</span> ${data.PO_ID}</div>
                        <div class="field"><span class="label">Project:</span> ${data.PROJECT}</div>
                        <div class="field"><span class="label">Date:</span> ${data.DATE}</div>
                        <div class="field"><span class="label">Supplier:</span> ${data.SUPPLIER}</div>
                        <div class="field"><span class="label">Quote Ref:</span> ${data.QUOTE_REF}</div>
                    </div>

                    <div class="section">
                        <h3 style="margin: 10px 0;">Order Details:</h3>
                        ${data.ITEMS_TABLE}
                    </div>

                    <div class="section">
                        <div class="field"><span class="label">Delivery Address:</span> ${data.DELIVERY_ADDRESS}</div>
                        <div class="field"><span class="label">Payment Terms:</span> ${data.PAYMENT_TERMS}</div>
                        <div class="field"><span class="label">Condition:</span> ${data.CONDITION}</div>
                        <div class="field"><span class="label">Delivery Date:</span> ${data.DELIVERY_DATE}</div>
                    </div>

                    <div class="signature">
                        <p><strong>Authorized By:</strong></p>
                        ${data.SIGNATURE_PLACEHOLDER ? 
                            `<img src="${data.SIGNATURE_PLACEHOLDER}" class="signature-image" alt="Signature">` : 
                            '<div class="signature-line"></div>'
                        }
                        <p><strong>${data.FINANCE_PIC}</strong></p>
                    </div>
                </body>
                </html>
            `;
        }

        /**
         * Open print window with generated HTML
         * @param {string} html - Complete HTML document
         * @param {string} filename - Suggested filename
         */
        function openPrintWindow(html, filename) {
            const printWindow = window.open('', '_blank');
            
            if (!printWindow) {
                alert('Please allow pop-ups to generate PDF documents');
                return;
            }
            
            printWindow.document.write(html);
            printWindow.document.close();

            // Wait for content to load, then trigger print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    
                    // Optional: Close window after print dialog closes
                    // Uncomment if you want automatic close
                    // printWindow.onafterprint = function() {
                    //     printWindow.close();
                    // };
                }, 250);
            };
        }

        /**
         * Format date for documents
         * @param {string} dateString - ISO date string
         * @returns {string} - Formatted date
         */
        function formatDocumentDate(dateString) {
            if (!dateString || dateString === 'TBD' || dateString === 'Pending') {
                return dateString;
            }
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        /**
         * Format currency value
         * @param {number} value - Numeric value
         * @returns {string} - Formatted currency
         */
        function formatCurrency(value) {
            return parseFloat(value || 0).toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // ========================================
        // END PDF GENERATION SYSTEM
        // ========================================

        window.viewPODocument = async function(poDocId) {
            console.log('Viewing PO document for:', poDocId);
            
            try {
                // Generate and open PO document directly
                await generatePODocument(poDocId);
            } catch (error) {
                console.error('Error viewing PO document:', error);
                showToast('Failed to open PO document', 'error');
            }
        };

        window.downloadPODocument = async function(poDocId) {
            console.log('Downloading PO document for:', poDocId);
            
            try {
                // Generate and open PO document (user will Save as PDF)
                await generatePODocument(poDocId);
            } catch (error) {
                console.error('Error downloading PO document:', error);
                showToast('Failed to download PO document', 'error');
            }
        };

        window.viewPODetails = async function(poDocId) {
            console.log('Loading PO details for:', poDocId);
            showLoading(true);
            
            try {
                const poRef = doc(db, 'pos', poDocId);
                const poDoc = await getDoc(poRef);
                
                if (!poDoc.exists()) {
                    showToast('PO not found', 'error');
                    return;
                }
                
                const po = { id: poDoc.id, ...poDoc.data() };
                const items = JSON.parse(po.items_json || '[]');
                
                // Build modal content
                let modalContent = `
                    <h2 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                        Purchase Order Details: ${po.po_id}
                    </h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">PO ID</div>
                                <div style="font-weight: 600;">${po.po_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">PR Reference</div>
                                <div style="font-weight: 600;">${po.pr_id || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">MRF Reference</div>
                                <div style="font-weight: 600;">${po.mrf_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Supplier</div>
                                <div style="font-weight: 600;">${po.supplier_name}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Project</div>
                                <div>${po.project_name}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Date Issued</div>
                                <div>${po.date_issued}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Delivery Status</div>
                                <div><span style="background: ${po.delivery_status === 'Delivered' ? '#d1fae5' : '#fef3c7'}; color: ${po.delivery_status === 'Delivered' ? '#065f46' : '#92400e'}; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-block;">${po.delivery_status || 'Pending'}</span></div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: #5f6368;">Total Amount</div>
                                <div style="font-weight: 600;">PHP ${parseFloat(po.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; color: #5f6368; margin-bottom: 0.5rem;">Delivery Address</div>
                            <div style="padding: 0.75rem; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${po.delivery_address || 'N/A'}</div>
                        </div>
                        
                        ${po.payment_terms ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.75rem; color: #5f6368; margin-bottom: 0.5rem;">Payment Terms</div>
                                <div style="padding: 0.75rem; background: #f9fafb; border-radius: 4px; font-size: 0.875rem;">${po.payment_terms}</div>
                            </div>
                        ` : ''}

                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem;">Items</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f3f4f6;">
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Item</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Category</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Qty</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Unit Cost</th>
                                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                items.forEach(item => {
                    modalContent += `
                        <tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.item || item.item_name}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.category || 'N/A'}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${item.qty || item.quantity} ${item.unit}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">PHP ${parseFloat(item.unit_cost || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">PHP ${parseFloat(item.subtotal || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
                
                modalContent += `
                                </tbody>
                                <tfoot>
                                    <tr style="font-weight: 600;">
                                        <td colspan="4" style="padding: 0.75rem; text-align: right; border-top: 2px solid #e5e7eb;">TOTAL:</td>
                                        <td style="padding: 0.75rem; border-top: 2px solid #e5e7eb;">PHP ${parseFloat(po.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="viewPODocument('${po.id}')" style="padding: 0.75rem 1.5rem;">View PO Document</button>
                            <button class="btn btn-success" onclick="downloadPODocument('${po.id}')" style="padding: 0.75rem 1.5rem;">Download PO Document</button>
                        </div>
                    </div>
                `;
                
                // Show in documents modal
                document.getElementById('documentsContent').innerHTML = modalContent;
                document.getElementById('documentsModal').classList.add('active');
                
                console.log('PO Details:', po);
                
            } catch (error) {
                console.error('Error loading PO details:', error);
                showToast('Failed to load PO details', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.viewAllDocuments = async function(mrfId) {
            console.log('Loading documents for MRF:', mrfId);
            showLoading(true);
            
            try {
                // Fetch all PRs for this MRF
                const prsRef = collection(db, 'prs');
                const prQuery = query(prsRef, where('mrf_id', '==', mrfId));
                const prSnapshot = await getDocs(prQuery);
                
                const prs = [];
                prSnapshot.forEach((doc) => {
                    prs.push({ id: doc.id, ...doc.data() });
                });
                
                // Fetch all POs for this MRF
                const posRef = collection(db, 'pos');
                const poQuery = query(posRef, where('mrf_id', '==', mrfId));
                const poSnapshot = await getDocs(poQuery);
                
                const pos = [];
                poSnapshot.forEach((doc) => {
                    pos.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Found ${prs.length} PRs and ${pos.length} POs for ${mrfId}`);
                
                // Build modal content with title
                let modalContent = `
                    <h2 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                        Documents for ${mrfId}
                    </h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                `;
                
                // PRs section
                if (prs.length > 0) {
                    modalContent += '<h3 style="margin-bottom: 1rem; color: #1a73e8;">Purchase Requests</h3>';
                    modalContent += '<div style="display: grid; gap: 1rem; margin-bottom: 2rem;">';
                    prs.forEach(pr => {
                        const items = pr.items_json ? JSON.parse(pr.items_json) : [];
                        modalContent += `
                            <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; background: #f9fafb;">
                                <div style="font-weight: 600; color: #1a73e8; margin-bottom: 0.5rem; font-size: 1.1rem;">${pr.pr_id}</div>
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">
                                    <div><strong>Supplier:</strong> ${pr.supplier_name || 'N/A'}</div>
                                    <div><strong>Amount:</strong> PHP ${parseFloat(pr.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                    <div><strong>Status:</strong> <span style="padding: 0.25rem 0.5rem; background: ${pr.finance_status === 'Approved' ? '#d4edda' : '#fff3cd'}; border-radius: 4px; font-weight: 600;">${pr.finance_status || 'Unknown'}</span></div>
                                    <div><strong>Date Generated:</strong> ${pr.date_generated || 'N/A'}</div>
                                    <div><strong>Items:</strong> ${items.length} item(s)</div>
                                </div>
                            </div>
                        `;
                    });
                    modalContent += '</div>';
                }
                
                // POs section
                if (pos.length > 0) {
                    modalContent += '<h3 style="margin-bottom: 1rem; color: #34a853;">Purchase Orders</h3>';
                    modalContent += '<div style="display: grid; gap: 1rem;">';
                    pos.forEach(po => {
                        const items = po.items_json ? JSON.parse(po.items_json) : [];
                        const deliveryFee = po.delivery_fee ? `<div><strong>Delivery Fee:</strong> <span style="color: #f59e0b; font-weight: 600;">PHP ${parseFloat(po.delivery_fee).toLocaleString('en-PH', {minimumFractionDigits: 2})}</span></div>` : '';
                        
                        modalContent += `
                            <div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; background: #f9fafb;">
                                <div style="font-weight: 600; color: #34a853; margin-bottom: 0.5rem; font-size: 1.1rem;">${po.po_id}</div>
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">
                                    <div><strong>Supplier:</strong> ${po.supplier_name || 'N/A'}</div>
                                    <div><strong>Amount:</strong> PHP ${parseFloat(po.total_amount || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                    ${deliveryFee}
                                    <div><strong>Status:</strong> <span style="padding: 0.25rem 0.5rem; background: ${po.procurement_status === 'Delivered' ? '#d4edda' : '#fff3cd'}; border-radius: 4px; font-weight: 600;">${po.procurement_status || po.delivery_status || 'Unknown'}</span></div>
                                    <div><strong>Date Issued:</strong> ${po.date_issued || 'N/A'}</div>
                                    ${po.delivered_date ? `<div><strong>Delivered Date:</strong> ${po.delivered_date}</div>` : ''}
                                    <div><strong>Items:</strong> ${items.length} item(s)</div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="viewPODetails('${po.id}')" style="margin-top: 0.5rem;">View Full Details</button>
                            </div>
                        `;
                    });
                    modalContent += '</div>';
                }
                
                if (prs.length === 0 && pos.length === 0) {
                    modalContent += '<p style="text-align: center; color: #999; padding: 2rem;">No documents found for this MRF.</p>';
                }
                
                modalContent += '</div>';
                
                // Show in modal
                document.getElementById('documentsContent').innerHTML = modalContent;
                document.getElementById('documentsModal').classList.add('active');
                
                console.log('Documents loaded:', { prs, pos });
                
            } catch (error) {
                console.error('Error loading documents:', error);
                showToast('Failed to load documents', 'error');
            } finally {
                showLoading(false);
            }
        };

    </script>


    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTimelineModal()">&times;</button>
            <div id="timelineContent"></div>
        </div>
    </div>

    <!-- Documents Modal -->
    <div id="documentsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="modal-close" onclick="closeDocumentsModal()">&times;</button>
            <div id="documentsContent"></div>
        </div>
    </div>

</body>
</html>
